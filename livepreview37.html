<!DOCTYPE html>

<html lang="en"><head><style id="app-mode-style">
/* --- App Mode (production-like) --- */
body.app-mode .mode-switch,
body.app-mode .builder-toolbar,
body.app-mode .inspector,
body.app-mode .schema-panel,
body.app-mode .fab,
body.app-mode .drag-handle,
body.app-mode .grid-guides,
body.app-mode .dev-badges,
body.app-mode .schema-btns,
body.app-mode .designer-only { display: none !important; }

body.app-mode .runtime-only { display: block !important; }
body.app-mode .builder-only { display: none !important; }

/* Lock layout interactions */
body.app-mode [draggable],
body.app-mode .sortable,
body.app-mode .resizable { pointer-events: none !important; }

/* Fallback button if toolbar not found */
#openAppBtn.fallback-fixed {
  position: fixed; top: 12px; right: 12px; z-index: 130;
  padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,.1);
  background: white; box-shadow: 0 2px 8px rgba(0,0,0,.15); font: inherit; cursor: pointer;
}
</style><style id="open-app-label-style">
/* --- Ensure label is visible for the Open App button --- */
#openAppBtn.force-label { 
  display: inline-flex; align-items: center; gap: .35rem;
  white-space: nowrap; font-size: inherit !important; text-indent: 0 !important;
  padding-inline: .6rem;
}
#openAppBtn.force-label .label { display: inline !important; }
#openAppBtn.force-label .icon { display: inline-block; line-height: 1; }
</style><style id="app-mode-hide-controls">
/* --- App mode: hide builder-affecting actions --- */
body.app-mode .cb-row-tools,
body.app-mode .cb-add-row,
body.app-mode [data-action="add-row"],
body.app-mode #addRowBtn,
body.app-mode .btn-add-row,
body.app-mode .row-toolbar,
body.app-mode .row-tools,
/* nav add */
body.app-mode #addNavBtn,
body.app-mode .nav-add,
body.app-mode .btn-nav-add,
body.app-mode [data-action="add-nav"],
body.app-mode .nav-toolbar .add,
/* schema/data io */
body.app-mode .schema-btns,
body.app-mode .schema-fab,
body.app-mode #schemaFab,
body.app-mode #schemaBtn,
body.app-mode [data-role="schema"],
body.app-mode #dataIOFab,
body.app-mode #dataIOFabExport,
body.app-mode #dataIOFabImport,
body.app-mode [data-role="data"],
body.app-mode [data-io],
/* generic toolbar items that often map to schema/data in your app */
body.app-mode .toolbar .schema,
body.app-mode .toolbar .data-io { display: none !important; }
</style><style id="app-mode-logo-lock">
/* --- App mode: lock branding (logo/name) --- */
body.app-mode .logo-picker,
body.app-mode .logo-edit,
body.app-mode .brand-edit,
body.app-mode [data-role="logo-edit"],
body.app-mode [data-action="logo-edit"],
body.app-mode [data-action="change-logo"],
body.app-mode .brand-upload,
body.app-mode .logo-uploader,
body.app-mode .brand-uploader,
body.app-mode .logo-tools { display: none !important; }

/* If brand name is contenteditable, make it read-only effectually */
body.app-mode [data-brand],
body.app-mode .brand-name,
body.app-mode #brandName,
body.app-mode [contenteditable][data-brand],
body.app-mode header [contenteditable] {
  pointer-events: none !important;
  user-select: text !important;
  caret-color: transparent !important;
  -webkit-user-modify: read-only !important;
}

/* Optional: dim hover affordance on brand area */
body.app-mode .brand, 
body.app-mode .brand-logo { cursor: default !important; }
</style><style id="app-mode-hide-schema-strong">
/* --- App mode: strong schema hide (generic) --- */
body.app-mode [data-schema],
body.app-mode .schema,
body.app-mode .schema-btn,
body.app-mode .schema-fab,
body.app-mode [data-fab*="schema"],
body.app-mode [id*="schema"],
body.app-mode [class*="schema"] { display: none !important; }
</style><style id="app-mode-hide-plus-row-css">
/* --- App mode: hide '+ Row' / 'Add Row' buttons in form designer --- */
body.app-mode .add-row,
body.app-mode .fd-add-row,
body.app-mode .fd-row-add,
body.app-mode .row-add,
body.app-mode .cb-add-row,
body.app-mode .row-toolbar .add,
body.app-mode [data-action*="add-row"],
body.app-mode [data-action*="addrow"],
body.app-mode [data-role*="add-row"],
body.app-mode [id*="addrow"],
body.app-mode [class*="add-row"],
body.app-mode button[title*="Row"],
body.app-mode button[aria-label*="Row"] { display: none !important; }
</style></head>
<script id="renderDebounced-shim">


// Early shim to avoid ReferenceError before helpers load later.
window.renderDebounced = window.renderDebounced || function(){ try{ if (typeof render==='function') render(); }catch(e){} };

    // === Custom datetime control: date + time with hidden ISO value ===
    function buildControlDatetimeComposite(fd){
      const wrap = document.createElement('div');
      wrap.className = 'datetime-wrap';
      wrap.setAttribute('data-datetime-composite','1');

      // visible date
      const segDate = document.createElement('div'); segDate.className = 'dt-seg';
      const labDate = document.createElement('label'); labDate.textContent = 'Date';
      const inDate = document.createElement('input'); inDate.type='date';
      segDate.appendChild(labDate); segDate.appendChild(inDate);

      // visible time
      const segTime = document.createElement('div'); segTime.className = 'dt-seg';
      const labTime = document.createElement('label'); labTime.textContent = 'Time';
      const inTime = document.createElement('input'); inTime.type='time';
      segTime.appendChild(labTime); segTime.appendChild(inTime);

      // hidden combined value (the one the app reads/saves by id)
      const hidden = document.createElement('input'); hidden.type='hidden'; 
      hidden.id = 'f_' + fd.id; hidden.name = fd.name || ('f_' + fd.id);
      hidden.dataset.ftype = 'datetime';
      if(fd.required) { hidden.required = true; inDate.required = true; inTime.required = true; }
      if(fd.readonly){ inDate.readOnly = true; inTime.readOnly = true; }
      if(fd.disabled){ inDate.disabled = true; inTime.disabled = true; }

      // min/max/step (fd.min/fd.max as full datetime, ex: 2025-01-31T09:00)
      if(fd.min){ try{ inDate.min = String(fd.min).slice(0,10); }catch(e){} }
      if(fd.max){ try{ inDate.max = String(fd.max).slice(0,10); }catch(e){} }
      if(fd.step){ inTime.step = fd.step; } // seconds or minutes depending on value (e.g., 60)

      function seedFromDefault(v){
        if(!v) return;
        const iso = String(v).trim().replace(' ', 'T');
        const d = new Date(iso);
        if(!isNaN(d.getTime())){
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          const HH = String(d.getHours()).padStart(2,'0');
          const MM = String(d.getMinutes()).padStart(2,'0');
          inDate.value = `${yyyy}-${mm}-${dd}`;
          inTime.value = `${HH}:${MM}`;
          hidden.value = `${inDate.value}T${inTime.value}`;
        }
      }

      // default value (supports 'YYYY-MM-DDTHH:mm' or full ISO)
      seedFromDefault(fd.default || fd.value || '');

      function sync(){
        if(inDate.value && inTime.value){
          hidden.value = `${inDate.value}T${inTime.value}`;
        } else {
          hidden.value = '';
        }
        // bubble change for any listeners
        hidden.dispatchEvent(new Event('input', {bubbles:true}));
        hidden.dispatchEvent(new Event('change', {bubbles:true}));
      }
      inDate.addEventListener('input', sync);
      inTime.addEventListener('input', sync);
      inDate.addEventListener('change', sync);
      inTime.addEventListener('change', sync);

      wrap.appendChild(segDate);
      wrap.appendChild(segTime);
      wrap.appendChild(hidden);
      return wrap;
    }
    
</script>
<script id="data-io-early">
(function(){
  if(window.__dataIOEarlyCap) return; window.__dataIOEarlyCap = true;
  function _run(action){
    try{
      if(action==='export'){ if(window.__dataIOCore && window.__dataIOCore.exportValues) window.__dataIOCore.exportValues(); }
      else if(action==='import'){ if(window.__dataIOCore && window.__dataIOCore.importValues) window.__dataIOCore.importValues(); }
    }catch(_){}
  }
  function handler(e){
    try{
      const t = e && e.target; if(!t) return;
      if(t.id==='dataIOFabExport'){ e.preventDefault(); e.stopPropagation(); _run('export'); }
      if(t.id==='dataIOFabImport'){ e.preventDefault(); e.stopPropagation(); _run('import'); }
    }catch(_){}
  }
  window.addEventListener('click', handler, true);
  document.addEventListener('click', handler, true);
})();
</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Website Name · Designer</title>
<link href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='2' y='2' width='60' height='60' rx='14' fill='%232563eb'/%3E%3C/svg%3E" id="dynamic-favicon" rel="icon"/>
<style>
  :root{
    --bg:#f6f8fc; --surface:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --primary:#2563eb; --shadow:0 10px 25px rgba(2,8,23,.08), 0 2px 6px rgba(2,8,23,.06);
    --radius:16px; --nav-h:64px; --side-w:280px; --insp-w:420px; --container:1240px;
    --ctrl-h:44px; --ctrl-r:12px; --accent:#1d4ed8; --ring:#93c5fd;
    --green:#16a34a; --danger:#ef4444; --link:#1d4ed8;
  ;--label-gap:4px}
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);
    background:
      radial-gradient(1200px 600px at 10% -10%,#ebf2ff 0%,transparent 40%),
      radial-gradient(1000px 500px at 90% 110%,#eaf7ef 0%,transparent 40%),
      var(--bg)
  }


  .topbar{position:sticky;top:0;z-index:80;height:var(--nav-h);backdrop-filter:saturate(180%) blur(8px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
  .topbar .inner{height:100%;display:flex;align-items:center;gap:12px;padding:0 18px;width:100%;margin:0}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800}
  .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--primary),#7c3aed);color:#fff;font-weight:900;cursor:pointer;border:1px solid #c7d2fe;box-shadow:var(--shadow)}
  .brand-name[contenteditable="true"]{outline:none;border-radius:8px;padding:3px 6px}
  .brand-name[contenteditable="true"]:focus{box-shadow:0 0 0 2px #bfdbfe;background:#eff6ff}
  .brand-name[contenteditable="false"]{cursor:default}
  .menu-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer;display:none}
  .grow{flex:1}



  .mode-switch button{padding:8px 12px;border:0;background:transparent;cursor:pointer;font-weight:800}
  .mode-switch button.active{background:#1e40af;color:#fff}
  .mode-hint{font-size:12px;color:var(--muted);margin-left:8px}


  .input,.select,.textarea{background:#fff;border:1px solid var(--line);border-radius:var(--ctrl-r);padding:10px 12px;min-width:0;outline:none;height:var(--ctrl-h)}
  .textarea{height:96px;resize:vertical}
  .btn{border:0;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;height:var(--ctrl-h)}
  .btn.primary{background:linear-gradient(135deg,#60a5fa,#22d3ee);color:#081326;border:1px solid #bae6fd}
  .btn.danger{background:linear-gradient(135deg,#fca5a5,#ef4444);color:#fff;border:1px solid #fecaca}
  .btn.link{background:transparent;border:0;color:var(--link);text-decoration:underline}
  .btn:disabled{opacity:.6;cursor:not-allowed}


  .layout{display:grid;grid-template-columns:var(--side-w) 1fr;gap:0;width:100%;margin:0;min-height:calc(100dvh - var(--nav-h))}
  .layout{display:grid;grid-template-columns:var(--side-w) 1fr;gap:0;width:100%;margin:0;min-height:calc(100dvh - var(--nav-h))}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:clamp(16px,2vw,24px)}
  .card header{font-size:clamp(20px,2.4vw,30px);font-weight:800;margin-bottom:6px}
  .card header[contenteditable="true"]{outline:none;border-radius:8px;padding:2px 6px}
  .card header[contenteditable="true"]:focus{box-shadow:0 0 0 2px #bfdbfe;background:#eff6ff}
  .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .hint{color:var(--muted);font-size:12px}
  .sep{height:1px;background:var(--line);margin:8px 0}
  .side-title{font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:#64748b;margin:10px 4px 8px}
  .side-panel{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px}


.mode-toggle{ display:inline-flex; align-items:center; gap:2px; border:1px solid var(--line); background:#fff;
              border-radius:999px; padding:2px; height:32px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
.mode-toggle .seg{ border:0; background:transparent; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer }
.mode-toggle .seg.active{ background:#edf2ff; color:#1d4ed8; font-weight:600 }
@media (max-width:768px){

  .mode-toggle{ position:fixed; top:calc(env(safe-area-inset-top) + 8px); right:12px; z-index:120; }
}
@media (max-width:768px){
  .mtabs{position:fixed;left:0;right:0;bottom:0;height:56px;background:#fff;border-top:1px solid #e5e7eb;
         display:flex;justify-content:space-around;align-items:center;gap:4px;z-index:97;padding-bottom:env(safe-area-inset-bottom)}
  .mtab{flex:1;min-width:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:4px 2px}
  .mtab .ico{font-size:18px;line-height:1}
  .mtab .lbl{font-size:11px;max-width:88px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mtab.active{color:#1d4ed8}
  .mtab-sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;max-height:60vh;overflow:auto;
              border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -8px 24px rgba(0,0,0,.15);z-index:98;
              padding-bottom:env(safe-area-inset-bottom)}
  .mtab-item{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #f1f5f9}

  body.mtabs-on .content{padding-bottom:calc(56px + env(safe-area-inset-bottom))}

  #fabAdd{ bottom: calc(56px + 12px + env(safe-area-inset-bottom)); z-index: 100 }
}
#hAdder > button, #vAdder > button { display:none !important; }
#headerAddBtn{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer }
#headerAddBtn .plus{ font-weight:700 }
@media (max-width:768px){
  #headerAddBtn{ display:none }
}
@media (min-width:769px){
  #fabAdd{ display:none }
}

#fabAdd{ position:fixed; right:12px; bottom:12px; width:48px; height:48px;
         border-radius:999px; border:1px solid #e5e7eb; background:#1d4ed8; color:#fff; font-size:22px;
         box-shadow:0 8px 24px rgba(0,0,0,.2); z-index: 98; display:grid; place-items:center }
#fabSheet{ position:fixed; left:0; right:0; bottom:0; background:#fff; max-height:60vh; overflow:auto;
           border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -8px 24px rgba(0,0,0,.15);
           z-index: 99; padding:8px; }
#fabSheet[hidden]{ display:none }
.fab-row{ display:flex; align-items:center; gap:12px; padding:12px 10px; border-bottom:1px solid #f1f5f9 }
.fab-row .lbl{ font-weight:600 }
.form-hint{ font-size:12px; color:#dc2626; margin-left:6px; display:none }
.form-hint.show{ display:inline }

  .hwrap{display:flex;align-items:center;gap:6px;min-width:0;margin-left:10px}
  .hbtn{border:1px solid var(--line);background:#fff;border-radius:10px;width:34px;height:34px;display:grid;place-items:center;cursor:pointer}
  .hbtn[hidden]{display:none !important} .hribbon::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:999px}
  .h-item{position:relative}
  .h-link{display:inline-flex;gap:8px;align-items:center;text-decoration:none;color:#0b1324;padding:8px 12px;border-radius:12px;font-weight:600;border:1px solid transparent;background:#fff}
  .h-link:hover{background:#f8fafc}
  .h-link.active{background:#eef2ff;color:#1d4ed8;border-color:#c7d2fe}
  .h-ico{font-size:14px}
  .h-caret{font-size:12px;opacity:.7}

  .vnav{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .vitem{border-radius:12px}
  .vbtn{width:100%;display:flex;align-items:center;gap:10px;text-align:left;padding:10px 12px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer;font-weight:600}
  .vbtn:hover{background:#f8fafc}
  .vbtn.active{background:#eef2ff;color:#1d4ed8;border-color:#c7d2fe}
  .container-tag{margin-left:auto;font-size:11px;color:#1d4ed8;background:#e0e7ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px}


  .adder-pop{position:relative}
  .adder-pop > button{border:1px dashed var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
  .adder-pop .panel{position:absolute;top:120%;left:0;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow);display:none;width:380px;z-index:80}
  .adder-pop.open .panel{display:block}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .panel header{font-weight:800;margin-bottom:8px}
  .panel .micro{display:flex;gap:6px;align-items:center;color:#64748b;font-size:12px}
  .panel .micro .dot{width:6px;height:6px;background:#60a5fa;border-radius:999px}
  .panel .footer{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}


  .fly-root{position:fixed; inset:0; display:none; z-index:120;}
  .fly-root.open{display:block;}
  .fly{position:fixed; top:0; left:0; min-width:240px; max-width:320px; max-height:70vh; overflow:auto;
       background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); padding:6px}
  .fly .item{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer}
  .fly .item:hover{background:#f1f5f9}
  .fly .item .caret{margin-left:auto; opacity:.6}
  .fly .sub{position:fixed; display:none; min-width:220px; max-height:60vh; overflow:auto; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow); padding:6px}
  .fly .item.open + .sub{display:block}


  .section{border:1px dashed #cbd5e1;border-radius:12px;padding:12px;background:#fff;margin-top:10px;position:relative}
  .section-title{display:flex;align-items:center;gap:8px;font-weight:800;margin-bottom:8px}
  .section-toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-left:auto}
  .stool{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .grid4{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:12px}
  .fcard{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;min-width:0;position:relative}
  .icons{position:absolute;top:8px;right:8px;display:flex;gap:6px;align-items:center;background:#ffffffcc;border:1px solid var(--line);border-radius:999px;padding:4px 6px}
  .icon-del{color:#b91c1c;border-color:#fecaca}
  .preview-form label{color:#334155;font-weight:600;margin:0;line-height:1.2}
  .preview-form .label-editable[contenteditable="true"]{outline:none;border-radius:6px;padding:2px 4px}
  .preview-form .label-editable[contenteditable="true"]:focus{box-shadow:0 0 0 2px #bfdbfe;background:#eff6ff}
  .preview-form input,.preview-form select,.preview-form textarea{width:100%;height:var(--ctrl-h);padding:10px 12px;border-radius:var(--ctrl-r);border:1px solid var(--line);background:#fff;color:#0f172a}
  .preview-form textarea{min-height:112px}


  .divider-card{position:relative;background:#fff;border:1px dashed #d1d5db;border-radius:12px;padding:8px}
  .divider-card hr{border:none;height:1px;background:#e5e7eb}


  .choice-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .choice{display:inline-flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
  .choice input{appearance:none;-webkit-appearance:none;outline:none;margin:0;transition:background .18s ease, border-color .18s ease, box-shadow .18s, transform .18s ease;}
  .choice span{ line-height:1; font-weight:600; color:#111827; }

  .choice input[type="checkbox"]{width:36px;height:20px;border-radius:999px;position:relative;background:#cbd5e1;border:1px solid #cbd5e1}
  .choice input[type="checkbox"]:hover{border-color:#94a3b8}
  .choice input[type="checkbox"]:focus-visible{box-shadow:0 0 0 3px var(--ring)}
  .choice input[type="checkbox"]::after{content:"";position:absolute;top:50%;left:2px;width:16px;height:16px;transform:translateY(-50%);border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.15);transition:left .18s ease}
  .choice input[type="checkbox"]:checked{background:var(--green);border-color:var(--green)}
  .choice input[type="checkbox"]:checked::after{left:calc(100% - 18px)}

  .choice input[type="radio"]{width:18px;height:18px;border-radius:999px;border:2px solid #9aa5b1;background:radial-gradient(circle at 50% 50%, transparent 0 5px, #ffffff 5px 7px, transparent 7px)}
  .choice input[type="radio"]:hover{border-color:#7c3aed}
  .choice input[type="radio"]:focus-visible{box-shadow:0 0 0 3px #c7d2fe}
  .choice input[type="radio"]:checked{border-color:#7c3aed;background:radial-gradient(circle at 50% 50%, #7c3aed 0 5px, #ffffff 5px 7px, transparent 7px)}


  .toggle{position:relative;display:inline-flex;align-items:center;gap:10px}
  .toggle input{position:absolute;opacity:0;pointer-events:none}
  .toggle .track{width:44px;height:24px;border-radius:999px;background:#cbd5e1;border:1px solid #cbd5e1;transition:background .18s ease, border-color .18s ease;position:relative}
  .toggle .thumb{position:absolute;top:50%;left:2px;transform:translateY(-50%);width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.18);transition:left .18s ease}
  .toggle input:focus-visible + .track{box-shadow:0 0 0 3px var(--ring)}
  .toggle input:checked + .track{background:#1e40af;border-color:#1e40af}
  .toggle input:checked + .track .thumb{left:calc(100% - 22px)}


  .inspector{position:fixed;top:var(--nav-h);right:0;width:var(--insp-w);height:calc(100dvh - var(--nav-h));background:#fff;border-left:1px solid var(--line);box-shadow:-10px 0 25px rgba(2,8,23,.08);transform:translateX(105%);transition:transform .15s ease;z-index:90;display:flex;flex-direction:column}
  .inspector{position:fixed;top:var(--nav-h);right:0;width:var(--insp-w);height:calc(100dvh - var(--nav-h));background:#fff;border-left:1px solid var(--line);box-shadow:-10px 0 25px rgba(2,8,23,.08);transform:translateX(105%);transition:transform .15s ease;z-index:90;display:flex;flex-direction:column}
  .inspector.open{transform:none}
  .insp-head{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:800;display:flex;align-items:center;gap:8px}
  .insp-tabs{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line)}
  .insp-tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer;font-size:12px}
  .insp-tab.active{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
  .insp-body{padding:14px;display:grid;gap:12px;overflow:auto}
  .insp-row{display:grid;gap:6px}
  .insp-row .label{font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.08em}
  .insp-actions{display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid var(--line);padding:12px 14px;margin-top:auto}
  .insp-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .insp-btn.primary{background:linear-gradient(135deg,#60a5fa,#22d3ee);border-color:#bae6fd}


  body.demo-mode .inspector,
  body.demo-mode .section-toolbar,
  body.demo-mode .adder-pop,
  body.demo-mode .icons { display:none !important }
  body.demo-mode #logoBtn { display:none !important }
  body.demo-mode [contenteditable="true"]{pointer-events:none}


  .logo-picker{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:150}
  .logo-picker.open{display:flex}
  .lp-panel{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);width:min(920px,94vw);max-height:82vh;display:flex;flex-direction:column}
  .lp-head{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);font-weight:800}
  .lp-body{display:grid;grid-template-columns:280px 1fr;gap:12px;padding:12px;overflow:auto}
  .lp-preview{border:1px solid var(--line);border-radius:12px;padding:16px;background:#f8fafc;display:grid;gap:10px;align-content:start}
  .lp-preview .big{width:84px;height:84px;border-radius:16px;display:grid;place-items:center;border:1px solid #dbeafe;background:linear-gradient(135deg,#60a5fa,#7c3aed);box-shadow:var(--shadow)}
  .lp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(96px,1fr));gap:12px}
  .lp-item{border:1px solid var(--line);border-radius:12px;padding:10px;display:grid;place-items:center;gap:6px;cursor:pointer;background:#fff}
  .lp-item:hover{background:#f8fafc}
  .lp-item.active{outline:2px solid #93c5fd}
  .lp-item svg{width:56px;height:56px}
  .lp-foot{display:flex;gap:8px;padding:12px;border-top:1px solid var(--line)}
  .isearch{flex:1}


  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;border-radius:999px;padding:10px 14px;font-weight:700;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s ease}
  .toast.show{opacity:1}


  .dtp-root{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.15);z-index:160}
  .dtp-root.open{display:flex}
  .dtp{margin-top:80px;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);width:min(720px,96vw);overflow:hidden}
  .dtp-head{display:flex;align-items:center;justify-content:space-between;background:#2563eb;color:#fff;padding:10px 14px}
  .dtp-head .navbtn{background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer}
  .dtp-body{display:grid;grid-template-columns:1.2fr .8fr;gap:0}
  .dtp-cal{padding:12px}
  .dtp-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dtp-dayhead{font-size:12px;color:#334155;text-align:center}
  .dtp-cell{height:36px;display:grid;place-items:center;border-radius:10px;cursor:pointer}
  .dtp-cell.dis{opacity:.35;cursor:default}
  .dtp-cell.cur{background:#eff6ff;border:1px solid #bfdbfe;color:#1d4ed8}
  .dtp-cell.sel{background:#2563eb;color:#fff}
  .dtp-clock{padding:12px;display:grid;gap:10px;align-content:start}
  .dtp-time{font-weight:800;font-size:18px;text-align:right;padding:0 6px}
  .clock-face{width:240px;height:240px;margin-inline:auto;background:#f1f5f9;border-radius:999px;position:relative;border:1px solid #e5e7eb}
  .clock-num{position:absolute;transform:translate(-50%,-50%);color:#0f172a}
  .clock-hand{position:absolute;top:50%;left:50%;width:2px;height:34%;background:#2563eb;transform-origin:50% 100%;border-radius:2px}
  .ampm{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:6px}
  .ampm button{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
  .ampm .active{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
  .dtp-foot{padding:12px;display:flex;justify-content:center}
  .dtp-foot .btn{min-width:140px}


  @media (max-width:1024px){ .layout{grid-template-columns:1fr} .sidebar{position:fixed;top:var(--nav-h);left:0;width:min(86vw,320px);transform:translateX(-105%);transition:transform .15s ease;box-shadow:var(--shadow)} body.side-open .sidebar{transform:none} .menu-btn{display:inline-block} .lp-body{grid-template-columns:1fr} }
  @media (max-width:640px){ .grid4{grid-template-columns:1fr} .preview-form .field{grid-template-columns:1fr} .btn,.input,.select{width:100%} #formActions{flex-direction:column;align-items:stretch} .hribbon{max-width:50vw} .dtp-body{grid-template-columns:1fr} .clock-face{width:220px;height:220px} }

  .cond-badge{font-size:11px;margin-left:6px}
  .fcard.dimmed{opacity:.6}

  .file-preview{display:grid;grid-template-columns:1fr;gap:12px;align-items:start}
  @media (min-width: 900px){ .file-preview{grid-template-columns:repeat(2,minmax(0,1fr))} }
  .file-frame{position:relative;width:100%;max-width:560px;cursor:pointer}
  .file-frame img{display:block;width:100%;height:auto}
  .file-frame iframe{display:block;width:100%;aspect-ratio:4/3;border:0}
  .viewer-btn{position:absolute;top:8px;right:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer;box-shadow:var(--shadow)}
  .viewer-btn:hover{background:#f8fafc}
  .viewer-body img{max-width:100%;height:auto;display:block;border-radius:12px}
  .viewer-body iframe{width:86vw;max-width:1040px;height:70vh;border:0;border-radius:12px;background:#111827} .hribbon::-webkit-scrollbar{height:6px}


  .vnav li{list-style:none}
  .vnav button{width:100%;display:flex;align-items:center;gap:12px;padding:10px 12px;border:0;background:transparent;border-radius:12px;cursor:pointer}
  .vnav button:hover{background:#f1f5f9}
  .vnav .icon{width:22px;display:inline-grid;place-items:center}
  .vnav .name{flex:1;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .hribbon{display:flex;gap:10px;overflow:auto;padding:8px}
  .hribbon a:hover{background:#f8fafc}
  .hribbon a.active{background:#111827;color:#fff;border-color:#111827}

  .fullscreen-btn{position:fixed;top:10px;right:12px;z-index:180}


  .layout{display:grid;grid-template-columns:240px 1fr;gap:16px}

  .icon-picker{position:absolute;z-index:120;inset:auto auto auto 0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:8px;display:grid;grid-template-columns:repeat(8,28px);gap:6px;max-width:260px}
  .icon-picker button{width:28px;height:28px;display:grid;place-items:center;border:1px solid transparent;border-radius:8px;background:#fff;cursor:pointer}
  .icon-picker button:hover{border-color:#e5e7eb;background:#f8fafc}
  .icon-input-wrap{position:relative;display:flex;gap:6px;align-items:center}
  .sidebar{position:sticky; top:64px; align-self:start; border-right:1px solid var(--line); padding-right:8px; background:#fff}
  .sidebar .card{box-shadow:none; background:transparent}


  .layout{display:grid;grid-template-columns:240px 1fr;gap:16px}
  @media (max-width: 900px){ .layout{grid-template-columns:1fr} }
  .content{padding-left:0}

  .page-head{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:800}
  .ico-tools{margin-left:auto;display:flex;gap:6px}
  .ico-tools .btn{padding:4px 8px}
  body.demo-mode .ico-tools{display:none}
  body:not(.demo-mode) .ico-tools{display:flex}

  .page-ico-trigger{display:inline-flex;align-items:center;gap:4px;border:1px solid var(--line);background:#fff;border-radius:10px;padding:4px 8px;cursor:pointer}
  .page-ico-trigger:hover{background:#f8fafc}
  .page-ico-pop{position:absolute;z-index:160;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:8px;display:none;grid-template-columns:repeat(10,28px);gap:6px;margin-top:6px}
  body.demo-mode .page-ico-trigger{display:none}


  .layout{max-width:none;width:100%;margin:0}
  .layout{grid-template-columns:var(--side-w) 1fr}
  aside.sidebar{margin-left:0;padding-left:0}


  :root{
    --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

    --fs-xs: clamp(11px, 0.75vw, 12px);
    --fs-sm: clamp(12px, 0.8vw, 13px);
    --fs-base: clamp(14px, 0.95vw, 16px);
    --fs-md: clamp(15px, 1.05vw, 18px);
    --fs-lg: clamp(18px, 1.4vw, 20px);
    --fs-xl: clamp(20px, 1.8vw, 24px);
    --fs-2xl: clamp(24px, 2.4vw, 28px);

    --fw-regular: 400;
    --fw-medium: 500;
    --fw-semibold: 600;
    --fw-bold: 700;
    --fw-extrabold: 800;

    --lh-tight: 1.15;
    --lh-normal: 1.45;
    --lh-relaxed: 1.6;
  }
  html, body{font-family: var(--font-sans); font-size: var(--fs-base); line-height: var(--lh-normal);}

  h1, .h1{font-size: var(--fs-2xl); font-weight: var(--fw-extrabold); line-height: var(--lh-tight); letter-spacing: -0.01em;}
  h2, .h2{font-size: var(--fs-xl); font-weight: var(--fw-bold); line-height: 1.2; letter-spacing: -0.005em;}
  h3, .h3{font-size: var(--fs-lg); font-weight: var(--fw-semibold); line-height: 1.25;}

  .page-head{font-size: var(--fs-xl) !important; font-weight: var(--fw-extrabold) !important; line-height: var(--lh-tight);}
  .page-ico{font-size: inherit;}

  .section-name{font-size: var(--fs-lg); font-weight: var(--fw-bold); line-height: 1.2;}
  label, .label{font-size: var(--fs-sm); font-weight: var(--fw-semibold); color: #111827;}
  .hint, .subtle, small{font-size: var(--fs-sm); color:#6b7280}

  input, select, textarea, .rich-wrap [contenteditable="true"]{font-size: var(--fs-base); line-height: 1.35;}
  .chip{font-size: var(--fs-xs); font-weight: var(--fw-medium);}

  .btn{font-size: var(--fs-sm); font-weight: var(--fw-semibold);}
  .btn.ghost{font-weight: var(--fw-medium);}

  .vnav button{font-size: var(--fs-base); font-weight: var(--fw-medium);}
  .vnav button.active{font-weight: var(--fw-semibold);}
  .hribbon a{font-size: var(--fs-sm); font-weight: var(--fw-medium);}

  .fcard .label-editable{font-size: var(--fs-base); font-weight: var(--fw-semibold);}

  .viewer-title{font-size: var(--fs-base); font-weight: var(--fw-bold);}


  .lp-preview{gap:6px !important;}
  .preview-form .field{row-gap:2px !important; margin-bottom:6px !important;}

  .fcard{margin-bottom:8px !important;}

  .divider-card{padding:6px !important; margin:6px 0 !important;}


  .fcard{background:transparent !important; border:none !important; box-shadow:none !important; padding:0 !important; border-radius:0 !important; margin:0 0 6px 0 !important;}
  .fcard .head{padding:0 !important; margin-bottom:4px !important; background:transparent !important; border:0 !important; box-shadow:none !important;}
  .fcard .body{padding:0 !important; background:transparent !important; border:0 !important; box-shadow:none !important; gap:6px !important;}

  .fcard .icons{top:0; right:0}

  #pageName[data-editing="1"]{outline:0;box-shadow:0 0 0 2px #bfdbfe;background:#eff6ff;border-radius:6px;padding:2px 4px}

  .page-edit-btn{margin-left:auto}
  body.demo-mode .page-edit-btn{display:none}

  #pageName{cursor:text}
  body.demo-mode #pageName{cursor:default}
  #pageName:hover{background:rgba(191,219,254,.35); border-radius:6px}

  [data-editing="1"]{outline:0;box-shadow:0 0 0 2px #bfdbfe;background:#eff6ff;border-radius:6px;padding:2px 4px}


  .fullscreen-btn.inline{position:static !important; margin-left:8px; z-index:auto}

  .fullscreen-btn{top:56px}


  .viewer-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,23,.55);backdrop-filter:blur(6px);z-index:170}
  .viewer-root.open{display:flex;animation:fadeIn .15s ease-out}
  @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:none}}
  .viewer{background:#0b1220;border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 40px rgba(2,8,23,.45);max-width:min(96vw,1200px);max-height:90vh;width:clamp(320px,92vw,1200px);display:grid;grid-template-rows:auto 1fr}
  .viewer-header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px 14px;color:#e5e7eb;background:linear-gradient(180deg,#0f172a,#0c1426);border-bottom:1px solid rgba(255,255,255,.06);border-top-left-radius:16px;border-top-right-radius:16px}
  .viewer-title{font-weight:700;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:55vw}
  .viewer-actions{display:flex;align-items:center;gap:8px}
  .viewer-actions .btn{margin:0}
  .viewer-body{position:relative;padding:0;background:#0b1220;display:grid;place-items:center;overflow:hidden;border-bottom-left-radius:16px;border-bottom-right-radius:16px}
  .viewer-stage{position:relative;max-width:100%;max-height:100%;width:100%;height:100%;display:grid;place-items:center;overflow:hidden}
  .viewer-stage img,.viewer-stage iframe{display:block;max-width:100%;max-height:100%;border:0;border-radius:12px;background:#0b1220;transform-origin:center center;transition:transform .12s ease-out}
  .viewer-toolbar{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;display:flex;gap:8px;background:rgba(15,23,42,.9);border:1px solid rgba(255,255,255,.08);padding:6px 8px;border-radius:999px;box-shadow:0 6px 20px rgba(0,0,0,.35)}
  .toolbar-btn{border:0;background:transparent;color:#e5e7eb;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:14px}
  .toolbar-btn:hover{background:rgba(255,255,255,.08)}
  @media (max-width: 640px){
    .viewer{max-width:96vw}
  }


  .file-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;align-items:start}
  .file-card{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;min-height:140px}
  .file-thumb{display:block;width:100%;aspect-ratio:4/3;border:0;background:#f8fafc;object-fit:contain}
  .file-thumb.is-pdf{background:#111827}
  .file-name{padding:8px 10px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-top:1px solid var(--line)}
  .file-meta{padding:0 10px 8px 10px;font-size:12px;color:#6b7280}
  .file-actions{display:flex;gap:6px;flex-wrap:wrap;padding:8px 10px;border-top:1px solid var(--line);background:#fafafa}
  .file-actions .btn{padding:4px 8px;font-size:12px}
  .drop-zone{margin-top:8px;border:1px dashed #cbd5e1;border-radius:12px;padding:14px;display:flex;align-items:center;justify-content:center;gap:8px;background:#f8fafc;color:#64748b;cursor:pointer}
  .drop-zone.over{background:#eef2ff;border-color:#93c5fd;color:#1e40af}
  .error-list{margin-top:8px;color:#b91c1c;font-size:12px}


  .upload-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,23,.55);backdrop-filter:blur(6px);z-index:180}
  .upload-root.open{display:flex;animation:fadeIn .15s ease-out}
  .upload{background:#ffffff;border:1px solid #e6e8f0;border-radius:16px;box-shadow:0 10px 40px rgba(2,8,23,.25);max-width:min(96vw,900px);width:clamp(320px,92vw,900px);display:grid;grid-template-rows:auto 1fr}
  .upload-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eef2f7}
  .upload-title{font-weight:700}
  .upload-body{padding:16px}
  .upload-drop{border:2px dashed #cbd5e1;border-radius:16px;background:#f8fafc;min-height:240px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:#475569;text-align:center}
  .upload-drop.over{background:#eef2ff;border-color:#93c5fd;color:#1e3a8a}
  .upload-actions{margin-top:14px;display:flex;gap:8px;justify-content:center}
  .upload-actions .btn{padding:8px 12px}
  .close-x{border:0;background:transparent;color:#374151;font-size:18px;border-radius:10px;cursor:pointer;padding:6px 8px}
  .close-x:hover{background:#f3f4f6}


  .mgr-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,23,.55);backdrop-filter:blur(6px);z-index:182}
  .mgr-root.open{display:flex;animation:fadeIn .15s ease-out}
  .mgr{max-height:90vh;background:#ffffff;border:1px solid #e6e8f0;border-radius:16px;box-shadow:0 10px 40px rgba(2,8,23,.25);max-width:min(96vw,1000px);width:clamp(360px,92vw,1000px);display:grid;grid-template-rows:auto auto 1fr auto}
  .mgr-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eef2f7}
  .mgr-title{font-weight:700}
  .mgr-drop{max-height:180px;margin:12px 16px;border:2px dashed #cbd5e1;border-radius:14px;background:#f8fafc;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:#475569;text-align:center}
  .mgr-drop.over{background:#eef2ff;border-color:#93c5fd;color:#1e3a8a}
  .mgr-body{padding:0 16px 16px 16px;min-height:220px; overflow:auto;}
  .mgr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;align-items:start}
  .mgr-card{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;min-height:140px}
  .mgr-thumb{display:block;width:100%;aspect-ratio:4/3;border:0;background:#f8fafc;object-fit:contain}
  .mgr-thumb.is-pdf{background:#111827}
  .mgr-name{padding:8px 10px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-top:1px solid var(--line)}
  .mgr-meta{padding:0 10px 8px 10px;font-size:12px;color:#6b7280}
  .mgr-actions{display:flex;gap:6px;flex-wrap:wrap;padding:8px 10px;border-top:1px solid var(--line);background:#fafafa}
  .mgr-actions .btn{padding:4px 8px;font-size:12px}
  .mgr-actions .btn.ghost{background:#fff}
  .mgr-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #eef2f7}

  .viewer-root{z-index:190 !important}


  .fcard{position:relative}
  .fcard .icon-btn{opacity:0.9}


  .confirm-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,23,.55);backdrop-filter:blur(4px);z-index:200}
  .confirm-root.open{display:flex;animation:fadeIn .12s ease-out}
  .confirm{background:#ffffff;border:1px solid #e6e8f0;border-radius:14px;box-shadow:0 10px 32px rgba(2,8,23,.25);width:min(92vw,440px);display:grid;grid-template-rows:auto 1fr auto}
  .confirm-head{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #eef2f7}
  .confirm-title{font-weight:700}
  .confirm-body{padding:14px;color:#475569}
  .confirm-foot{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #eef2f7}
  .confirm .btn{padding:8px 12px}


  .confirm .btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
  .confirm .btn.danger:hover{background:#dc2626;border-color:#dc2626}
  .confirm-head .icon{font-size:18px;line-height:1}


  .fcard{position:relative}
  .fcard .icons{position:absolute; top:4px; right:4px; display:flex; gap:6px; z-index:5}
  .icon-btn{opacity:.9}
  .fcard:hover .icon-btn{opacity:1}



  .label-editable{position:relative}
  body:not(.demo-mode) .label-editable::after{
    content:'✎';
    opacity:0;
    transition:opacity .12s ease;
    margin-left:6px;
    font-size:12px;
    color:#64748b;
  }
  body:not(.demo-mode) .fcard:hover .label-editable::after{opacity:.8}


  .opt-chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
  .opt-chip{display:inline-flex; align-items:center; gap:6px; background:#f3f4f6; border:1px solid var(--line); border-radius:999px; padding:4px 8px}
  .opt-chip .txt{outline:none; min-width:24px}
  .opt-chip .rm{border:0; background:transparent; cursor:pointer; font-size:14px; line-height:1}
  .opt-add{padding:4px 8px; font-size:12px}


  body.demo-mode .opt-add { display: none !important; }


  body.demo-mode .opt-chips { display: none !important; }


  select.select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="10" viewBox="0 0 20 14"><path d="M4 5l6 6 6-6" stroke="%2362748b" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat right 10px center;
    padding: 8px 34px 8px 10px;
    border: 1px solid var(--line);
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.4;
    min-height: 36px;
    width: 100%;
    box-shadow: var(--shadow);
  }
  body.demo-mode select.select{  }

  body.demo-mode .opt-chips { display:none !important; }
  body.demo-mode .fcard .field-body{ margin-bottom: 0; }


  .fcard .field-body select.select,
  .fcard .field-body input:not([type=checkbox]):not([type=radio]),
  .fcard .field-body textarea { width: 100%; box-sizing: border-box; }

  body.demo-mode .fcard .field-body select.select,
  body.demo-mode .fcard .field-body input:not([type=checkbox]):not([type=radio]),
  body.demo-mode .fcard .field-body textarea { width: 100%; box-sizing: border-box; }


  body.demo-mode .fcard .field-body { display:block }


  .fcard input[type=checkbox],
  .fcard input[type=radio]{
    width: 14px;
    height: 14px;
    vertical-align: middle;
    margin: 0 6px 0 0;
  }

  .fcard label.inline{
    gap: 6px;
  }

  .fcard label .label-editable{ cursor: default !important; }
  #logoText, .logo-text, [data-role="logo-text"]{ cursor: default !important; }

  .table-field{ width:100%; overflow:auto; }
  .tbl{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--line); border-radius:8px; overflow:hidden; }
  .tbl thead th{ text-align:left; font-weight:600; background:var(--bg); border-bottom:1px solid var(--line); padding:8px 10px; font-size: var(--fs-sm); }
  .tbl tbody td{ border-top:1px solid var(--line); padding:8px 10px; font-size: var(--fs-sm); color: var(--muted); }
  .tbl tbody tr:first-child td{ border-top:1px solid var(--line); }
  .cols-editor{ display:grid; gap:8px; }
  .col-row{ display:flex; align-items:center; gap:8px; }
  .col-row input[type="text"]{ flex:1; }
  .col-row .col-key{ min-width:96px; font: 12px/1.2 ui-sans-serif,system-ui; color:var(--muted); background:#f8fafc; border:1px dashed var(--line); border-radius:6px; padding:6px 8px; }
  .col-row .btns{ display:flex; gap:6px; }



  .table-field{ width:100%; overflow:auto; }
  .tbl{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--line); border-radius:8px; overflow:hidden; }
  .tbl thead th{ position:sticky; top:0; text-align:left; font-weight:600; background:var(--bg); border-bottom:1px solid var(--line); padding:8px 10px; font-size: var(--fs-sm); }
  .tbl tbody td{ border-top:1px solid var(--line); padding:8px 10px; font-size: var(--fs-sm); color: var(--muted); }
  .tbl td input{ width:100%; }
  .cols-editor{ display:grid; gap:8px; }
  .col-row{ display:flex; align-items:center; gap:8px; }
  .col-row input[type="text"]{ flex:1; }
  .col-row .col-key{ min-width:96px; font: 12px/1.2 ui-sans-serif,system-ui; color:var(--muted); background:#f8fafc; border:1px dashed var(--line); border-radius:6px; padding:6px 8px; }
  .col-row .btns{ display:flex; gap:6px; }
  .row-actions{ display:flex; gap:6px; margin:6px 0; }
  .csv-tools{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0; }



  .tbl th.sortable{ cursor:pointer; user-select:none; }
  .tbl th.sortable .arrow{ opacity:0.7; margin-left:6px; font-weight:400; }

  .tbl th{ position: relative; }
  .tbl th .hdr-wrap{ display:flex; align-items:center; gap:8px; justify-content:flex-start; }
  .tbl th .filter-icon{ font-size:12px; opacity:.75; cursor:pointer; padding:2px 6px; border-radius:6px; }
  .tbl th .filter-icon:hover{ background:rgba(0,0,0,.05); }
  .tbl th.filter-active .filter-icon{ opacity:1; background:rgba(0,0,0,.08); }
  .filter-drop{ width: fit-content; min-width: 160px; position:absolute; top:100%; right:0; z-index: 99999;  max-height:260px; overflow:auto;
    background:#fff; border:1px solid var(--line); box-shadow:0 8px 24px rgba(0,0,0,.08); border-radius:8px; padding:12px; }
.filter-drop.portal{ position:fixed; z-index:2147483647; }
  .filter-drop .row{ display:flex; gap:6px; align-items:center; margin:6px 0; }
  .filter-drop .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
  .filter-drop input[type="text"], .filter-drop input[type="number"], .filter-drop input[type="date"], .filter-drop input[type="time"]{ width:auto; }
  .filter-drop .vals{ display:flex; flex-direction:column; gap:6px; max-height:160px; overflow:auto; }

  .filter-drop{ border-radius:12px; box-shadow:0 16px 48px rgba(0,0,0,.12); }
  .filter-drop .title{ font-weight:600; font-size:13px; color:#111; margin:2px 2px 10px; }
  .filter-drop .hint{ font-size:12px; color:#666; margin:0 2px 8px; }
  .filter-drop .row{ gap:8px; }
  .filter-drop .vals label.row{ gap:8px; padding:4px 6px; border-radius:8px; }
  .filter-drop .vals label.row:hover{ background:rgba(0,0,0,.04); }
  .filter-drop .actions{ position:sticky; bottom:-12px; background:linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,.9)); padding-top:8px; }
  .filter-drop .actions .btn{ padding:6px 10px; border-radius:8px; }
  .filter-drop input[type="text"], .filter-drop input[type="number"], .filter-drop input[type="date"], .filter-drop input[type="time"]{
    border-radius:8px; padding:6px 8px; border:1px solid var(--line); background:#fff;
  }
  .filter-drop .head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
  .filter-drop .head .title{ font-weight:600; font-size:13px; color:#111; }
  .filter-drop .close{ border:none; background:transparent; cursor:pointer; font-size:16px; line-height:1; padding:4px 6px; border-radius:8px; }
  .filter-drop .close:hover{ background:rgba(0,0,0,.06); }
.richtext-field .ql-container{ min-height: 160px; }
.richtext-field .ql-editor{ min-height: 120px; }
.rating-field { display:inline-flex; align-items:center; gap:4px; line-height:1; }
.rating-field .star { cursor:pointer; font-size:20px; color:#d1d5db; transition: color .18s ease; user-select:none; }
.rating-field .star.active { color:#f59e0b; }
.rating-field .star:hover { color:#fbbf24; }
.col-actions.single .col-act{ padding:2px 8px; font-size:12px; }


/* override: allow typing richtext in demo mode */
body.demo-mode .richtext-field [contenteditable="true"]{ pointer-events:auto !important; }

/* DEMO MODE: Allow interaction inside richtext */
body.demo-mode .richtext-field, 
body.demo-mode .richtext-field * { pointer-events: auto !important; user-select: text !important; }

/* DEMO: force editability and pointer events for richtext */
body.demo-mode .richtext-field, body.demo-mode .richtext-field * { pointer-events:auto !important; user-select:text !important; }

<style>
/* SIGNATURE CELL MODAL */
.sig-modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:9999; }
.sig-card{ background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); width:min(720px, 96vw); }
.sig-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.sig-body{ display:flex; flex-direction:column; gap:10px; }
.sig-canvas{ width:100%; height:220px; border:1px solid var(--line); border-radius:10px; background:#fff; touch-action:none; }
.sig-tools{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.sig-actions{ display:flex; gap:8px; justify-content:flex-end; }

/* DEMO: allow editing inside table cell editors */
body.demo-mode .tbl .ql-container, 
body.demo-mode .tbl .ql-editor, 
body.demo-mode .tbl .ql-toolbar { pointer-events: auto !important; user-select: text !important; }

/* === Datetime composite control (date + time) === */
.datetime-wrap{display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap}
.datetime-wrap .dt-seg{display:inline-flex;flex-direction:column;gap:4px}
.datetime-wrap .dt-seg label{font-size:.78rem;opacity:.8}
.datetime-wrap input[type="date"],
.datetime-wrap input[type="time"]{padding:.45rem .6rem;border:1px solid var(--border-color, #ddd);border-radius:.6rem;outline:none}
.datetime-wrap input[type="date"]:focus,
.datetime-wrap input[type="time"]:focus{box-shadow:0 0 0 .12rem rgba(0,0,0,.06)}


/* === Data I/O FAB (form values) === */
#dataIOFab{position:fixed;left:12px;bottom:64px;z-index:99999}
#dataIOFab .btn{all:unset;display:inline-flex;align-items:center;gap:.4rem;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:.75rem;padding:.5rem .7rem;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.12)}
#dataIOFab .btn:hover{box-shadow:0 10px 24px rgba(0,0,0,.18)}
#dataIOFab .btn span{font-weight:600}
#dataIOFabMenu{position:fixed;left:12px;bottom:112px;background:#fff;border-radius:.75rem;box-shadow:0 12px 24px rgba(0,0,0,.2);min-width:200px;padding:.35rem;display:none}
#dataIOFabMenu.open{display:block}
#dataIOFabMenu button{all:unset;display:block;width:100%;padding:.55rem .7rem;border-radius:.45rem;cursor:pointer;color:#111}
#dataIOFabMenu button:hover{background:rgba(0,0,0,.06)}
@media (max-width: 480px){
  #dataIOFab{bottom:58px;left:10px}
  #dataIOFabMenu{bottom:100px}
}

</style>
<style>

body:not(.demo-mode) #siteName,
body:not(.demo-mode) .fcard label .label-editable{
  pointer-events:auto;
  user-select:text;
  -webkit-user-select:text;
  cursor:text;
}
</style>
<style>

body:not(.demo-mode) #siteName,
body:not(.demo-mode) .fcard label .label-editable{
  pointer-events: auto !important;
  user-select: text !important;
  -webkit-user-select: text !important;
  cursor: text !important;
  position: relative;
  z-index: 2;
}
</style>
<style id="inline-edit-style">

:root{
  --ie-bg: rgba(250, 204, 21, 0.18);
  --ie-border: rgba(59, 130, 246, 0.65);
  --ie-shadow: rgba(37, 99, 235, 0.25);
}

body:not(.demo-mode) .label-editable{
  display:inline-block;
  border-radius:.375rem;
  transition: background-color .15s ease, box-shadow .15s ease, outline-color .15s ease;
  cursor:text;
}
body:not(.demo-mode) .fcard:hover .label-editable{
  background:rgba(148, 163, 184, 0.10);
}
body:not(.demo-mode) .label-editable[data-inline-editing="1"],
body:not(.demo-mode) .label-editable[contenteditable="true"]:focus{
  background: var(--ie-bg);
  outline: 2px dashed var(--ie-border);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px var(--ie-shadow);
  padding: 2px 6px;
  caret-color:#111827;
  animation: ie-pop .12s ease-out;
}
body:not(.demo-mode) .preview-form label{ display:inline-block; }

@keyframes ie-pop {
  from { transform: scale(.985); opacity:.9; }
  to   { transform: scale(1);    opacity:1; }
}
</style>
<style id="opt-inline-css">
.opt-inline { margin-top: .25rem; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.opt-action { font: inherit; border: 0; background: none; cursor: pointer; padding: 0 6px; opacity:.8 }
.opt-action:hover { opacity: 1 }
.opt-action.add::before { content: "➕ "; }
.opt-action.remove { margin-left: .25rem; }
.cb-row-tools { display:inline-flex; align-items:center; gap:.25rem; margin-left:.25rem; }
</style>
<style id="opt-inline-css-visibility">

body.demo-mode .opt-inline,
body.demo-mode .cb-row-tools {
  display: none !important;
}
</style>
<style id="page-header-style">

:root{
  --ph-title: #0f172a;
  --ph-sub: #475569;
  --ph-accent: #0ea5e9;
  --ph-line: rgba(2, 6, 23, 0.08);
  --ph-bg: #f0f9ff;
  --ph-border: #0ea5e9;
}

.page-header{
  display:flex; align-items:flex-end; justify-content:space-between;
  gap:1rem; padding:1.25rem 1rem 0.75rem 1rem;

  background:transparent;
  border: 1px solid var(--ph-border);
  background: var(--ph-bg);
}
.page-header .title-wrap{ display:flex; flex-direction:column; gap:.25rem; min-width:0; }
.page-header .title-wrap .kicker{
  font-size:.75rem; letter-spacing:.08em; text-transform:uppercase; color:var(--ph-sub);
  font-weight:600;
}

.page-header .title-wrap #pageName,
.page-header .title-wrap .page-title,
.page-header .title-wrap [data-role="page-title"]{
  color:var(--ph-title);
  font-size:clamp(1.25rem, 2.4vw, 1.75rem);
  line-height:1.2;
  font-weight:700;
  margin:0;
  padding:0;

  cursor:text; user-select:text; -webkit-user-select:text;
  outline:none;
}
.page-header .title-wrap .subtitle{
  color:var(--ph-sub);
  font-size:clamp(.85rem, 1.2vw, .95rem);
  line-height:1.35;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.page-header .actions{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.page-header .actions .btn{
  display:inline-flex; align-items:center; gap:.5rem;
  height:2.25rem; padding:0 .8rem; border-radius:.5rem;
  border:1px solid var(--ph-line); background:#fff; color:#0f172a;
  font-weight:600; font-size:.9rem; text-decoration:none;
}
.page-header .actions .btn:hover{ border-color:rgba(2,6,23,.18); }
.page-header .actions .btn.ghost{ background:transparent; }
.page-header .actions .btn.primary{ border-color:transparent; background:var(--ph-accent); color:white; }
.page-header.sticky{ position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(10px); background:var(--ph-bg); }
@supports not (backdrop-filter: blur(10px)){
  .page-header.sticky{ background:#fff; }
}
.page-header.compact{ padding:.75rem 1rem; }
.page-header.compact .title-wrap [data-role="page-title"],
.page-header.compact .title-wrap #pageName,
.page-header.compact .title-wrap .page-title{ font-size:clamp(1.1rem,2vw,1.4rem); }
</style>
<style id="page-header-style-golive">

.page-header.variant-golive{

  --ph-bg: #f0fdf4;
  --ph-border: #10b981;
  --ph-title: #064e3b;
  --ph-sub: #047857;
  position: relative;
}

.page-header.variant-golive::before{
  content:""; position:absolute; left:0; top:0; bottom:0; width:4px;
  background: linear-gradient(180deg, #10b981, #34d399);
  border-top-left-radius: 8px; border-bottom-left-radius: 8px;
}

.page-header.variant-golive .actions .btn.primary{
  background:#10b981; color:white; border-color:transparent;
}
</style>
<style id="fit-sections-fullheight">

#designerCard{
  min-height: calc(100dvh - var(--nav-h));
  min-height: calc(var(--vh, 1vh) * 100 - var(--nav-h)) * 100 - var(--nav-h));
  display: flex;
  flex-direction: column;
}
#designerCard > #formHost{
  flex: 1 1 auto;
  min-height: 0;
  display: flex;
  flex-direction: column;
}

aside.sidebar{
  position: sticky;
  top: var(--nav-h);
  height: calc(100dvh - var(--nav-h));
  height: calc(var(--vh, 1vh) * 100 - var(--nav-h)) * 100 - var(--nav-h));
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}
</style>
<style id="dynamic-sizing-overrides">
:root{
  --nav-h: clamp(56px, 6vw, 72px);
  --side-w: clamp(220px, 22vw, 300px);
  --insp-w: clamp(280px, 35vw, 520px);
  --ctrl-h: clamp(38px, 5.3vw, 46px);
  --radius: clamp(10px, 1.5vw, 16px);
}
.adder-pop .panel{ width: clamp(260px, 70vw, 420px) !important; }
.fly{ min-width: 220px; max-width: min(90vw, 420px); max-height: 70vh; }
.fly .sub{ min-width: 200px; max-width: min(80vw, 380px); max-height: 60vh; }
.dtp{ width: min(96vw, 720px) !important; }
.viewer{ width: clamp(320px, 92vw, 1200px) !important; max-height: 90vh; }
.mgr{ width: clamp(360px, 92vw, 1000px) !important; max-height: 90vh; }
.upload{ width: clamp(320px, 92vw, 900px) !important; }
@media (max-width: 900px){
  #iconPreviewH[style], #iconPreviewV[style]{ width: clamp(140px, 42vw, 260px) !important; }
  .btn[style*="width:"], .input[style*="width:"], .select[style*="width:"], .textarea[style*="width:"]{ width: 100% !important; }
}
.clock-face{ width: clamp(200px, 52vw, 320px) !important; height: clamp(200px, 52vw, 320px) !important; }
.lp-preview .big{ width: clamp(64px, 10vw, 96px); height: clamp(64px, 10vw, 96px); }
.lp-item svg{ width: clamp(40px, 8vw, 64px); height: clamp(40px, 8vw, 64px); }
.hbtn{ width: clamp(30px, 4vw, 36px); height: clamp(30px, 4vw, 36px); }
aside.sidebar{ top: var(--nav-h); height: calc(100dvh - var(--nav-h)); }
aside.sidebar{ top: var(--nav-h); height: calc(100dvh - var(--nav-h)); }
.grid4{ gap: clamp(8px, 1.5vw, 14px); }
.input, .select, .textarea, .btn{ height: var(--ctrl-h); }
.layout{ grid-template-columns: var(--side-w) 1fr; }
</style>
<style id="hide-fullscreen-mobile">

@media (max-width: 768px){
  .btn-fullscreen,
  .fullscreen,
  .full-screen,
  [data-action="fullscreen"],
  [data-role="toggle-fullscreen"],
  [aria-label*="full screen" i],
  button[title*="full screen" i]{
    display: none !important;
    visibility: hidden !important;
  }
}
</style>
<style id="mobile-designer-cover-and-toggle">
@media (max-width: 768px){

  html, body{ height: calc(var(--vh, 1vh) * 100); }


  #designerCard, .content, .content-area, .main-content{
    position: fixed;
    left: 0; right: 0;
    top: var(--nav-h, 56px);
    height: calc(var(--vh, 1vh) * 100 - var(--nav-h, 56px));
    min-height: calc(var(--vh, 1vh) * 100 - var(--nav-h, 56px));
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 !important;
    padding-top: 0 !important;
    z-index: 50;
  }


  .page-header, .topbar{ position: sticky; top: 0; z-index: 90; }


  .menu-btn, .nav-toggle, .side-toggle{
    position: relative;
    z-index: 120;
  }


  aside.sidebar{
    z-index: 110;
  }
}
</style>
<style id="mobile-nav-visibility-fix">
@media (max-width: 768px){

  .hribbon, .hnav{
    display: block !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    white-space: nowrap !important;
    -webkit-overflow-scrolling: touch;
    height: auto !important;
    margin: 0 !important;
    padding: 6px 8px !important;
    border: 0 !important;
    box-shadow: none !important;
    z-index: 95;
    background: #fff;
  }


  .page-header{
    height: auto !important;
    overflow: visible !important;
    margin: 0 !important;
    padding: 8px 12px !important;
    border: 0 !important;
    position: sticky;
    top: 0;
    z-index: 96;
    background: #fff;
  }


  .page-header .actions{ display:flex !important; flex-wrap:wrap; gap:8px; }
  .page-header .actions .btn{ display:inline-flex; }


  #designerCard, .content, .content-area, .main-content{
    top: var(--nav-h, 56px) !important;
  }
}
</style>
<style id="tabs-overflow-css">

.tabs-wrap{
  position: sticky; top: 0; z-index: 96; background:#fff; display:grid;
  grid-template-columns: 16px 1fr auto 16px; align-items:center; gap:8px;
  padding: 6px 0; border-bottom: 1px solid rgba(2,6,23,.08);
}
.tabs{
  display:flex; overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x proximity;
  gap: 6px; padding: 0 4px; scrollbar-width: thin;
}
.tab{
  flex:0 0 auto; scroll-snap-align: start;
  height: 40px; padding: 0 12px; border-radius: 10px;
  border:1px solid rgba(2,6,23,.12); background:#fff; font-weight:600;
}
.tab[aria-selected="true"]{ border-color:#0ea5e9; box-shadow:0 0 0 2px rgba(14,165,233,.2) inset; }
.tabs-more{ height:36px; padding:0 10px; border-radius:8px; border:1px solid rgba(2,6,23,.12); background:#fff; }
.tabs-edge{ height: 100%; pointer-events:none; opacity:0; transition:opacity .15s; }
.tabs-edge.left{ background: linear-gradient(to right, rgba(255,255,255,1), rgba(255,255,255,0)); }
.tabs-edge.right{ background: linear-gradient(to left, rgba(255,255,255,1), rgba(255,255,255,0)); }

@media (max-width:768px){
  .tabs{ gap: 4px; }
  .tab{ height: 38px; padding: 0 10px; }
}
</style>
<style id="hide-manage-logo-css">

#manageLogo,
.manage-logo,
.button-manage-logo,
[data-role="manage-logo"],
[aria-label="Manage Logo"]{
  display: none !important;
  visibility: hidden !important;
}
</style>
<style id="add-nav-icon-only-css">

.sr-only{
  position:absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
.nav-icon{
  display:inline-block; vertical-align:middle;
  width: 20px; height: 20px;
  background-repeat:no-repeat; background-size:contain; background-position:center;
}
.nav-icon.add-icon{
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%230f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>');
}
.tabs .tab.icon-only{
  padding: 0 10px;
  display:inline-flex; align-items:center; justify-content:center;
  width: 40px; min-width:40px;
}
aside.sidebar .icon-only{
  display:flex; align-items:center; gap:8px;
  min-height: 36px;
}
</style>
<style id="lock-sidebar-scroll-on-add-css">

aside.sidebar.lock-scroll{
  overflow: hidden !important;
  overscroll-behavior: contain;
  touch-action: none;
}
</style>
<style id="space-span-controls-css">
  .fcard.space-card{border:1px solid var(--line); min-height:48px; padding: 8px; position:relative; background:#fff;}
  .fcard.space-card .space-label{font-size: 10px; color:#64748b; text-transform: uppercase; letter-spacing:.08em;}
  .icons .span-btn{font-weight:700; line-height:1; padding:4px 6px; border-radius:999px; border:1px solid var(--line); background:#fff; min-width: 28px;}
</style>
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
<style id="signature-field-css">
.signature-field{ display:flex; flex-direction:column; gap:8px; width:100%; }
.signature-pad{ position:relative; border:1px solid var(--line); background:#fff; border-radius:12px; box-shadow:var(--shadow); padding:8px; }
.signature-canvas{ display:block; width:100%; height:220px; border-radius:8px; background:#ffffff; touch-action:none; }
.signature-tools{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.signature-tools .btn{ padding:6px 10px; height:auto; }
.signature-tools .hint{ font-size:12px; color:#64748b; }
</style>
<style id="row12-css">

.row12{ border:1px dashed var(--line); border-radius:12px; padding:10px; background: var(--surface); }
.row12-head{ display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.row12-title{ font-weight:700; font-size:14px; color:#0f172a; }
.row12-grid{ display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:12px; min-height:60px; }
.col12{ position:relative; display:flex; flex-direction:column; gap:6px; background:#fff; border-radius:12px; padding:8px; min-height:56px }
.col12 .col12-head{ display:flex; align-items:center; justify-content:space-between; gap:6px; color:#475569; font-size:12px }
.col12 .chip{ padding:2px 6px; border-radius:999px; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; }
.col12 .icon-btn.warn{ border-color:#fecaca; background:#fff5f5; color:#b91c1c }
.col12 .fields{ display:flex; flex-direction:column; gap:6px }
.col12 .empty{ display:grid; place-items:center; color:#94a3b8; border:1px dashed var(--line); border-radius:10px; min-height:48px; background:#fafafa }
.col12.droptarget{ outline:2px dashed #93c5fd; outline-offset:2px }
</style>
<style id="row12-demo-css">

body.demo-mode .row12-tools { display:none !important; }
body.demo-mode .col12 [data-act] { display:none !important; }
body.demo-mode .col12 { outline: none !important; }
</style>
<style id="row12-hide-labels">

.row12 .row12-title { display:none !important; }
.col12 .col12-head > div:first-child { display:none !important; }

.col12 .col12-head { justify-content: flex-end; }
</style>
<style id="col-actions-style">

.col-actions{
  display:inline-flex;
  align-items:center;
  gap:1px;
  background:#fff;
  border:1px solid var(--line);
  border-radius:999px;
  padding:1px;
  box-shadow: var(--shadow);
}
.col-act{
  border:0;
  background:transparent;
  border-radius:999px;
  padding:2px 6px;
  display:inline-flex;
  align-items:center;
  gap:4px;
  cursor:pointer;
  line-height:1;
  font-weight:600;
  font-size:12px;
}
.col-act:hover{ background:#f8fafc; }
.col-act:focus-visible{ outline:2px solid var(--ring); outline-offset:0; }
.col-act.primary{ color:#1d4ed8; }
.col-act.danger{ color:#b91c1c; }
.col-act .ico{ font-size:12px; }
.col-act .lab{ display:none; font-size:12px; }
@media (min-width: 900px){
  .col-act .lab{ display:inline; }
}

.col-row .col-actions{ margin-left:auto; }
.drag-handle-wrap{ position:absolute; top:4px; right:4px; z-index:99; pointer-events:auto; }
.drag-btn{
  padding:2px 6px;
  border:1px solid var(--line);
  border-radius:8px;
  background:#fff;
  line-height:1;
  font-size:12px;
  cursor:grab;
  box-shadow:var(--shadow);
  opacity:.95;
}
.drag-btn:active{ cursor:grabbing; }
@media (max-width: 640px){
  .drag-handle-wrap{ top:2px; right:2px; }
  .drag-btn{ padding:2px 5px; font-size:11px; }
}
.icon-btn.drag-btn{ margin-left:4px; }
</style>
<style>

.mode-switch{ display:inline-flex; align-items:center; gap:2px; border:1px solid var(--line, #e5e7eb); background:#fff; border-radius:999px; padding:2px; height:28px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
.mode-switch > button{ border:0; background:transparent; padding:4px 8px; border-radius:999px; font-size:12px; line-height:1; cursor:pointer; }
.mode-switch > button.active,[aria-selected="true"]{ background:#edf2ff; color:#1d4ed8; font-weight:600; }
@media (max-width:768px){
  .mode-switch{ height:28px; padding:2px; }
  .mode-switch > button{ padding:4px 8px; font-size:12px; }
}
</style>
<style id="hide-top-hnav-on-mobile">

  @media (max-width:768px){
    .hribbon, .hnav, .tabs-wrap {
      display: none !important;
      visibility: hidden !important;
    }
  }
</style>
<style id="addnav-mode-toggle-css">
  .addnav-mode-toggle{display:flex;align-items:center;gap:.5rem;margin:.5rem 0 1rem;}
  .addnav-mode-toggle .lbl{font-size:.9rem;opacity:.8;white-space:nowrap;}
  .addnav-mode-toggle .switch{position:relative;display:inline-block;width:56px;height:28px;}
  .addnav-mode-toggle .switch input{opacity:0;width:0;height:0;}
  .addnav-mode-toggle .slider{position:absolute;cursor:pointer;inset:0;border-radius:999px;background:#ddd;transition:.2s;}
  .addnav-mode-toggle .slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
  .addnav-mode-toggle input:checked + .slider{background:#9cc;}
  .addnav-mode-toggle input:checked + .slider:before{transform:translateX(28px);}
  .addnav-mode-toggle .opt{font-size:.9rem;opacity:.9;min-width:72px;text-align:center;}
</style>
<style>

.designer-form .is-invalid{outline:2px solid #e00; box-shadow:0 0 0 3px rgba(255,0,0,.12); border-radius:6px}
.designer-form .error-msg{margin-top:4px; font-size:12px; line-height:1.4; color:#b00020}
.validation-summary{position:sticky; top:0; z-index:10; background:#fff5f5; border:1px solid #ffc9c9; padding:10px 12px; margin:0 0 12px 0; border-radius:10px}
.validation-summary .summary-title{font-weight:600; margin-bottom:6px}
.validation-summary ul{margin:0; padding-left:18px}
.validation-summary a{text-decoration:underline; cursor:pointer}
</style>
<style id="sig-modal-css">
/* Signature Modal (top-layer) */
.sig-modal, dialog.sig-modal { 
  position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,.45); z-index: 2147483647; isolation: isolate;
}
dialog.sig-modal { border: none; padding: 0; background: transparent; }
dialog.sig-modal::backdrop { background: rgba(0,0,0,.45); }
.sig-card{ background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);
  width:min(760px, 96vw); max-height: 92vh; display:flex; flex-direction:column; gap:10px; }
.sig-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.sig-body{ display:flex; flex-direction:column; gap:10px; }
.sig-canvas{ width:100%; height:240px; border:1px solid var(--line, #e5e7eb); border-radius:10px; background:#fff; touch-action:none; }
.sig-tools{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.sig-actions{ display:flex; gap:8px; justify-content:flex-end; }
.btn{ border:1px solid #e5e7eb; border-radius:10px; padding:8px 12px; cursor:pointer; background:#111827; color:#fff; }
.btn.ghost{ background:#fff; color:#111827; }
</style>
<style>
/* Mobile tweak: prevent iOS zoom-on-focus & keep layout stable while typing */
@media (max-width: 480px){
  input, textarea, select { font-size: 16px; }
}
</style>
<style>
/* Disable transitions on inputs while typing to avoid flicker */
html.typing input, html.typing textarea, html.typing [contenteditable="true"] { transition: none !important; }
</style>
<style id="rtx-demo-mode-fixes">
/* Demo-mode RichText fixes: allow full interaction & avoid clipping */
body.demo-mode .richtext-field,
body.demo-mode .richtext-field * {
  pointer-events: auto !important;
  user-select: text !important;
}
/* Prevent pickers from being clipped by card/field containers */
body.demo-mode .richtext-field,
body.demo-mode .richtext-field .ql-toolbar,
body.demo-mode .fcard,
body.demo-mode .field-body {
  overflow: visible !important;
}
/* Make sure pickers/tooltips render above */
body.demo-mode .richtext-field .ql-picker-options,
body.demo-mode .richtext-field .ql-tooltip {
  z-index: 999 !important;
}
</style>
<style id="empty-hint-demo-fix">
/* Show the empty drop hint only in Edit mode (hide in Demo) */
body.demo-mode .fields .empty { display: none !important; }
/* Force white background for the hint */
.fields .empty { background: #fff !important; }
</style>
<style id="cp-hide-name">
  .cp-name { display: none !important; }
  .cp-prof-wrap { gap: 6px; } /* tighten spacing a bit */
</style>
<style id="mobile-hide-user-role-avatar">
/* Mobile (≤640px): hide User select, Role select, and Profile avatar */
@media (max-width: 640px){
  /* Switchers container (User & Role) */
  #cbSwitchWrap,
  #cbUserSelect,
  #cbRoleSelect,
  /* Profile avatar/name wrapper */
  #cpProfWrap {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }
}
</style>
<body>
<nav class="topbar">
<div class="inner">
<div class="brand">
<div aria-label="Change logo" class="logo" id="logoBox" role="button" tabindex="0" title="Click to change logo"></div>
<div class="brand-name" contenteditable="true" id="siteName" spellcheck="false" title="Click to edit">
          Website Name
        </div>
<button aria-label="Open logo picker" class="btn soft" id="logoBtn" style="height:34px;padding:6px 10px">Manage Logo</button>
</div>
<button class="menu-btn" id="toggleSideBtn">☰ Menu</button>
<div class="hwrap" style="flex:1;min-width:0">
<button class="hbtn" hidden="" id="hPrev" title="Scroll left">‹</button>
<div aria-label="Features" class="hribbon" id="hRibbon" role="menubar"></div>
<button class="hbtn" hidden="" id="hNext" title="Scroll right">›</button>
<div class="adder-pop" id="hAdder">
<button aria-expanded="false" aria-haspopup="true" type="button">＋ Add</button>
<div class="panel">
<header>
<!-- === Schema IO Early Capture (preempts global blockers) === -->
<script id="schema-io-early-capture">
(function(){
  if(window.__schemaIOEarlyCap) return; window.__schemaIOEarlyCap = true;

  function _run(action){
    try{
      if(action === 'export'){
        if(window.__schemaIOCore && window.__schemaIOCore.exportCurrent){
          window.__schemaIOCore.exportCurrent();
        }
      }else if(action === 'import'){
        if(window.__schemaIOCore && window.__schemaIOCore.importCurrent){
          window.__schemaIOCore.importCurrent();
        }
      }
    }catch(e){ try{ if(window.toast) toast('Schema action error'); }catch(_){} }
  }

  function handler(e){
    // If clicking our menu items, run before anything else
    const t = e.target;
    if(!t) return;
    const exp = t.closest && t.closest('#schemaIOFabExport');
    const imp = t.closest && t.closest('#schemaIOFabImport');
    if(exp || imp){
      e.stopImmediatePropagation();
      e.stopPropagation();
      e.preventDefault();
      _run(exp ? 'export' : 'import');
      return false;
    }
  }

  // Capture very early at window + document
  try{
    window.addEventListener('click', handler, true);
    document.addEventListener('click', handler, true);
  }catch(_){}
})();
</script>
New horizontal item<button aria-label="Edit page title" class="btn ghost page-edit-btn" id="pageEditBtn" title="Edit page title">✎ Edit</button></header>
<div class="row">
<input class="input" id="navNameH" placeholder="Item name…" style="flex:1"/>
<input class="input" id="iconPreviewH" placeholder="Icon (emoji or text)" style="width:160px"/>
</div>
<div class="row">
<select class="select" id="navParentH" style="flex:1"></select>
<div class="micro"><span class="dot"></span>Up to 3 levels</div>
</div>
<div class="footer">
<button class="btn ghost" id="cancelNavH">Cancel</button>
<button class="btn primary" id="addNavBtnH">Add</button>
</div>
</div>
</div>
</div>
<div class="mode-switch" id="modeSwitch">
<button aria-selected="true" class="active" id="modeEdit">Edit</button>
<button aria-selected="false" id="modeDemo">Demo</button>
<button aria-label="Open application view in a new tab" class="btn sm force-label" id="openAppBtn" title="Open application view in a new tab" type="button"><span aria-hidden="true" class="icon">↗</span><span class="label">Launch</span></button></div>
<div class="mode-hint">Shift+D</div>
</div>
</nav>
<div class="layout">
<aside class="sidebar">
<ul class="vnav" id="vNav"></ul>
<div class="adder-pop" id="vAdder" style="margin-top:10px">
<button type="button">＋ Add vertical item</button>
<div class="panel">
<header>New vertical item</header>
<div class="row">
<input class="input" id="navNameV" placeholder="Item name…" style="flex:1"/>
<input class="input" id="iconPreviewV" placeholder="Icon (emoji or text)" style="width:160px"/>
</div>
<div class="row">
<select class="select" id="navParentV" style="flex:1"></select>
<div class="micro"><span class="dot"></span>Up to 3 levels</div>
</div>
<div class="footer">
<button class="btn ghost" id="cancelNavV">Cancel</button>
<button class="btn primary" id="addNavBtnV">Add</button>
</div>
</div>
</div>
<div class="side-title" style="margin-top:14px">Admin</div>
<ul class="vnav">
<li class="vitem"><button class="vbtn"><span class="ico">⚙️</span> Settings</button></li>
<li class="vitem"><button class="vbtn" data-cb-nav="roles-permissions" id="navRolesPermissions"><span class="ico">🔒</span>  Roles &amp; Permissions</button></li>
</ul>
</aside>
<main class="content">
<section class="card" id="designerCard">
<header class="page-head" id="pageHeader"><span class="page-ico-trigger" id="pageIconWrap"><span class="page-ico" id="pageIcon"></span><span class="caret">▾</span></span><div class="page-ico-pop" id="pageIconPop"></div><span class="label-editable" contenteditable="true" id="pageName" title="Click to rename">FORM_NAME</span></header>
<div class="sep"></div>
<div id="formHost"></div>
<div class="inline" id="formActions" style="margin-top:12px;gap:10px">
</div>
</section>
</main>
</div>
<aside aria-label="Inspector" class="inspector" id="inspector">
<div class="insp-head"><span id="inspTitle">Inspector</span><button class="insp-btn" id="inspClose">✖</button></div>
<div class="insp-tabs" id="inspTabs"></div>
<div class="insp-body" id="inspBody"></div>
<div class="insp-actions">
<button class="insp-btn" id="inspUp">↑ Up</button>
<button class="insp-btn" id="inspDown">↓ Down</button>
<button class="insp-btn" id="inspDup">⧉ Duplicate</button>
<button class="insp-btn" id="inspDel" style="color:#b91c1c;border-color:#fecaca">🗑️ Delete</button>
<button class="insp-btn primary" id="inspDone">Done</button>
</div>
</aside>
<div aria-hidden="true" class="fly-root" id="flyRoot"></div>
<div aria-labelledby="lpTitle" aria-modal="true" class="logo-picker" id="logoPicker" role="dialog">
<div class="lp-panel">
<div class="lp-head"><span id="lpTitle">Choose a logo</span><button class="insp-btn" id="lpClose">✖</button></div>
<div class="lp-body">
<div class="lp-preview">
<div class="big" id="lpBig"></div>
<div class="inline"><span class="hint">Live preview</span></div>
<div class="sep"></div>
<div class="inline"><span class="chip">Tip</span><span class="hint">“Auto Initials” uses the current Website Name.</span></div>
</div>
<div>
<div class="inline" style="margin-bottom:8px">
<input class="input" id="lpSearch" placeholder="Search logos…" style="flex:1"/>
<button class="btn soft" id="lpAuto">Auto Initials</button>
<button class="btn ghost" id="lpReset">Minimal Gradient</button>
</div>
<div class="lp-grid" id="lpGrid"></div>
</div>
</div>
<div class="lp-foot">
<button class="btn primary" id="lpUse">Use selected</button>
</div>
</div>
</div>
<div aria-hidden="true" class="dtp-root" id="dtpRoot"></div>
<div aria-live="polite" class="toast" id="appToast" role="status"></div>
<script>
/* ================= MODE ================= */
let demoMode=false; const modeEditBtn=document.getElementById('modeEdit'), modeDemoBtn=document.getElementById('modeDemo');
function applyMode(){
  document.body.classList.toggle('demo-mode', demoMode);
  modeEditBtn.classList.toggle('active', !demoMode);
  modeDemoBtn.classList.toggle('active', demoMode);
  const siteNameEl=document.getElementById('siteName');
  siteNameEl.setAttribute('contenteditable', demoMode ? 'false' : 'true');
  siteNameEl.title = demoMode ? 'Demo mode: editing disabled' : 'Click to edit';
  var _pg=document.getElementById('pageName'); if(_pg){ _pg.setAttribute('contenteditable', demoMode ? 'false' : 'true'); }
  localStorage.setItem('hrsuite_demo', demoMode?'1':'0');
  if(demoMode) closeInspector();
  renderDebounced();
}
modeEditBtn.onclick=()=>{ demoMode=false; applyMode(); };
modeDemoBtn.onclick=()=>{ demoMode=true; applyMode(); };
document.addEventListener('keydown',e=>{ if(e.shiftKey && e.key.toLowerCase()==='d'){ demoMode=!demoMode; applyMode(); }});
(function(){
  // Force EDIT mode on reload
  demoMode = false;
  try { localStorage.setItem('hrsuite_demo','0'); } catch(_){}
  applyMode();
})();

/* ================= HELPERS ================= */
const $=(s,d=document)=>d.querySelector(s), $$=(s,d=document)=>Array.from(d.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,10);
function toast(msg){ const t=$('#appToast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

/* ================= SITE NAME + LOGO + FAVICON ================= */
const siteNameEl=$('#siteName'), logoBox=$('#logoBox');
function getInitials(name){ return (name||'').split(/\s+/).filter(Boolean).slice(0,2).map(w=>w[0]).join('').toUpperCase() || 'WN'; }
function svgAutoInitials(name){
  const initials=getInitials(name);
  return `
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs><linearGradient id="g" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#2563eb"/><stop offset="1" stop-color="#7c3aed"/></linearGradient></defs>
      <rect x="2" y="2" width="60" height="60" rx="14" fill="url(#g)"/>
      <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="26" font-weight="800" fill="#fff" font-family="ui-sans-serif,system-ui,Segoe UI,Roboto">${initials}</text>
    </svg>`;
}
function renderAutoInitials(){ logoBox.innerHTML = svgAutoInitials(siteNameEl.textContent.trim()); updateFaviconFromLogo(); }
function saveBrand(){ localStorage.setItem('site_name', siteNameEl.textContent.trim()); localStorage.setItem('site_logo_html', logoBox.innerHTML); document.title = siteNameEl.textContent.trim()+' · Designer'; }
function loadBrand(){
  const n=localStorage.getItem('site_name'); if(n){ siteNameEl.textContent=n; document.title=n+' · Designer'; }
  const h=localStorage.getItem('site_logo_html'); if(h){ logoBox.innerHTML=h; } else { renderAutoInitials(); }
  updateFaviconFromLogo();
}
function updateFaviconFromLogo(){
  const svg = logoBox.innerHTML || svgAutoInitials(siteNameEl.textContent.trim());
  const encoded = 'data:image/svg+xml,' + encodeURIComponent(svg.replace(/\n+/g,''));
  const link = document.getElementById('dynamic-favicon');
  link.setAttribute('href', encoded);
}
siteNameEl.addEventListener('input', ()=>{ if(demoMode) return; renderAutoInitials(); saveBrand(); });
siteNameEl.addEventListener('blur', ()=>{ if(demoMode) return; saveBrand(); });

/* ================= Logo picker ================= */
const logoPicker=$('#logoPicker'), lpGrid=$('#lpGrid'), lpClose=$('#lpClose'), lpAuto=$('#lpAuto'), lpReset=$('#lpReset'), lpBig=$('#lpBig'), lpSearch=$('#lpSearch'), lpUse=$('#lpUse');
let lpSelectedIndex=0;
const GENERIC_LOGOS = [
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g1" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#2563eb"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs><rect rx="14" x="4" y="4" width="56" height="56" fill="#0ea5e9" opacity=".08"/><path d="M8 40 Q22 18 34 28 T56 28 L56 56 H8 Z" fill="url(#g1)"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g2" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#7c3aed"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="14" fill="#7c3aed" opacity=".06"/><g fill="url(#g2)"><circle cx="16" cy="32" r="6"/><circle cx="32" cy="16" r="6"/><circle cx="32" cy="48" r="6"/><circle cx="48" cy="32" r="6"/></g></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g3" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#22c55e"/><stop offset="1" stop-color="#16a34a"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="14" fill="#16a34a" opacity=".08"/><path d="M14 38c10 2 26-10 36-24 2 20-12 34-26 36-4-2-8-6-10-12z" fill="url(#g3)"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g4" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#f59e0b"/><stop offset="1" stop-color="#ef4444"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="14" fill="#f59e0b" opacity=".09"/><path d="M32 10l16 10v24L32 54 16 44V20z" fill="url(#g4)"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g5" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#06b6d4"/><stop offset="1" stop-color="#3b82f6"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="14" fill="#3b82f6" opacity=".06"/><circle cx="32" cy="32" r="10" fill="url(#g5)"/><ellipse cx="32" cy="32" rx="22" ry="10" fill="none" stroke="#60a5fa" stroke-width="3"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g6" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#10b981"/><stop offset="1" stop-color="#34d399"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="14" fill="#10b981" opacity=".07"/><path d="M14 46 L26 22 L38 40 L50 18 L54 46 Z" fill="url(#g6)"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g7" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#06b6d4"/><stop offset="1" stop-color="#7c3aed"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="14" fill="#0ea5e9" opacity=".08"/><g fill="url(#g7)"><rect x="14" y="14" width="36" height="8" rx="3"/><rect x="14" y="28" width="36" height="8" rx="3"/><rect x="14" y="42" width="36" height="8" rx="3"/></g></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g8" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#ef4444"/><stop offset="1" stop-color="#f97316"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="14" fill="#ef4444" opacity=".07"/><polyline points="10,34 22,34 28,20 36,48 42,30 54,30" fill="none" stroke="url(#g8)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g9" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#3b82f6"/><stop offset="1" stop-color="#22c55e"/></linearGradient></defs><rect x="6" y="6" width="52" height="52" rx="14" fill="#eef2ff"/><path d="M18 44 L32 18 L46 44 Z" fill="url(#g9)"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g10" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#f43f5e"/><stop offset="1" stop-color="#6366f1"/></linearGradient></defs><rect x="6" y="6" width="52" height="52" rx="14" fill="#fff7ed"/><circle cx="32" cy="32" r="16" fill="url(#g10)"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g11" x1="1" y="0" x2="0" y="1"><stop offset="0" stop-color="#06b6d4"/><stop offset="1" stop-color="#0ea5e9"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="16" fill="#ecfeff"/><path d="M16 40 C24 28, 40 28, 48 40" stroke="url(#g11)" stroke-width="8" fill="none" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g12" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#a78bfa"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs><rect x="5" y="5" width="54" height="54" rx="16" fill="#f5f3ff"/><rect x="18" y="18" width="28" height="28" rx="6" fill="url(#g12)"/></svg>`
,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gAtom' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#06b6d4'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<circle cx='32' cy='32' r='5' fill='#0ea5e9'/>
<ellipse cx='32' cy='32' rx='22' ry='12' fill='none' stroke='url(#gAtom)' stroke-width='4'/>
<ellipse cx='32' cy='32' rx='12' ry='22' fill='none' stroke='url(#gAtom)' stroke-width='4' transform='rotate(45 32 32)'/>
<ellipse cx='32' cy='32' rx='12' ry='22' fill='none' stroke='url(#gAtom)' stroke-width='4' transform='rotate(-45 32 32)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCube' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#3b82f6'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<path d='M32 8 L52 18 L32 28 L12 18 Z' fill='url(#gCube)'/>
<path d='M12 18 L32 28 L32 48 L12 38 Z' fill='#1d4ed8' opacity='.9'/>
<path d='M52 18 L32 28 L32 48 L52 38 Z' fill='#38bdf8' opacity='.9'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gShield' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22c55e'/><stop offset='1' stop-color='#16a34a'/></linearGradient></defs>
<path d='M32 8 L52 14 V30 C52 42 43 52 32 56 C21 52 12 42 12 30 V14 Z' fill='url(#gShield)'/>
<path d='M22 28 L30 36 L44 22' fill='none' stroke='white' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gFlame' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#f59e0b'/><stop offset='1' stop-color='#ef4444'/></linearGradient></defs>
<path d='M34 10 C42 20 40 26 46 32 C52 38 52 56 32 56 C14 56 12 40 20 30 C26 22 24 18 28 14 C30 12 32 11 34 10 Z' fill='url(#gFlame)'/>
<circle cx='32' cy='40' r='8' fill='white' opacity='.15'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gWave' x1='0' y1='0' x2='1' y2='0'>
<stop offset='0' stop-color='#06b6d4'/><stop offset='1' stop-color='#3b82f6'/></linearGradient></defs>
<path d='M8 40 Q16 32 24 36 T40 36 T56 32 L56 56 H8 Z' fill='url(#gWave)'/>
<path d='M8 30 Q16 22 24 26 T40 26 T56 22' fill='none' stroke='url(#gWave)' stroke-width='4' stroke-linecap='round'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gGear' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#64748b'/><stop offset='1' stop-color='#0ea5e9'/></linearGradient></defs>
<g fill='url(#gGear)'>
<path d='M28 8 h8 l2 8 7 3 6-5 6 6-5 6 3 7 8 2v8l-8 2-3 7 5 6-6 6-6-5-7 3-2 8h-8l-2-8-7-3-6 5-6-6 5-6-3-7-8-2v-8l8-2 3-7-5-6 6-6 6 5 7-3z' opacity='.9'/>
<circle cx='32' cy='32' r='12' fill='white' opacity='.2'/>
<circle cx='32' cy='32' r='8'/>
</g></svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gLeaf' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22c55e'/><stop offset='1' stop-color='#10b981'/></linearGradient></defs>
<path d='M12 44 C16 20 36 12 52 12 C48 36 28 44 12 44 Z' fill='url(#gLeaf)'/>
<path d='M12 44 Q30 32 52 12' stroke='white' stroke-width='3' fill='none' opacity='.5'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCloud' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#93c5fd'/><stop offset='1' stop-color='#3b82f6'/></linearGradient></defs>
<path d='M20 48 H48 C56 48 58 36 48 36 C48 24 30 22 28 32 C18 30 10 38 14 44 C16 47 18 48 20 48 Z' fill='url(#gCloud)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gGlobe' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#06b6d4'/><stop offset='1' stop-color='#22c55e'/></linearGradient></defs>
<circle cx='32' cy='32' r='22' fill='url(#gGlobe)'/>
<path d='M10 32 H54 M32 10 V54' stroke='white' stroke-width='3' opacity='.5'/>
<ellipse cx='32' cy='32' rx='16' ry='22' fill='none' stroke='white' stroke-width='3' opacity='.5'/>
<ellipse cx='32' cy='32' rx='22' ry='10' fill='none' stroke='white' stroke-width='3' opacity='.5'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gChart' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22d3ee'/><stop offset='1' stop-color='#1d4ed8'/></linearGradient></defs>
<path d='M10 50 H54' stroke='#cbd5e1' stroke-width='2'/>
<rect x='14' y='34' width='8' height='16' rx='2' fill='url(#gChart)'/>
<rect x='28' y='26' width='8' height='24' rx='2' fill='url(#gChart)' opacity='.8'/>
<rect x='42' y='18' width='8' height='32' rx='2' fill='url(#gChart)' opacity='.6'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gStack' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#7c3aed'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<path d='M12 22 L32 12 L52 22 L32 32 Z' fill='url(#gStack)'/>
<path d='M12 32 L32 22 L52 32 L32 42 Z' fill='url(#gStack)' opacity='.8'/>
<path d='M12 42 L32 32 L52 42 L32 52 Z' fill='url(#gStack)' opacity='.6'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gTarget' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#ef4444'/><stop offset='1' stop-color='#f59e0b'/></linearGradient></defs>
<circle cx='32' cy='32' r='22' fill='none' stroke='url(#gTarget)' stroke-width='6'/>
<circle cx='32' cy='32' r='12' fill='none' stroke='url(#gTarget)' stroke-width='6' opacity='.6'/>
<circle cx='32' cy='32' r='4' fill='url(#gTarget)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gBolt' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#fde047'/><stop offset='1' stop-color='#f59e0b'/></linearGradient></defs>
<path d='M36 6 L14 36 H30 L26 58 L50 28 H34 Z' fill='url(#gBolt)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gInf' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#06b6d4'/><stop offset='1' stop-color='#8b5cf6'/></linearGradient></defs>
<path d='M14 34 C18 24 30 24 34 34 C38 44 50 44 54 34 C50 24 38 24 34 34 C30 44 18 44 14 34 Z'
fill='none' stroke='url(#gInf)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gHex' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#22c55e'/></linearGradient></defs>
<path d='M32 8 L52 20 V44 L32 56 L12 44 V20 Z' fill='url(#gHex)'/>
<path d='M22 24 L42 24 L42 40 L22 40 Z' fill='white' opacity='.15'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gKnot' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#9333ea'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<path d='M18 28 C22 20 34 20 34 28 C34 36 22 36 18 28 Z' fill='none' stroke='url(#gKnot)' stroke-width='6' stroke-linecap='round'/>
<path d='M46 36 C42 44 30 44 30 36 C30 28 42 28 46 36 Z' fill='none' stroke='url(#gKnot)' stroke-width='6' stroke-linecap='round'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gRocket' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#3b82f6'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<path d='M36 8 C44 10 54 20 56 28 C44 28 36 36 36 48 C28 46 18 36 16 28 C28 28 36 20 36 8 Z' fill='url(#gRocket)'/>
<circle cx='42' cy='22' r='4' fill='white' opacity='.8'/>
<path d='M12 52 L20 44 L22 52 L14 54 Z' fill='#f59e0b'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gSpiral' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22d3ee'/><stop offset='1' stop-color='#8b5cf6'/></linearGradient></defs>
<path d='M48 32 A16 16 0 1 1 32 16 A8 8 0 1 0 40 24' fill='none' stroke='url(#gSpiral)' stroke-width='6' stroke-linecap='round'/>
</svg>`
,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCandle' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#10b981'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<path d='M16 14 V50' stroke='#94a3b8' stroke-width='2'/>
<rect x='12' y='20' width='8' height='16' rx='2' fill='url(#gCandle)'/>
<path d='M32 10 V54' stroke='#94a3b8' stroke-width='2'/>
<rect x='28' y='26' width='8' height='20' rx='2' fill='#ef4444'/>
<path d='M48 18 V52' stroke='#94a3b8' stroke-width='2'/>
<rect x='44' y='24' width='8' height='18' rx='2' fill='url(#gCandle)' opacity='.8'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gBank' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#334155'/><stop offset='1' stop-color='#0ea5e9'/></linearGradient></defs>
<path d='M10 22 L32 10 L54 22 Z' fill='url(#gBank)'/>
<rect x='12' y='22' width='40' height='4' fill='#94a3b8' opacity='.6'/>
<rect x='16' y='26' width='6' height='22' rx='2' fill='url(#gBank)'/>
<rect x='29' y='26' width='6' height='22' rx='2' fill='url(#gBank)' opacity='.9'/>
<rect x='42' y='26' width='6' height='22' rx='2' fill='url(#gBank)'/>
<rect x='12' y='48' width='40' height='4' fill='#94a3b8' opacity='.8'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCard' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#1d4ed8'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<rect x='10' y='18' width='44' height='28' rx='6' fill='url(#gCard)'/>
<rect x='10' y='24' width='44' height='6' fill='white' opacity='.2'/>
<rect x='16' y='36' width='10' height='4' rx='2' fill='white' opacity='.6'/>
<rect x='30' y='36' width='8' height='4' rx='2' fill='white' opacity='.4'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gLock2' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#6366f1'/></linearGradient></defs>
<rect x='14' y='28' width='36' height='24' rx='6' fill='url(#gLock2)'/>
<path d='M22 28 C22 18 42 18 42 28 V28' fill='none' stroke='#94a3b8' stroke-width='4'/>
<circle cx='32' cy='40' r='4' fill='white' opacity='.8'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gApi' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22d3ee'/><stop offset='1' stop-color='#0ea5e9'/></linearGradient></defs>
<path d='M14 24 L22 32 L14 40' stroke='url(#gApi)' stroke-width='4' fill='none' stroke-linecap='round' stroke-linejoin='round'/>
<path d='M50 24 L42 32 L50 40' stroke='url(#gApi)' stroke-width='4' fill='none' stroke-linecap='round' stroke-linejoin='round'/>
<circle cx='32' cy='32' r='6' fill='none' stroke='#94a3b8' stroke-width='3'/>
<circle cx='32' cy='32' r='2' fill='#94a3b8'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gHook' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#06b6d4'/><stop offset='1' stop-color='#22c55e'/></linearGradient></defs>
<path d='M24 22 A10 10 0 1 1 14 32' fill='none' stroke='url(#gHook)' stroke-width='4'/>
<path d='M40 42 A10 10 0 1 1 50 32' fill='none' stroke='url(#gHook)' stroke-width='4'/>
<circle cx='32' cy='32' r='5' fill='url(#gHook)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gDB' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#64748b'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<ellipse cx='32' cy='16' rx='18' ry='8' fill='url(#gDB)'/>
<rect x='14' y='16' width='36' height='24' fill='url(#gDB)' opacity='.85'/>
<ellipse cx='32' cy='40' rx='18' ry='8' fill='url(#gDB)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gRack' x1='0' y='0' x2='1' y2='1'>
<stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#6366f1'/></linearGradient></defs>
<rect x='14' y='14' width='36' height='12' rx='4' fill='url(#gRack)'/>
<rect x='14' y='26' width='36' height='12' rx='4' fill='url(#gRack)' opacity='.85'/>
<rect x='14' y='38' width='36' height='12' rx='4' fill='url(#gRack)' opacity='.7'/>
<circle cx='46' cy='20' r='2' fill='white'/>
<circle cx='46' cy='32' r='2' fill='white'/>
<circle cx='46' cy='44' r='2' fill='white'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gGauge' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22d3ee'/><stop offset='1' stop-color='#f59e0b'/></linearGradient></defs>
<path d='M12 44 A20 20 0 0 1 52 44' fill='none' stroke='#94a3b8' stroke-width='4'/>
<line x1='32' y1='44' x2='44' y2='28' stroke='url(#gGauge)' stroke-width='4' stroke-linecap='round'/>
<circle cx='32' cy='44' r='4' fill='url(#gGauge)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCompass' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22d3ee'/><stop offset='1' stop-color='#3b82f6'/></linearGradient></defs>
<circle cx='32' cy='32' r='20' fill='none' stroke='#94a3b8' stroke-width='3'/>
<path d='M32 18 L26 38 L46 32 Z' fill='url(#gCompass)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCode' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#8b5cf6'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<path d='M24 18 L12 32 L24 46' fill='none' stroke='url(#gCode)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/>
<path d='M40 18 L52 32 L40 46' fill='none' stroke='url(#gCode)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gLink' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#06b6d4'/><stop offset='1' stop-color='#0ea5e9'/></linearGradient></defs>
<path d='M24 24 C32 16 40 16 48 24' fill='none' stroke='url(#gLink)' stroke-width='4'/>
<path d='M16 32 C24 40 32 40 40 32' fill='none' stroke='url(#gLink)' stroke-width='4'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gChat' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22c55e'/><stop offset='1' stop-color='#06b6d4'/></linearGradient></defs>
<path d='M12 18 H52 V38 H28 L20 46 V38 H12 Z' fill='url(#gChat)'/>
<circle cx='24' cy='28' r='2' fill='white'/>
<circle cx='32' cy='28' r='2' fill='white'/>
<circle cx='40' cy='28' r='2' fill='white'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gUser' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<circle cx='32' cy='24' r='10' fill='url(#gUser)'/>
<rect x='16' y='36' width='32' height='14' rx='7' fill='url(#gUser)' opacity='.8'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gDoc' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#3b82f6'/><stop offset='1' stop-color='#22d3ee'/></linearGradient></defs>
<path d='M18 12 H38 L50 24 V52 H18 Z' fill='url(#gDoc)'/>
<path d='M38 12 V24 H50' fill='white' opacity='.6'/>
<rect x='22' y='32' width='24' height='3' fill='white' opacity='.8'/>
<rect x='22' y='38' width='18' height='3' fill='white' opacity='.6'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCal' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#ef4444'/><stop offset='1' stop-color='#f59e0b'/></linearGradient></defs>
<rect x='12' y='16' width='40' height='32' rx='6' fill='url(#gCal)'/>
<rect x='12' y='16' width='40' height='8' fill='white' opacity='.2'/>
<rect x='18' y='30' width='8' height='8' rx='2' fill='white' opacity='.9'/>
<rect x='30' y='30' width='8' height='8' rx='2' fill='white' opacity='.7'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gClock' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#06b6d4'/><stop offset='1' stop-color='#3b82f6'/></linearGradient></defs>
<circle cx='32' cy='32' r='20' fill='none' stroke='url(#gClock)' stroke-width='4'/>
<line x1='32' y1='32' x2='32' y2='20' stroke='#94a3b8' stroke-width='4' stroke-linecap='round'/>
<line x1='32' y1='32' x2='44' y2='32' stroke='#94a3b8' stroke-width='4' stroke-linecap='round'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gPin' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#ef4444'/><stop offset='1' stop-color='#f59e0b'/></linearGradient></defs>
<path d='M32 10 C22 10 16 18 16 26 C16 38 32 54 32 54 C32 54 48 38 48 26 C48 18 42 10 32 10 Z' fill='url(#gPin)'/>
<circle cx='32' cy='26' r='6' fill='white' opacity='.8'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gBag' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#f59e0b'/><stop offset='1' stop-color='#ef4444'/></linearGradient></defs>
<rect x='16' y='22' width='32' height='26' rx='6' fill='url(#gBag)'/>
<path d='M22 22 C22 16 42 16 42 22' fill='none' stroke='white' stroke-width='3' opacity='.7'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gHeart' x1='0' y='0' x2='1' y2='1'>
<stop offset='0' stop-color='#ef4444'/><stop offset='1' stop-color='#f43f5e'/></linearGradient></defs>
<path d='M32 52 C24 44 12 38 12 26 C12 18 18 14 24 14 C28 14 30 16 32 18 C34 16 36 14 40 14 C46 14 52 18 52 26 C52 38 40 44 32 52 Z' fill='url(#gHeart)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gStar' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#fde047'/><stop offset='1' stop-color='#f59e0b'/></linearGradient></defs>
<path d='M32 10 L38 26 L56 26 L42 36 L48 52 L32 42 L16 52 L22 36 L8 26 L26 26 Z' fill='url(#gStar)'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gPie' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22c55e'/><stop offset='1' stop-color='#06b6d4'/></linearGradient></defs>
<circle cx='32' cy='32' r='20' fill='url(#gPie)' opacity='.3'/>
<path d='M32 12 A20 20 0 0 1 52 32 H32 Z' fill='url(#gPie)'/>
<path d='M32 12 L32 32 L14 26 A20 20 0 0 1 32 12 Z' fill='#22c55e'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gCloudUp' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#93c5fd'/><stop offset='1' stop-color='#3b82f6'/></linearGradient></defs>
<path d='M20 48 H48 C56 48 58 36 48 36 C48 24 30 22 28 32 C18 30 10 38 14 44 C16 47 18 48 20 48 Z' fill='url(#gCloudUp)'/>
<path d='M32 40 L32 30 M26 36 L32 30 L38 36' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/>
</svg>`,
  `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'>
<defs><linearGradient id='gTrend' x1='0' y1='0' x2='1' y2='1'>
<stop offset='0' stop-color='#22c55e'/><stop offset='1' stop-color='#0ea5e9'/></linearGradient></defs>
<path d='M10 50 H54' stroke='#cbd5e1' stroke-width='2'/>
<path d='M14 40 L28 28 L36 34 L50 20' fill='none' stroke='url(#gTrend)' stroke-width='4' stroke-linecap='round'/>
<path d='M46 20 H54 V28' fill='none' stroke='url(#gTrend)' stroke-width='4' stroke-linecap='round'/>
</svg>`
];
let filteredLogos=[...GENERIC_LOGOS];
function openLogoPicker(){
  if(demoMode){ toast('Demo mode: logo editing is disabled'); return; }
  filteredLogos=[...GENERIC_LOGOS]; lpSelectedIndex=0; paintLogoGrid(); logoPicker.classList.add('open'); lpBig.innerHTML = filteredLogos[0]; lpSearch.value='';
}
function closeLogoPicker(){ logoPicker.classList.remove('open'); }
function paintLogoGrid(){
  lpGrid.innerHTML='';
  filteredLogos.forEach((svg,i)=>{
    const card=document.createElement('button'); card.type='button'; card.type='button'; card.type='button'; card.className='lp-item'+(i===lpSelectedIndex?' active':'');
    card.innerHTML=svg;
    card.onclick=()=>{ lpSelectedIndex=i; paintLogoGrid(); lpBig.innerHTML=filteredLogos[lpSelectedIndex]; };
    lpGrid.appendChild(card);
  });
}
$('#logoBtn').addEventListener('click', openLogoPicker);
logoBox.addEventListener('click', openLogoPicker);
lpClose.onclick=closeLogoPicker;
lpAuto.onclick=()=>{ if(demoMode){ toast('Demo mode: logo editing is disabled'); return; } lpBig.innerHTML = svgAutoInitials(siteNameEl.textContent.trim()); lpSelectedIndex=-1; };
lpReset.onclick=()=>{ if(demoMode){ toast('Demo mode: logo editing is disabled'); return; } lpBig.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g0' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#2563eb'/><stop offset='1' stop-color='#7c3aed'/></linearGradient></defs><rect x='2' y='2' width='60' height='60' rx='14' fill='url(#g0)'/></svg>`; lpSelectedIndex=-2; };
lpSearch.oninput=()=>{ const q=lpSearch.value.trim().toLowerCase(); filteredLogos = GENERIC_LOGOS.filter((_,i)=>('logo '+(i+1)).includes(q) || !q); lpSelectedIndex=0; paintLogoGrid(); lpBig.innerHTML=filteredLogos[0]||''; };
lpUse.onclick=()=>{ if(demoMode){ toast('Demo mode: logo editing is disabled'); return; } logoBox.innerHTML = lpBig.innerHTML; updateFaviconFromLogo(); saveBrand(); closeLogoPicker(); };
loadBrand();

/* ================= MODEL ================= */
var Model = window.Model || (window.Model = { items: [] });
let current=null, selectedNodeId=null, targetSectionId=null;

/* ================= NAV helpers ================= */
function findParentOf(id, place){
  let parent=null;
  (function walk(list,p=null){
    for(const n of list){
      if(n.id===id){ parent=p; return; }
      if(n.children?.length){ walk(n.children,n); if(parent) return; }
    }
  })(Model.items.filter(i=>i.place===place));
  return parent;
}
function depthOfNode(place,id){
  let depth=-1;
  (function walk(list,d){
    for(const n of list){
      if(n.id===id){ depth=d; return; }
      if(n.children?.length){ walk(n.children,d+1); if(depth!==-1) return; }
    }
  })(Model.items.filter(i=>i.place===place),0);
  return depth;
}
function findNavNode(place,id){
  let hit=null;
  (function walk(list){
    for(const n of list){
      if(n.id===id){ hit=n; return; }
      if(n.children?.length){ walk(n.children); if(hit) return; }
    }
  })(Model.items.filter(i=>i.place===place));
  return hit;
}
function roots(place){
  const ids=new Set(Model.items.filter(i=>i.place===place).map(i=>i.id));
  Model.items.filter(i=>i.place===place).forEach(n=>{ const p=findParentOf(n.id,place); if(p) ids.delete(n.id); });
  return Model.items.filter(i=>i.place===place && ids.has(i.id));
}

/* ================= HORIZONTAL RIBBON + FLYOUT ================= */
const hRibbon=$('#hRibbon'), hPrev=$('#hPrev'), hNext=$('#hNext');
hPrev.onclick=()=>hRibbon.scrollBy({left:-220,behavior:'smooth'}); hNext.onclick=()=>hRibbon.scrollBy({left:220,behavior:'smooth'});
function checkRibbonOverflow(){ const need = hRibbon.scrollWidth > Math.ceil(hRibbon.clientWidth + 2); hPrev.hidden = hNext.hidden = !need; }

/* build horizontal item */
function buildHItem(node){
  const wrap=document.createElement('div'); wrap.className='h-item'; wrap.dataset.id=node.id; wrap.dataset.place=node.place;
  const hasChildren=(node.children?.length||0)>0;
  const a=document.createElement('a'); a.href='#'; a.className='h-link'; a.innerHTML=`${node.icon?`<span class="h-ico">${node.icon}</span>`:''}<span>${node.name}</span>${hasChildren?'<span class="h-caret">▾</span>':''}`;
  a.onclick=(e)=>{ e.preventDefault(); if(hasChildren){ openFlyMenu(node, a, 'below'); } else { openDesigner(node); } };
  if(hasChildren){ const tag=document.createElement('span'); tag.className='container-tag'; tag.textContent='Container'; a.appendChild(tag); }
  wrap.appendChild(a);
  return wrap;
}

/* ================= VERTICAL NAV ================= */
function buildVItem(node){
  const li=document.createElement('li'); li.className='vitem'; li.dataset.id=node.id; li.dataset.place=node.place;
  const hasChildren=(node.children?.length||0)>0;
  const b=document.createElement('button'); b.type='button'; b.type='button'; try{ b.classList.add('field-btn'); b.dataset.fieldId = fd.id || ''; b.dataset.btnAction = fd.btnAction || 'none'; }catch(_){} b.className='vbtn';
  b.innerHTML=`${node.icon?`<span class="ico">${node.icon}</span>`:'<span class="ico">•</span>'}<span>${node.name}</span>${hasChildren?'<span class="container-tag">Container</span>':''}`;
  b.onclick=(e)=>{ e.preventDefault(); if(hasChildren){ openFlyMenu(node, b, 'right'); } else { openDesigner(node); } };
  li.appendChild(b);
  return li;
}
function setActive(){
  const id=current?.id;
  $$('#hRibbon .h-link').forEach(a=> a.classList.toggle('active', a.parentElement.dataset.id===id));
  $$('#vNav .vbtn').forEach(b=> b.classList.toggle('active', b.parentElement.dataset.id===id));
}

/* ================= ADDERS ================= */
const hAdder=$('#hAdder'), vAdder=$('#vAdder');
const navNameH=$('#navNameH'), navParentH=$('#navParentH'), iconPreviewH=$('#iconPreviewH'), addNavBtnH=$('#addNavBtnH'), cancelNavH=$('#cancelNavH');
const navNameV=$('#navNameV'), navParentV=$('#navParentV'), iconPreviewV=$('#iconPreviewV'), addNavBtnV=$('#addNavBtnV'), cancelNavV=$('#cancelNavV');

hAdder.querySelector('button').onclick = (e)=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } e.stopPropagation(); populateParentSelect('h'); hAdder.classList.toggle('open'); hAdder.querySelector('button').setAttribute('aria-expanded', hAdder.classList.contains('open')?'true':'false'); };
document.addEventListener('click', e=>{ if(!hAdder.contains(e.target)) { hAdder.classList.remove('open'); hAdder.querySelector('button').setAttribute('aria-expanded','false'); } });
vAdder.querySelector('button').onclick = ()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } vAdder.classList.toggle('open'); populateParentSelect('v'); };
cancelNavH.onclick=()=>{ hAdder.classList.remove('open'); }; cancelNavV.onclick=()=>{ vAdder.classList.remove('open'); };

function parentChoices(place){
  const out=[{value:'',text:'(No parent — top level)'}];
  (function walk(list,d){
    list.filter(n=>n.place===place).forEach(n=>{
      out.push({value:n.id,text:'—'.repeat(d)+' '+(n.icon? n.icon+' ':'')+n.name});
      if(d<2 && n.children?.length) walk(n.children,d+1);
    });
  })(Model.items.filter(i=>i.place===place && !findParentOf(i.id,place)),0);
  return out;
}
function populateParentSelect(place){
  const sel=(place==='h')? navParentH : navParentV; sel.innerHTML='';
  parentChoices(place).forEach(o=>{ const op=document.createElement('option'); op.value=o.value; op.textContent=o.text; sel.appendChild(op); });
}
function addNav(name, place, parentId, icon){
  if(demoMode){ toast('Demo mode: structure editing is disabled'); return; }
  const title=(name||'').trim(); if(!title) return;
  const item={id:uid(),name:title,place,icon:(icon||'').trim(),children:[],root:defaultRootSection(title)};
  if(!parentId){ Model.items.push(item); }
  else{
    const parent=findNavNode(place,parentId); if(!parent) return;
    if(depthOfNode(place,parentId)>=2){ alert('Maximum depth is 3 levels.'); return; }
    parent.children.push(item);
  }
  renderMenus(); openDesigner(item);
}
addNavBtnH.onclick=()=>{ addNav(navNameH.value,'h',navParentH.value||'',iconPreviewH.value); navNameH.value=''; iconPreviewH.value=''; hAdder.classList.remove('open'); };
addNavBtnV.onclick=()=>{ addNav(navNameV.value,'v',navParentV.value||'',iconPreviewV.value); navNameV.value=''; iconPreviewV.value=''; vAdder.classList.remove('open'); };

/* ================= Floating menu ================= */
const flyRoot=$('#flyRoot');
function openFlyMenu(node, anchorEl, mode){
  closeFly();
  const rect=anchorEl.getBoundingClientRect();
  const root=document.createElement('div'); root.className='fly';
  const left = mode==='right' ? rect.right+6 : Math.min(rect.left, window.innerWidth-340);
  const top  = mode==='right' ? rect.top : rect.bottom+6;
  positionPanel(root, top, left);
  root.appendChild(buildFlyList(node.children));
  flyRoot.appendChild(root);
  flyRoot.classList.add('open');
  flyRoot.onclick=(e)=>{ if(e.target===flyRoot) closeFly(); };
  document.addEventListener('keydown', escCloseOnce);
}
function escCloseOnce(e){ if(e.key==='Escape'){ closeFly(); } }
function closeFly(){ flyRoot.classList.remove('open'); flyRoot.innerHTML=''; document.removeEventListener('keydown', escCloseOnce); }
function positionPanel(panel, top, left){
  const w=panel.offsetWidth||300;
  let L=left, T=top;
  if(L+w>window.innerWidth-8) L=window.innerWidth-w-8;
  if(T<8) T=8;
  panel.style.left=L+'px'; panel.style.top=T+'px';
}
function buildFlyList(items){
  const wrap=document.createElement('div');
  items.forEach(it=>{
    const row=document.createElement('div'); row.className='item'; row.innerHTML=`${it.icon?`<span>${it.icon}</span>`:''}<span>${it.name}</span>${(it.children?.length?'<span class="caret">▸</span>':'')}`;
    row.onclick=(e)=>{ e.stopPropagation(); if(it.children?.length){ /* nested */ } else { openDesigner(it); closeFly(); } };
    wrap.appendChild(row);
    if(it.children?.length){
      const sub=document.createElement('div'); sub.className='sub';
      sub.appendChild(buildFlyList(it.children));
      wrap.appendChild(sub);
      row.addEventListener('mouseenter', ()=>{
        row.classList.add('open');
        const r=row.getBoundingClientRect(); sub.style.left=(r.right+6)+'px';
        const height=sub.offsetHeight||280;
        sub.style.top=Math.min(r.top, window.innerHeight-height-8)+'px';
      });
      row.addEventListener('mouseleave', ()=> row.classList.remove('open'));
    }
  });
  return wrap;
}

/* ================= FORM / DESIGNER ================= */
function defaultRootSection(title){
  const root={id:uid(),type:'section',name:'General',children:[]};
  return root;
}
function field(ftype,name,req=false){
  return {
    id:uid(), type:'field', name, ftype, span:2,
    required:req, readonly:false, disabled:false,
    placeholder:'', help:'', default:'',
    min:'', max:'', step:'', minLen:'', maxLen:'', pattern:'',
    labelPos:'top',
    options:[], allowCustom:false,
    btnStyle:'primary', btnAction:'none',
    logic:{mode:'all',conditions:[]}
  };
}
function divider(){ return {id:uid(),type:'divider',showLine:true}; }
function space(span=1){ return { id: uid(), type:'space', span: Number(span)||1 }; }
function options(node,arr){ node.options=arr.slice(); return node; }

const pageHeader=$('#pageHeader'), formNote=$('#formNote');
function getItem(){ return current && findNavNode(current.place,current.id); }
function openDesigner(item){ current={id:item.id,place:item.place,name:item.name}; pageHeader.textContent=item.name; if(!item.root) item.root=defaultRootSection(item.name); if(!targetSectionId) targetSectionId=item.root.id; render(); }

/* rename feature inline (no re-render until blur) */
pageHeader.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); pageHeader.blur(); }});
document.getElementById('pageName').addEventListener('blur', ()=>{
  if(demoMode) return;
  const it=getItem(); if(!it) return;
  it.name = (pageHeader.textContent||'').trim() || it.name;
  renderMenus(); setActive();
});

function render(){ renderForm(); setActive(); checkRibbonOverflow(); updateVisibility(); setTimeout(postRenderFocus,0); }
function postRenderFocus(){
  try{
    const host=document.getElementById('formHost');
    const cards=[...host.querySelectorAll('.fcard')];
    if(!window.__cardCount) window.__cardCount = cards.length; window.__focusAdded = false;
    if(window.__focusNextId){
      const el=host.querySelector(`.fcard[data-nid="${window.__focusNextId}"]`);
      if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); const span=el.querySelector('.label-editable'); (span||el).focus(); }
      window.__focusNextId=null; window.__cardCount=cards.length; return;
    }
    if(window.__focusAdded || cards.length > window.__cardCount){
      const el = cards[cards.length-1];
      if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); const span=el.querySelector('.label-editable'); (span||el).focus(); }
      window.__cardCount = cards.length; window.__focusAdded = false;
    }
  }catch{}
}
function renderForm(){
  const item=getItem(); const host=$('#formHost'); // Focus guard: if user is typing, skip rebuilding the form; do light updates only
  const __af=document.activeElement;
  if(__af && ((/^(INPUT|TEXTAREA)$/).test(__af.tagName) || __af.isContentEditable)){
    try{ typeof setActive==='function' && setActive(); }catch(_){}
    try{ typeof checkRibbonOverflow==='function' && checkRibbonOverflow(); }catch(_){}
    try{ typeof updateVisibility==='function' && updateVisibility(); }catch(_){}
    return;
  }
host.innerHTML=''; if(!item) return;
  // Build a real <form> so HTML5 validations (required, pattern, min/max) work on submit
  const form=document.createElement('form'); form.id='designerForm'; form.className='designer-form';
  // Submit: first run native constraint validation, then existing custom doSubmit (table, etc.)
  form.addEventListener('submit', (e)=>{
    
    
    // DEMO GUARD: process only when an explicit Submit control triggered this submit
    if (window.demoMode) {
      var __s = (typeof e!=='undefined' && e) ? (e.submitter || document.activeElement) : document.activeElement;
      var __isSubmit = (function(el){
        if(!el || !el.tagName) return false;
        var txt=(el.getAttribute('aria-label')||el.textContent||'').trim().toLowerCase();
        return el.type==='submit' || el.classList.contains('submit') || el.getAttribute('data-role')==='submit' || txt==='submit';
      })(__s);
      if(!__isSubmit){ e.preventDefault(); return; }
    }
// Guard: only handle actual Submit clicks (ignore add row/col/field etc.)
    var __isRealSubmit = (function(){
      var s = (typeof e!=='undefined' && e) ? (e.submitter || document.activeElement) : document.activeElement;
      function isSubmitEl(el){
        if(!el || !el.tagName) return false;
        var txt=(el.getAttribute('aria-label')||el.textContent||'').trim().toLowerCase();
        return el.type==='submit' || el.classList.contains('submit') || el.getAttribute('data-role')==='submit' || txt==='submit';
      }
      return isSubmitEl(s);
    })();
    if(!__isRealSubmit){ e.preventDefault(); return; }
if(!form.checkValidity()){
      e.preventDefault();
      try{ form.reportValidity(); }catch(_){}
      return;
    }
    let ok = true;
    try{ ok = (typeof doSubmit==='function') ? !!doSubmit() : true; }catch(_){ ok=true; }
    if(!ok){
      e.preventDefault();
      return;
    }
    // Demo: prevent navigation
    e.preventDefault();
    
// Only show toast when real Submit button triggered
(function(){
  var s = (typeof e!=='undefined' && e) ? (e.submitter || document.activeElement) : document.activeElement;
  function isSubmitEl(el){
    if(!el || !el.tagName) return false;
    var txt=(el.getAttribute('aria-label')||el.textContent||'').trim().toLowerCase();
    return el.type==='submit' || el.classList.contains('submit') || el.getAttribute('data-role')==='submit' || txt==='submit';
  }
  if(!isSubmitEl(s)) return;
  try{ toast && toast('✅ Submitted (demo).'); }catch(_){}
})();});
  // Reset: keep native reset for inputs and also invoke existing custom reset hook
  form.addEventListener('reset', ()=>{
    setTimeout(()=>{ try{ typeof doReset==='function' && doReset(); }catch(_){} }, 0);
  });
  form.appendChild(renderSection(item.root));
  host.appendChild(form);

  
  // Rehydrate values after rebuild using the snapshot
  ;(function(){
    try{
      const cache = window.__renderFormCache;
      if(!cache) return;
      form.querySelectorAll('input, textarea, [contenteditable="true"]').forEach(el=>{
        const id  = el.id || '';
        const nm  = (el.getAttribute && el.getAttribute('name')) || '';
        let v = null;
        if(id && Object.prototype.hasOwnProperty.call(cache.byId,id)) v = cache.byId[id];
        else if(nm && Object.prototype.hasOwnProperty.call(cache.byName,nm)) v = cache.byName[nm];
        if(v!=null && v!==''){
          if(el.isContentEditable){ if(el.innerHTML!==v) el.innerHTML=v; }
          else if(el.tagName==='INPUT' || el.tagName==='TEXTAREA'){ if(el.value!==v) el.value=v; }
        }
      });
    }catch(_){}
  })();
try{ attachValidationUX(form); }catch(_){}
}

function renderSection(sec){
  const wrap=document.createElement('div'); wrap.className='section'; wrap.dataset.nid=sec.id;

  const head=document.createElement('div'); head.className='section-title';
  const titleEl=document.createElement('div'); titleEl.className='section-name label-editable'; titleEl.textContent=sec.name;
  titleEl.contentEditable = !demoMode;
  titleEl.onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); titleEl.blur(); } };
  titleEl.addEventListener('mousedown', (e)=>{ e.stopPropagation(); });
  titleEl.addEventListener('click', (e)=>{ e.stopPropagation(); });
  titleEl.onblur=()=>{ if(demoMode) return; const v=(titleEl.textContent||'').trim(); if(v && v!==sec.name){ sec.name=v; render(); } };
  head.appendChild(titleEl);
  const tools=document.createElement('div'); tools.className='section-toolbar';

  const editBtn=document.createElement('button'); editBtn.type='button'; editBtn.type='button'; editBtn.className='stool'; editBtn.textContent='✏️ Edit';
  editBtn.onclick=()=>{ if(!demoMode){ selectedNodeId=sec.id; openInspector(sec.id); } else toast('Demo mode: editing disabled'); };
  const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.type='button'; delBtn.className='stool'; delBtn.textContent='🗑️ Delete';
  delBtn.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } deleteNode(sec.id); };

  const targetBtn=document.createElement('button'); targetBtn.type='button'; targetBtn.type='button'; targetBtn.className='stool'; targetBtn.textContent='🎯 Target';
  targetBtn.onclick=()=>{ if(!demoMode) setTarget(sec.id); else toast('Demo mode: editing disabled'); };

  const addFieldBtn=document.createElement('button'); addFieldBtn.type='button'; addFieldBtn.type='button'; addFieldBtn.className='col-act primary'; addFieldBtn.textContent='<span class="ico">＋</span><span class="lab">Field</span>';
  addFieldBtn.onclick=()=>{ if(!demoMode){ const n=field('text','Field'); sec.children.push(n); render(); /* inspector auto-open removed by patch */ } else toast('Demo mode: editing disabled'); };
  // Enhance + Field to quick-pick type
  addFieldBtn.onclick=async ()=>{
    if(demoMode){ toast('Demo mode: editing disabled'); return; }
    try{
      const choice = (await window.pickFieldType()) || '';
      if(!choice) return;
      let n=null;
      if(choice==='space'){ n=space(1); }
      else if(choice==='divider'){ n=divider(); }
      else if(choice==='table'){ n=field('table','Table'); n.columns=[{key:'col1',label:'Column 1'},{key:'col2',label:'Column 2'}]; n.sampleRows=3; }
      else {
        const name = choice.charAt(0).toUpperCase()+choice.slice(1)+' Field';
        n = field(choice, name);
      }
      if(n){ sec.children.push(n); render(); if(n.type!=='space' && n.type!=='divider'){ /* inspector auto-open removed */} }
    }catch(e){ console.error(e); }
  };

  const addSecBtn=document.createElement('button'); addSecBtn.type='button'; addSecBtn.type='button'; addSecBtn.className='stool'; addSecBtn.textContent='＋ Section';
  addSecBtn.onclick=()=>{ if(!demoMode){ const n={id:uid(),type:'section',name:'Section',description:'',span:4,children:[]}; sec.children.push(n); render(); /* inspector auto-open removed by patch */ } else toast('Demo mode: editing disabled'); };

  const addDivBtn=document.createElement('button'); addDivBtn.type='button'; addDivBtn.type='button'; addDivBtn.className='stool'; addDivBtn.textContent='— Divider';
  addDivBtn.onclick=()=>{ if(!demoMode){ sec.children.push(divider()); render(); } else toast('Demo mode: editing disabled'); };

  const addSpaceBtn=document.createElement('button'); addSpaceBtn.type='button'; addSpaceBtn.type='button'; addSpaceBtn.className='stool'; addSpaceBtn.textContent='— Space';
  const addRow12Btn=document.createElement('button'); addRow12Btn.type='button'; addRow12Btn.type='button'; addRow12Btn.className='stool add-row12'; addRow12Btn.textContent='＋ Row (12)';
  addRow12Btn.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; }
    const row={ id:uid(), type:'row12', name:'Row', capacity:12, columns:[] };
    sec.children.push(row); render(); };

  addSpaceBtn.onclick=()=>{ if(!demoMode){ sec.children.push(space(1)); render(); } else toast('Demo mode: editing disabled'); };

  tools.append(addRow12Btn);
  head.appendChild(tools); wrap.appendChild(head);

  const grid=document.createElement('div'); grid.className='grid4'; wrap.appendChild(grid);
  const cols = matchMedia('(max-width:640px)').matches ? 1 : matchMedia('(max-width:1024px)').matches ? 2 : 4;

  for(const node of sec.children){
    if(node && node.type==='row12'){
      const r = renderRow12(node);
      r.style.gridColumn = '1/-1';
      grid.appendChild(r);
      continue;
    }

    if(node.type==='divider'){
      const box=document.createElement('div'); box.className='divider-card'; box.style.gridColumn='1/-1'; box.dataset.nid=node.id;
      const bar=document.createElement('div'); bar.className='icons';
      const e=document.createElement('button'); e.type='button'; e.type='button'; e.className='icon-btn';
try{ if(!e.getAttribute('aria-label')) e.setAttribute('aria-label', e.getAttribute('title') || e.textContent || 'action'); }catch(e){}; e.textContent='✏️';
      e.onclick=(ev)=>{ ev.stopPropagation(); if(!demoMode){ selectedNodeId=node.id; openInspector(node.id); } else toast('Demo mode: editing disabled'); };
      const d=document.createElement('button'); d.type='button'; d.type='button'; d.className='icon-btn icon-del'; d.textContent='🗑️';
      d.onclick=(ev)=>{ ev.stopPropagation(); if(!demoMode){ deleteNode(node.id); } else toast('Demo mode: editing disabled'); };
      bar.append(e,d); box.appendChild(bar);
      const hr=document.createElement('hr'); box.appendChild(hr);
      grid.appendChild(box);
      continue;
    }
    if(node.type==='section'){ const s=renderSection(node); s.style.gridColumn='span '+Math.min(cols,node.span||4); grid.appendChild(s); continue; }

    const span=Math.max(1, Math.min(cols, Number(node.span)||2));
    const fc=renderField(node); fc.style.gridColumn='span '+span; grid.appendChild(fc);
  }
  return wrap;
}

function renderField(fd){

  // Space pseudo-field
  if(fd && fd.type==='space'){
    const card=document.createElement('div'); card.className='fcard space-card'; card.dataset.nid=fd.id;
    const bar=document.createElement('div'); bar.className='icons';
    const del=document.createElement('button'); del.type='button'; del.type='button'; del.className='icon-btn icon-del'; del.title='Delete'; del.textContent='🗑️';
    function _clamp(v){ v=Number(v)||1; return Math.max(1, Math.min(4, v)); }
    del.onclick=(e)=>{ e.stopPropagation(); if(!demoMode){ deleteNode(fd.id); } else toast('Demo mode: editing disabled'); };
    bar.append(del); card.appendChild(bar);
    const filler=document.createElement('div'); filler.setAttribute('aria-hidden','true'); filler.style.minHeight='24px'; card.appendChild(filler);
return card;
  }
const card=document.createElement('div'); card.className='fcard'; card.dataset.nid=fd.id;
  try{ if(typeof passesLogic==='function' && typeof demoMode!=='undefined'){ if(demoMode){ card.style.display = passesLogic(fd)? '' : 'none'; } } }catch{}
  const bar=document.createElement('div'); bar.className='icons';
  const edit=document.createElement('button'); edit.type='button'; edit.type='button'; edit.className='icon-btn';
try{ if(!edit.getAttribute('aria-label')) edit.setAttribute('aria-label', edit.getAttribute('title') || edit.textContent || 'action'); }catch(e){}; edit.title='Edit basics'; edit.textContent='✏️';
  const validation=document.createElement('button'); validation.type='button'; validation.type='button'; validation.className='icon-btn';
try{ if(!validation.getAttribute('aria-label')) validation.setAttribute('aria-label', validation.getAttribute('title') || validation.textContent || 'action'); }catch(e){}; validation.title='Validation'; validation.textContent='✅';
  const bolt=document.createElement('button'); bolt.type='button'; bolt.type='button'; bolt.className='icon-btn';
try{ if(!bolt.getAttribute('aria-label')) bolt.setAttribute('aria-label', bolt.getAttribute('title') || bolt.textContent || 'action'); }catch(e){}; bolt.title='Conditions'; bolt.textContent='⚡';
  const del=document.createElement('button'); del.type='button'; del.type='button'; del.className='icon-btn icon-del'; del.title='Delete'; del.textContent='🗑️';
  function _clamp(v){ v=Number(v)||1; return Math.max(1, Math.min(4, v)); }
  /* width buttons removed */
  bar.append(edit,validation,bolt,del); card.appendChild(bar);

  const wrapper=document.createElement('div'); wrapper.className='preview-form';
  const row=document.createElement('div'); row.className='field';

  if(fd.ftype!=='button'){
    const label=document.createElement('label'); label.htmlFor='f_'+fd.id;
    const span=document.createElement('span'); span.className='label-editable'; span.textContent=fd.name;
    span.setAttribute('contenteditable', demoMode ? 'false' : 'true');
    span.onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); span.blur(); } };
    span.onblur=()=>{ if(demoMode) return; fd.name = (span.textContent||'').trim() || fd.name; render(); };
    span.tabIndex=0; span.addEventListener('mousedown',(e)=>{e.stopPropagation(); e.preventDefault();});
    span.addEventListener('click',(e)=>{e.stopPropagation(); e.preventDefault(); span.focus();});
    const star=document.createElement('span'); star.textContent=fd.required?' *':'';
    star.style.color='#b91c1c'; star.style.marginLeft='3px';
    label.append(span, star);
    // Layout by label position (left/top/hidden)
(function(){
  row.style.display = 'grid';
  const pos = (fd && fd.labelPos) ? fd.labelPos:'top';
  if (pos === 'left') {
    row.style.gridTemplateColumns = 'minmax(60px, var(--label-w, 88px)) minmax(0,1fr)';
    row.style.columnGap = 'var(--label-gap, 4px)'; row.style.alignItems = 'center';
    label.style.display = '';
    label.style.marginBottom = '0';
  } else if (pos === 'top') {
    row.style.gridTemplateColumns = '1fr';
    label.style.display = '';
    label.style.marginBottom = '2px';
  } else if (pos === 'hidden') {
    row.style.gridTemplateColumns = '1fr';
    label.style.display = 'none';
  }
})();
row.appendChild(label);
  }

  const host=document.createElement('div'); host.style.display='flex'; host.style.alignItems='center'; host.style.gap='6px'; host.style.flexWrap='wrap';
  host.appendChild(buildControl(fd)); row.appendChild(host); wrapper.appendChild(row); card.appendChild(wrapper);

  edit.onclick=(e)=>{ e.stopPropagation(); if(!demoMode){ selectedNodeId=fd.id; openInspector(fd.id); } else toast('Demo mode: editing disabled'); };
  validation.onclick=(e)=>{
    e.stopPropagation();
    if(!demoMode){
      try{ card.scrollIntoView({behavior:'smooth', block:'center'}); }catch{}
      if(window.openInspectorAndTab){ openInspectorAndTab(fd.id, 'Validation'); }
      else { selectNode(fd.id); openInspector(fd.id); }
    } else toast('Demo mode: editing disabled');
  };
  bolt.onclick=(e)=>{
    e.stopPropagation();
    if(!demoMode){
      try{ card.scrollIntoView({behavior:'smooth', block:'center'}); }catch{}
      if(window.openInspectorAndTab){ openInspectorAndTab(fd.id, 'Visibility'); }
      else { selectNode(fd.id); openInspector(fd.id); }
    } else toast('Demo mode: editing disabled');
  };

  del.onclick=(e)=>{ e.stopPropagation(); if(!demoMode){ confirmDialog({title:'Delete field?', name: fd.name || '', showName:true, body:'This cannot be undone.', confirmText:'Delete', tone:'danger', icon:'🗑️'}).then(ok=>{ if(ok) deleteNode(fd.id); }); } else toast('Demo mode: editing disabled'); };

  return card;
}

function buildControl(fd){
      // datetime composite (date + time + hidden ISO)
      try {
        const _t = (fd && (fd.ftype || fd.type)) || 'text';
        if (_t==='datetime' || _t==="datetime-local") { return buildControlDatetimeComposite(fd); }
      } catch(e) { /* safe no-op */ }
    
  const t=(fd.ftype||'text').toLowerCase();
  const set=(el)=>{ if(fd.placeholder) el.placeholder=fd.placeholder; if(fd.required) el.required=true; if(fd.readonly) el.readOnly=true; if(fd.disabled) el.disabled=true; if(fd.default!=='' && !['radio','checkboxes','toggle','range','rating','button'].includes(t)) try{ el.value=fd.default; }catch{}; if(fd.min) el.min=fd.min; if(fd.max) el.max=fd.max; if(fd.step) el.step=fd.step; if(fd.minLen) el.minLength=fd.minLen; if(fd.maxLen) el.maxLength=fd.maxLen; if(fd.pattern) el.pattern=fd.pattern; };
  if(t==='button'){
  const b=document.createElement('button'); b.type='button'; b.type='button';
  // Style
  const styleClass = (fd.btnStyle==='ghost'||fd.btnStyle==='danger'||fd.btnStyle==='link') ? fd.btnStyle : 'primary';
  b.className='btn '+styleClass;
  b.textContent=fd.name||'Button';
  // Behavior: map to native form actions
  if(fd.btnAction==='submit'){
    b.type='submit';
  }else if(fd.btnAction==='reset'){
    b.type='reset';
    // Also trigger custom reset for complex widgets
    b.addEventListener('click', (ev)=>{
      // prevent double reset flickers; allow native reset then custom hook
      setTimeout(()=>{ try{ typeof doReset==='function' && doReset(); }catch(_){} }, 0);
    });
  }else{
    b.type='button';
  }
  return b;
}

  if(['text','email','tel','url','password','number','date','time','color'].includes(t)){ const i=document.createElement('input'); i.type=t; set(i); i.id='f_'+fd.id;
        if(['email','url','tel'].includes(t)){
          (function(){
            function message(){
              const s=String(i.value||'').trim();
              if(!s) return i.required ? 'This field is required.' : '';
              if(t==='email'){ return (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)) ? '' : 'Invalid email address.'; }
              if(t==='url'){ try{ const u=new URL(s); if(!(u.protocol==='http:'||u.protocol==='https:')) throw 0; return ''; }catch(e){ return 'Invalid URL.'; } }
              if(t==='tel'){
                const pat = (typeof fd!=='undefined' && fd && fd.pattern) ? fd.pattern : '';
                if(pat){ try{ const re=new RegExp(pat); if(!re.test(s)) return 'Invalid phone number.'; }catch(e){} }
                else { if(!/^[+()\d\s\-]{6,}$/.test(s)) return 'Invalid phone number.'; }
                return '';
              }
              return '';
            }
            function ensureErr(){
              let e=i.nextElementSibling;
              if(!e || !e.classList || !e.classList.contains('input-error')){
                e=document.createElement('div'); e.className='input-error';
                e.style.fontSize='12px'; e.style.color='var(--danger,#c00)'; e.style.marginTop='4px';
                i.insertAdjacentElement('afterend', e);
              }
              return e;
            }
            function sync(){
              const m=message();
              if(i.setCustomValidity) i.setCustomValidity(m||'');
              i.classList.toggle('invalid', !!m);
              const e=ensureErr(); e.textContent = m||''; e.style.display = m ? '' : 'none';
              if(m){ i.setAttribute('aria-invalid','true'); } else { i.removeAttribute('aria-invalid'); }
            }
            i.addEventListener('input', sync);
            i.addEventListener('blur', sync);
            setTimeout(sync, 0);
          })();
        }
        return i; }



if(t==='richtext'){
    const wrap=document.createElement('div'); wrap.className='richtext-field'; wrap.style.width='100%';
    // assign id for consistency (used by scrolling/focus)
    wrap.id = 'f_'+fd.id;
    
if(typeof demoMode!=='undefined' && demoMode){
        // FORCE interactive Quill in demo mode
        const host = document.createElement('div'); host.className='ql-host'; host.style.width='100%';
        const toolbar = document.createElement('div'); toolbar.className='ql-toolbar ql-snow';
        toolbar.innerHTML = [
          '<span class="ql-formats">',
            '<select class="ql-header"><option value="1"></option><option value="2"></option><option selected></option></select>',
          '</span>',
          '<span class="ql-formats">',
            '<button type="button" class="ql-bold"></button>',
            '<button type="button" class="ql-italic"></button>',
            '<button type="button" class="ql-underline"></button>',
            '<button type="button" class="ql-strike"></button>',
          '</span>',
          '<span class="ql-formats">',
            '<button type="button" class="ql-list" value="ordered"></button>',
            '<button type="button" class="ql-list" value="bullet"></button>',
          '</span>',
          '<span class="ql-formats">',
            '<button type="button" class="ql-link"></button>',
            '<button type="button" class="ql-blockquote"></button>',
            '<button type="button" class="ql-code-block"></button>',
          '</span>'
        ].join('');
        const container = document.createElement('div'); container.style.minHeight='160px'; container.setAttribute('aria-label','Rich Text');
        host.appendChild(toolbar); try{ host.style.position='relative'; host.style.zIndex='20'; }catch{}
        host.appendChild(container);
        wrap.appendChild(host);

        if(window.Quill){
          try{
            const quill = new Quill(container, { theme:'snow', modules:{ toolbar: toolbar } });
            try{ quill.root.style.minHeight='120px'; }catch{}
            // Enable + defend against demo sanitizers
            try{ quill.enable(true); quill.root.setAttribute('contenteditable','true'); }catch{}
            try{
              ['pointerdown','mousedown','click','dblclick','touchstart','focusin'].forEach(ev=>{
                host.addEventListener(ev, (e)=>{ if (e.target && e.target.closest && e.target.closest('.ql-toolbar')) return; e.stopPropagation(); }, {capture:true});
              });
              let primed=false;
              function forceFocus(){ try{ quill.enable(true); quill.root.setAttribute('contenteditable','true'); quill.focus(); }catch{} }
              host.addEventListener('pointerdown', (e)=>{ if(!primed){ primed=true; forceFocus(); } }, {capture:true});
              host.addEventListener('click', (e)=>{ forceFocus(); }, {capture:true});
              host.addEventListener('focusin', (e)=>{ forceFocus(); }, {capture:true});
            }catch{}
            try{
              const mo = new MutationObserver(() => {
                if (typeof demoMode!=='undefined' && demoMode && quill && quill.root.getAttribute('contenteditable')!=='true') {
                  quill.enable(true);
                  quill.root.setAttribute('contenteditable','true');
                }
              });
              mo.observe(quill.root, { attributes:true, attributeFilter:['contenteditable'] });
            }catch{}
            // Seed content
            let seeded = false;
            if(fd && fd.valueDelta){
              try{ quill.setContents(fd.valueDelta); seeded = true; }catch{}
            }
            if(!seeded && fd && fd.valueHtml){
              try{ quill.clipboard.dangerouslyPasteHTML(fd.valueHtml); seeded = true; }catch{}
            }
            if(!seeded && typeof fd?.default === 'string'){
              quill.setText(fd.default);
            }
            // Persist changes back to fd so switching modes keeps edits
            quill.on('text-change', ()=>{
              if(!fd) return;
              try{
                fd.valueDelta = quill.getContents();
                fd.valueHtml  = quill.root.innerHTML;
              }catch{}
            });
            // Resize guard
            try{
              if('ResizeObserver' in window){
                const ro = new ResizeObserver(()=>{ editorHost.style.width='100%'; });
                ro.observe(wrap);
              }
            }catch{}
          }catch(e){
            // Quill failed: fallback to sanitized HTML/Plain
            const view=document.createElement('div'); view.className='ql-editor';
            let html = fd?.valueHtml || '';
            if(!html && fd?.valueDelta && Array.isArray(fd.valueDelta.ops)){
              html = fd.valueDelta.ops.map(op => (typeof op.insert==='string'? op.insert : '')).join('');
            }
            try{ view.innerHTML = (window.DOMPurify ? DOMPurify.sanitize(html) : html); }catch{ view.innerHTML = html; }
            if(container && container.parentNode){ container.parentNode.replaceChild(view, container); } else { wrap.appendChild(view); }
          }
        } else {
          // No Quill in page: fallback to read-only view
          const view=document.createElement('div'); view.className='ql-editor';
          let html = fd?.valueHtml || '';
          if(!html && fd?.valueDelta && Array.isArray(fd.valueDelta.ops)){
            html = fd.valueDelta.ops.map(op => (typeof op.insert==='string'? op.insert : '')).join('');
          }
          try{ view.innerHTML = (window.DOMPurify ? DOMPurify.sanitize(html) : html); }catch{ view.innerHTML = html; }
          if(container && container.parentNode){ container.parentNode.replaceChild(view, container); } else { wrap.appendChild(view); }
        }
        return wrap;
    } else {

        const editorHost=document.createElement('div'); editorHost.style.width='100%';
        wrap.appendChild(editorHost);
        try{
          const quill = new Quill(editorHost, {
            theme: 'snow',
            placeholder: fd.placeholder || 'Start typing…',
            modules: {
              toolbar: fd.toolbar || [[{ header: [1,2,3,false] }], ['bold','italic','underline','strike'], [{ color: [] }, { background: [] }], [{ list:'ordered' }, { list:'bullet' }], [{ align: [] }], ['link','blockquote','code-block','clean']],
              history: { delay: 400, maxStack: 200, userOnly: true }
            }
          });
          if(fd.valueDelta) quill.setContents(fd.valueDelta);
          else if(fd.valueHtml) quill.root.innerHTML = fd.valueHtml;
          quill.on('text-change', ()=>{
            try{
              fd.valueDelta = quill.getContents();
              fd.valueHtml  = quill.root.innerHTML;
            }catch{}
          });
          fd.__quill = quill;
          try{
            if('ResizeObserver' in window){
              const ro = new ResizeObserver(()=>{
                // Quill uses content-box width automatically; just ensure container matches wrapper
                editorHost.style.width = '100%';
              });
              ro.observe(wrap);
            }
          }catch{}
        }catch(e){
          const warn=document.createElement('div');
          warn.textContent='Quill failed to load. Check network or CDN.';
          wrap.appendChild(warn);
        }
        return wrap;
    }
  }
if(t==='rating'){
  const wrap=document.createElement('div'); wrap.className='rating-field'; wrap.id='f_'+fd.id;
  const max = Math.max(1, Math.min(10, Number(fd.max||fd.maxRating||5)));
  const current = Math.max(0, Math.min(max, Number(fd.default||0)));
  function paint(val){
    const stars = wrap.querySelectorAll('.star');
    stars.forEach(s => { const v = Number(s.dataset.value||0); s.classList.toggle('active', v <= val); });
  }
  for(let i=1;i<=max;i++){
    const star = document.createElement('span');
    star.className = 'star';
    star.textContent = '★';
    star.setAttribute('role','radio');
    star.setAttribute('aria-checked', String(i===current));
    star.setAttribute('tabindex','0');
    star.dataset.value = String(i);
    star.onclick = (e)=>{
      const v = Number(star.dataset.value||0);
      fd.default = v;
      paint(v);
    };
    star.onkeydown = (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        star.click();
      }else if(e.key==='ArrowLeft' || e.key==='ArrowDown'){
        e.preventDefault();
        const v = Math.max(1, Number(fd.default||0) - 1);
        fd.default = v; paint(v);
      }else if(e.key==='ArrowRight' || e.key==='ArrowUp'){
        e.preventDefault();
        const v = Math.min(max, Number(fd.default||0) + 1);
        fd.default = v; paint(v);
      }
    };
    wrap.appendChild(star);
  }
  paint(current);
  return wrap;
}

  if(t==='table'){
    /*__TABLE_FULL__*/
    fd.columns = Array.isArray(fd.columns) && fd.columns.length ? fd.columns : [{key:'col1',label:'Column 1',type:'text',align:'left',width:''},{key:'col2',label:'Column 2',type:'text',align:'left',width:''}];
    fd.sampleRows = Number(fd.sampleRows)||3;
    fd.rows = Array.isArray(fd.rows) ? fd.rows : [];
    fd.filters = fd.filters || {};
    const wrap=document.createElement('div'); wrap.className='table-field';
    const tools=document.createElement('div'); tools.className='row-actions';
      const clearAll=document.createElement('button'); clearAll.type='button'; clearAll.type='button'; clearAll.type='button'; clearAll.className='btn ghost'; clearAll.textContent='Clear filters';
      clearAll.style.display = Object.keys(fd.filters||{}).length ? '' : 'none';
      clearAll.onclick=()=>{ fd.filters = {}; paintHeader(); paintBody(true); paintFooter(); paintFooter(); };
      tools.appendChild(clearAll);
    const addRow=document.createElement('button'); addRow.type='button'; addRow.type='button'; addRow.type='button'; addRow.className='btn ghost'; addRow.textContent='+ Add row';
    const delRow=document.createElement('button'); delRow.type='button'; delRow.type='button'; delRow.type='button'; delRow.className='btn ghost'; delRow.textContent='× Delete last';
    tools.append(addRow, delRow);
    // Footer totals toggle
    fd.showFooter = (fd.showFooter!==false);
    const footerTog=document.createElement('label'); footerTog.className='toggle';
    const ftIn=document.createElement('input'); ftIn.type='checkbox'; ftIn.checked=!!fd.showFooter;
    const ftTrack=document.createElement('span'); ftTrack.className='track'; const ftThumb=document.createElement('span'); ftThumb.className='thumb'; ftTrack.appendChild(ftThumb);
    const ftTxt=document.createElement('span'); ftTxt.textContent='Totals'; ftTxt.style.marginLeft='6px';
    ftIn.onchange=()=>{ fd.showFooter=ftIn.checked; try{ paintFooter(); }catch(e){} };
    footerTog.append(ftIn, ftTrack, ftTxt);
    footerTog.style.display='none'; tools.appendChild(footerTog);


    const tbl=document.createElement('table'); tbl.className='tbl';
    const stickyFooter=document.createElement('div'); stickyFooter.className='tbl-sticky-footer'; stickyFooter.style.display = (fd.showFooter===false ? 'none' : 'grid');

    const thead=document.createElement('thead'); const hr=document.createElement('tr');

    function colVisible(c){ try{ return !(c.logic && Array.isArray(c.logic.conditions) && c.logic.conditions.length) || passesLogic({logic:c.logic}); }catch{ return true; } }

    function paintHeader(){
      hr.innerHTML='';
      (fd.columns||[]).forEach(c=>{
        // respect column visibility if present
        let visible = true;
        try{ if(c.logic && Array.isArray(c.logic.conditions) && c.logic.conditions.length){ visible = passesLogic({logic:c.logic}); } }catch(e){ visible = true; }
        if(!visible) return;
        const th=document.createElement('th');
        const wrap=document.createElement('div'); wrap.className='hdr-wrap';
        const title=document.createElement('span'); title.textContent=c.label||c.key;
        wrap.appendChild(title);
        const fbtn=document.createElement('span'); fbtn.className='filter-icon'; fbtn.title='Filter'; fbtn.textContent='⏷';
        wrap.appendChild(fbtn);
        th.appendChild(wrap);
        if(c.align){ th.style.textAlign=c.align; }
        if(c.width){ th.style.width=c.width; }
        th.classList.add('sortable');
        if(fd.filters?.[c.key]) th.classList.add('filter-active');
        if(fd.sort && fd.sort.key===c.key){
          const arrow=document.createElement('span'); arrow.className='arrow'; arrow.textContent = fd.sort.dir==='desc' ? '▼' : '▲'; th.appendChild(arrow);
        }
        th.onclick=(ev)=>{ if(ev && ev.target && ev.target.closest && ev.target.closest('.filter-drop')) return;
        try{ if(fd && fd._openFilter && fd._openFilter.key===c.key){ fd._openFilter.cleanup(); return; } }catch{}
          if(!fd.sort || fd.sort.key!==c.key){ fd.sort={key:c.key, dir:'asc'}; }
          else if(fd.sort.dir==='asc'){ fd.sort.dir='desc'; }
          else{ fd.sort=null; }
          paintHeader();
          paintBody(true);
        };

        // Filter dropdown
        fbtn.onclick=(ev)=>{ ev.stopPropagation();
          try{ if(fd && fd._openFilter && fd._openFilter.key===c.key){ fd._openFilter.cleanup(); return; } }catch{}
          try{ if(fd && fd._openFilter && fd._openFilter.cleanup){ fd._openFilter.cleanup(); } }catch{}
const old = th.querySelector('.filter-drop'); if(old) old.remove();
          if(window.__openTableFilterDrop && window.__openTableFilterDrop.cleanup){ try{ window.__openTableFilterDrop.cleanup(); }catch{} }
          const drop=document.createElement('div'); drop.className='filter-drop portal';
          drop.style.visibility='hidden';
          drop.addEventListener('click', (e)=>e.stopPropagation());
          document.body.appendChild(drop);
          const ref={drop}; window.__openTableFilterDrop = ref; ref.cleanup = cleanup;
          try{ fd._openFilter = { key: c.key, cleanup }; }catch{}
          const head=document.createElement('div'); head.className='head';
          const ttl=document.createElement('div'); ttl.className='title'; ttl.textContent='Filter: '+(c.label||c.key);
          const x=document.createElement('button'); x.type='button'; x.type='button'; x.className='close'; x.type='button'; x.setAttribute('aria-label','Close'); x.textContent='✕';
          x.addEventListener('pointerdown',(e)=>{ e.preventDefault(); e.stopPropagation(); });
          x.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); cleanup(); });
          head.append(ttl,x); drop.appendChild(head);
          function place(){
            const r = fbtn.getBoundingClientRect();
            // measure after attached
            const dw = drop.offsetWidth || 240;
            const dh = drop.offsetHeight || 180;
            let left = Math.max(8, Math.min(r.left, window.innerWidth - dw - 8));
            let top = r.bottom + 4;
            if(top + dh > window.innerHeight){ top = Math.max(8, r.top - dh - 4); }
            drop.style.left = left + 'px';
            drop.style.top = top + 'px';
            drop.style.visibility='visible';
          }
          // place on next frame so sizes are computed
          requestAnimationFrame(place);
          const onScroll = ()=>place();
          window.addEventListener('scroll', onScroll, true);
          window.addEventListener('resize', onScroll);
          const t = (c.type||'text');
          function closeOnOutside(e) {

  const isEditable = (el)=> el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]'));
  if (isEditable(e.target)) return;
try{ if(!drop.contains(e.target) && e.target!==fbtn){ cleanup();
}
 }catch{ cleanup(); }
          }
          document.addEventListener('pointerdown', closeOnOutside, true);
          document.addEventListener('click', closeOnOutside, true);
          const onKey=(e)=>{ if(e.key==='Escape'){ cleanup(); } };
          document.addEventListener('keydown', onKey, true);
          function cleanup(){
            try{ if(fd && fd._openFilter && fd._openFilter.key===c.key){ fd._openFilter = null; } }catch{}
            try{ if(ref && ref.drop && ref.drop.parentNode){ ref.drop.parentNode.removeChild(ref.drop); } }catch{}
            document.removeEventListener('pointerdown', closeOnOutside, true);
            document.removeEventListener('click', closeOnOutside, true);
            window.removeEventListener('scroll', onScroll, true);
            window.removeEventListener('resize', onScroll);
            document.removeEventListener('keydown', onKey, true);
          }

          if(t==='number' || t==='integer' || t==='currency' || t==='percent'){
            const rMin=document.createElement('div'); rMin.className='row';
            const minI=document.createElement('input'); minI.type='number'; minI.placeholder='Min'; minI.value=(fd.filters?.[c.key]?.min ?? '');
            rMin.append(minI);
            const rMax=document.createElement('div'); rMax.className='row';
            const maxI=document.createElement('input'); maxI.type='number'; maxI.placeholder='Max'; maxI.value=(fd.filters?.[c.key]?.max ?? '');
            rMax.append(maxI);
            drop.append(rMin, rMax);
            const actions=document.createElement('div'); actions.className='actions';
            const apply=document.createElement('button'); apply.type='button'; apply.type='button'; apply.type='button'; apply.className='btn ghost'; apply.textContent='Apply';
            const clear=document.createElement('button'); clear.type='button'; clear.type='button'; clear.type='button'; clear.className='btn ghost'; clear.textContent='Clear';
            const closeBtnRange=document.createElement('button'); closeBtnRange.type='button'; closeBtnRange.type='button'; closeBtnRange.type='button'; closeBtnRange.className='btn ghost'; closeBtnRange.textContent='Close';
            actions.append(apply, clear, closeBtnRange); drop.append(actions);
            apply.onclick=()=>{ fd.filters[c.key] = {mode:'range', min:minI.value, max:maxI.value}; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
            clear.onclick=()=>{ delete fd.filters[c.key]; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
            closeBtnRange.onclick=()=>{ cleanup(); };
          }else if(t==='date' || t==='datetime'){
            const rMin=document.createElement('div'); rMin.className='row';
            const minI=document.createElement('input'); minI.type=(t==='date'?'date':'datetime-local'); minI.placeholder='From'; minI.value=(fd.filters?.[c.key]?.min ?? '');
            rMin.append(minI);
            const rMax=document.createElement('div'); rMax.className='row';
            const maxI=document.createElement('input'); maxI.type=(t==='date'?'date':'datetime-local'); maxI.placeholder='To'; maxI.value=(fd.filters?.[c.key]?.max ?? '');
            rMax.append(maxI);
            drop.append(rMin, rMax);
            const actions=document.createElement('div'); actions.className='actions';
            const apply=document.createElement('button'); apply.type='button'; apply.type='button'; apply.type='button'; apply.className='btn ghost'; apply.textContent='Apply';
            const clear=document.createElement('button'); clear.type='button'; clear.type='button'; clear.type='button'; clear.className='btn ghost'; clear.textContent='Clear';
            const closeBtnRange=document.createElement('button'); closeBtnRange.type='button'; closeBtnRange.type='button'; closeBtnRange.type='button'; closeBtnRange.className='btn ghost'; closeBtnRange.textContent='Close';
            actions.append(apply, clear, closeBtnRange); drop.append(actions);
            apply.onclick=()=>{ fd.filters[c.key] = {mode:'range', min:minI.value, max:maxI.value}; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
            clear.onclick=()=>{ delete fd.filters[c.key]; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
            closeBtnRange.onclick=()=>{ cleanup(); };
          }else if(t==='time'){
            const rMin=document.createElement('div'); rMin.className='row';
            const minI=document.createElement('input'); minI.type='time'; minI.placeholder='From'; minI.value=(fd.filters?.[c.key]?.min ?? '');
            rMin.append(minI);
            const rMax=document.createElement('div'); rMax.className='row';
            const maxI=document.createElement('input'); maxI.type='time'; maxI.placeholder='To'; maxI.value=(fd.filters?.[c.key]?.max ?? '');
            rMax.append(maxI);
            drop.append(rMin, rMax);
            const actions=document.createElement('div'); actions.className='actions';
            const apply=document.createElement('button'); apply.type='button'; apply.type='button'; apply.type='button'; apply.className='btn ghost'; apply.textContent='Apply';
            const clear=document.createElement('button'); clear.type='button'; clear.type='button'; clear.type='button'; clear.className='btn ghost'; clear.textContent='Clear';
            const closeBtnRange=document.createElement('button'); closeBtnRange.type='button'; closeBtnRange.type='button'; closeBtnRange.type='button'; closeBtnRange.className='btn ghost'; closeBtnRange.textContent='Close';
            actions.append(apply, clear, closeBtnRange); drop.append(actions);
            apply.onclick=()=>{ fd.filters[c.key] = {mode:'range', min:minI.value, max:maxI.value}; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
            clear.onclick=()=>{ delete fd.filters[c.key]; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
            closeBtnRange.onclick=()=>{ cleanup(); };
          }else{
            const search=document.createElement('input'); search.type='text'; search.placeholder='Search values';
            drop.append(search);
            const list=document.createElement('div'); list.className='vals'; drop.append(list);

            const all = ensureRowsForPreview();
const uniques = new Set();
const t = getColType(c);
function __toLabels(val){
  
  if(t==='signature'){
    const arr = Array.isArray(val) ? val : (val ? [val] : ['']);
    return arr.map(x=> (!!x && String(x).length>0) ? 'Signed' : '' );
  }
  if(t==='richtext'){
    const arr = Array.isArray(val) ? val : (val ? [val] : ['']);
    return arr.map(x => stripHtmlToText(x));
  }
if(t==='file'){
    const arr = Array.isArray(val) ? val : (val ? [val] : ['']);
    return arr.map(x=>{
      if(typeof x==='string'){ const nm=(x.split('/').pop()||x); return nm; }
      if(x && typeof x==='object'){ const nm=(x.name||x.url||''); return (nm.split('/').pop()||''); }
      return String(x??'');
    });
  }
  return Array.isArray(val) ? val.map(v=>String(v)) : [String(val??'')];
}
all.forEach(r=>{ __toLabels(r[c.key]).forEach(v=>uniques.add(v)); });
            const cur = new Set((fd.filters?.[c.key]?.values || []).map(String));

            function paintVals(){
              list.innerHTML='';
              const q = (search.value||'').toLowerCase();
              Array.from(uniques).sort().forEach(v=>{
                const label = v==='' ? '(empty)' : v;
                if(q && label.toLowerCase().indexOf(q)<0) return;
                const row=document.createElement('label'); row.className='row';
                const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=cur.has(v);
                cb.onchange=()=>{ if(cb.checked) cur.add(v); else cur.delete(v); };
                row.append(cb, document.createTextNode(label));
                list.appendChild(row);
              });
            }
            paintVals();
            search.oninput=paintVals;

            const actions=document.createElement('div'); actions.className='actions';
            const apply=document.createElement('button'); apply.type='button'; apply.type='button'; apply.type='button'; apply.className='btn ghost'; apply.textContent='Apply';
            const clear=document.createElement('button'); clear.type='button'; clear.type='button'; clear.type='button'; clear.className='btn ghost'; clear.textContent='Clear';
            actions.append(apply, clear); drop.append(actions);
            apply.onclick=()=>{ fd.filters[c.key] = {mode:'values', values:Array.from(cur)}; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
            clear.onclick=()=>{ delete fd.filters[c.key]; paintHeader(); paintBody(true); paintFooter(); paintFooter(); cleanup(); };
          }

          // drop is portaled to <body>
        };

        th.addEventListener('dblclick',(e)=>{ try{ if(fd && fd._openFilter && fd._openFilter.key===c.key){ e.stopPropagation(); fd._openFilter.cleanup(); } }catch{} });
        hr.appendChild(th);
      });
    }
    paintHeader();
    thead.appendChild(hr); tbl.appendChild(thead);
    const tbody=document.createElement('tbody');
    const tfoot=document.createElement('tfoot');

    // Filtering state + helpers
    fd.filters = fd.filters || {}; // { [key]: {mode:'values', values:[...]} | {mode:'range', min:'', max:''} }
    function getColType(c){
  try{
    const v = String((c&&c.type)||'text').toLowerCase();
    const map = { 'rich':'richtext', 'rich-text':'richtext', 'signaturepad':'signature', 'sig':'signature' };
    const t = map[v] || v;
    const allowed = new Set(['label','text','textarea','number','integer','currency','percent','date','datetime','time','email','url','tel','color','select','multiselect','file','rating','richtext','signature']);
    return allowed.has(t) ? t : 'text';
  }catch{ return 'text'; }
}
    function parseForFilter(t, v){
      if(v===undefined || v===null || v==='') return null;
      if(t==='number' || t==='integer' || t==='currency' || t==='percent'){
        const n = Number(v); return isNaN(n) ? null : n;
      }
      if(t==='date' || t==='datetime'){
        const d = Date.parse(String(v)); return isNaN(d) ? null : d;
      }
      if(t==='time'){
        const m = /^([0-2]?\d):([0-5]\d)(?::([0-5]\d))?$/.exec(String(v)); if(!m) return null;
        const hh=Number(m[1]), mm=Number(m[2]), ss=Number(m[3]||0);
        return hh*3600 + mm*60 + ss; // minutes since midnight
      }
      if(t==='checkbox'){ return !!v; }
      
      if(t==='richtext'){
        return stripHtmlToText(v).toLowerCase();
      }
if(Array.isArray(v)) return v.map(x=>String(x).toLowerCase());
      return String(v).toLowerCase();
    }
    function normalizeCandidate(t, v){
      if(v===undefined || v===null) return '';
      if(t==='file'){
        const normOne=(f)=>{
          if(f==null) return '';
          if(Array.isArray(f)) return f.map(normOne).flat();
          if(typeof f==='string'){
            const name = f.split('/').pop()||f;
            return String(name);
          }
          if(typeof f==='object'){
            const name = (f.name || f.url || '').split('/').pop();
            return String(name||'');
          }
          return String(f);
        };
        const out = normOne(v);
        return out;
      }

      if(t==='signature'){
        const arr = Array.isArray(v) ? v : (v ? [v] : ['']);
        return arr.map(x=> (!!x && String(x).length>0) ? 'Signed' : '' );
      }
      if(t==='richtext'){
        const arr = Array.isArray(v) ? v : (v ? [v] : ['']);
        return arr.map(x => stripHtmlToText(x));
      }
      if(Array.isArray(v)) return v.map(x=>String(x));
      return String(v);
    }
    function filterRows(rows){
      const fkeys = Object.keys(fd.filters||{});
      if(!fkeys.length) return rows;
      const cols = fd.columns||[];
      return rows.filter(r=>{
        for(const k of fkeys){
          const rule = fd.filters[k];
          const col = cols.find(c=>c.key===k); if(!col) continue;
          const t = getColType(col);
          const raw = r[k];
          if(rule.mode==='range'){
            const cand = parseForFilter(t, raw);
            const minv = parseForFilter(t, rule.min);
            const maxv = parseForFilter(t, rule.max);
            if(minv!==null && (cand===null || cand < minv)) return false;
            if(maxv!==null && (cand===null || cand > maxv)) return false;
          }else if(rule.mode==='values'){
            const cand = normalizeCandidate(t, raw);
            const set = new Set((rule.values||[]).map(String));
            if(Array.isArray(cand)){
              if(!cand.some(v=>set.has(v))) return false;
            }else{
              if(!set.has(String(cand))) return false;
            }
          }
        }
        return true;
      });
    }
    // Sorting state + helpers
    fd.sort = fd.sort || null; // {key, dir:'asc'|'desc'}
    function getTypedVal(col, v){
      if(v===undefined || v===null) return '';
      const t = (col.type||'text');
      if(t==='file'){
        const n = normalizeCandidate('file', v);
        const one = Array.isArray(n) ? (n[0]||'') : n;
        return String(one).toLowerCase();
      }
      if(t==='number' || t==='integer' || t==='currency' || t==='percent'){
        const n = Number(v); return isNaN(n) ? NaN : n;
      }
      if(t==='checkbox'){
        return !!v ? 1 : 0;
      }
      if(t==='date' || t==='datetime' || t==='time'){
        const tms = Date.parse(String(v));
        return isNaN(tms) ? 0 : tms;
      }
      if(Array.isArray(v)) return v.join(',').toLowerCase();
      return String(v).toLowerCase();
    }
    function sortRows(rows){
      if(!fd.sort || !fd.sort.key) return rows;
      const cols = fd.columns||[];
      const col = cols.find(c=>c.key===fd.sort.key);
      if(!col) return rows;
      const dir = fd.sort.dir==='desc' ? -1 : 1;
      const clone = rows.slice();
      clone.sort((a,b)=>{
        const va = getTypedVal(col, a[col.key]);
        const vb = getTypedVal(col, b[col.key]);
        if(va===vb) return 0;
        if(va===undefined || va==='' || (typeof va==='number' && isNaN(va))) return 1;
        if(vb===undefined || vb==='' || (typeof vb==='number' && isNaN(vb))) return -1;
        return va > vb ? dir : -dir;
      });
      return clone;
    }
    function newEmptyRow(){
      const obj={};
      (fd.columns||[]).forEach(c=>{ obj[c.key] = (c.type==='checkbox') ? false : ''; });
      return obj;
    }
    function ensureRowsForPreview(){
      if((fd.rows||[]).length===0 && fd.sampleRows>0){
        const tmp=[]; for(let i=0;i<fd.sampleRows;i++){ tmp.push(newEmptyRow()); }
        return tmp;
      }
      return fd.rows||[];
    }
    function paintBody(){
      tbody.innerHTML='';
      let rows=ensureRowsForPreview(); /*__APPLY_FILTER*/ rows = filterRows(rows);
      if(fd.rows && fd.rows.length && fd.sort){ rows = sortRows(rows); }
      function ensureBacking(){ if(!(fd.rows&&fd.rows.length)){ fd.rows = rows; } }
      rows.forEach((r,ri)=>{
        const tr=document.createElement('tr');
        (fd.columns||[]).forEach(c=>{
          if(!colVisible(c)) return;
          const td=document.createElement('td');
          if(c.align){ td.style.textAlign=c.align; }

          let ctrl;
          const t = (typeof getColType==='function' ? getColType(c) : (c.type||'text'));
          const setCommon=(el)=>{
          const attachLiveValidation=(ctrl,type)=>{
            const errEl=document.createElement('div'); errEl.className='cell-error'; errEl.style.display='none';
            errEl.style.color='var(--danger,#c00)'; errEl.style.fontSize='11px'; errEl.style.marginTop='4px';
            const placeErr=()=>{ try{ if(ctrl.parentNode && !errEl.parentNode){ ctrl.parentNode.appendChild(errEl);} }catch(e){} };
            function message(val){
              const s=String(val||'').trim();
              if(!s) return c.required ? 'This field is required.' : '';
              if(type==='email'){ return (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)) ? '' : 'Invalid email address.'; }
              if(type==='url'){ try{ const u=new URL(s); if(!(u.protocol==='http:'||u.protocol==='https:')) throw 0; return ''; }catch(e){ return 'Invalid URL.'; } }
              if(type==='tel'){
                if(c.pattern){ try{ const re=new RegExp(c.pattern); if(!re.test(s)) return 'Invalid phone number.'; }catch(e){} }
                else { if(!/^[+()\d\s\-]{6,}$/.test(s)) return 'Invalid phone number.'; }
                return '';
              }
              return '';
            }
            function sync(){
              const m=message(ctrl.value);
              if(ctrl.setCustomValidity) ctrl.setCustomValidity(m||'');
              ctrl.classList.toggle('invalid', !!m);
              placeErr(); errEl.textContent = m||''; errEl.style.display = m ? '' : 'none';
              if(m){ ctrl.setAttribute('aria-invalid','true'); } else { ctrl.removeAttribute('aria-invalid'); }
            }
            ctrl.addEventListener('input', sync);
            ctrl.addEventListener('blur', sync);
            setTimeout(sync, 0);
          }
      paintFooter();;

            if(c.pattern && el.setAttribute) el.setAttribute('pattern', c.pattern);
            if(c.min!==undefined && c.min!==''){ try{ el.min = c.min; }catch{} }
            if(c.max!==undefined && c.max!==''){ try{ el.max = c.max; }catch{} }
            el.required = !!c.required;
          };
          if(t==='label'){
            ctrl=document.createElement('span'); ctrl.textContent = (r[c.key]??'') || (c.static||'');
          }else if(t==='checkbox'){
            ctrl=document.createElement('input'); ctrl.type='checkbox'; ctrl.checked=!!r[c.key];
            ctrl.onchange=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.checked; try{ paintFooter(); }catch(e){} try{ paintFooter(); }catch(e){} };

          }else if(t==='rating'){
            const current = Number(r[c.key] ?? 0);
            const cell = renderTableRatingCell(fd, ri, c, current);
            ctrl = cell;
}else if(t==='textarea'){
            ctrl=document.createElement('textarea'); ctrl.className='input'; ctrl.rows=2; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='integer'){
            ctrl=document.createElement('input'); ctrl.type='number'; ctrl.step='1'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='currency'){
            ctrl=document.createElement('input'); ctrl.type='number'; ctrl.step = (c.decimals??2) > 0 ? '0.' + '0'.repeat((c.decimals??2)-1) + '1' : '1'; ctrl.placeholder=(c.prefix||''); ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='percent'){
            ctrl=document.createElement('input'); ctrl.type='number'; ctrl.min = c.min ?? 0; ctrl.max = c.max ?? 100; ctrl.step = (c.decimals??2) > 0 ? '0.' + '0'.repeat((c.decimals??2)-1) + '1' : '1'; ctrl.placeholder=(c.suffix||'%'); ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='number'){
            ctrl=document.createElement('input'); ctrl.type='number'; ctrl.step = (c.decimals??2) > 0 ? '0.' + '0'.repeat((c.decimals??2)-1) + '1' : '1'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='date'){
            ctrl=document.createElement('input'); ctrl.type='date'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='datetime'){
            ctrl=document.createElement('input'); ctrl.type='datetime-local'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='time'){
            ctrl=document.createElement('input'); ctrl.type='time'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='email'){
            ctrl=document.createElement('input'); ctrl.type='email'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} }
            attachLiveValidation(ctrl,'email');;
          }else if(t==='url'){
            ctrl=document.createElement('input'); ctrl.type='url'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} }
            attachLiveValidation(ctrl,'url');;
          }else if(t==='tel'){
            ctrl=document.createElement('input'); ctrl.type='tel'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} }
            attachLiveValidation(ctrl,'tel');;
          }else if(t==='color'){
            ctrl=document.createElement('input'); ctrl.type='color'; ctrl.value=r[c.key]??'#000000';
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          
}else if(t==='richtext'){
            const container = document.createElement('div');
            ctrl = container;
            // Modal-based rich text editor; preview + "Edit…" button
            renderRichtextCell(container, r, c, {
              onChange: (html) => { ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key] = html; try{ paintFooter(); }catch(e){} }
            });
          }
          else if(t==='signature'){
            const box=document.createElement('div'); box.style.display='flex'; box.style.alignItems='center'; box.style.gap='8px';
            const img=document.createElement('img'); img.alt='Signature'; img.style.maxHeight='36px'; img.style.maxWidth='160px'; img.style.borderRadius='4px'; img.style.border='1px solid var(--line)';
            const val=r[c.key]??''; if(val && /^data:image\//.test(String(val))){ img.src=val; } else { img.style.display='none'; }
            const draw=document.createElement('button'); draw.type='button'; draw.type='button'; draw.type='button'; draw.className='btn ghost'; draw.textContent= val ? 'Redraw' : 'Draw';
            draw.onclick = (e)=>{ try{ e && e.preventDefault(); e && e.stopPropagation(); }catch{} openSignatureCellModal(r[c.key]??'', (data)=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=data; try{ paintFooter(); }catch(e){} img.src = data; img.style.display=''; img.style.display=''; }); };
            ctrl = box; box.append(img, draw);
          }
else if(t==='richtext'){
            const container = document.createElement('div');
            ctrl = container;
            // Modal-based rich text editor; preview + "Edit…" button
            renderRichtextCell(container, r, c, {
              onChange: (html) => { ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key] = html; try{ paintFooter(); }catch(e){} }
            });
          }else if(t==='signature'){
            const box=document.createElement('div'); box.style.display='flex'; box.style.alignItems='center'; box.style.gap='8px';
            const img=document.createElement('img'); img.alt='Signature'; img.style.maxHeight='36px'; img.style.maxWidth='160px'; img.style.borderRadius='4px'; img.style.border='1px solid var(--line)';
            const val=r[c.key]??''; if(val && /^data:image\//.test(String(val))){ img.src=val; }
            const draw=document.createElement('button'); draw.type='button'; draw.type='button'; draw.type='button'; draw.className='btn ghost'; draw.textContent= val ? 'Redraw' : 'Draw';
            draw.onclick = (e)=>{ try{ e && e.preventDefault(); e && e.stopPropagation(); }catch{} openSignatureCellModal(r[c.key]??'', (data)=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=data; try{ paintFooter(); }catch(e){} img.src = data; img.style.display=''; }); };
            ctrl = box; box.append(img, draw);
    
}else if(t==='richtext'){
            const container = document.createElement('div');
            ctrl = container;
            // Modal-based rich text editor; preview + "Edit…" button
            renderRichtextCell(container, r, c, {
              onChange: (html) => { ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key] = html; try{ paintFooter(); }catch(e){} }
            });
          }
          else if(t==='signature'){
            const box=document.createElement('div'); box.style.display='flex'; box.style.alignItems='center'; box.style.gap='8px';
            const img=document.createElement('img'); img.alt='Signature'; img.style.maxHeight='36px'; img.style.maxWidth='160px'; img.style.borderRadius='4px'; img.style.border='1px solid var(--line)';
            const val=r[c.key]??''; if(val && /^data:image\//.test(String(val))){ img.src=val; } else { img.style.display='none'; }
            const draw=document.createElement('button'); draw.type='button'; draw.type='button'; draw.type='button'; draw.className='btn ghost'; draw.textContent= val ? 'Redraw' : 'Draw';
            draw.onclick = (e)=>{ try{ e && e.preventDefault(); e && e.stopPropagation(); }catch{} openSignatureCellModal(r[c.key]??'', (data)=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=data; try{ paintFooter(); }catch(e){} img.src = data; img.style.display=''; img.style.display=''; }); };
            ctrl = box; box.append(img, draw);
          }
else if(t==='richtext'){
            const container = document.createElement('div');
            ctrl = container;
            // Modal-based rich text editor; preview + "Edit…" button
            renderRichtextCell(container, r, c, {
              onChange: (html) => { ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key] = html; try{ paintFooter(); }catch(e){} }
            });
          }
          else if(t==='signature'){
            const box=document.createElement('div'); box.style.display='flex'; box.style.alignItems='center'; box.style.gap='8px';
            const img=document.createElement('img'); img.alt='Signature'; img.style.maxHeight='36px'; img.style.maxWidth='160px'; img.style.borderRadius='4px'; img.style.border='1px solid var(--line)';
            const val=r[c.key]??''; if(val && /^data:image\//.test(String(val))){ img.src=val; } else { img.style.display='none'; }
            const draw=document.createElement('button'); draw.type='button'; draw.type='button'; draw.type='button'; draw.className='btn ghost'; draw.textContent= val ? 'Redraw' : 'Draw';
            draw.onclick = (e)=>{ try{ e && e.preventDefault(); e && e.stopPropagation(); }catch{} openSignatureCellModal(r[c.key]??'', (data)=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=data; try{ paintFooter(); }catch(e){} img.src = data; img.style.display=''; img.style.display=''; }); };
            ctrl = box; box.append(img, draw);
          }
else if(t==='richtext'){
            const container = document.createElement('div');
            ctrl = container;
            // Modal-based rich text editor; preview + "Edit…" button
            renderRichtextCell(container, r, c, {
              onChange: (html) => { ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key] = html; try{ paintFooter(); }catch(e){} }
            });
          }
          else if(t==='signature'){
            const box=document.createElement('div'); box.style.display='flex'; box.style.alignItems='center'; box.style.gap='8px';
            const img=document.createElement('img'); img.alt='Signature'; img.style.maxHeight='36px'; img.style.maxWidth='160px'; img.style.borderRadius='4px'; img.style.border='1px solid var(--line)';
            const val=r[c.key]??''; if(val && /^data:image\//.test(String(val))){ img.src=val; } else { img.style.display='none'; }
            const draw=document.createElement('button'); draw.type='button'; draw.type='button'; draw.type='button'; draw.className='btn ghost'; draw.textContent= val ? 'Redraw' : 'Draw';
            draw.onclick = (e)=>{ try{ e && e.preventDefault(); e && e.stopPropagation(); }catch{} openSignatureCellModal(r[c.key]??'', (data)=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=data; try{ paintFooter(); }catch(e){} img.src = data; img.style.display=''; img.style.display=''; }); };
            ctrl = box; box.append(img, draw);
          }
else if(t==='select'){

            ctrl=document.createElement('select'); ctrl.className='select';
            (Array.isArray(c.options)?c.options:[]).forEach(opt=>{ const o=document.createElement('option'); o.value=o.textContent=opt; ctrl.appendChild(o); });
            ctrl.value=r[c.key]??'';
            ctrl.onchange=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }else if(t==='multiselect'){
            ctrl=document.createElement('select'); ctrl.className='select'; ctrl.multiple=true;
            const opts=(Array.isArray(c.options)?c.options:[]);
            opts.forEach(opt=>{ const o=document.createElement('option'); o.value=o.textContent=opt; ctrl.appendChild(o); });
            const cur=Array.isArray(r[c.key])? r[c.key] : (r[c.key] ? String(r[c.key]).split(';').map(v=>v.trim()).filter(Boolean) : []);
            Array.from(ctrl.options).forEach(o=>{ o.selected = cur.includes(o.value); });
            ctrl.onchange=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=Array.from(ctrl.selectedOptions).map(o=>o.value); try{ paintFooter(); }catch(e){} };

          }else if(t==='file'){
            ctrl = createTableFileUploader(c, r, (next)=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=next; try{ paintFooter(); }catch(e){} });
          }else if(t==='rating'){
            ctrl=document.createElement('input'); ctrl.type='range'; ctrl.min='0'; ctrl.max=String(c.maxRating||5); ctrl.step='1'; ctrl.value=String(r[c.key]??0);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=Number(ctrl.value); try{ paintFooter(); }catch(e){} };
          }else{
            ctrl=document.createElement('input'); ctrl.type='text'; ctrl.value=r[c.key]??''; setCommon(ctrl);
            ctrl.oninput=()=>{ ensureBacking(); try{ paintFooter(); }catch(e){}  r[c.key]=ctrl.value; try{ paintFooter(); }catch(e){} };
          }
ctrl.id='f_'+fd.id+'_r'+ri+'_'+c.key;
          td.appendChild(ctrl); tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
    
    function paintFooter(){
      try{
        if(fd && fd.showFooter===false){ try{ tfoot.innerHTML=''; }catch{}; try{ if(typeof stickyFooter!=='undefined' && stickyFooter){ stickyFooter.innerHTML=''; stickyFooter.style.display='none'; } }catch{}; return; }
        tfoot.innerHTML='';
        const tr=document.createElement('tr');
        let rows=ensureRowsForPreview(); rows = filterRows(rows);
        const visCols = (fd.columns||[]).filter(colVisible);
        function valIsFilled(v){
          if(Array.isArray(v)) return v.some(x=>x!=null && String(x).trim().length>0);
          return v!=null && String(v).trim().length>0;
        }
        function toNum(v){ const n=Number(v); return isFinite(n) ? n : null; }
        function fmtNum(n,c){
          try{
        if(fd && fd.showFooter===false){ try{ tfoot.innerHTML=''; }catch{}; try{ if(typeof stickyFooter!=='undefined' && stickyFooter){ stickyFooter.innerHTML=''; stickyFooter.style.display='none'; } }catch{}; return; }
            const dec = (c.decimals!=null) ? Number(c.decimals) : (c.type==='integer'?0:2);
            const s = n.toFixed(Math.max(0,Math.min(8,isFinite(dec)?dec:2)));
            const pre = c.prefix||''; const suf = c.suffix||'';
            return pre + s + suf;
          }catch{ return String(n); }
        }
        function textNorm(t, x){
          if(t==='richtext') return stripHtmlToText(x);
          if(t==='file'){
            if(typeof x==='string'){ return (x.split('/').pop()||x); }
            if(x && typeof x==='object'){ const nm=(x.name||x.url||''); return (nm.split('/').pop()||''); }
          }
          if(t==='signature') return (x && String(x).length>0) ? 'Signed' : '';
          return String(x??'');
        }
        visCols.forEach((c, idx)=>{
          const td=document.createElement('td'); td.className='agg-cell';
          const t = (typeof getColType==='function' ? getColType(c) : (c.type||'text'));
          const agg = (c.agg||'').toLowerCase();
          const showAgg = (c.showAgg!==false);
          if(!showAgg){ if(idx===0){ out=''; } }
          let out = (idx===0 ? ('# '+rows.length) : '');
          if(c.showAgg===false){ out=''; }
          if(!agg || agg==='none'){ td.textContent=out; tr.appendChild(td); return; }
          if(agg==='sum'){
            let sum=0; let has=false;
            for(const r of rows){ const n=toNum(r[c.key]); if(n!=null){ sum+=n; has=true; } }
            out += (out? ' | ' : '') + (has ? fmtNum(sum,c) : '');
          }else if(agg==='avg'){
            const nums = rows.map(r=>toNum(r[c.key])).filter(x=>x!=null);
            const avg = nums.length ? nums.reduce((a,b)=>a+b,0)/nums.length : null;
            out += (out? ' | ' : '') + (avg!=null ? fmtNum(avg,c) : '');
          }else if(agg==='min' || agg==='max'){
            const nums = rows.map(r=>toNum(r[c.key])).filter(x=>x!=null);
            if(nums.length){
              const val = (agg==='min') ? Math.min(...nums) : Math.max(...nums);
              out += (out? ' | ' : '') + fmtNum(val,c);
            }
          }else if(agg==='count'){
            let cnt=0;
            if(t==='checkbox'){ for(const r of rows){ if(!!r[c.key]) cnt++; } }
            else if(t==='signature'){ for(const r of rows){ const v=r[c.key]; if(Array.isArray(v)) cnt+=v.filter(x=>x && String(x).length>0).length; else if(v && String(v).length>0) cnt++; } }
            else{ for(const r of rows){ if(valIsFilled(r[c.key])) cnt++; } }
            out += (out? ' | ' : '') + String(cnt);
          }else if(agg==='distinct'){
            const set = new Set();
            for(const r of rows){
              const v=r[c.key];
              if(Array.isArray(v)){ v.forEach(x=>set.add(textNorm(t,x))); }
              else{ set.add(textNorm(t,v)); }
            }
            set.delete(''); out += (out? ' | ' : '') + String(set.size);
          }
          td.textContent = out;
          tr.appendChild(td);
        });
        tfoot.appendChild(tr);
        try{
        if(fd && fd.showFooter===false){ try{ tfoot.innerHTML=''; }catch{}; try{ if(typeof stickyFooter!=='undefined' && stickyFooter){ stickyFooter.innerHTML=''; stickyFooter.style.display='none'; } }catch{}; return; }
          if(stickyFooter){
            stickyFooter.innerHTML='';
            const visCols = (fd.columns||[]).filter(colVisible);
            stickyFooter.style.display = visCols.length ? 'grid' : 'none';
            stickyFooter.style.gridTemplateColumns = 'repeat(' + visCols.length + ', minmax(80px, 1fr))';
            const cells = tfoot.querySelectorAll('td');
            cells.forEach(td => {
              const div=document.createElement('div');
              div.className='agg-cell';
              div.textContent = td.textContent||'';
              stickyFooter.appendChild(div);
            });
          }
        }catch{}
      }catch(e){ /* noop */ }
    }
    

    addRow.onclick=()=>{ if(!demoMode){ if(!(fd.rows&&fd.rows.length)){ fd.rows=[]; } (fd.rows||[]).push(newEmptyRow()); paintBody(); paintFooter(); } else toast('Demo mode: editing disabled'); };
    delRow.onclick=()=>{ if(!demoMode){ if((fd.rows||[]).length){ fd.rows.pop(); paintBody(); paintFooter(); } } else toast('Demo mode: editing disabled'); };

    paintBody(); paintFooter();
    wrap.appendChild(tools);
    
    wrap.appendChild(stickyFooter);
wrap.appendChild(tbl);
    tbl.appendChild(tbody);
    tbl.appendChild(tfoot);
    return wrap;
  }
if(t==='datetime'){
    const wrap=document.createElement('div'); wrap.style.position='relative'; wrap.style.width='100%';
    const i=document.createElement('input'); i.type='text'; i.className='input dtp-input'; i.placeholder=fd.placeholder||'YYYY-MM-DD HH:MM:SS'; i.readOnly=true; i.id='f_'+fd.id;
    set(i); if(fd.default) i.value=fd.default;
    const ico=document.createElement('button'); ico.type='button'; ico.type='button'; ico.type='button'; ico.className='btn ghost'; ico.textContent='🕒'; ico.style.height='var(--ctrl-h)';
    ico.onclick=()=>openDTP(i);
    i.onclick=()=>openDTP(i);
    wrap.append(i,ico);
    return wrap;
  }
  if(t==='textarea'){ const ta=document.createElement('textarea'); set(ta); ta.id='f_'+fd.id; return ta; }





  if(t==='file'){
    // Persist & settings
    fd.files = Array.isArray(fd.files) ? fd.files : [];
    fd.accept = fd.accept || "image/*,application/pdf,text/html";
    fd.maxSizeMB = (typeof fd.maxSizeMB==='number' && fd.maxSizeMB>0) ? fd.maxSizeMB : 20;
    fd.maxFiles = (typeof fd.maxFiles==='number' && fd.maxFiles>=0) ? fd.maxFiles : 0;
    fd.multiple = (typeof fd.multiple==='boolean') ? fd.multiple : true;
    const files = fd.files;

    const wrap = document.createElement('div');
    const i = document.createElement('input'); i.type='file'; i.multiple=!!fd.multiple; i.accept=fd.accept; i.style.display='none';
    const btn = document.createElement('button'); btn.type='button'; btn.type='button'; btn.type='button'; btn.className='btn'; btn.textContent='Manage files ('+(files.length||0)+')';
    wrap.append(btn, i);

    function updateBtn(){ btn.textContent = 'Manage files ('+files.length+')'; }
    function addFile(f){
      const url = URL.createObjectURL(f);
      const kind = f.type.startsWith('image/') ? 'image' : (f.type==='application/pdf' ? 'pdf' : 'html');
      files.push({name:f.name, type:f.type, size:f.size, url, kind});
      updateBtn();
    }
    function handleFiles(list){ Array.from(list||[]).forEach(addFile); updateBtn(); }
    function onUpdate(){ updateBtn(); }

    btn.onclick = ()=> openFileManager({accept: fd.accept, maxSizeMB: fd.maxSizeMB, maxFiles: fd.maxFiles, multiple: fd.multiple, htmlSandbox: true}, files, onUpdate);
    i.onchange = ()=>{ if(i.files && i.files.length){ Array.from(i.files).forEach(addFile); openFileManager({accept: fd.accept, maxSizeMB: fd.maxSizeMB, maxFiles: fd.maxFiles, multiple: fd.multiple, htmlSandbox: true}, files, onUpdate); } };

    wrap.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    wrap.addEventListener('drop', (e)=>{ e.preventDefault(); if(e.dataTransfer && e.dataTransfer.files){ Array.from(e.dataTransfer.files).forEach(addFile); openFileManager({accept: fd.accept, maxSizeMB: fd.maxSizeMB, maxFiles: fd.maxFiles, multiple: fd.multiple, htmlSandbox: true}, files, onUpdate); } });

    return wrap;
  }

  if(t==='range'){ const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='8px'; const s=document.createElement('input'); s.type='range'; if(fd.min) s.min=fd.min; if(fd.max) s.max=fd.max; if(fd.step) s.step=fd.step; const out=document.createElement('span'); out.className='hint'; s.value=fd.default||s.min||0; out.textContent=s.value; s.oninput=()=>out.textContent=s.value; wrap.append(s,out); return wrap; }

  if(t==='dropdown' || t==='multiselect'){
    const wrap=document.createElement('div');
    const sel=document.createElement('select'); sel.className='select'; sel.multiple = (t==='multiselect');
    function syncSelect(){
      sel.innerHTML='';
      (fd.options||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }
    syncSelect();
    sel.id='f_'+fd.id; wrap.appendChild(sel);
    if(!demoMode){
      const chips=document.createElement('div'); chips.className='opt-chips';
      function renderChips(){
        chips.innerHTML='';
        (fd.options||[]).forEach((v,idx)=>{
          const chip=document.createElement('span'); chip.className='opt-chip';
          const txt=document.createElement('span'); txt.className='txt'; txt.contentEditable='true'; txt.textContent=v;
          txt.onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); txt.blur(); } };
          txt.onblur=()=>{ const nv=(txt.textContent||'').trim(); if(nv && nv!==v){ fd.options[idx]=nv; syncSelect(); } else { txt.textContent=fd.options[idx]||v; } };
          const rm=document.createElement('button'); rm.type='button'; rm.type='button'; rm.type='button'; rm.className='rm'; rm.title='Remove'; rm.textContent='×';
          rm.onclick=()=>{ fd.options.splice(idx,1); renderChips(); syncSelect(); };
          chip.append(txt, rm); chips.appendChild(chip);
        });
        const add=document.createElement('button'); add.type='button'; add.type='button'; add.type='button'; add.className='btn ghost opt-add'; add.textContent='+ Add option';
        add.onclick=()=>{ fd.options = Array.isArray(fd.options)?fd.options:[]; fd.options.push('Option '+(fd.options.length+1)); renderChips(); syncSelect(); };
        chips.appendChild(add);
      }
      renderChips();
      wrap.appendChild(chips);
    }
    return wrap;
  }


  if(t==='radio' || t==='checkboxes'){
    const wrap=document.createElement('div');
    const row=document.createElement('div'); row.className='inline'; row.style.gap='12px'; row.style.flexWrap='wrap';
    function syncGroup(){
      row.innerHTML='';
      (fd.options||[]).forEach(v=>{
        const lab=document.createElement('label'); lab.className='inline';
        const inp=document.createElement('input'); inp.type=(t==='radio')?'radio':'checkbox'; inp.name='f_'+fd.id;
        const sp=document.createElement('span'); sp.textContent=v;
        lab.append(inp, sp); row.appendChild(lab);
      });
    }
    syncGroup();
    wrap.appendChild(row);
    if(!demoMode){
      const chips=document.createElement('div'); chips.className='opt-chips';
      function renderChips(){
        chips.innerHTML='';
        (fd.options||[]).forEach((v,idx)=>{
          const chip=document.createElement('span'); chip.className='opt-chip';
          const txt=document.createElement('span'); txt.className='txt'; txt.contentEditable='true'; txt.textContent=v;
          txt.onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); txt.blur(); } };
          txt.onblur=()=>{ const nv=(txt.textContent||'').trim(); if(nv && nv!==v){ fd.options[idx]=nv; syncGroup(); } else { txt.textContent=fd.options[idx]||v; } };
          const rm=document.createElement('button'); rm.type='button'; rm.type='button'; rm.type='button'; rm.className='rm'; rm.title='Remove'; rm.textContent='×';
          rm.onclick=()=>{ fd.options.splice(idx,1); renderChips(); syncGroup(); };
          chip.append(txt, rm); chips.appendChild(chip);
        });
        const add=document.createElement('button'); add.type='button'; add.type='button'; add.type='button'; add.className='btn ghost opt-add'; add.textContent='+ Add option';
        add.onclick=()=>{ fd.options = Array.isArray(fd.options)?fd.options:[]; fd.options.push('Option '+(fd.options.length+1)); renderChips(); syncGroup(); };
        chips.appendChild(add);
      }
      renderChips();
      wrap.appendChild(chips);
    }
    return wrap;
  }

  if(t==='toggle'){
    const lab=document.createElement('label'); lab.className='toggle';
    const inp=document.createElement('input'); inp.type='checkbox'; if(String(fd.default)==='true') inp.checked=true;
    const track=document.createElement('span'); track.className='track';
    const thumb=document.createElement('span'); thumb.className='thumb'; track.appendChild(thumb);
    lab.append(inp, track);
    if(fd.placeholder){ const txt=document.createElement('span'); txt.textContent=fd.placeholder; txt.style.fontWeight='600'; lab.appendChild(txt); }
    return lab;
  }
    if(t==='paragraph'){
    const wrap=document.createElement('div');
    wrap.className='rich-wrap';
    const bar=document.createElement('div');
    bar.style.display='flex'; bar.style.gap='6px'; bar.style.flexWrap='wrap'; bar.style.marginBottom='6px';
    function mk(cmd,txt){ const b=document.createElement('button'); b.type='button'; b.type='button'; b.type='button'; b.className='btn ghost'; b.textContent=txt; b.onclick=()=>{ document.execCommand(cmd,false,null); host.focus(); updateVisibility(); }; return b; }
    bar.append(mk('bold','B'), mk('italic','I'), mk('underline','U'), mk('insertUnorderedList','• List'));
    const host=document.createElement('div'); host.contentEditable='true'; host.id='f_'+fd.id;
    host.style.minHeight='120px'; host.style.border='1px solid var(--line)'; host.style.borderRadius='8px'; host.style.padding='10px'; host.style.background='#fff';
    host.innerHTML = fd.default || '';
    host.addEventListener('input', ()=>{ try{ updateVisibility(); }catch{} });
    wrap.append(bar, host);
    return wrap;
  }
  const i=document.createElement('input'); i.type='text'; set(i); i.id='f_'+fd.id; return i;
}

/* =============== Inspector (Basics · Validation · Visibility) =============== */
const insp=$('#inspector'), inspTitle=$('#inspTitle'), inspBody=$('#inspBody'), inspTabs=$('#inspTabs');
const inspClose=$('#inspClose'), inspDone=$('#inspDone'), inspUp=$('#inspUp'), inspDown=$('#inspDown'), inspDup=$('#inspDup'), inspDel=$('#inspDel');
inspClose.onclick=()=>insp.classList.remove('open'); inspDone.onclick=()=>insp.classList.remove('open');

/* Close inspector when clicking outside */
document.addEventListener('mousedown', (e)=>{
  if(!insp.classList.contains('open')) return;
  const clickedInside = insp.contains(e.target);
  const isEditButton = e.target.closest('.icon-btn') || e.target.closest('.stool'); // edit buttons
  if(!clickedInside && !isEditButton){ insp.classList.remove('open'); }
});

function openInspector(id){
  if(demoMode) return;
  const item=getItem(); if(!item) return;
  function find(root,id,p=null){ if(root && root.id===id) return {node:root,parent:p}; if(root && root.children){ for(const c of root.children){ const r=find(c,id,root); if(r) return r; } } if(root && root.columns){   for(const col of root.columns){     if(col && col.id===id) return {node:col,parent:root};     if(col && col.children){ for(const ch of col.children){ const r=find(ch,id,col); if(r) return r; } }   } } return null; }
  const hit=find(item.root,id); if(!hit) return; const node=hit.node;
  selectedNodeId=id; highlightSelected();

  inspTitle.textContent = node.type==='field'?'Field':node.type==='section'?'Section':'Divider';
  inspTabs.innerHTML=''; inspBody.innerHTML='';

  const tabs = node.type==='field'
    ? [{key:'basics',label:'Basics'},{key:'validation',label:'Validation'},{key:'visibility',label:'Visibility'}]
    : [{key:'basics',label:'Basics'}];

  tabs.forEach((t,i)=>{
    const b=document.createElement('button'); b.type='button'; b.type='button'; b.className='insp-tab'+(i===0?' active':''); b.textContent=t.label; b.onclick=()=>{ $$('.insp-tab',inspTabs).forEach(x=>x.classList.remove('active')); b.classList.add('active'); paintInspectorPane(t.key,node,hit); };
    inspTabs.appendChild(b);
  });
  insp.classList.add('open');
  paintInspectorPane(tabs[0].key,node,hit);

  // actions
  inspDel.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } if(!confirm('Delete this item?')) return; if(!hit.parent) return; hit.parent.children = hit.parent.children.filter(x=>x.id!==node.id); render(); insp.classList.remove('open'); };
  inspDup.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } const copy=JSON.parse(JSON.stringify(node)); (function ids(n){ n.id=uid(); if(n.children) n.children.forEach(ids); })(copy); hit.parent.children.splice(hit.parent.children.indexOf(node)+1,0,copy); render(); };
  inspUp.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } const idx=hit.parent.children.indexOf(node); if(idx>0){ [hit.parent.children[idx-1],hit.parent.children[idx]]=[hit.parent.children[idx],hit.parent.children[idx-1]]; render(); } };
  inspDown.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } const idx=hit.parent.children.indexOf(node); if(idx<hit.parent.children.length-1){ [hit.parent.children[idx+1],hit.parent.children[idx]]=[hit.parent.children[idx],hit.parent.children[idx+1]]; render(); } };
}
function renderTableRatingCell(node, rowIndex, col, value){
  const wrap = document.createElement('div'); wrap.className='rating-field';
  const max = Math.max(1, Math.min(10, Number(col.maxRating||node.maxRating||5)));
  const current = Math.max(0, Math.min(max, Number(value||0)));
  function paint(val){
    const stars = wrap.querySelectorAll('.star');
    stars.forEach(s => { const v = Number(s.dataset.value||0); s.classList.toggle('active', v <= val); });
  }
  for(let i=1;i<=max;i++){
    const star = document.createElement('span');
    star.className='star'; star.textContent='★'; star.dataset.value=String(i);
    star.onclick=()=>{
      const v = Number(star.dataset.value||0);
      node.rows = Array.isArray(node.rows) ? node.rows : [];
      const r = node.rows[rowIndex] || (node.rows[rowIndex] = {});
      r[col.key] = v;
      paint(v);
    };
    wrap.appendChild(star);
  }
  paint(current);
  return wrap;
}

function highlightSelected(){ $$('.fcard,.section,.divider-card').forEach(el=> el.classList.toggle('selected', el.dataset.nid===selectedNodeId)); }

/* === Live label updater (keep caret) === */
function updateFieldLabelText(fieldId, text){
  const span = document.querySelector(`.fcard[data-nid="${fieldId}"] .label-editable`);
  if(span) span.textContent = text || '';
}

/* small UI helpers for inspector rows */
function row(lbl, el){ const r=document.createElement('div'); r.className='insp-row'; const l=document.createElement('div'); l.className='label'; l.textContent=lbl; r.append(l,el); return r; }
function input(val,on){ const i=document.createElement('input'); i.className='input'; i.value=val??''; i.oninput=()=>on(i.value); return i; }
function num(val,on){ const i=document.createElement('input'); i.className='input'; i.type='number'; i.value=val??''; i.oninput=()=>on(i.value); return i; }
function select(opts,val,on){ const s=document.createElement('select'); s.className='select'; opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; s.appendChild(op);}); s.value=val; s.onchange=()=>on(s.value); return s; }
function checkbox(label,checked,on){ const w=document.createElement('label'); w.className='inline'; const c=document.createElement('input'); c.type='checkbox'; c.checked=!!checked; c.onchange=()=>on(c.checked); const t=document.createElement('span'); t.textContent=' '+label; w.append(c,t); return w; }
function wrap(...els){ const d=document.createElement('div'); d.className='inline'; els.forEach(e=>d.appendChild(e)); return d; }
function newChip(txt){ const c=document.createElement('span'); c.className='chip'; c.textContent=txt; return c; }

function paintInspectorPane(which,node,hit){
  inspBody.innerHTML='';
  if(which==='basics'){
    if(node.type==='field'){
      // Field label input — no re-render while typing
      (() => {
        const el = input(node.name, v => { node.name = v; updateFieldLabelText(node.id, v); });
        el.addEventListener('blur', () => { render(); openInspector(node.id); });
        inspBody.append(row('Label', el));
      })();

      inspBody.append(row('Type', select(['text','textarea','number','email','tel','url','password','date','time','datetime','color','dropdown','multiselect','radio','checkboxes','toggle','range','file','rating','button','richtext', 'table'], node.ftype, v=>{node.ftype=v; if(['dropdown','multiselect','radio','checkboxes'].includes(v) && (!node.options||!node.options.length)) node.options=['Option 1','Option 2','Option 3']; render(); openInspector(node.id);})))
      if(node.ftype==='table' && (!Array.isArray(node.columns) || !node.columns.length)){
        node.columns=[{key:'col1',label:'Column 1'},{key:'col2',label:'Column 2'}];
        node.sampleRows = 3;
      }
    ;

      if(node.ftype==='table'){
        node.columns = Array.isArray(node.columns) && node.columns.length ? node.columns : [{key:'col1',label:'Column 1',type:'text',align:'left',width:''},{key:'col2',label:'Column 2',type:'text',align:'left',width:''}];
        node.sampleRows = Number(node.sampleRows)||3;
        node.rows = Array.isArray(node.rows) ? node.rows : [];


        // Selected-column editor UI
        node.columns = Array.isArray(node.columns) && node.columns.length ? node.columns : [{key:'col1',label:'Column 1',type:'text',align:'left',width:''},{key:'col2',label:'Column 2',type:'text',align:'left',width:''}];
        node.selCol = (typeof node.selCol==='number' && node.selCol>=0 && node.selCol<node.columns.length) ? node.selCol : 0;

        const chooser=document.createElement('div'); chooser.className='inline'; chooser.style.flexWrap='wrap';
        const colSel=document.createElement('select'); colSel.className='select';
        function rebuildColSel(){
          colSel.innerHTML='';
          (node.columns||[]).forEach((c,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=(c.label||c.key)+' ['+c.key+']'; colSel.appendChild(o); });
          colSel.value=String(node.selCol);
        }
        rebuildColSel();
        colSel.onchange=()=>{ node.selCol=Number(colSel.value); render(); openInspector(node.id); };

        const up=document.createElement('button'); up.type='button'; up.type='button'; up.type='button'; up.className='col-act'; up.title='Move column left'; up.innerHTML='<span class="ico">←</span><span class="lab">Left</span>';
        up.onclick=()=>{ const i=node.selCol; if(i>0){ const t=node.columns[i-1]; node.columns[i-1]=node.columns[i]; node.columns[i]=t; node.selCol=i-1; render(); openInspector(node.id);} };
        const down=document.createElement('button'); down.type='button'; down.type='button'; down.type='button'; down.className='col-act'; down.title='Move column right'; down.innerHTML='<span class="ico">→</span><span class="lab">Right</span>';
        down.onclick=()=>{ const i=node.selCol; if(i<node.columns.length-1){ const t=node.columns[i+1]; node.columns[i+1]=node.columns[i]; node.columns[i]=t; node.selCol=i+1; render(); openInspector(node.id);} };
        const add=document.createElement('button'); add.type='button'; add.type='button'; add.type='button'; add.className='col-act primary'; add.title='Add column'; add.innerHTML='<span class="ico">＋</span><span class="lab">Add</span>';
        add.onclick=()=>{ const i=node.selCol+1; const newKey='col'+((node.columns||[]).length+1); (node.columns||[]).splice(i,0,{key:newKey,label:'Column '+((node.columns||[]).length+1),type:'text',align:'left',width:''}); node.selCol=i; render(); openInspector(node.id); };
        const del=document.createElement('button'); del.type='button'; del.type='button'; del.type='button'; del.className='col-act danger'; del.title='Delete column'; del.innerHTML='<span class="ico">🗑️</span><span class="lab">Delete</span>';
        del.onclick=()=>{ var __i=node.selCol; var __n=((node.columns||[])[__i]||{}).label||((node.columns||[])[__i]||{}).key||'this column'; if(!window.confirm(`Delete column \"${__n}\"?`)) return; var __i=node.selCol; var __n=((node.columns||[])[__i]||{}).label||((node.columns||[])[__i]||{}).key||'this column'; if(!window.confirm(`Delete column \"${__n}\"?`)) return; if((node.columns||[]).length>1){ (function(){ const removed=(node.columns||[])[node.selCol]; (node.columns||[]).splice(node.selCol,1); if(removed&&removed.key && node.filters){ delete node.filters[removed.key]; } })(); node.selCol=Math.max(0,node.selCol-1); render(); openInspector(node.id);} };

        const chooserLbl=document.createElement('span'); chooserLbl.textContent='Column:';
        const actions=document.createElement('div'); actions.className='col-actions'; actions.append(up,down,add,del);
chooser.append(chooserLbl, colSel, actions);

        const editor=document.createElement('div'); editor.className='cols-editor';

        function renderEditor(){
          editor.innerHTML='';
          const i = node.selCol;
          const c = (node.columns||[])[i] || (node.columns[0]);
          if(!c) return;
          const rowTop=document.createElement('div'); rowTop.className='inline'; rowTop.style.flexWrap='wrap';

          const keyEl=document.createElement('div'); keyEl.className='col-key'; keyEl.textContent=c.key;
          const nameEl=document.createElement('input'); nameEl.type='text'; nameEl.className='input'; nameEl.placeholder='Column name'; nameEl.value=c.label||'';
          nameEl.oninput=()=>{ c.label=nameEl.value; render(); openInspector(node.id); };

          const typeSel=document.createElement('select'); typeSel.className='select';
          ['label','text','textarea','number','integer','currency','percent','date','datetime','time','checkbox','select','multiselect','email','url','tel','color','file', 'rating'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; typeSel.appendChild(o); });
          (function(){try{const need=['richtext','signature']; need.forEach(n=>{ const exists = Array.from(typeSel.options).some(o => (String(o.value||'').toLowerCase()===n)); if(!exists){ const o=document.createElement('option'); o.value=n; o.textContent=n; typeSel.appendChild(o); } });}catch{}})(); typeSel.value=c.type||'text';
        (function(){
          try{
            const need=['richtext','signature'];
            need.forEach(n=>{
              const exists = Array.from(typeSel.options).some(o => (String(o.value||'').toLowerCase()===n));
              if(!exists){ const o=document.createElement('option'); o.value=n; o.textContent=n; typeSel.appendChild(o); }
            });
          }catch{}
        })();
        try{ typeSel.value = (c.type||'text'); }catch{}
        
    (function(){
      try{
        const need=['signature','richtext'];
        need.forEach(n=>{
          const exists = Array.from(typeSel.options).some(o => (String(o.value||'').toLowerCase()===n));
          if(!exists){
            const o=document.createElement('option'); o.value=n; o.textContent=n; typeSel.appendChild(o);
          }
        });
      }catch{}
    })();
     typeSel.onchange=()=>{ c.type=(typeSel.value||'').toLowerCase(); render(); try{ if(typeof paintHeader==='function') paintHeader(); if(typeof paintBody==='function') paintBody(true); setTimeout(()=>{ try{ if(typeof paintBody==='function') paintBody(true); }catch{} },0); }catch{} openInspector(node.id); };

          const alignSel=document.createElement('select'); alignSel.className='select';
          ['left','center','right'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; alignSel.appendChild(o); });
          alignSel.value=c.align||'left'; alignSel.onchange=()=>{ c.align=alignSel.value; render(); openInspector(node.id); };

          const widthEl=document.createElement('input'); widthEl.type='text'; widthEl.className='input'; widthEl.placeholder='Width (e.g., 120px or 20%)'; widthEl.value=c.width||'';
          widthEl.oninput=()=>{ c.width = widthEl.value; render(); openInspector(node.id); };

          const req=document.createElement('input'); req.type='checkbox'; req.checked=!!c.required; req.onchange=()=>{ c.required=req.checked; render(); openInspector(node.id); };
          const reqLbl=document.createElement('label'); reqLbl.textContent=' required'; reqLbl.prepend(req);
          const min=document.createElement('input'); min.type='text'; min.className='input'; min.placeholder='min'; min.value=c.min||''; min.oninput=()=>{ c.min=min.value; render(); openInspector(node.id); };
          const max=document.createElement('input'); max.type='text'; max.className='input'; max.placeholder='max'; max.value=c.max||''; max.oninput=()=>{ c.max=max.value; render(); openInspector(node.id); };
          const pattern=document.createElement('input'); pattern.type='text'; pattern.className='input'; pattern.placeholder='pattern (regex)'; pattern.value=c.pattern||''; pattern.oninput=()=>{ c.pattern=pattern.value; render(); openInspector(node.id); };

          // Column visibility (single condition)
          c.logic = c.logic || {mode:'all', conditions:[]};
          if(!Array.isArray(c.logic.conditions)) c.logic.conditions=[];
          if(c.logic.conditions.length===0) c.logic.conditions.push({field:'',op:'=',value:''});
          const visRow=document.createElement('div'); visRow.className='inline'; visRow.style.flexWrap='wrap';
          const visLabel=document.createElement('span'); visLabel.textContent='Column visible when:';
          const fields = allFieldsExcept(node.id).map(f=>({id:f.id,label:f.name,type:f.ftype}));
          const fSel=document.createElement('select'); fSel.className='select'; (fields||[]).forEach(fi=>{ const o=document.createElement('option'); o.value=fi.id; o.textContent=fi.label; fSel.appendChild(o); });
          const cur=c.logic.conditions[0]; fSel.value=cur.field||'';
          const opsSel=document.createElement('select'); opsSel.className='select'; ['=','!=','contains','notcontains','>','<','>=','<='].forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; opsSel.appendChild(op); }); opsSel.value=cur.op||'=';
          const valEl=document.createElement('input'); valEl.type='text'; valEl.className='input'; valEl.placeholder='value'; valEl.value=cur.value||'';
          function syncColLogic(){ c.logic.conditions[0] = { field: fSel.value||'', op: opsSel.value||'=', value: valEl.value||'' }; }
          fSel.onchange=()=>{ syncColLogic(); render(); openInspector(node.id); };
          opsSel.onchange=()=>{ syncColLogic(); render(); openInspector(node.id); };
          valEl.oninput=()=>{ syncColLogic(); render(); openInspector(node.id); };

          // Type-specific config
          const cfg=document.createElement('div'); cfg.className='inline'; cfg.style.flexWrap='wrap'; cfg.style.margin='4px 0 10px';
          function rebuildCfg(){
            cfg.innerHTML='';
            const t = (typeof getColType==='function' ? getColType(c) : (c.type||'text'));
            if(c.type==='select' || c.type==='multiselect'){
              const ta=document.createElement('textarea'); ta.className='input'; ta.rows=3; ta.placeholder='Choices (one per line)';
              ta.value=(Array.isArray(c.options)?c.options:[]).join('\n');
              ta.oninput=()=>{ c.options = ta.value.split(/\r?\n/).map(v=>v.trim()).filter(Boolean); render(); openInspector(node.id); };
              cfg.append(ta);
            }
            if(c.type==='currency' || c.type==='percent' || c.type==='number' || c.type==='integer'){
              const dec=document.createElement('input'); dec.type='number'; dec.min='0'; dec.max='6'; dec.className='input'; dec.placeholder='decimals'; dec.value=(c.decimals??(c.type==='integer'?0:2));
              dec.oninput=()=>{ c.decimals = Math.max(0, Math.min(6, Number(dec.value)||0)); render(); openInspector(node.id); };
              const pre=document.createElement('input'); pre.type='text'; pre.className='input'; pre.placeholder='prefix (e.g., $)'; pre.value=c.prefix||''; pre.oninput=()=>{ c.prefix=pre.value; render(); openInspector(node.id); };
              const suf=document.createElement('input'); suf.type='text'; suf.className='input'; suf.placeholder='suffix (e.g., %)'; suf.value=(c.type==='percent' ? '%' : (c.suffix||''));
              suf.oninput=()=>{ c.suffix=suf.value; render(); openInspector(node.id); };
              cfg.append(dec, pre, suf);
            }
            if(c.type==='rating'){
              const max=document.createElement('input'); max.type='number'; max.min='1'; max.max='10'; max.className='input'; max.placeholder='max stars'; max.value=(c.maxRating||5);
              max.oninput=()=>{ c.maxRating=Math.max(1, Math.min(10, Number(max.value)||5)); render(); openInspector(node.id); };
              cfg.append(max);
            }
            if(t==='label'){
              const def=document.createElement('input'); def.type='text'; def.className='input'; def.placeholder='Default text'; def.value=c.static||''; def.oninput=()=>{ c.static=def.value; render(); openInspector(node.id); };
              cfg.append(def);
            }
          
            // Aggregation (footer) controls
            (function(){
              try{
                const label=document.createElement('label'); label.textContent=' Aggregation ';
                label.style.marginLeft='12px';
                const aggSel=document.createElement('select'); aggSel.className='select';
                const opts=[
                  ['none','None'], ['sum','Sum'], ['avg','Average'], ['min','Min'], ['max','Max'],
                  ['count','Count filled'], ['distinct','Count distinct']
                ];
                opts.forEach(([v,l])=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; aggSel.appendChild(o); });
                let def='none';
                if(t==='number'||t==='integer'||t==='currency'||t==='percent') def='sum';
                if(t==='rating') def='avg';
                if(t==='checkbox'||t==='signature'||t==='richtext'||t==='file'||t==='text'||t==='textarea') def='count';
                try{ aggSel.value = (c.agg||def); }catch{}
                aggSel.onchange=()=>{ c.agg = aggSel.value; try{ render(); paintFooter(); }catch(e){} openInspector(node.id); };
                const wrap=document.createElement('span'); wrap.className='inline';
                wrap.append(label, aggSel);
                cfg.append(wrap);
              }catch(e){}
            })();
        
          
            // Per-column "Show in footer"
            (function(){
              try{
                const showWrap=document.createElement('span'); showWrap.className='inline';
                const showLbl=document.createElement('label'); showLbl.textContent=' Show in footer';
                const showCb=document.createElement('input'); showCb.type='checkbox';
                // default: on if agg not 'none', otherwise off (explicit false)
                let defOn = (c.agg && String(c.agg).toLowerCase()!=='none');
                if(typeof c.showAgg==='undefined'){ c.showAgg = defOn; }
                showCb.checked = (c.showAgg!==false);
                showCb.onchange=()=>{ c.showAgg = showCb.checked; try{ render(); paintFooter(); }catch(e){} openInspector(node.id); };
                showLbl.prepend(showCb);
                showWrap.append(showLbl);
                cfg.append(showWrap);
              }catch(e){}
            })();
            
          }
          rebuildCfg();

          rowTop.append(keyEl,nameEl,typeSel,alignSel,widthEl);
          const rowVal=document.createElement('div'); rowVal.className='inline'; rowVal.style.flexWrap='wrap';
          rowVal.append(reqLbl, min, max, pattern);
          visRow.append(visLabel,fSel,opsSel,valEl);

          editor.append(rowTop, cfg, rowVal, visRow);
        }
        renderEditor();

        inspBody.append(row('Column', chooser), row('Settings', editor));

      }
if(['dropdown','multiselect','radio','checkboxes'].includes(node.ftype)){
        const ta=document.createElement('textarea'); ta.className='textarea'; ta.style.height='120px'; ta.placeholder='One option per line'; ta.value=(node.options||[]).join('\n');
        ta.oninput=()=>{ node.options = ta.value.split('\n').map(s=>s.trim()).filter(Boolean); render(); };
        const inline=checkbox('Inline choices', node.inlineChoices||false, v=>{ node.inlineChoices=v; render();});
        const allowC=checkbox('Allow user to enter custom option', node.allowCustom||false, v=>{ node.allowCustom=v; render();});
        inspBody.append(row('Options', ta), row('Display', wrap(inline, allowC)));
      }
      if(node.ftype==='table'){
        // Ensure defaults
        node.columns = Array.isArray(node.columns) && node.columns.length ? node.columns : [{key:'col1',label:'Column 1'},{key:'col2',label:'Column 2'}];
        node.sampleRows = Number(node.sampleRows)||3;

        const list = document.createElement('div'); list.className='cols-editor';

        function renderCols(){
          list.innerHTML='';
          (node.columns||[]).forEach((c,idx)=>{
            const rowEl=document.createElement('div'); rowEl.className='col-row';
            const keyEl=document.createElement('div'); keyEl.className='col-key'; keyEl.textContent=c.key;
            const nameEl=document.createElement('input'); nameEl.type='text'; nameEl.className='input'; nameEl.placeholder='Column name'; nameEl.value=c.label||'';
            nameEl.oninput=()=>{ c.label = nameEl.value; render(); };
            const btns=document.createElement('div'); btns.className='col-actions';
            const up=document.createElement('button'); up.type='button'; up.type='button'; up.type='button'; up.className='col-act'; up.title='Move column left'; up.innerHTML='<span class="ico">←</span><span class="lab">Left</span>';
            const down=document.createElement('button'); down.type='button'; down.type='button'; down.type='button'; down.className='col-act'; down.title='Move column right'; down.innerHTML='<span class="ico">→</span><span class="lab">Right</span>';
            const del=document.createElement('button'); del.type='button'; del.type='button'; del.type='button'; del.className='col-act danger'; del.title='Delete column'; del.innerHTML='<span class="ico">🗑️</span><span class="lab">Delete</span>';
            up.onclick=()=>{ if(idx>0){ const t=node.columns[idx-1]; node.columns[idx-1]=node.columns[idx]; node.columns[idx]=t; render(); openInspector(node.id);} };
            down.onclick=()=>{ if(idx<node.columns.length-1){ const t=node.columns[idx+1]; node.columns[idx+1]=node.columns[idx]; node.columns[idx]=t; render(); openInspector(node.id);} };
            del.onclick=()=>{ var __n=(node.columns[idx]?.label||node.columns[idx]?.key||'this column'); if(!window.confirm(`Delete column \"${__n}\"?`)) return; node.columns.splice(idx,1); if(!node.columns.length){ node.columns=[{key:'col1',label:'Column 1'}]; } render(); openInspector(node.id); };
            btns.append(up,down,del);
            rowEl.append(keyEl,nameEl,btns);
            list.appendChild(rowEl);
          });
          const add=document.createElement('button'); add.type='button'; add.type='button'; add.type='button'; add.className='col-act primary'; add.title='Add column'; add.innerHTML='<span class="ico">＋</span><span class="lab">Add</span>';
          add.onclick=()=>{
            const n = (node.columns||[]).length+1;
            const key = 'col'+n;
            (node.columns||[]).push({key, label:'Column '+n});
            render(); openInspector(node.id);
          };
          list.appendChild(add);
        }
        renderCols();

        const rowsNum = document.createElement('input'); rowsNum.type='number'; rowsNum.className='input'; rowsNum.min='0'; rowsNum.max='20'; rowsNum.value=String(node.sampleRows);
        rowsNum.oninput=()=>{ const v = Math.max(0, Math.min(20, Number(rowsNum.value)||0)); node.sampleRows = v; render();  render(); openInspector(node.id); };

        inspBody.append(row('Columns', list));
        inspBody.append(row('Sample rows', rowsNum));

      }
      inspBody.append(row('Placeholder', input(node.placeholder||'',v=>{node.placeholder=v; try{ updatePlaceholderLive(node.id || (current&&current.id) || (n&&n.id), (typeof v!=='undefined'?v:(node.placeholder||''))); }catch(_e){} render();})));
      inspBody.append(row('Help text', input(node.help||'',v=>{node.help=v; render();})));
      inspBody.append(row('Label position', select(['left','top','hidden'], node.labelPos||'top', v=>{node.labelPos=v; render();})));
      if(node.ftype==='button'){
        inspBody.append(row('Button style', select(['primary','ghost','danger','link'], node.btnStyle||'primary', v=>{node.btnStyle=v; render();})));
        inspBody.append(row('Button action', select(['none','submit','reset'], node.btnAction||'none', v=>{node.btnAction=v; render();})));
      }
    } else if(node.type==='section'){
      // Section title: no re-render while typing; update live DOM title
      const el = input(node.name, v => {
        node.name = v;
        const domTitle = document.querySelector(`.section[data-nid="${node.id}"] .section-name`);
        if(domTitle) domTitle.textContent = v;
      });
      el.addEventListener('blur', ()=>{ render(); openInspector(node.id); });
      inspBody.append(row('Title', el));

      const area=document.createElement('textarea'); area.className='textarea'; area.value=node.description||''; area.oninput=()=>{node.description=area.value;};
      area.addEventListener('blur', ()=>{ render(); openInspector(node.id); });
      inspBody.append(row('Description', area));
      } else {
      const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=node.showLine; chk.onchange=()=>{node.showLine=chk.checked; render();};
      inspBody.append(row('Show line', wrap(chk)));
    }
  }

  if(which==='validation' && node.type==='field'){
    const req=checkbox('Required', !!node.required, v=>{node.required=v; render();});
    const ro =checkbox('Read-only', !!node.readonly, v=>{node.readonly=v; render();});
    const dis=checkbox('Disabled', !!node.disabled, v=>{node.disabled=v; render();});
    inspBody.append(row('Flags', wrap(req,ro,dis)));
    inspBody.append(row('Min', input(node.min||'',v=>{node.min=v; render();})));
    inspBody.append(row('Max', input(node.max||'',v=>{node.max=v; render();})));
    inspBody.append(row('Step', input(node.step||'',v=>{node.step=v; render();})));
    inspBody.append(row('Min length', input(node.minLen||'',v=>{node.minLen=v; render();})));
    inspBody.append(row('Max length', input(node.maxLen||'',v=>{node.maxLen=v; render();})));
    inspBody.append(row('Regex pattern', input(node.pattern||'',v=>{node.pattern=v; render();})));

    // File field settings
    if(node.ftype==='file'){
      // Defaults
      node.accept = node.accept || "image/*,application/pdf,text/html";
      node.maxSizeMB = (typeof node.maxSizeMB==='number' && node.maxSizeMB>0) ? node.maxSizeMB : 20;
      node.maxFiles = (typeof node.maxFiles==='number' && node.maxFiles>=0) ? node.maxFiles : 0;
      node.multiple = (typeof node.multiple==='boolean') ? node.multiple : true;

      const chipsWrap = document.createElement('div');
      function chip(label, val){
        const b=document.createElement('button'); b.type='button'; b.type='button'; b.type='button'; b.className='btn ghost'; b.textContent=label;
        function selected(){ return (node.accept||'').split(',').map(s=>s.trim()).includes(val); }
        function sync(){ b.classList.toggle('active', selected()); }
        b.onclick=()=>{
          const list=(node.accept||'').split(',').map(s=>s.trim()).filter(Boolean);
          const idx=list.indexOf(val);
          if(idx>=0) list.splice(idx,1); else list.push(val);
          node.accept=list.join(','); render();
          sync();
        };
        sync();
        return b;
      }
      const imgC=chip('Images','image/*'), pdfC=chip('PDF','application/pdf'), htmlC=chip('HTML','text/html');
      const custom=input(node.accept||'', v=>{ node.accept=v; render(); });
      custom.placeholder="Custom accept (e.g., application/zip,.csv)";
      chipsWrap.append(imgC,pdfC,htmlC);
      inspBody.append(row('Allowed types', wrap(chipsWrap, custom)));
      inspBody.append(row('Max file size (MB)', num(node.maxSizeMB, v=>{ node.maxSizeMB = Math.max(1, Number(v)||20); render(); })));
      inspBody.append(row('Max files (0 = unlimited)', num(node.maxFiles, v=>{ node.maxFiles = Math.max(0, Number(v)||0); render(); })));
      const mult=checkbox('Allow multiple', !!node.multiple, v=>{ node.multiple=v; render(); });
      inspBody.append(row('Multiple', mult));
    }
    const defLbl = ['radio','checkboxes','toggle','range','rating','button'].includes(node.ftype) ? 'Default (see field)' : 'Default value';
    inspBody.append(row(defLbl, input(node.default||'',v=>{node.default=v; render();})));
  }

  if(which==='visibility' && node.type==='field'){
    const modeSel=select(['all','any'], node.logic?.mode||'all', v=>{node.logic.mode=v; updateVisibility();});
    inspBody.append(row('Match conditions', wrap(newChip('Show when'),modeSel,newChip('conditions are true'))));
    const list=document.createElement('div'); list.style.display='grid'; list.style.gap='8px';
    const fields = allFieldsExcept(node.id).map(f=>({id:f.id,label:f.name,type:f.ftype}));
    const opsFor = (t)=> (t==='number'||t==='date'||t==='time'||t==='datetime') ? ['=','!=','>','<','>=','<=','contains','notcontains']
                 : (t==='checkboxes'||t==='multiselect'||t==='radio'||t==='dropdown') ? ['=','!=','contains','notcontains']
                 : ['=','!=','contains','notcontains','>','<'];
    node.logic = node.logic || {mode:'all',conditions:[]};
    node.logic.conditions = node.logic.conditions || [];
    node.logic.conditions.forEach((c,idx)=>{
      const rowEl=document.createElement('div'); rowEl.className='inline'; rowEl.style.flexWrap='wrap';
      const fSel=document.createElement('select'); fSel.className='select'; fSel.style.minWidth='160px';
      fields.forEach(fi=>{ const op=document.createElement('option'); op.value=fi.id; op.textContent=fi.label; fSel.appendChild(op); });
      fSel.value=c.field||'';
      const oSel=document.createElement('select'); oSel.className='select';
      const ftype=(fields.find(f=>f.id===fSel.value)?.type)||'text';
      opsFor(ftype).forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; oSel.appendChild(op); });
      oSel.value=c.op||'=';

// Build a value control appropriate for the selected field type
function buildValueControl(){
  const ref = fieldById(fSel.value);
  const t = (ref?.ftype||'text').toLowerCase();
  let el;
  const setVal=(val)=>{ c.value=val; updateVisibility(); };
  if(t==='dropdown' || t==='radio'){
    el=document.createElement('select'); el.className='select';
    (ref.options||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
    el.value = (c.value??'');
    el.onchange=()=>{ if(demoMode){ return; } setVal(el.value); };
  }else if(t==='multiselect' || t==='checkboxes'){
    // single-select by default (to keep condition semantics consistent); can extend to multiple later
    el=document.createElement('select'); el.className='select';
    (ref.options||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
    el.value = (c.value??'');
    el.onchange=()=>{ if(demoMode){ return; } setVal(el.value); };
  }else if(t==='toggle'){
    el=document.createElement('select'); el.className='select';
    [['true','On'],['false','Off']].forEach(([val,lab])=>{ const o=document.createElement('option'); o.value=val; o.textContent=lab; el.appendChild(o); });
    el.value = String(c.value??'false');
    el.onchange=()=>{ if(demoMode){ return; } setVal(el.value); };
  }else if(t==='number'){
    el=document.createElement('input'); el.type='number'; el.className='input';
    el.value = (c.value??'');
    el.oninput=()=>{ if(demoMode){ return; } setVal(el.value); };
  }else if(t==='date' || t==='time' || t==='datetime'){
    el=document.createElement('input'); el.type=(t==='datetime')?'datetime-local':t; el.className='input';
    el.value = (c.value??'');
    el.oninput=()=>{ if(demoMode){ return; } setVal(el.value); };
  }else{
    el=document.createElement('input'); el.className='input'; el.placeholder='Value';
    el.value = (c.value??'');
    el.oninput=()=>{ if(demoMode){ return; } setVal(el.value); };
  }
  return el;
}
let vInp = buildValueControl();

const del=document.createElement('button'); del.type='button'; del.type='button'; del.className='btn ghost'; del.textContent='Remove';
del.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } node.logic.conditions.splice(idx,1); paintInspectorPane('visibility',node,hit); updateVisibility(); };
fSel.onchange=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } c.field=fSel.value; /* rebuild operator list */ oSel.innerHTML=''; opsFor((fieldById(c.field)?.ftype||'text').toLowerCase()).forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; oSel.appendChild(op); }); c.op=oSel.options[0]?.value||'='; /* rebuild value control */ vInp.replaceWith(vInp=buildValueControl()); updateVisibility(); };
oSel.onchange=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } c.op=oSel.value; /* could alter semantics */ updateVisibility(); };
rowEl.append(fSel,oSel,vInp,del); list.appendChild(rowEl);
 list.appendChild(rowEl);
    });
    inspBody.append(list);
    const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.type='button'; addBtn.className='btn primary'; addBtn.textContent='＋ Add condition';
    addBtn.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } node.logic.conditions.push({field:fields[0]?.id||'', op:'=', value:''}); paintInspectorPane('visibility',node,hit); updateVisibility(); };
    inspBody.append(addBtn);
  }
}

/* Field listing for conditions */
function allFieldsExcept(excludeId){
  const item=getItem(); const out=[];
  (function walk(n){ if(n.type==='field' && n.id!==excludeId) out.push(n); if(n.type==='section') n.children.forEach(walk); })(item.root);
  return out;
}

/* Field helpers */
function fieldById(id){
  const it=getItem(); let hit=null;
  (function walk(n){
    if(hit) return;
    if(n.type==='field' && n.id===id){ hit=n; return; }
    if(n.type==='section') n.children.forEach(walk);
  })(it.root);
  return hit;
}
/* Section helpers */
function sectionById(id){ const it=getItem(); let hit=null; (function walk(n){ if(n.id===id){ hit=n; return; } if(n.type==='section') n.children.forEach(walk); })(it.root); return hit; }
function setTarget(id){ if(demoMode){ toast('Demo mode: editing disabled'); return; } const sec=sectionById(id); if(sec){ targetSectionId=id; render(); openInspector(id); } }
function deleteNode(id){
  if(demoMode){ toast('Demo mode: editing disabled'); return; }
  const it=getItem(); if(!it) return;
  function find(root,id,p=null){ if(root && root.id===id) return {node:root,parent:p}; if(root && root.children){ for(const c of root.children){ const r=find(c,id,root); if(r) return r; } } if(root && root.columns){   for(const col of root.columns){     if(col && col.id===id) return {node:col,parent:root};     if(col && col.children){ for(const ch of col.children){ const r=find(ch,id,col); if(r) return r; } }   } } return null; }
  const hit=find(it.root,id); if(!hit||!hit.parent) return; const hitName = (hit && hit.node && hit.node.name) ? hit.node.name : '';
  return confirmDialog({title:'Delete item?', name:hitName, showName:true, body:'This action cannot be undone.', confirmText:'Delete', cancelText:'Cancel', tone:'danger', icon:'🗑️'}).then(ok=>{ if(!ok) return;
  hit.parent.children = hit.parent.children.filter(c=>c.id!==id); render(); closeInspector(); });
}
function closeInspector(){
  // TDZ-safe + null-safe: resolve inspector lazily each time
  const el = document.getElementById('inspector') || document.querySelector('.inspector');
  if(el && el.classList && typeof el.classList.remove === 'function'){
    try{ el.classList.remove('open'); }catch(_){}
  }
}

/* ================= Visibility engine ================= */
function getFieldValueById(fid){
  const el=document.getElementById('f_'+fid);
  const item=getItem(); let node=null; (function find(n){ if(n.id===fid){ node=n; return; } if(n.type==='section') n.children.forEach(find); })(item.root);
  if(!node) return '';
  const t=node.ftype;
  if(!el){
    if(t==='radio'){ const nodes=$$('input[name="f_'+fid+'"]'); const y=nodes.find(n=>n.checked); return y?y.value:''; }
    if(t==='checkboxes'){ const nodes=$$('input[name="f_'+fid+'"]'); return nodes.filter(n=>n.checked).map(n=>n.value); }
    if(t==='toggle'){ return String(node.default)==='true'; }
    return node.default||'';
  }
  if(t==='paragraph'){ return el.innerHTML; }
  if(t==='multiselect'){ return Array.from(el.selectedOptions).map(o=>o.value); }
  if(t==='file'){ return el.files?.length? el.files[0].name : ''; }
  return el.value??'';
}
function testCondition(c){
  function _normDT(s){ return (typeof s==='string') ? s.replace(' ', 'T') : s; }

  if(!c||!c.field) return true;
  const cur=getFieldValueById(c.field), v=c.value??'', op=c.op||'=';
  if(op==='=') return Array.isArray(cur)? cur.includes(v): String(cur)===String(v);
  if(op==='!=') return Array.isArray(cur)? !cur.includes(v): String(cur)!==String(v);
  if(op==='contains') return Array.isArray(cur)? cur.includes(v): String(cur).toLowerCase().includes(String(v).toLowerCase());
  if(op==='notcontains') return Array.isArray(cur)? !cur.includes(v): !String(cur).toLowerCase().includes(String(v).toLowerCase());
  // typed comparisons for number/date/time/datetime
  if(op==='>'||op==='<'||op==='>='||op==='<='){
    const meta = (typeof fieldById==='function') ? fieldById(c.field) : null;
    const t = (meta && meta.ftype ? String(meta.ftype).toLowerCase() : '');
    function toTimeMinutes(x){
      if(x==null) return NaN;
      const s=String(x).trim();
      if(!s) return NaN;
      const parts=s.split(':').map(n=>parseInt(n,10));
      if(parts.some(n=>Number.isNaN(n))) return NaN;
      const [h=0,m=0,sec=0]=parts;
      return h*60 + m + (sec>0? sec/60 : 0);
    }
    function cmp(a,b){
      if(op==='>') return a>b;
      if(op==='<') return a<b;
      if(op==='>=') return a>=b;
      if(op==='<=') return a<=b;
      return false;
    }
    if(t==='number'){
      const na=parseFloat(cur), nb=parseFloat(v);
      if(!Number.isNaN(na)&&!Number.isNaN(nb)) return cmp(na,nb);
    }else if(t==='date' || t==='datetime'){
      const da=Date.parse(cur), db=Date.parse(v);
      if(!Number.isNaN(da)&&!Number.isNaN(db)) return cmp(da,db);
    }else if(t==='time'){
      const ta=toTimeMinutes(cur), tb=toTimeMinutes(v);
      if(!Number.isNaN(ta)&&!Number.isNaN(tb)) return cmp(ta,tb);
    }else{
      // Fallback string compare when type unknown
      return cmp(String(cur), String(v));
    }
    // If parsing failed, be conservative (no match)
    return false;
  }
  return true;
}
function passesLogic(n){
  const lg=n.logic||{mode:'all',conditions:[]};
  if(!lg.conditions||lg.conditions.length===0) return true;
  const res=lg.conditions.map(testCondition);
  return (lg.mode==='any')? res.some(Boolean): res.every(Boolean);
}

function updateVisibility(){
  const item=getItem(); if(!item) return;
  (function walk(n){
    if(n.type==='field'){
      const card=document.querySelector(`.fcard[data-nid="${n.id}"]`);
      if(card){
        const ok = passesLogic(n);
        const hasConds = (n.logic && Array.isArray(n.logic.conditions) && n.logic.conditions.length>0);
        if(demoMode){
          card.style.display = ok? '' : 'none';
          const b = card.querySelector('.cond-badge'); if(b) b.remove();
          card.classList.remove('dimmed');
        }else{
          card.style.display = '';
          let badge = card.querySelector('.cond-badge');
          if(hasConds){
            if(!badge){
              badge = document.createElement('span');
              badge.className = 'cond-badge chip';
              const bar = card.querySelector('.icons');
              (bar || card).appendChild(badge);
            }
            badge.textContent = ok? 'Shown (conditions met)' : 'Hidden in demo';
            card.classList.toggle('dimmed', !ok);
          }else{
            if(badge) badge.remove();
            card.classList.remove('dimmed');
          }
        }
      }
    }
    if(n.type==='section') n.children.forEach(walk);
  })(item.root);
}

/* Submit & Reset */

function validateTable(fd){
  try{
    const rows = Array.isArray(fd.rows) && fd.rows.length ? fd.rows : [];
    for(let ri=0; ri<rows.length; ri++){
      const r = rows[ri];
      for(const c of (fd.columns||[])){
        let visible = true;
        try{ if(c.logic && Array.isArray(c.logic.conditions) && c.logic.conditions.length){ visible = passesLogic({logic:c.logic}); } }catch{}
        if(!visible) continue;

        const val = r[c.key];
        if(c.required && (val===undefined || val===null || String(val).trim()==='')){
          return `Row ${ri+1}, column "${c.label||c.key}" is required.`;
        }
        if(c.type==='number'){
          const num = Number(val);
          if(val!=='' && Number.isNaN(num)) return `Row ${ri+1}, column "${c.label||c.key}" must be a number.`;
          if(c.min!==undefined && c.min!=='' && num < Number(c.min)) return `Row ${ri+1}, column "${c.label||c.key}" must be ≥ ${c.min}.`;
          if(c.max!==undefined && c.max!=='' && num > Number(c.max)) return `Row ${ri+1}, column "${c.label||c.key}" must be ≤ ${c.max}.`;
        }
        if(c.type==='text' && c.pattern){
          try{ const rx=new RegExp(c.pattern); if(val && !rx.test(String(val))) return `Row ${ri+1}, column "${c.label||c.key}" has invalid format.`; }catch{}
        }
      }
    }
    return '';
  }catch(e){ return ''; }
}
function doSubmit(){
  const item=getItem(); if(!item) return true; let ok=true;
  (function walk(n){
    if(n.type==='field'){
      const card=document.querySelector(`.fcard[data-nid="${n.id}"]`);
      if(card && card.style.display==='none') return;
      const old=card?.querySelector('.error'); if(old) old.remove();
      const val=getFieldValueById(n.id); let msg='';
      if(n.required){ if((Array.isArray(val)&&!val.length)||(!Array.isArray(val)&&String(val).trim()==='')) msg='This field is required.'; }
      if(!msg && n.pattern){ try{const re=new RegExp(n.pattern); if(!re.test(String(val))) msg='Does not match required format.';}catch{} }
      if(!msg && n.min && n.ftype==='number'){ if(Number(val)<Number(n.min)) msg=`Must be ≥ ${n.min}.`; }
      if(!msg && n.max && n.ftype==='number'){ if(Number(val)>Number(n.max)) msg=`Must be ≤ ${n.max}.`;
      /*TABLE_VALIDATION_HOOK*/
      if(!msg && n.ftype==='table'){ const err=validateTable(n); if(err){ msg=err; } }
 }
      if(msg && card){ const d=document.createElement('div'); d.className='error'; d.style.color='#b91c1c'; d.style.fontSize='12px'; d.textContent=msg; card.appendChild(d); ok=false; }
    }
    if(n.type==='section') n.children.forEach(walk);
  })(item.root);
  if(formNote){ formNote.textContent = ok? '✅ Submitted (demo).' : '⚠️ Please fix the highlighted issues.'; }
  return ok;
}
function doReset(){
  $('#designerCard').querySelectorAll('input,textarea,select').forEach(el=>{
    if(el.type==='checkbox'||el.type==='radio'){ el.checked=false; }
    else if(el.tagName==='SELECT' && el.multiple){ Array.from(el.options).forEach(o=>o.selected=false); }
    else { el.value=''; }
  });
  $$('.error').forEach(e=>e.remove());

  /*TABLE_RESET*/
  try{
    const item=getItem(); if(item){
      (function walk(n){
        if(n.type==='field' && n.ftype==='table'){ n.rows=[]; }
        if(n.type==='section') n.children.forEach(walk);
      })(item.root);
    }
  }catch{}

  /*TABLE_RESET_FILTERS*/
  try{
    const item=getItem(); if(item){
      (function walk(n){
        if(n.type==='field' && n.ftype==='table'){ n.filters = {}; }
        if(n.type==='section') n.children.forEach(walk);
      })(item.root);
    }
  }catch{}
if(formNote){ formNote.textContent ='↺ Cleared.'; }
  updateVisibility();
}

// Live re-evaluation: update field visibility whenever user changes any input
(function(){
  const host=document.getElementById('designerCard');
  if(!host) return;
  function onEvt(e){
    const t=e.target;
    if(!t) return;
    if(t.matches('input,select,textarea,div[contenteditable="true"]')){
      try{ updateVisibility(); }catch{}
    }
  }
  host.addEventListener('input', onEvt, true);
  host.addEventListener('change', onEvt, true);
})();
(function(){ const fs=$('#formSubmit'), fr=$('#formReset'); if(fs) fs.onclick=()=>doSubmit(); if(fr) fr.onclick=()=>doReset(); })();
/* ================== DateTime Picker ================== */
const dtpRoot = $('#dtpRoot');
function openDTP(targetInput){
  const start = targetInput.value ? new Date(targetInput.value.replace(' ', 'T')) : new Date();
  const state = { d:new Date(start), phase:'hour', ampm: start.getHours()<12?'am':'pm' };

  dtpRoot.innerHTML = '';
  const cont=document.createElement('div'); cont.className='dtp'; dtpRoot.appendChild(cont);
  const head=document.createElement('div'); head.className='dtp-head';
  const prev=document.createElement('button'); prev.type='button'; prev.type='button'; prev.className='navbtn'; prev.textContent='‹';
  const next=document.createElement('button'); next.type='button'; next.type='button'; next.className='navbtn'; next.textContent='›';
  const title=document.createElement('div'); title.style.fontWeight='800';
  const timeLive=document.createElement('div'); timeLive.style.fontWeight='800';
  head.append(prev,title,next,timeLive); cont.appendChild(head);

  const body=document.createElement('div'); body.className='dtp-body'; cont.appendChild(body);
  const calWrap=document.createElement('div'); calWrap.className='dtp-cal'; body.appendChild(calWrap);
  const clockWrap=document.createElement('div'); clockWrap.className='dtp-clock'; body.appendChild(clockWrap);

  const foot=document.createElement('div'); foot.className='dtp-foot'; const ok=document.createElement('button'); ok.type='button'; ok.type='button'; ok.className='btn primary'; ok.textContent='Confirm'; foot.appendChild(ok); cont.appendChild(foot);

  function fmt2(n){ return String(n).padStart(2,'0'); }
  function renderHead(){
    const m=state.d.toLocaleString(undefined,{month:'long',year:'numeric'});
    title.textContent=m;
    timeLive.textContent=`${fmt2(state.d.getHours())}:${fmt2(state.d.getMinutes())}:${fmt2(state.d.getSeconds())}`;
  }

  function renderCal(){
    calWrap.innerHTML='';
    const names=['S','M','T','W','T','F','S'];
    const headRow=document.createElement('div'); headRow.className='dtp-grid';
    names.forEach(n=>{ const s=document.createElement('div'); s.className='dtp-dayhead'; s.textContent=n; headRow.appendChild(s); });
    calWrap.appendChild(headRow);

    const grid=document.createElement('div'); grid.className='dtp-grid'; calWrap.appendChild(grid);

    const cur = new Date(state.d); cur.setDate(1);
    const firstDay = cur.getDay();
    const month = cur.getMonth();
    const prevM = new Date(cur); prevM.setMonth(month-1); const prevDays = new Date(prevM.getFullYear(), prevM.getMonth()+1, 0).getDate();
    const days = new Date(cur.getFullYear(), month+1, 0).getDate();

    for(let i=firstDay-1;i>=0;i--){
      const v=prevDays-i; const c=document.createElement('div'); c.className='dtp-cell dis'; c.textContent=v; grid.appendChild(c);
    }
    const today=new Date();
    for(let d=1; d<=days; d++){
      const c=document.createElement('div'); c.className='dtp-cell'; c.textContent=d;
      const isToday = today.getFullYear()===state.d.getFullYear() && today.getMonth()===state.d.getMonth() && today.getDate()===d;
      if(isToday) c.classList.add('cur');
      if(state.d.getDate()===d) c.classList.add('sel');
      c.onclick=()=>{ state.d.setDate(d); renderHead(); renderCal(); };
      grid.appendChild(c);
    }
    const total = firstDay + days;
    for(let i=1;i<= (7 - (total % 7 || 7)); i++){
      const c=document.createElement('div'); c.className='dtp-cell dis'; c.textContent=i; grid.appendChild(c);
    }
  }

  function polarToXY(r,deg,cx,cy){
    const rad=(deg-90)*Math.PI/180;
    return {x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad)};
  }
  function renderClock(){
    clockWrap.innerHTML='';
    const time=document.createElement('div'); time.className='dtp-time'; time.textContent='';
    const face=document.createElement('div'); face.className='clock-face';
    const hand=document.createElement('div'); hand.className='clock-hand'; face.appendChild(hand);
    clockWrap.append(time,face);

    const radius=110, cx=120, cy=120;
    const nums = state.phase==='hour' ? Array.from({length:12},(_,i)=> (i+1)) : Array.from({length:12},(_,i)=> i*5);
    nums.forEach(n=>{
      const deg=(n/12)*360;
      const p=polarToXY(radius,deg,cx,cy);
      const el=document.createElement('div'); el.className='clock-num'; el.style.left=p.x+'px'; el.style.top=p.y+'px'; el.textContent=n===0?'00':n;
      face.appendChild(el);
    });

    function setHandByTime(){
      let deg;
      if(state.phase==='hour'){
        const h=state.d.getHours()%12 || 12;
        deg = (h/12)*360;
      }else{
        const m=state.d.getMinutes();
        deg = (m/60)*360;
      }
      hand.style.transform=`translate(-50%,-100%) rotate(${deg}deg)`;
      time.textContent = `${String(state.phase).toUpperCase()}: ` + (state.phase==='hour' ? (state.d.getHours()%12||12) : ('00'+state.d.getMinutes()).slice(-2));
    }
    setHandByTime();

    face.onclick=(e)=>{
      const rect=face.getBoundingClientRect();
      const x=e.clientX-rect.left - rect.width/2;
      const y=e.clientY-rect.top - rect.height/2;
      let deg=Math.atan2(y,x)*180/Math.PI + 90; if(deg<0) deg+=360;
      if(state.phase==='hour'){
        let h=Math.round(deg/30); if(h===0) h=12;
        const wasPM=state.d.getHours()>=12;
        state.d.setHours((wasPM? (h%12)+12 : (h%12))%24);
        state.phase='minute';
      }else{
        const m=Math.round(deg/6)%60;
        state.d.setMinutes(m); state.phase='hour';
      }
      renderHead(); renderClock();
    };

    const ampm=document.createElement('div'); ampm.className='ampm';
    const am=document.createElement('button'); am.type='button'; am.type='button'; am.textContent='AM';
    const pm=document.createElement('button'); pm.type='button'; pm.type='button'; pm.textContent='PM';
    function syncAP(){ am.classList.toggle('active', state.d.getHours()<12); pm.classList.toggle('active', state.d.getHours()>=12); }
    am.onclick=()=>{ const h=state.d.getHours(); if(h>=12) state.d.setHours(h-12); syncAP(); renderHead(); };
    pm.onclick=()=>{ const h=state.d.getHours(); if(h<12) state.d.setHours(h+12); syncAP(); renderHead(); };
    syncAP(); clockWrap.appendChild(ampm); ampm.append(am,pm);
  }

  prev.onclick=()=>{ state.d.setMonth(state.d.getMonth()-1); renderHead(); renderCal(); };
  next.onclick=()=>{ state.d.setMonth(state.d.getMonth()+1); renderHead(); renderCal(); };
  ok.onclick=()=>{ const z=(n)=>String(n).padStart(2,'0'); targetInput.value = state.d.getFullYear()+'-'+z(state.d.getMonth()+1)+'-'+z(state.d.getDate())+' T'+z(state.d.getHours())+':'+z(state.d.getMinutes())+':'+z(state.d.getSeconds()); closeDTP(); };

  function closeDTP(){ dtpRoot.classList.remove('open'); dtpRoot.innerHTML=''; document.removeEventListener('keydown',onEsc); }
  function onEsc(e){ if(e.key==='Escape') closeDTP(); }
  dtpRoot.onclick=(e)=>{ if(e.target===dtpRoot) closeDTP(); };
  document.addEventListener('keydown', onEsc);

  renderHead(); renderCal(); renderClock();
  dtpRoot.classList.add('open');
}

/* ================= INIT ================= */
(function init(){
  const f1={id:uid(),name:'Feature One',place:'h',icon:'➕',children:[],root:defaultRootSection('Feature One')};
  const f2={id:uid(),name:'Feature Two',place:'v',icon:'📁',children:[],root:defaultRootSection('Feature Two')};
  const sub={id:uid(),name:'Upload',place:'h',icon:'▶️',children:[],root:defaultRootSection('Upload')};
  const sub2={id:uid(),name:'Go Live',place:'h',icon:'📡',children:[],root:defaultRootSection('Go Live')};
  const sub3={id:uid(),name:'Create Post',place:'h',icon:'✏️',children:[],root:defaultRootSection('Create Post')};
  f1.children.push(sub,sub2,sub3);

  Model.items.push(f1,f2);
  renderMenus(); openDesigner(f1);
})();

/* ================= RENDER MENUS ================= */
function renderMenus(){
  hRibbon.innerHTML='';
  roots('h').forEach(n=> hRibbon.appendChild(buildHItem(n)));
  checkRibbonOverflow();
  const vNav=$('#vNav'); vNav.innerHTML='';
  roots('v').forEach(n=> vNav.appendChild(buildVItem(n)));
  setActive();
}

/* ================= SIDE TOGGLE + RESIZE ================= */
$('#toggleSideBtn').onclick=()=> document.body.classList.toggle('side-open');
let __r; window.addEventListener('resize',()=>{ clearTimeout(__r); __r=setTimeout(()=>{ render(); },120); });

/* ===== Modal Viewer (enhanced) ===== */
let viewerLastUrl=null; let viewerLastIsBlob=false;
function openViewer(url, kind, name){
  // Hide (do not close) any open upload dialogs; restore them on close
  try{
    window.__viewerHiddenEls = [];
    ['uploadRoot','mgrRoot'].forEach(id=>{
      const el=document.getElementById(id);
      if(el && (el.classList.contains('open') || getComputedStyle(el).display!=='none')){
        window.__viewerHiddenEls.push(el);
        el.dataset._wasOpen='1';
        el.style.visibility='hidden';
      }
    });
  }catch{}
  // Ensure uploader/file manager modals don't sit above the viewer
  try{
    const up=document.getElementById('uploadRoot'); if(up){ up.classList.remove('open'); up.innerHTML=''; }
    const mgr=document.getElementById('mgrRoot'); if(mgr){ mgr.classList.remove('open'); }
  }catch{}
  const root=document.getElementById('viewerRoot'); if(!root) return;
  root.innerHTML='';
  const box=document.createElement('div'); box.className='viewer'; root.appendChild(box);

  // Header
  const head=document.createElement('div'); head.className='viewer-header';
  const title=document.createElement('div'); title.className='viewer-title';
  title.textContent = name || (kind==='pdf' ? 'PDF preview' : 'Image preview');
  const actions=document.createElement('div'); actions.className='viewer-actions';
  const openNew=document.createElement('a'); openNew.className='btn'; openNew.textContent='Open in new tab'; openNew.href=url; openNew.target='_blank';
  const closeBtn=document.createElement('button'); closeBtn.type='button'; closeBtn.type='button'; closeBtn.className='close-x'; closeBtn.setAttribute('aria-label','Close'); closeBtn.textContent='✕';
  closeBtn.onclick=()=>closeViewer();
  actions.append(openNew, closeBtn);
  head.append(title, actions); box.appendChild(head);

  // Body & Stage
  const body=document.createElement('div'); body.className='viewer-body';
  const stage=document.createElement('div'); stage.className='viewer-stage';
  let media; let scale=1; let rotation=0;
  if(kind==='pdf'){ media=document.createElement('iframe'); media.src=url; media.allow='fullscreen'; }
  else if(kind==='html'){ media=document.createElement('iframe'); media.src=url; media.sandbox=''; }
  else { media=new Image(); media.src=url; }
  stage.appendChild(media);
  body.appendChild(stage); box.appendChild(body);

  // Toolbar
  const tb=document.createElement('div'); tb.className='viewer-toolbar';
  function mk(txt, title, fn){ const b=document.createElement('button'); b.type='button'; b.type='button'; b.className='toolbar-btn'; b.textContent=txt; b.title=title; b.onclick=fn; return b; }
  const fitBtn=mk('Fit','Fit to window',()=>{ scale=1; rotation=rotation%360; apply(); });
  const zoomIn=mk('+','Zoom in (Ctrl +)',()=>{ scale=Math.min(5, scale+0.15); apply(); });
  const zoomOut=mk('−','Zoom out (Ctrl -)',()=>{ scale=Math.max(0.2, scale-0.15); apply(); });
  const rotateBtn=mk('⟲','Rotate 90°',()=>{ rotation=(rotation+90)%360; apply(); });
  tb.append(zoomOut, zoomIn, fitBtn, rotateBtn);
  body.appendChild(tb);

  function apply(){
    if(kind==='pdf'){ media.style.transform = 'scale('+scale+') rotate('+rotation+'deg)'; }
    else { media.style.transform = 'scale('+scale+') rotate('+rotation+'deg)'; }
  }

  // Simple drag-to-pan when zoomed
  let dragging=false, sx=0, sy=0, ox=0, oy=0;
  stage.addEventListener('mousedown', (e)=>{ if(scale<=1) return; dragging=true; sx=e.clientX; sy=e.clientY; stage.style.cursor='grabbing'; });
  window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; stage.scrollLeft = ox - dx; stage.scrollTop = oy - dy; });
  window.addEventListener('mouseup', ()=>{ dragging=false; ox=stage.scrollLeft; oy=stage.scrollTop; stage.style.cursor='default'; });
  stage.addEventListener('wheel', (e)=>{ if(e.ctrlKey){ e.preventDefault(); (e.deltaY>0?zoomOut:zoomIn)(); } }, {passive:false});

  viewerLastUrl=url; viewerLastIsBlob = typeof url==='string' && url.startsWith('blob:');
  root.classList.add('open');
  function onEsc(e){ if(e.key==='Escape') closeViewer(); if((e.ctrlKey||e.metaKey)&&e.key==='+') zoomIn(); if((e.ctrlKey||e.metaKey)&&e.key==='-') zoomOut(); if(e.key==='0'&&(e.ctrlKey||e.metaKey)) {e.preventDefault(); fitBtn.click();} if(e.key.toLowerCase()==='r'){ rotateBtn.click(); } }
  root.addEventListener('click', (e)=>{ if(e.target===root) closeViewer(); });
  document.addEventListener('keydown', onEsc, {once:false});
}
function closeViewer(){
  // Restore any dialogs hidden by viewer
  try{
    (window.__viewerHiddenEls||[]).forEach(el=>{ el.style.visibility=''; /* keep 'open' state */ delete el.dataset._wasOpen; });
    window.__viewerHiddenEls = [];
  }catch{} const root=document.getElementById('viewerRoot'); if(!root) return; root.classList.remove('open'); root.innerHTML=''; try{ if(viewerLastIsBlob && viewerLastUrl){ URL.revokeObjectURL(viewerLastUrl); window.__blobURLs && window.__blobURLs.delete && window.__blobURLs.delete(viewerLastUrl); } }catch{} viewerLastUrl=null; viewerLastIsBlob=false; }

// === Fullscreen toggle: delegated, cross-browser, and label-synced ===
(function(){
  function isFS(){ return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement; }
  function reqFS(el){ return (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el); }
  function exitFS(){ return (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document); }
  function syncBtn(){
    const btn=document.getElementById('fullscreenBtn'); if(!btn) return;
    btn.textContent = isFS() ? 'Exit Full Screen' : '⛶ Full Screen';
    btn.setAttribute('aria-pressed', isFS() ? 'true':'false');
  }
  // Click handler (delegated in case button is moved in DOM)
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest && e.target.closest('#fullscreenBtn');
    if(!btn) return;
    e.preventDefault();
    try{
      if(!isFS()) reqFS(document.documentElement);
      else exitFS();
    }catch(e){/* ignore */}
  }, true);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.key==='F11'){ e.preventDefault(); try{ if(!isFS()) reqFS(document.documentElement); else exitFS(); }catch{} }
    if(e.key==='Escape'){ setTimeout(syncBtn,0); }
  });

  ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(ev=>document.addEventListener(ev, syncBtn));
  // Try to place the button inline with mode controls if present
  (function place(){
    const fs=document.getElementById('fullscreenBtn'); if(!fs) return;
    const demo=document.getElementById('modeDemoBtn');
    const edit=document.getElementById('modeEditBtn');
    const host=(demo&&demo.parentElement)||(edit&&edit.parentElement);
    if(host && !host.contains(fs)){ host.appendChild(fs); fs.classList.add('inline'); }
  })();
  // Initial sync
  setTimeout(syncBtn, 0);
})();

// === Prevent any inline editing while in Demo mode ===
(function(){
  function disableInlineEditing(){
    // Remove contenteditable and editing state everywhere
    document.querySelectorAll('[contenteditable="true"], [data-editing="1"]').forEach(el=>{
      el.setAttribute('contenteditable','false');
      el.removeAttribute('data-editing');
    });
    // If something is currently focused and editable, blur it
    if(document.activeElement && (document.activeElement.getAttribute('contenteditable')==='true' || document.activeElement.dataset.editing==='1')){
      try{ document.activeElement.blur(); }catch{}
    }
  }
  // Harden all clicks: if in demo mode, block starting inline edits
  document.addEventListener('click', (e)=>{
    if(typeof demoMode!=='undefined' && demoMode===true){
      const target = e.target;
      // If the user clicks on any element that normally triggers inline edit, stop it
      if(target.closest && (target.closest('#pageName') || target.closest('.section-name') || target.closest('.label-editable') || target.closest('#vNav .name') || target.closest('#hRibbon .name'))){
        e.stopPropagation();
        e.preventDefault();
        disableInlineEditing();
      }
    }
  }, true);

  // Hook into mode toggling to enforce read-only in demo
  const _applyMode = window.applyMode;
  if(_applyMode){
    window.applyMode = function(){
      _applyMode.apply(this, arguments);
      if(typeof demoMode!=='undefined' && demoMode===true){
        disableInlineEditing();
      }
    };
  } else {
    // Fallback: run once at startup if already in demo
    if(typeof demoMode!=='undefined' && demoMode===true){
      disableInlineEditing();
    }
  }
})();

// === Demo-mode hardening: block dblclick + focus, sanitize after render ===
(function(){
  function isDemo(){ return (typeof demoMode!=='undefined' && demoMode===true) || document.body.classList.contains('demo-mode'); }
  function isEditableTarget(t){
    return t && t.closest && (
      t.closest('#pageName') ||
      t.closest('.section-name') ||
      t.closest('.label-editable') ||
      t.closest('#vNav .name') ||
      t.closest('#hRibbon .name')
    );
  }
  function sanitize(){
    document.querySelectorAll('[contenteditable="true"], [data-editing="1"], .section-name[contenteditable], .label-editable[contenteditable]').forEach(el=>{
      el.setAttribute('contenteditable','false');
      el.removeAttribute('data-editing');
    });
    if(document.activeElement && isEditableTarget(document.activeElement)){
      try{ document.activeElement.blur(); }catch{}
    }
  }
  // Block dblclick as well
  document.addEventListener('dblclick', (e)=>{
    if(!isDemo()) return;
    if(isEditableTarget(e.target)){ e.stopPropagation(); e.preventDefault(); sanitize(); }
  }, true);
  // Block focus entry
  document.addEventListener('focusin', (e)=>{
    if(!isDemo()) return;
    if(isEditableTarget(e.target)){ e.stopPropagation(); e.preventDefault(); sanitize(); }
  }, true);
  // Also guard keydown typing
  document.addEventListener('keydown', (e)=>{
    if(!isDemo()) return;
    if(isEditableTarget(e.target)){ e.stopPropagation(); e.preventDefault(); sanitize(); }
  }, true);

  // Sanitize after every render (in case contenteditable is re-applied)
  const _render = window.render;
  if(_render){
    window.render = function(){ _render.apply(this, arguments); if(isDemo()) sanitize(); };
  }
  // On init and when switching modes
  sanitize();
})();

// Remove leftover nav tip if injected dynamically
(function(){
  const sel = Array.from(document.querySelectorAll('.nav-tip, .tip, .tip-nav'));
  sel.forEach(el=>{
    if(/Items with children are containers/i.test(el.textContent||'')) el.remove();
  });
})();

// === Modal Dropzone Uploader ===
(function(){
  window.openUploader = function(accept, onFiles){
    let root = document.getElementById('uploadRoot');
    if(!root){
      root = document.createElement('div'); root.id='uploadRoot'; root.className='upload-root';
      document.body.appendChild(root);
    }
    root.innerHTML = '';
    const box = document.createElement('div'); box.className='upload'; root.appendChild(box);

    const head = document.createElement('div'); head.className='upload-header';
    const title = document.createElement('div'); title.className='upload-title'; title.textContent='Upload files';
    const cx = document.createElement('button'); cx.type='button'; cx.type='button'; cx.className='close-x'; cx.textContent='✕'; cx.onclick=()=>close();
    head.append(title, cx); box.appendChild(head);

    const body = document.createElement('div'); body.className='upload-body';
    const drop = document.createElement('div'); drop.className='upload-drop';
    drop.innerHTML = '<div style="font-weight:600">Drag & drop files here</div><div>or</div>';
    const actions = document.createElement('div'); actions.className='upload-actions';
    const browse = document.createElement('button'); browse.type='button'; browse.type='button'; browse.className='btn'; browse.type='button'; browse.textContent='Browse files';
    const cancel = document.createElement('button'); cancel.type='button'; cancel.type='button'; cancel.className='btn ghost'; cancel.type='button'; cancel.textContent='Cancel';
    actions.append(browse, cancel);
    body.append(drop, actions); box.appendChild(body);

    const input = document.createElement('input'); input.type='file'; input.multiple=true; if(accept) input.accept=accept; input.style.display='none';
    box.appendChild(input);

    function finish(list){
      try{ onFiles && onFiles(list); }finally{ close(); }
    }
    function close(){ root.classList.remove('open'); root.innerHTML=''; window.__confirmOpen=false; }
    function onDrop(e){
      e.preventDefault(); drop.classList.remove('over');
      const files = e.dataTransfer && e.dataTransfer.files;
      if(files && files.length) finish(files);
    }
    function onDragOver(e){ e.preventDefault(); drop.classList.add('over'); }
    function onDragLeave(){ drop.classList.remove('over'); }

    drop.addEventListener('dragover', onDragOver);
    drop.addEventListener('dragleave', onDragLeave);
    drop.addEventListener('drop', onDrop);
    browse.onclick = ()=> input.click();
    cancel.onclick = ()=> close();
    input.onchange = ()=>{ if(input.files && input.files.length) finish(input.files); };

    root.classList.add('open');
    root.addEventListener('click', (e)=>{ if(e.target===root) close(); });
    document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ close(); document.removeEventListener('keydown', esc); } });
  };
})();

// === Modal File Manager (grid-only previews inside dialog) ===
(function(){
  window.openFileManager = function(cfgOrAccept, filesArr, onUpdate){

    const cfg = (typeof cfgOrAccept==='object' && cfgOrAccept) ? cfgOrAccept : {accept: cfgOrAccept, maxSizeMB: 20, maxFiles: 0, multiple: true, htmlSandbox: true};
    const accept = cfg.accept || '';
    const maxSizeMB = (typeof cfg.maxSizeMB==='number' && cfg.maxSizeMB>0) ? cfg.maxSizeMB : 20;
    const maxFiles = (typeof cfg.maxFiles==='number' && cfg.maxFiles>=0) ? cfg.maxFiles : 0;
    const multiple = !!cfg.multiple;
    const htmlSandbox = cfg.htmlSandbox!==false;

    let root = document.getElementById('mgrRoot');
    if(!root){
      root = document.createElement('div'); root.id='mgrRoot'; root.className='mgr-root';
      document.body.appendChild(root);
    }
    root.innerHTML = '';
    const box = document.createElement('div'); box.className='mgr'; root.appendChild(box);

    const head = document.createElement('div'); head.className='mgr-header';
    const title = document.createElement('div'); title.className='mgr-title'; title.textContent='Manage files';
    const cx = document.createElement('button'); cx.type='button'; cx.type='button'; cx.className='close-x'; cx.textContent='✕'; cx.onclick=()=>close();
    head.append(title, cx); box.appendChild(head);

    const drop = document.createElement('div'); drop.className='mgr-drop';
    drop.innerHTML = '<div style="font-weight:600">Drag & drop files here</div><div>or</div>';
    const actions = document.createElement('div'); actions.className='upload-actions';
    const browse = document.createElement('button'); browse.type='button'; browse.type='button'; browse.className='btn'; browse.type='button'; browse.textContent='Browse files';
    actions.append(browse);
    const hint=document.createElement('div'); hint.style.marginTop='8px'; hint.style.fontSize='12px'; hint.style.color='#64748b'; hint.textContent='Allowed: '+(accept||'images,pdf,html')+' • Max size: '+maxSizeMB+' MB'+(maxFiles?(' • Up to '+maxFiles+' files'):'');
    const dropWrap = document.createElement('div'); dropWrap.append(drop, actions, hint);
    box.appendChild(dropWrap);

    const body = document.createElement('div'); body.className='mgr-body';
    const grid = document.createElement('div'); grid.className='mgr-grid';
    body.appendChild(grid); box.appendChild(body);

    const footer = document.createElement('div'); footer.className='mgr-footer';
    const done = document.createElement('button'); done.type='button'; done.type='button'; done.className='btn'; done.textContent='Done'; done.onclick=()=>close();
    footer.append(done); box.appendChild(footer);

    const input = document.createElement('input'); input.type='file'; input.multiple=true; if(accept) input.accept=accept; input.style.display='none';
    box.appendChild(input);


    function parseAccept(str){
      if(!str) return [];
      return str.split(',').map(s=>s.trim()).filter(Boolean);
    }
    const acceptList = parseAccept(accept);
    function isAllowedType(file){
      if(!acceptList.length) return /^(image\/.*|application\/pdf|text\/html)$/i.test(file.type) || /\.html?$/i.test(file.name||'');
      const name=(file.name||'').toLowerCase();
      const mime=(file.type||'').toLowerCase();
      return acceptList.some(rule=>{
        rule=rule.toLowerCase();
        if(rule.endsWith('/*')){ const p=rule.replace('/*','/'); return mime.startsWith(p); }
        if(rule.startsWith('.')){ return name.endsWith(rule); }
        return mime===rule;
      });
    }

    function bytes(n){ if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(1)+' MB'; }
    function pushErr(m){ toast ? toast(m) : console.warn(m); }
    function addFile(f){
      const MAX = maxSizeMB*1024*1024;
      if(!isAllowedType(f)){ pushErr('Unsupported type: '+(f.name||'')); return; }
      if(f.size>MAX){ pushErr((f.name||'file')+' too large ('+bytes(f.size)+', max '+maxSizeMB+' MB)'); return; }
      if(maxFiles && filesArr.length>=maxFiles){ pushErr('Maximum '+maxFiles+' files allowed. Remove one to add another.'); return; }
      const url = URL.createObjectURL(f);
      const kind = f.type.startsWith('image/') ? 'image' : (f.type==='application/pdf' ? 'pdf' : 'html');
      filesArr.push({file:f, url, kind, name:f.name});
    }
    function handleFiles(list){ const arr=Array.from(list||[]);
      if(!multiple){
        // replace policy: keep only last file
        // revoke existing blobs
        filesArr.splice(0, filesArr.length).forEach(g=>{ try{ if(g && g.url && g.url.startsWith('blob:')) URL.revokeObjectURL(g.url); }catch{} });
      }
      arr.forEach(addFile);
      render(); onUpdate && onUpdate(filesArr); }

    function render(){
      grid.innerHTML='';
      filesArr.forEach((obj, idx)=>{
        const card=document.createElement('div'); card.className='mgr-card';
        if(obj.kind==='image'){
          const img=new Image(); img.src=obj.url; img.className='mgr-thumb'; card.appendChild(img);
        }else if(obj.kind==='pdf'){
          const iframe=document.createElement('iframe'); iframe.src=obj.url; iframe.className='mgr-thumb is-pdf'; card.appendChild(iframe);
        }else{
          const iframe=document.createElement('iframe'); iframe.src=obj.url; iframe.className='mgr-thumb'; if(htmlSandbox) iframe.sandbox=''; card.appendChild(iframe);
        }
        const nm=document.createElement('div'); nm.className='mgr-name'; nm.title=obj.name; nm.textContent=obj.name; card.appendChild(nm);
        const meta=document.createElement('div'); meta.className='mgr-meta'; meta.textContent = (typeof obj.size==='number') ? bytes(obj.size) : (obj.file && typeof obj.file.size==='number' ? bytes(obj.file.size) : ''); card.appendChild(meta);
        const act=document.createElement('div'); act.className='mgr-actions';
        const bOpen=document.createElement('button'); bOpen.type='button'; bOpen.type='button'; bOpen.type='button'; bOpen.className='btn'; bOpen.textContent='Open'; bOpen.onclick=()=>openViewer(obj.url, obj.kind, obj.name||'');
        const bDl=document.createElement('a'); bDl.href=obj.url; bDl.download=obj.name||'file'; bDl.className='btn ghost'; bDl.textContent='Download';
        const bRep=document.createElement('button'); bRep.type='button'; bRep.type='button'; bRep.type='button'; bRep.className='btn ghost'; bRep.textContent='Replace';
        const bRem=document.createElement('button'); bRem.type='button'; bRem.type='button'; bRem.type='button'; bRem.className='btn ghost'; bRem.textContent='Remove';
        act.append(bOpen, bDl, bRep, bRem); card.appendChild(act);
        bRep.onclick=()=>{
          const r=document.createElement('input'); r.type='file'; r.accept=input.accept; r.onchange=()=>{
            const nf=r.files && r.files[0]; if(!nf) return;
            try{ if(obj.url && obj.url.startsWith('blob:')){ URL.revokeObjectURL(obj.url); window.__blobURLs && window.__blobURLs.delete && window.__blobURLs.delete(obj.url); } }catch{}
            const url=URL.createObjectURL(nf);
            obj.file=nf; obj.url=url; obj.kind = nf.type.startsWith('image/') ? 'image' : (nf.type==='application/pdf' ? 'pdf' : 'html'); obj.name=nf.name; obj.type=nf.type; obj.size=nf.size;
            render(); onUpdate && onUpdate(filesArr);
          }; r.click();
        };
        bRem.onclick=()=>{
          const gone = filesArr.splice(idx,1)[0];
          try{ if(gone && gone.url && gone.url.startsWith('blob:')){ URL.revokeObjectURL(gone.url); window.__blobURLs && window.__blobURLs.delete && window.__blobURLs.delete(gone.url); } }catch{}
          render(); onUpdate && onUpdate(filesArr);
        };
        card.addEventListener('click',(e)=>{
          if(e.target && (e.target===bOpen || e.target===bDl || e.target===bRep || e.target===bRem)) return;
          openViewer(obj.url, obj.kind, obj.name||'');
        });
        grid.appendChild(card);
      });
    }

    function close(){ root.classList.remove('open'); root.innerHTML=''; window.__confirmOpen=false; }
    // drag/drop + browse hookup
    function onDrop(e){ e.preventDefault(); drop.classList.remove('over'); const f=e.dataTransfer && e.dataTransfer.files; if(f && f.length) handleFiles(f); }
    function onDragOver(e){ e.preventDefault(); drop.classList.add('over'); }
    function onDragLeave(){ drop.classList.remove('over'); }

    drop.addEventListener('dragover', onDragOver);
    drop.addEventListener('dragleave', onDragLeave);
    drop.addEventListener('drop', onDrop);
    browse.onclick = ()=> input.click();
    input.onchange = ()=>{ if(input.files && input.files.length) handleFiles(input.files); };

    root.classList.add('open');
    root.addEventListener('click', (e)=>{ if(e.target===root) close(); });
    document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ close(); document.removeEventListener('keydown', esc); } });
    render();
  };
})();

// === Nice confirmation dialog returning a Promise<boolean> ===
window.confirmDialog = function(opts){
  if(window.__confirmOpen){return Promise.resolve(false);} window.__confirmOpen=true;
  return new Promise((resolve)=>{
    const title = (opts && opts.title) || 'Are you sure?';
    const name = (opts && opts.name) || '';
    const showName = (opts && opts.showName) || false;
    const body = (opts && opts.body) || 'This action cannot be undone.';
    const confirmText = (opts && opts.confirmText) || 'Delete';
    const cancelText = (opts && opts.cancelText) || 'Cancel';
    const tone = (opts && opts.tone) || 'danger';
    const icon = (opts && opts.icon) || (tone==='danger' ? '⚠️' : 'ℹ️');

    let root = document.getElementById('confirmRoot');
    if(!root){ root = document.createElement('div'); root.id='confirmRoot'; root.className='confirm-root'; document.body.appendChild(root); }
    root.innerHTML='';

    const box = document.createElement('div'); box.className='confirm'; root.appendChild(box);
    const head = document.createElement('div'); head.className='confirm-head';
    const ic = document.createElement('div'); ic.className='icon'; ic.textContent=icon;
    const h = document.createElement('div'); h.className='confirm-title'; h.textContent= title + (showName && name? (' ' + name) : '');
    head.appendChild(ic);
    head.appendChild(h);
    const bodyEl = document.createElement('div'); bodyEl.className='confirm-body'; bodyEl.textContent=body;
    const foot = document.createElement('div'); foot.className='confirm-foot';
    const cancel = document.createElement('button'); cancel.type='button'; cancel.type='button'; cancel.className='btn ghost'; cancel.textContent=cancelText;
    const ok = document.createElement('button'); ok.type='button'; ok.type='button'; ok.className='btn ' + (tone==='danger' ? 'danger' : ''); ok.textContent=confirmText;
    foot.append(cancel, ok);
    box.append(head, bodyEl, foot);

    function close(){ root.classList.remove('open'); root.innerHTML=''; window.__confirmOpen=false; }
    cancel.onclick = ()=>{ cancel.disabled=true; ok.disabled=true; resolve(false); close(); };
    ok.onclick = ()=>{ cancel.disabled=true; ok.disabled=true; resolve(true); close(); };
    root.classList.add('open');
    root.addEventListener('click', (e)=>{ if(e.target===root) { resolve(false); close(); } });
    document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ resolve(false); close(); document.removeEventListener('keydown', esc); } });
  });
};

// === Nice "Add Field" picker dialog (Promise<string|null>) ===
if(!window.pickFieldType){

window.pickFieldType = function(opts){
  if(window.__pickerOpen){ return Promise.resolve(null); }
  window.__pickerOpen = true;
  const TYPES = (opts && opts.types) || ['text', 'number', 'email', 'password', 'tel', 'url', 'select', 'dropdown', 'multiselect', 'radio', 'checkbox', 'checkboxes', 'date', 'time', 'range', 'color', 'textarea', 'html', 'file', 'image', 'rating', 'button', 'divider', 'space', 'table', 'toggle', 'signature', 'richtext'];
  const ICONS = {'text': '🔤', 'number': '🔢', 'email': '✉️', 'password': '🔒', 'tel': '📞', 'url': '🔗', 'select': '▾', 'dropdown': '▾', 'multiselect': '▾+', 'radio': '🔘', 'checkbox': '☑️', 'checkboxes': '☑️☑️', 'date': '📅', 'time': '⏰', 'range': '📈', 'color': '🎨', 'textarea': '📝', 'html': '</>', 'file': '📎', 'image': '🖼️', 'rating': '⭐', 'button': '🔳', 'divider': '⎯', 'space': '⬚', 'table': '📊', 'toggle': '🎚️', 'richtext': '🅁', 'signature': '✍️'};
  return new Promise((resolve)=>{
    let root = document.getElementById('pickerRoot');
    if(!root){ root = document.createElement('div'); root.id='pickerRoot'; root.className='confirm-root'; document.body.appendChild(root); }
    root.innerHTML='';

    const box = document.createElement('div'); box.className='confirm'; root.appendChild(box);
    const head = document.createElement('div'); head.className='confirm-head';
    const ic = document.createElement('div'); ic.className='icon'; ic.textContent='➕';
    const h = document.createElement('div'); h.className='confirm-title'; h.textContent='Add a new field';
    head.appendChild(ic); head.appendChild(h);

    const body = document.createElement('div'); body.className='confirm-body';
    const hintWrap = document.createElement('div'); hintWrap.style.display='flex'; hintWrap.style.justifyContent='space-between'; hintWrap.style.alignItems='center'; hintWrap.style.marginBottom='8px';
    const hint = document.createElement('div'); hint.textContent='Pick a field type:';
    const lastSpan = document.createElement('div'); lastSpan.className='last-used';
    hintWrap.appendChild(hint); hintWrap.appendChild(lastSpan);
    const grid = document.createElement('div'); grid.className='type-grid';
    body.appendChild(hintWrap); body.appendChild(grid);

    const last = (localStorage && localStorage.getItem('lastFieldType')) || '';
    if(last){ lastSpan.textContent = 'Last used: ' + last; }
    const btns = [];

    TYPES.forEach((t, idx)=>{
      const btn = document.createElement('button'); btn.type='button'; btn.type='button';
      btn.className='btn ghost type-pill';
      btn.type='button';
      btn.setAttribute('data-type', t);
      btn.setAttribute('data-index', String(idx));
      while (btn.firstChild) btn.removeChild(btn.firstChild);
      const ico = document.createElement('span'); ico.className='tp-ico'; ico.textContent = (ICONS[t]||'•');
      const lab = document.createElement('span'); lab.className='tp-label'; lab.textContent = t;
      btn.appendChild(ico); btn.appendChild(lab);
      // content already set via DOM creation
      btn.onclick = ()=>{
        cleanup();
        try{ localStorage && localStorage.setItem('lastFieldType', t); }catch{}
        resolve(t);
      };
      btn.onkeydown = (e)=>{
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); btn.click(); return; }
        const count = colCount();
        const i = btns.indexOf(btn);
        let j = i;
        if(e.key==='ArrowRight') j = Math.min(btns.length-1, i+1);
        else if(e.key==='ArrowLeft') j = Math.max(0, i-1);
        else if(e.key==='ArrowDown') j = Math.min(btns.length-1, i+count);
        else if(e.key==='ArrowUp') j = Math.max(0, i-count);
        if(j !== i){ e.preventDefault(); btns[j].focus(); }
      };
      btns.push(btn);
      grid.appendChild(btn);
    });

    const foot = document.createElement('div'); foot.className='confirm-foot';
    const cancel = document.createElement('button'); cancel.type='button'; cancel.type='button'; cancel.className='btn ghost'; cancel.textContent='Cancel';
    cancel.onclick = ()=>{ cleanup(); resolve(null); };
    foot.appendChild(cancel);

    box.append(head, body, foot);

    function onKey(e){ if(e.key==='Escape'){ cleanup(); resolve(null); } }
    function onBackdrop(e){ if(e.target===root){ cleanup(); resolve(null); } }
    function colCount(){
      const first = btns[0];
      if(!first) return 1;
      const pillW = first.offsetWidth || 140;
      const gap = 8;
      const w = grid.clientWidth || 400;
      return Math.max(1, Math.floor((w + gap) / (pillW + gap)));
    }
    function cleanup(){
      root.classList.remove('open');
      root.innerHTML='';
      document.removeEventListener('keydown', onKey);
      root.removeEventListener('click', onBackdrop);
      window.__pickerOpen = false;
    }

    root.classList.add('open');
    document.addEventListener('keydown', onKey);
    root.addEventListener('click', onBackdrop);

    setTimeout(()=>{
      let focusBtn = null;
      if(last){ focusBtn = btns.find(b=> b.getAttribute('data-type')===last) || null; }
      (focusBtn || btns[0] || cancel).focus();
    }, 0);
  });
};

  // minimal styles for type grid/pills
  (function injectPickerStyles(){
    if(document.getElementById('pickerStyles')) return;
    const style = document.createElement('style'); style.id='pickerStyles';
    style.textContent = `/* Type picker grid & pills */
.type-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.type-pill{display:flex;align-items:center;justify-content:flex-start;gap:8px;padding:10px 12px;border:1px solid #e6e8f0;border-radius:9999px;cursor:pointer}
.type-pill .tp-ico{font-size:14px;line-height:1}
.type-pill .tp-label{text-transform:capitalize}
.type-pill:focus{outline:2px solid var(--ring); outline-offset:2px}
.last-used{opacity:.7; font-size:12px}`;
    document.head.appendChild(style);
  })();
}

// === Enhanced inline edit for field labels (match logo/pageName) ===
(function(){
  if(window.__labelsEnhanced) return; window.__labelsEnhanced = true;
  function enable(el, getFD){
    if(!el || el.dataset.inlineReady2) return;
    el.dataset.inlineReady2 = '1';
    el.style.cursor = 'text';
    let originalText = '';
    function begin(){
      if((typeof demoMode!=='undefined' && demoMode) || (document.body && document.body.classList && document.body.classList.contains('demo-mode'))) return;
      originalText = (el.textContent||'').trim();
      el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
      el.setAttribute('data-editing','1');
      el.focus();
      try{ document.execCommand && document.execCommand('selectAll', false, null);}catch{}
    }
    function commit(){
      if((typeof demoMode!=='undefined' && demoMode) || (document.body && document.body.classList && document.body.classList.contains('demo-mode'))) return;
      const v=(el.textContent||'').trim();
      const fd = getFD && getFD();
      if(fd && v && v!==fd.name){ fd.name=v; render?.(); }
      el.removeAttribute('data-editing');
      el.removeAttribute('contenteditable');
    }
    function cancel(){
      el.textContent = originalText;
      el.removeAttribute('data-editing');
      el.removeAttribute('contenteditable');
    }
    el.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); begin(); });
    el.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
      if(e.key==='Escape'){ e.preventDefault(); cancel(); el.blur(); }
    });
    el.addEventListener('blur', commit);
  }

  function boot(root){
    (root||document).querySelectorAll('.fcard').forEach(card=>{
      const fid = card.dataset && card.dataset.nid;
      const labelHost = card.querySelector('label .label-editable') || card.querySelector('label');
      if(!fid || !labelHost) return;
      enable(labelHost, ()=> (typeof fieldById==='function') ? fieldById(fid) : null);
    });
  }
  const _render = window.render;
  if(_render){
    window.render = function(){ _render.apply(this, arguments); try{ boot(); }catch{} };
  }
  try{ boot(); }catch{}
})();

// Robustly open inspector and switch to a specific tab name

// Stronger helper: waits with MutationObserver and fuzzy-matches tab text
window.openInspectorAndTab = function(fieldId, tabName){
  try{ selectNode(fieldId); }catch{}
  try{ openInspector(fieldId); }catch{}
  const deadline = Date.now() + 5000; // wait up to 5s
  function tryClick(){
    const tabsEl = document.getElementById('inspTabs');
    if(tabsEl){
      const btns = Array.from(tabsEl.querySelectorAll('button'));
      if(btns.length){
        const want = (tabName||'').toLowerCase();
        // fuzzy matcher: contains word, ignores spaces/icons
        let target = btns.find(b => (b.textContent||'').toLowerCase().replace(/[^a-z]/g,'').includes(want.replace(/[^a-z]/g,'')));
        if(!target && want){
          // fallback: first button that starts with same letter
          target = btns.find(b => (b.textContent||'').trim().toLowerCase().startsWith(want[0]||''));
        }
        (target||btns[0]).click();
        return true;
      }
    }
    return false;
  }
  if(tryClick()) return;
  const obs = new MutationObserver(() => {
    if(tryClick()){ obs.disconnect(); }
    else if(Date.now()>deadline){ obs.disconnect(); }
  });
  obs.observe(document.querySelector('#designerCard') || document.body, {childList:true, subtree:true});
  // also poll as a backup
  const timer = setInterval(()=>{
    if(tryClick() || Date.now()>deadline){ clearInterval(timer); }
  }, 80);
};

// === Unified Inline Editing (logo, page header, sections, field labels) ===
(function(){
  if(window.__inlineUnified) return; window.__inlineUnified = true;

  function beginEdit(el){
    if(!el || (typeof demoMode!=='undefined' && demoMode)) return false;
    if(el.dataset.editing==='1') return true;
    el.dataset.editing='1';
    el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
    el.focus();
    try{ document.execCommand && document.execCommand('selectAll', false, null);}catch{}
    return true;
  }
  function endEdit(el, commit, onSave, original){
    if(!el) return;
    el.removeAttribute('contenteditable');
    el.removeAttribute('data-editing');
    if(commit){
      const v=(el.textContent||'').trim();
      if(typeof onSave==='function') onSave(v, original);
    }else{
      el.textContent = original;
    }
  }
  function wire(el, onSave, opts){
    if(!el) return;
    let original='';
    const start = (e)=>{
      if((typeof demoMode!=='undefined' && demoMode) || (document.body && document.body.classList && document.body.classList.contains('demo-mode'))) return;
      // avoid when clicking an input nested in label (checkbox/radio)
      if(e && e.target && (/^(input|select|textarea)$/i).test(e.target.tagName)) return;
      original=(el.textContent||'').trim();
      if(beginEdit(el)){ e && e.stopPropagation(); }
    };
    const onKey=(e)=>{
      if(el.dataset.editing!=='1') return;
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
      if(e.key==='Escape'){ e.preventDefault(); endEdit(el,false,onSave,original); el.blur(); }
    };
    const onBlur=()=>{
      if(el.dataset.editing!=='1') return;
      endEdit(el,true,onSave,original);
    };
    el.addEventListener('click', function(e){ e.preventDefault(); start(e); });
    el.addEventListener('keydown', onKey);
    el.addEventListener('blur', onBlur);
  }

  // Field labels (within .fcard)
  function wireFieldLabels(root){
    (root||document).querySelectorAll('.fcard').forEach(card=>{
      const fid = card.dataset && card.dataset.nid;
      if(!fid) return;
      const fd = (typeof fieldById==='function') ? fieldById(fid) : null;
      const labelEl = card.querySelector('label .label-editable') || card.querySelector('label');
      if(!labelEl || !fd) return;
      wire(labelEl, (v)=>{ if(v && v!==fd.name){ fd.name=v; if(typeof render==='function') renderDebounced(); } });
    });
  }

  // Section titles (assume .section-name is the editable span)
  function wireSections(root){
    (root||document).querySelectorAll('.section-name').forEach(node=>{
      const sid = node.closest('[data-sid]')?.getAttribute('data-sid');
      wire(node, (v)=>{
        if(!v) return;
        try{
          if(typeof sectionById==='function'){ const s=sectionById(sid); if(s && s.name!==v){ s.name=v; render && render(); } }
          else { node.textContent=v; }
        }catch{ node.textContent=v; }
      });
    });
  }

  // Page header text (assume #pageName)
  function wirePageHeader(root){
    const el = (root||document).querySelector('#pageName');
    if(!el) return;
    wire(el, (v)=>{
      if(!v) return;
      try{
        if(typeof setPageName==='function'){ setPageName(v); }
        else { el.textContent=v; }
      }catch{ el.textContent=v; }
    });
  }

  // Logo text (assume #logoText or .logo-text)
  function wireLogo(root){
    const el = (root||document).querySelector('#logoText, .logo-text');
    if(!el) return;
    wire(el, (v)=>{
      if(!v) return;
      try{
        if(typeof setLogoText==='function'){ setLogoText(v); }
        else { el.textContent=v; }
      }catch{ el.textContent=v; }
    });
  }

  function boot(root){
    wireFieldLabels(root);
    wireSections(root);
    wirePageHeader(root);
    wireLogo(root);
  }

  // Re-run after each render
  const _render = window.render;
  if(_render){
    window.render = function(){ _render.apply(this, arguments); try{ boot(); }catch{} };
  }
  try{ boot(); }catch{}
})();

// === Ensure logo inline editing works on initial load (DOM-ready + observer) ===
(function(){
  const sel = '#logoText, .logo-text, [data-role="logo-text"]';
  function bind(el){
    if(!el || el.dataset.logoInlineReady) return;
    el.dataset.logoInlineReady = '1';
    el.style.cursor = 'text';
    let original='';
    function begin(){
      if((typeof demoMode!=='undefined' && demoMode) || (document.body && document.body.classList && document.body.classList.contains('demo-mode'))) return;
      original=(el.textContent||'').trim();
      el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
      el.setAttribute('data-editing','1');
      el.focus();
      try{ document.execCommand && document.execCommand('selectAll', false, null);}catch{}
    }
    function cancel(){
      el.textContent = original;
      el.removeAttribute('contenteditable'); el.removeAttribute('data-editing');
    }
    function commit(){
      if((typeof demoMode!=='undefined' && demoMode) || (document.body && document.body.classList && document.body.classList.contains('demo-mode'))) return;
      const v=(el.textContent||'').trim();
      try{ if(typeof setLogoText==='function' && v){ setLogoText(v); } else { el.textContent=v; } }catch{ el.textContent=v; }
      el.removeAttribute('contenteditable'); el.removeAttribute('data-editing');
    }
    el.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); begin(); });
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); el.blur(); } if(e.key==='Escape'){ e.preventDefault(); cancel(); el.blur(); } });
    el.addEventListener('blur', commit);
  }
  function find(){ const el = document.querySelector(sel); if(el) bind(el); }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', find, {once:true}); } else { find(); }
  const mo = new MutationObserver(()=>find());
  mo.observe(document.querySelector('#designerCard') || document.documentElement, {childList:true, subtree:true});
})();

// Ensure inline editing is enabled immediately on load (even before first render)
(function(){
  function kick(){
    try{
      if(window.__inlineUnified && typeof render==='function'){ /* no-op, unified already hooks render */ }
      // Try to bind logo explicitly (id/class/data-role)
      const sel = '#logoText, .logo-text, [data-role="logo-text"]';
      const logo = document.querySelector(sel);
      if(logo && !logo.dataset.logoInlineReady){ logo.click(); logo.blur(); } // primes listeners without staying in edit
    }catch(e){}
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', kick, {once:true}); } else { kick(); }
})();

// === Normalize field labels & unify inline editing behavior with sections ===
(function(){
  if(window.__normalizeLabels) return; window.__normalizeLabels = true;

  function isDemo(){
    return (typeof demoMode!=='undefined' && demoMode) || (document.body && document.body.classList && document.body.classList.contains('demo-mode'));
  }

  function fieldModelFromCard(card){
    try{
      const fid = card && card.dataset && card.dataset.nid;
      return (fid && typeof fieldById==='function') ? fieldById(fid) : null;
    }catch{ return null; }
  }

  // Ensure each label has a dedicated .label-editable span (text only, not the control)
  function normalizeLabels(root){
    (root||document).querySelectorAll('.fcard').forEach(card=>{
      const label = card.querySelector('label');
      if(!label) return;
      if(label.querySelector('.label-editable')) return; // already normalized
      const fd = fieldModelFromCard(card);
      const span = document.createElement('span');
      span.className = 'label-editable';
      // Prefer model name to avoid duplicating existing text nodes
      span.textContent = (fd && fd.name) ? fd.name : (label.textContent||'').trim();
      // Insert span at the start of the label content
      label.insertBefore(span, label.firstChild || null);
    });
  }

  // Wire inline editing exactly like sections
  function wireInline(root){
    (root||document).querySelectorAll('.fcard').forEach(card=>{
      const fd = fieldModelFromCard(card);
      const el = card.querySelector('label .label-editable');
      if(!el || el.dataset.inlineReadySecLike) return;
      el.dataset.inlineReadySecLike='1';
      el.style.cursor='text';
      let original='';
      el.addEventListener('click', (e)=>{
        if(isDemo()) return;
        e.preventDefault(); e.stopPropagation();
        original=(el.textContent||'').trim();
        el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
        el.setAttribute('data-editing','1');
        el.focus();
        try{ document.execCommand && document.execCommand('selectAll', false, null);}catch{}
      });
      el.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
        if(e.key==='Escape'){ e.preventDefault(); el.textContent=original; el.blur(); }
      });
      el.addEventListener('blur', ()=>{
        if(isDemo()) return;
        const v=(el.textContent||'').trim();
        if(fd && v && v!==fd.name){ fd.name=v; try{ render && render(); }catch{} }
        el.removeAttribute('contenteditable'); el.removeAttribute('data-editing');
      });
    });
  }

  // Logo: apply the same pattern and prevent anchor default if logo is a link
  function wireLogo(){
    const el = document.querySelector('#logoText, .logo-text, [data-role="logo-text"]');
    if(!el || el.dataset.inlineReadySecLike) return;
    el.dataset.inlineReadySecLike='1';
    el.style.cursor='text';
    let original='';
    el.addEventListener('click', (e)=>{
      if(isDemo()) return;
      e.preventDefault(); e.stopPropagation();
      original=(el.textContent||'').trim();
      el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
      el.setAttribute('data-editing','1');
      el.focus();
      try{ document.execCommand && document.execCommand('selectAll', false, null);}catch{}
    });
    el.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
      if(e.key==='Escape'){ e.preventDefault(); el.textContent=original; el.blur(); }
    });
    el.addEventListener('blur', ()=>{
      if(isDemo()) return;
      const v=(el.textContent||'').trim();
      try{ if(typeof setLogoText==='function' && v){ setLogoText(v); } else { el.textContent=v; } }catch{ el.textContent=v; }
      el.removeAttribute('contenteditable'); el.removeAttribute('data-editing');
    });
  }

  function boot(root){
    normalizeLabels(root);
    wireInline(root);
    wireLogo();
  }

  // Run now and after each render; also observe DOM for late content
  const _render = window.render;
  if(_render){
    window.render = function(){ _render.apply(this, arguments); try{ boot(); }catch{} };
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', ()=>boot(), {once:true}); } else { try{ boot(); }catch{} }
  const mo = new MutationObserver((() => { const __deb=(window.__bootDeb||(window.__bootDeb=__debounce(()=>boot(),80))); __deb(); }));
  mo.observe(document.querySelector('#designerCard') || document.body || document.documentElement, {childList:true, subtree:true});
})();
</script>
<div aria-modal="true" class="viewer-root" id="viewerRoot" role="dialog"></div>
<button class="btn ghost fullscreen-btn" id="fullscreenBtn" title="Full screen">⛶</button>
<script>
    // injected debounce helper
    function __debounce(fn, wait){
      let t; return function(){ const ctx=this, args=arguments;
        clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, wait||60);
      };
    }
    </script>
<script>
// First-load inline-edit guard (idempotent)
(function(){
  function ensureInlineReady(){
    try{
      if(document.body.classList.contains('demo-mode')) return; // demo mode: no inline edit
      // Prefer the app's own unified module if present
      if (window.__inlineUnified && typeof window.__inlineUnified.boot === 'function'){
        window.__inlineUnified.boot();
        return;
      }
      // Minimal fallback: make key elements editable
      var targets = [];
      var siteName = document.querySelector('#siteName');
      if (siteName) targets.push(siteName);
      document.querySelectorAll('.fcard label .label-editable').forEach(function(el){ targets.push(el); });
      targets.forEach(function(el){
        if(!el.getAttribute('contenteditable')) el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
      });
    }catch(e){ /* noop */ }
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ensureInlineReady, {once:true});
  } else {
    ensureInlineReady();
  }
  // Run again shortly after other boot scripts bind
  setTimeout(ensureInlineReady, 150);
})();
</script>
<script>
// Robust inline editing: first-click works (Edit mode), caret preserved
(function(){
  if (window.__inlineHardGuardInstalled) return; window.__inlineHardGuardInstalled = true;

  function isDemo(){ return document.body.classList.contains('demo-mode'); }

  function placeCaretAtEnd(el){
    try{
      el.focus();
      var range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      var sel = window.getSelection();
      sel.removeAllRanges(); sel.addRange(range);
    }catch(e){ el.focus(); }
  }
  function placeCaretAtPoint(el, ev){
    try{
      el.focus();
      var sel = window.getSelection();
      var range = null;
      if (document.caretRangeFromPoint){
        range = document.caretRangeFromPoint(ev.clientX, ev.clientY);
      } else if (document.caretPositionFromPoint){
        var pos = document.caretPositionFromPoint(ev.clientX, ev.clientY);
        if (pos){ range = document.createRange(); range.setStart(pos.offsetNode, pos.offset); }
      }
      if (range){
        sel.removeAllRanges();
        sel.addRange(range);
        return true;
      }
    }catch(e){}
    return false;
  }
    try{
      el.focus();
      var range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      var sel = window.getSelection();
      sel.removeAllRanges(); sel.addRange(range);
    }catch(e){ el.focus(); }
  }

  function beginInline(el, ev){
    if (isDemo()) return;
    // ensure only one editing at a time
    document.querySelectorAll('[data-inline-editing="1"]').forEach(function(other){
      if (other!==el){ other.removeAttribute('data-inline-editing'); other.removeAttribute('contenteditable'); }
    });
    el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
    el.setAttribute('data-inline-editing','1');
    // prevent parent click toggles from interfering
    el.addEventListener('mousedown', function(ev){ ev.stopPropagation(); }, {once:true, capture:true});
    // key handling
    function onKey(e){
      if (e.key==='Escape'){ e.preventDefault(); el.blur(); }
      if (e.key==='Enter'){ e.preventDefault(); el.blur(); }
    }
    function onBlur(){
      el.removeEventListener('keydown', onKey);
      el.removeEventListener('blur', onBlur);
      el.removeAttribute('data-inline-editing');
      // persist via existing app contracts if present
      if (el.id==='siteName' && window.localStorage){
        try{ localStorage.setItem('site_name', el.textContent.trim()); }catch{}
      }
      // leave contenteditable true for subsequent edits to avoid races
      // (if your unified module prefers removing it, it can still do so later)
    }
    el.addEventListener('keydown', onKey);
    el.addEventListener('blur', onBlur);
    // position caret where user clicked; fallback to end
    setTimeout(function(){ if(!(ev && placeCaretAtPoint(el, ev))){ placeCaretAtEnd(el); } }, 0);
  }

  function bindInlineTargets(root){
    if (isDemo()) return;
    var targets = [];
    var site = root.querySelector('#siteName'); if(site) targets.push(site);
    root.querySelectorAll('.fcard label .label-editable').forEach(function(el){ targets.push(el); });
    targets.forEach(function(el){
      if (!el.__inlineBound){
        el.__inlineBound = true;
        el.addEventListener('pointerdown', function(ev){
  if (isDemo()) return;
  ev.stopPropagation();
  beginInline(el, ev);
}, {capture:true});
// prevent bubbling click from triggering other handlers (like logo picker)
el.addEventListener('click', function(ev){ if(!isDemo()){ ev.stopPropagation(); ev.preventDefault(); } });
        // ensure editable attribute exists so caret shows immediately on focus
        if(!el.hasAttribute('contenteditable')) el.setAttribute('contenteditable','true'); if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
      }
    });
  }

  // initial and after boot
  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ bindInlineTargets(document); }, {once:true});
  } else {
    bindInlineTargets(document);
  }
  // re-bind on relevant renders (scoped observer)
  var container = document.querySelector('#designerCard') || document.body;
  var rebind = (function(){ let t; return function(){ clearTimeout(t); t=setTimeout(function(){ bindInlineTargets(container); }, 60); }; })();
  try{
    var mo = new MutationObserver(rebind);
    mo.observe(container, {childList:true, subtree:true});
  }catch(e){ /* ignore */ }
})();
</script>
<script>
(function(){
  if (window.__inlineFinalGuardInstalled) return; window.__inlineFinalGuardInstalled = true;

  // Prefer Edit on first load unless explicitly stored (won't override a saved choice)
  try{
    var saved = localStorage.getItem('demo_mode'); // expect '1' when demo
    if (saved !== '1' && document.body.classList.contains('demo-mode')){
      document.body.classList.remove('demo-mode');
    }
  }catch(e){}

  function isDemo(){ return document.body.classList.contains('demo-mode'); }

  function caretAtPoint(el, ev){
    try{
      el.focus();
      var sel = window.getSelection();
      var range = null;
      if (document.caretRangeFromPoint){
        range = document.caretRangeFromPoint(ev.clientX, ev.clientY);
      } else if (document.caretPositionFromPoint){
        var pos = document.caretPositionFromPoint(ev.clientX, ev.clientY);
        if (pos){ range = document.createRange(); range.setStart(pos.offsetNode, pos.offset); }
      }
      if (range){
        sel.removeAllRanges(); sel.addRange(range);
        return true;
      }
    }catch(e){}
    return false;
  }
  function caretAtEnd(el){
    try{
      el.focus();
      var r = document.createRange(); r.selectNodeContents(el); r.collapse(false);
      var s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }catch(e){ el.focus(); }
  }

  function beginInline(el, ev){
    if (isDemo()) return;
    // Ensure editable + focusability
    el.setAttribute('contenteditable','true');
    if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0');
    if(!el.hasAttribute('role')) el.setAttribute('role','textbox');

    // Kill interfering click immediately
    if (ev){ ev.preventDefault(); ev.stopPropagation(); }

    // Place caret where clicked (fallback end)
    setTimeout(function(){ if(!(ev && caretAtPoint(el, ev))){ caretAtEnd(el); } }, 0);

    // Save on blur for siteName
    function onBlur(){
      el.removeEventListener('blur', onBlur);
      if (el.id==='siteName'){
        try{ localStorage.setItem('site_name', el.textContent.trim()); }catch{}
      }
    }
    el.addEventListener('blur', onBlur, {once:true});
  }

  function bindTarget(el){
    if (el.__inlineBoundFinal) return; el.__inlineBoundFinal = true;
    // Capture early on pointerdown so no other handler can steal it
    el.addEventListener('pointerdown', function(ev){
      if (isDemo()) return;
      beginInline(el, ev);
    }, {capture:true});
    // Also block the bubbling click afterwards in edit mode
    el.addEventListener('click', function(ev){
      if (!isDemo()){ ev.preventDefault(); ev.stopPropagation(); }
    });
  }

  function apply(){
    if (isDemo()) return;
    var sn = document.querySelector('#siteName'); if (sn) bindTarget(sn);
    document.querySelectorAll('.fcard label .label-editable').forEach(bindTarget);

    // If there is a logoBox or similar, stop it in edit mode from opening pickers on text
    var logoBox = document.querySelector('#logoBox, .logo-box, .brand .logo, .brand .logo-box');
    if (logoBox && sn){
      logoBox.addEventListener('click', function(ev){
        // if the click starts on the text node/element itself in edit mode, do not let parent handle it
        if (!isDemo() && (ev.target===sn || sn.contains(ev.target))){
          ev.stopPropagation(); ev.preventDefault();
        }
      }, true);
    }
  }

  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', apply, {once:true});
  }else{
    apply();
  }
  // Watch for re-renders inside designer
  var container = document.querySelector('#designerCard') || document.body;
  try{
    var mo = new MutationObserver(function(){ setTimeout(apply, 30); });
    mo.observe(container, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
<script id="inline-edit-style-boot">
/* Style toggling for inline editing (idempotent) */
(function(){
  if (window.__inlineStyleBoot) return; window.__inlineStyleBoot = true;
  function isDemo(){ return document.body.classList.contains('demo-mode'); }

  // Delegate focus/blur to set data attribute for styling
  document.addEventListener('focusin', function(ev){
    var el = ev.target;
    if (!el || !el.classList || !el.classList.contains('label-editable')) return;
    if (isDemo()) return;
    el.setAttribute('data-inline-editing','1');
  });
  document.addEventListener('focusout', function(ev){
    var el = ev.target;
    if (!el || !el.classList || !el.classList.contains('label-editable')) return;
    el.removeAttribute('data-inline-editing');
  });

  // Ensure label-editables are focusable and editable in Edit mode
  function prime(){
    if (isDemo()) return;
    document.querySelectorAll('.label-editable').forEach(function(el){
      if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0');
      // Don't force contenteditable here; respect app logic—styles still apply on focus if enabled.
    });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', prime, {once:true});
  } else { prime(); }

  // Re-prime after dynamic renders
  try{
    var host = document.querySelector('#designerCard') || document.body;
    var mo = new MutationObserver(function(){ setTimeout(prime, 50); });
    mo.observe(host, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
<script id="opt-inline-js">
(function(){
  if (window.__optInlineInstalled) return; window.__optInlineInstalled = true;
  function isDemo(){ return document.body.classList.contains('demo-mode'); }
  function slug(x){ return String(x||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,40) || 'item'; }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  function closestFieldId(el){
    var host = el.closest('[data-nid]');
    return host ? host.getAttribute('data-nid') : null;
  }

  // SELECT helpers
  function addSelectControls(select){
    if (!select || select.__optDecorated) return;
    select.__optDecorated = true;

    // Insert an inline controls row after the select
    var wrap = document.createElement('div');
    wrap.className = 'opt-inline';
    wrap.innerHTML = '<button class="opt-action add" data-role="add-select-option" title="Add option">option</button><small class="hint">(double‑click an option to remove)</small>';
    select.insertAdjacentElement('afterend', wrap);

    // Wire add
    wrap.querySelector('[data-role="add-select-option"]').addEventListener('click', function(ev){
      ev.preventDefault(); ev.stopPropagation();
      if (isDemo()) return (window.toast && toast('Demo mode: editing disabled'));
      var label = prompt('Option label?'); if(!label) return;
      var val = prompt('Option value? (leave empty to use label slug)') || slug(label);
      var opt = document.createElement('option'); opt.value = val; opt.textContent = label;
      select.appendChild(opt); select.value = val;

      // update model if available
      var fid = closestFieldId(select);
      if (fid && window.formModel){
        for (const sec of (formModel.sections||[])){
          const fld = (sec.children||[]).find(x=>x.id===fid);
          if (fld){
            if (!Array.isArray(fld.options)) fld.options = [];
            fld.options.push({label:label, value:val});
            break;
          }
        }
      }
      if (window.renderDebounced) renderDebounced();
    });

    // Wire dblclick remove on options
    select.addEventListener('dblclick', function(ev){
      var tgt = ev.target;
      if (!(tgt && tgt.tagName==='OPTION')) return;
      if (isDemo()) return;
      if (!confirm('Remove option "'+tgt.textContent+'"?')) return;
      // update model
      var fid = closestFieldId(select);
      if (fid && window.formModel){
        for (const sec of (formModel.sections||[])){
          const fld = (sec.children||[]).find(x=>x.id===fid);
          if (fld && Array.isArray(fld.options)){
            fld.options = fld.options.filter(o => !(o.label===tgt.textContent && o.value===tgt.value));
            break;
          }
        }
      }
      tgt.remove();
      if (window.renderDebounced) renderDebounced();
    });
  }

  // CHECKBOX helpers
      function syncEditModeUI(){
    var demo = document.body.classList.contains('demo-mode');
    if (demo){
      // Remove all controls to ensure nothing remains in Demo
      document.querySelectorAll('.opt-inline, /*cb-row-tools removed*/').forEach(function(el){ el.remove(); });
      // Also detach dblclick handlers by cloning selects (lightweight reset)
      document.querySelectorAll('select').forEach(function(sel){
        if (!sel.closest('[data-nid]')) return;
        var clone = sel.cloneNode(true);
        sel.parentNode.replaceChild(clone, sel);
      });
    } else {
      // Rebuild controls for current DOM
      decorate(document);
    }
  }

  function decorate(scope){
    var root = scope || document;
    // SELECTS: only in Edit mode, and only those inside form preview
    root.querySelectorAll('select').forEach(function(sel){
      // require that the select belongs to a field wrapper with data-nid so we don't touch random selects
      if (!sel.closest('[data-nid]')) return;
      if (isDemo()) return; // keep UI clean in Demo
      addSelectControls(sel);
    });

    /* Checkbox editing removed globally by request. */

  // Initial & after renders
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ decorate(document); }, {once:true});
  } else {
    decorate(document);
  }
  // Enforce initial mode visibility
  syncEditModeUI();
  try{
    var host = document.querySelector('#designerCard') || document.body;
    var mo = new MutationObserver(function(){ decorate(host); });
    mo.observe(host, {childList:true, subtree:true});
  try{
    var bodMo = new MutationObserver(function(m){ m.forEach(function(rec){ if(rec.type==='attributes'){ syncEditModeUI(); } }); });
    bodMo.observe(document.body, {attributes:true, attributeFilter:['class']});
  }catch(e){}
  }catch(e){}
})();
</script>
<script id="mode-visibility-sync">
(function(){
  if (window.__modeVisibilitySync) return; window.__modeVisibilitySync = true;

  function runVisibilityNow(){
    try{
      if (typeof updateVisibility === 'function'){
        updateVisibility();
      } else {
        // Fallback: trigger a synthetic 'change' to kick any listeners
        var root = document.querySelector('#designerCard') || document;
        root.querySelectorAll('input, select, textarea').forEach(function(el){
          try {
            el.dispatchEvent(new Event('change', {bubbles:true}));
            el.dispatchEvent(new Event('input', {bubbles:true}));
          } catch(e){}
        });
      }
    } catch(e){}
  }

  function flushVisibility(){
    // run immediately and after a short tick to outwait pending renders
    runVisibilityNow();
    setTimeout(runVisibilityNow, 0);
    setTimeout(runVisibilityNow, 60);
  }

  // On initial load, if already in demo mode, ensure conditions apply
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      if (document.body.classList.contains('demo-mode')) flushVisibility();
    }, {once:true});
  } else {
    if (document.body.classList.contains('demo-mode')) flushVisibility();
  }

  // Observe mode toggles (body class changes)
  try{
    var mo = new MutationObserver(function(mutations){
      for (var m of mutations){
        if (m.type === 'attributes' && m.attributeName === 'class'){
          // On entering demo mode, immediately evaluate conditions
          if (document.body.classList.contains('demo-mode')){
            flushVisibility();
          }
        }
      }
    });
    mo.observe(document.body, {attributes:true, attributeFilter:['class']});
  }catch(e){}
})();
</script>
<script id="visibility-flush-hook">
(function(){
  if (window.__visibilityFlushHook) return; window.__visibilityFlushHook = true;
  function __runVisibility(){
    try{ if (typeof updateVisibility==='function') updateVisibility(); }catch(e){}
  }
  window.flushVisibility = function(){
    __runVisibility();
    setTimeout(__runVisibility, 0);
    setTimeout(__runVisibility, 60);
  };
  // Wrap applyMode once
  if (typeof window.applyMode === 'function' && !window.applyMode.__wrapped){
    const __orig = window.applyMode;
    window.applyMode = function(){
      const out = __orig.apply(this, arguments);
      try{ window.flushVisibility && window.flushVisibility(); }catch(e){}
      return out;
    };
    window.applyMode.__wrapped = true;
  }
  // Initial check
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      if (document.body.classList.contains('demo-mode')) window.flushVisibility();
    }, {once:true});
  } else {
    if (document.body.classList.contains('demo-mode')) window.flushVisibility();
  }
  // Body class observer
  try{
    const mo = new MutationObserver(function(m){
      for (const rec of m){ if (rec.type==='attributes'){ window.flushVisibility(); break; } }
    });
    mo.observe(document.body, {attributes:true, attributeFilter:['class']});
  }catch(e){}
})();
</script>
<script id="page-header-inline-edit">
(function(){
  if (window.__pageHeaderInlineInstalled) return; window.__pageHeaderInlineInstalled = true;
  function isDemo(){ return document.body.classList.contains('demo-mode'); }

  function caretAtPoint(el, ev){
    try{
      el.focus();
      var sel = window.getSelection();
      var range = null;
      if (document.caretRangeFromPoint){
        range = document.caretRangeFromPoint(ev.clientX, ev.clientY);
      } else if (document.caretPositionFromPoint){
        var pos = document.caretPositionFromPoint(ev.clientX, ev.clientY);
        if (pos){ range = document.createRange(); range.setStart(pos.offsetNode, pos.offset); }
      }
      if (range){ sel.removeAllRanges(); sel.addRange(range); return true; }
    }catch(e){}
    return false;
  }
  function caretAtEnd(el){
    try{
      el.focus();
      var r = document.createRange(); r.selectNodeContents(el); r.collapse(false);
      var s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }catch(e){ el.focus(); }
  }

  function beginHeaderEdit(el, ev){
    if (isDemo()) return;
    el.setAttribute('contenteditable','true');
    if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0');
    if(!el.hasAttribute('role')) el.setAttribute('role','textbox');
    if (ev){ ev.preventDefault(); ev.stopPropagation(); }
    setTimeout(function(){ if(!(ev && caretAtPoint(el, ev))){ caretAtEnd(el); } }, 0);

    function onKey(e){
      if (e.key === 'Enter'){ e.preventDefault(); el.blur(); }
      if (e.key === 'Escape'){ e.preventDefault(); el.blur(); }
    }
    function onBlur(){
      el.removeEventListener('keydown', onKey);
      el.removeEventListener('blur', onBlur);
      try{ localStorage.setItem('page_name', (el.textContent||'').trim()); }catch(e){}
      // If your app has a model, update it here (optional)
      if (typeof window.renderDebounced === 'function') renderDebounced();
    }
    el.addEventListener('keydown', onKey);
    el.addEventListener('blur', onBlur, {once:true});
  }

  function bindHeader(el){
    if (!el || el.__phInline) return; el.__phInline = true;
    // capture early so other click handlers don't win
    el.addEventListener('pointerdown', function(ev){
      if (isDemo()) return;
      beginHeaderEdit(el, ev);
    }, {capture:true});
    // prevent bubbling click from opening other UI when editing
    el.addEventListener('click', function(ev){ if (!isDemo()){ ev.preventDefault(); ev.stopPropagation(); } });
    // Ensure normal text behavior (no extra highlight)
    el.style.cursor = 'text';
    el.style.userSelect = 'text';
    el.style.webkitUserSelect = 'text';
  }

  function apply(){
    if (isDemo()) return;
    var el = document.querySelector('#pageName') ||
             document.querySelector('.page-title') ||
             document.querySelector('[data-role="page-title"]');
    if (!el){
      var scope = document.querySelector('#designerCard') || document;
      el = scope.querySelector('h1, h2');
      if (el){ el.setAttribute('data-role','page-title'); }
    }
    if (el) bindHeader(el);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', apply, {once:true});
  } else { apply(); }

  // rebind after dynamic renders
  try{
    var mo = new MutationObserver(function(){ apply(); });
    mo.observe(document.body, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
<script id="page-header-dom-shim">
(function(){
  if (window.__pageHeaderShim) return; window.__pageHeaderShim = true;
  function apply(){
    var headerEl = document.querySelector('#pageName') ||
                   document.querySelector('.page-title') ||
                   document.querySelector('[data-role="page-title"]') ||
                   (document.querySelector('#designerCard')||document).querySelector('h1, h2');
    if (!headerEl) return;

    // Already wrapped?
    if (headerEl.closest('.page-header')) return;

    var wrapper = document.createElement('div'); wrapper.className='page-header';
    var titleWrap = document.createElement('div'); titleWrap.className='title-wrap';
    var actions = document.createElement('div'); actions.className='actions';
    // Move header into titleWrap
    headerEl.parentNode.insertBefore(wrapper, headerEl);
    titleWrap.appendChild(headerEl);
    wrapper.appendChild(titleWrap);
    wrapper.appendChild(actions);

    // Optional: add a subtitle placeholder (remove if not needed)
    // var sub = document.createElement('div'); sub.className='subtitle'; sub.textContent='';
    // titleWrap.appendChild(sub);

    // Example action buttons (comment out if not desired)
    // var b1=document.createElement('a'); b1.className='btn ghost'; b1.href='#'; b1.textContent='Help';
    // var b2=document.createElement('a'); b2.className='btn primary'; b2.href='#'; b2.textContent='Save';
    // actions.append(b1,b2);
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', apply, {once:true}); } else { apply(); }
  // Re-apply on dynamic render
  try{
    var mo=new MutationObserver(function(){ apply(); });
    mo.observe(document.body, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
<script id="page-header-golive-detector">
(function(){
  if (window.__phGoLiveDetector) return; window.__phGoLiveDetector = true;
  function norm(x){ return (x||'').trim().toLowerCase(); }
  function apply(){
    var candidates = [
      document.querySelector('#pageName'),
      document.querySelector('.page-title'),
      document.querySelector('[data-role="page-title"]')
    ];
    // also look for first h1/h2 inside app scope
    var scope = document.querySelector('#designerCard') || document;
    var h = scope.querySelector('h1, h2');
    if (h) candidates.push(h);

    candidates = candidates.filter(Boolean);
    if (!candidates.length) return;
    candidates.forEach(function(el){
      var txt = norm(el.textContent);
      if (txt === 'go live'){
        var wrap = el.closest('.page-header');
        if (wrap && !wrap.classList.contains('variant-golive')){
          wrap.classList.add('variant-golive');
        }
      }
    });
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', apply, {once:true}); } else { apply(); }
  // Re-apply on dynamic changes
  try{
    var mo=new MutationObserver(function(){ apply(); });
    mo.observe(document.body, {childList:true, subtree:true, characterData:true});
  }catch(e){}
})();
</script>
<script id="vh-fix-mobile">
(function(){
  if (window.__vhFixInstalled) return; window.__vhFixInstalled = true;
  function setVH(){
    var vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH);
  window.addEventListener('orientationchange', setVH);
  document.addEventListener('visibilitychange', setVH);
})();
</script>
<script id="sidebar-auto-hide-on-item-click">
(function(){
  if (window.__sideAutoHide) return; window.__sideAutoHide = true;
  function closeSide(){ document.body.classList.remove('side-open'); }
  function shouldClose(target){
    if (!target) return false;
    if (target.closest('[data-keep-open], .keep-open')) return false; // allow opt-out
    // Close on common nav items
    return !!target.closest('a, button, [role="menuitem"], li');
  }
  function onActivate(e){
    const t = e.target;
    if (!shouldClose(t)) return;
    // Let routing happen first, then close
    setTimeout(closeSide, 60);
  }
  function init(){
    const aside = document.querySelector('aside.sidebar');
    if (!aside) return;
    // Mouse/touch click
    aside.addEventListener('click', onActivate);
    // Keyboard activation (Enter/Space)
    aside.addEventListener('keydown', function(e){
      if ((e.key === 'Enter' || e.key === ' ') && shouldClose(e.target)) {
        setTimeout(closeSide, 60);
      }
    });
    // Touchend fallback (some UIs stop click)
    aside.addEventListener('touchend', function(e){
      if (shouldClose(e.target)) setTimeout(closeSide, 60);
    }, {passive:true});
  }
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); }
  else { init(); }
})();
</script>
<script id="mobile-header-measure">
(function(){
  if (window.__mobileHeaderMeasure) return; window.__mobileHeaderMeasure = true;
  function px(n){ return (n||0) + 'px'; }
  function measureHeader(){
    if (!window.matchMedia('(max-width: 768px)').matches) return;
    // Add heights of visible horizontal ribbon + page header (if both exist)
    var h = 0;
    var r = document.querySelector('.hribbon, .hnav');
    var p = document.querySelector('.page-header');
    if (r && getComputedStyle(r).display !== 'none') h += r.getBoundingClientRect().height;
    if (p && getComputedStyle(p).display !== 'none') h += p.getBoundingClientRect().height;
    if (!h){ h = 56; }
    document.documentElement.style.setProperty('--nav-h', px(Math.round(h)));
  }
  function init(){
    measureHeader();
    window.addEventListener('resize', measureHeader);
    window.addEventListener('orientationchange', measureHeader);
    try{
      var mo = new MutationObserver(measureHeader);
      mo.observe(document.body, {childList:true, subtree:true, attributes:true});
    }catch(e){}
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); }
  else { init(); }
})();
</script>
<script id="tabs-overflow-js">
(function(){
  if (window.__tabsOverflow) return; window.__tabsOverflow = true;
  const scroller = document.querySelector('.tabs');
  const moreBtn = document.querySelector('.tabs-more');
  const menu = document.getElementById('tabsMenuInjected');

  function activate(tab){
    document.querySelectorAll('.tab[aria-selected="true"]').forEach(t => t.setAttribute('aria-selected','false'));
    tab.setAttribute('aria-selected','true');
    // scroll active into view
    try{ tab.scrollIntoView({inline:'center', block:'nearest', behavior:'smooth'}); }catch(e){}
    // TODO: wire to your section switcher here using data-tab attribute
    // e.g., switchSection(tab.dataset.tab);
  }

  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>activate(tab));
    tab.addEventListener('keydown', (e)=>{
      const tabs = [...document.querySelectorAll('.tab')];
      const i = tabs.indexOf(tab);
      if (e.key === 'ArrowRight'){ e.preventDefault(); activate(tabs[Math.min(i+1, tabs.length-1)]); }
      if (e.key === 'ArrowLeft'){ e.preventDefault(); activate(tabs[Math.max(i-1, 0)]); }
    });
  });

  // Overflow menu
  function openMenu(){ if (!menu) return; menu.hidden = false; moreBtn?.setAttribute('aria-expanded','true'); }
  function closeMenu(){ if (!menu) return; menu.hidden = true; moreBtn?.setAttribute('aria-expanded','false'); }
  moreBtn?.addEventListener('click', ()=> menu?.hidden ? openMenu() : closeMenu());
  document.addEventListener('click', (e)=>{ if (menu && !menu.hidden && !menu.contains(e.target) && e.target!==moreBtn) closeMenu(); });
  menu?.querySelectorAll('[role="menuitem"]').forEach(item=>{
    item.addEventListener('click', ()=>{ /* switchSection(item.dataset.tab); */ closeMenu(); });
  });

  // Edge fades visibility
  function updateEdges(){
    const left = document.querySelector('.tabs-edge.left');
    const right = document.querySelector('.tabs-edge.right');
    if (!scroller || !left || !right) return;
    left.style.opacity  = scroller.scrollLeft > 2 ? 1 : 0;
    const max = scroller.scrollWidth - scroller.clientWidth - 2;
    right.style.opacity = scroller.scrollLeft < max ? 1 : 0;
  }
  scroller?.addEventListener('scroll', updateEdges);
  window.addEventListener('resize', updateEdges);
  updateEdges();
})();
</script>
<script id="hide-manage-logo-js">
(function(){
  if (window.__hideManageLogo) return; window.__hideManageLogo = true;
  function isManageLogoEl(el){
    if (!el) return false;
    if (el.matches && el.matches('#manageLogo, .manage-logo, .button-manage-logo, [data-role="manage-logo"], [aria-label="Manage Logo"]')) return true;
    var txt = (el.textContent || '').trim().toLowerCase();
    return /manage\s*logo/.test(txt);
  }
  function removeManageLogo(){
    var cands = Array.from(document.querySelectorAll('button, a, [role="button"], #manageLogo, .manage-logo, .button-manage-logo, [data-role="manage-logo"], [aria-label="Manage Logo"]'));
    cands.forEach(function(el){
      if (isManageLogoEl(el)){
        // remove containing wrapper if it looks like an action slot
        var wrap = el.closest('.actions, .page-header .actions, .toolbar, .tool') || el;
        (wrap.parentNode && wrap.parentNode.removeChild(wrap)) || el.remove();
      }
    });
  }
  function init(){
    removeManageLogo();
    try{
      var mo = new MutationObserver(function(m){ removeManageLogo(); });
      mo.observe(document.body, {childList:true, subtree:true});
    }catch(e){}
  }
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); }
  else { init(); }
})();
</script>
<script id="add-nav-icon-only-js">
(function(){
  if (window.__addNavIconOnly) return; window.__addNavIconOnly = true;
  function toIconOnly(el){
    if (!el) return;
    // if a span/li inside a tab, target the nearest interactive parent
    var host = el.closest && (el.closest('.tab,[role="tab"],button,a,[role="menuitem"]') || el);
    el = host;
    if (!el || el.classList.contains('icon-only')) return;
    if (!el || el.classList.contains('icon-only')) return;
    // Save label for a11y
    var label = (el.getAttribute('aria-label') || el.textContent || 'Add').trim();
    el.setAttribute('aria-label', label);
    el.setAttribute('title', label);
    // Clear visible text but keep it for screen readers
    var txt = (el.textContent || '').trim();
    if (txt){
      var sr = document.createElement('span');
      sr.className = 'sr-only';
      sr.textContent = txt;
      // Remove existing text nodes
      while (el.firstChild) el.removeChild(el.firstChild);
      // Add icon + sr-only text
      var icon = document.createElement('span');
      icon.className = 'nav-icon add-icon';
      icon.setAttribute('aria-hidden','true');
      el.appendChild(icon);
      el.appendChild(sr);
    }else{
      // Just prepend icon
      var icon = document.createElement('span');
      icon.className = 'nav-icon add-icon';
      icon.setAttribute('aria-hidden','true');
      el.prepend(icon);
    }
    el.classList.add('icon-only');
  }

  function isAddItem(el){
    if (!el) return false;
    // don't touch 'More' overflow
    if (el.closest && el.closest('.tabs-more')) return false;
    if (el.matches && el.matches('[data-role="nav-add"], [data-action="add"], .nav-add, [data-icon="add"]')) return true;
    var t = (el.textContent || '').toLowerCase().replace(/\s+/g,' ').trim();
    if (!t) return false;
    // normalize common prefixes/symbols
    if (t === '+' || t === '＋' || t === '➕') return true;
    // match 'add', '+ add', 'add field', 'add button', 'add page', etc.
    return t === 'add' || t.startsWith('add ') || t.includes(' add') || t.includes('+ add') || /^add[:\-]/.test(t);
  }
    if (!el) return false;
    if (el.matches('[data-role="nav-add"], [data-action="add"], .nav-add')) return true;
    var t = (el.textContent || '').toLowerCase().replace(/\s+/g,' ').trim();
    // match "add", "+ add", "add field", "add button"
    return t === 'add' || t.startsWith('add ') || t.includes(' add') || t.includes('+ add') || t.includes('add button');
  }

  function scan(){
    // Horizontal tabs and ribbons
    document.querySelectorAll('.tabs .tab, .tabs [role="tab"], .tabs button, .tabs a, .tabs span, .tabs li, .hnav button, .hnav a, .hribbon button, .hribbon a').forEach(function(el){
      if (isAddItem(el)) toIconOnly(el);
    });
    // Vertical sidebar items
    document.querySelectorAll('aside.sidebar a, aside.sidebar button, aside.sidebar [role="menuitem"]').forEach(function(el){
      if (isAddItem(el)) toIconOnly(el);
    });
  }

  function init(){
    scan();
    try{
      var mo = new MutationObserver(function(){ scan(); });
      mo.observe(document.body, {childList:true, subtree:true});
    }catch(e){}
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); }
  else { init(); }
})();
</script>
<script id="lock-sidebar-scroll-on-add-js">
(function(){
  if (window.__lockSideOnAdd) return; window.__lockSideOnAdd = true;
  function prevent(e){ e.preventDefault(); }
  function lockSidebar(){
    var aside = document.querySelector('aside.sidebar');
    if (!aside || aside.classList.contains('lock-scroll')) return;
    aside.classList.add('lock-scroll');
    // Prevent wheel/touch scroll leaks while locked
    aside.addEventListener('wheel', prevent, {passive:false});
    aside.addEventListener('touchmove', prevent, {passive:false});
  }
  function unlockSidebar(){
    var aside = document.querySelector('aside.sidebar');
    if (!aside) return;
    aside.classList.remove('lock-scroll');
    aside.removeEventListener('wheel', prevent, {passive:false});
    aside.removeEventListener('touchmove', prevent, {passive:false});
  }

  function isOpen(adder){
    if (!adder) return false;
    return adder.classList.contains('open') || getComputedStyle(adder.querySelector('.panel')).display !== 'none';
  }

  function sync(){
    var vAdder = document.getElementById('vAdder');
    if (!vAdder) return;
    if (isOpen(vAdder)) lockSidebar(); else unlockSidebar();
  }

  function bind(){
    var vAdder = document.getElementById('vAdder');
    if (!vAdder) return;
    // Clicks on the vAdder button or any close buttons inside the panel
    var btn = vAdder.querySelector('button');
    if (btn && !btn.__lockBound){
      btn.addEventListener('click', function(){ setTimeout(sync, 0); });
      btn.__lockBound = true;
    }
    vAdder.addEventListener('click', function(e){
      var t = e.target;
      // if user clicks cancel/add/close inside panel, try to unlock shortly after
      if (t.matches('.btn, [data-action="close"], [data-action="cancel"], [data-action="confirm"]')){
        setTimeout(sync, 30);
      }
    });
    // Mutation observer: watch class changes and style display changes
    try{
      var mo = new MutationObserver(function(){ sync(); });
      mo.observe(vAdder, {attributes:true, attributeFilter:['class','style'], subtree:true, childList:true});
    }catch(e){}

    // Safety: also unlock if user clicks outside the sidebar or presses ESC
    document.addEventListener('click', function(e){
      var inside = e.target.closest && e.target.closest('#vAdder, aside.sidebar');
      if (!inside) unlockSidebar();
    });
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape') unlockSidebar(); });
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  else { bind(); }

})();
</script>
<script>
// ---- Inject: extend inspector Type select with 'space' and transform node when chosen ----
(function(){
  if (window.__spaceTypePatched) return; window.__spaceTypePatched = true;
  try{
    const orig = window.paintInspectorPane;
    if (typeof orig === 'function'){
      window.paintInspectorPane = function(which, node, hit){
        orig(which, node, hit);
        try{
          if(which==='basics' && node && node.type==='field'){
            const sel = document.querySelector('#inspector .body select');
            if(sel){
              // If this is the Type select (heuristic: contains 'text' option)
              const hasText = Array.from(sel.options).some(o => (o.value||'').toLowerCase()==='text');
              if(hasText){
                let hasSpace = Array.from(sel.options).some(o => (o.value||'').toLowerCase()==='space');
                if(!hasSpace){
                  const opt = document.createElement('option'); opt.value='space'; opt.textContent='space';
                  sel.appendChild(opt);
                }
                let hasRich = Array.from(sel.options).some(o => (o.value||'').toLowerCase()==='richtext');
                if(!hasRich){
                  const opt2 = document.createElement('option'); opt2.value='richtext'; opt2.textContent='richtext';
                  sel.appendChild(opt2);
                }
                sel.addEventListener('change', function onTypeChange(e){
                  const v = (sel.value||'').toLowerCase();
                  if(v==='space'){
                    // transform this field into a space node at same index
                    const parent = hit && hit.parent;
                    if(parent && Array.isArray(parent.children)){
                      const idx = parent.children.findIndex(x=>x && x.id===node.id);
                      if(idx>=0){
                        parent.children.splice(idx, 1, { id: uid(), type:'space', span: Math.max(1, Math.min(4, Number(node.span)||2)) });
                        render();
                        // reopen basics so user sees span controls on the card
                        setTimeout(()=>{ try{ openInspector(parent.children[idx].id); }catch{} }, 0);
                      }
                    }
                  }
                }, { once: true });
              }
            }
          }
        }catch(e){ console.warn('space type patch error', e); }
      };
    }
  }catch(e){ console.warn('space type hook setup failed', e); }
})();
</script>
<style>
.file-cell{display:flex;flex-direction:column;gap:6px}
.file-chips{display:flex;flex-wrap:wrap;gap:6px}
.file-chip{display:inline-block;padding:.2rem .5rem;border:1px solid var(--line,#ddd);border-radius:8px;text-decoration:none;white-space:nowrap}
.file-chip:hover{text-decoration:underline}
</style>
<script>
function createTableFileUploader(c, row, setValue){
  // Minimal UI: only a Manage Files button; uses the same modal as the form file field.
  const wrap = document.createElement('div');
  wrap.className = 'file-uploader only-manage-btn';

  const manage = document.createElement('button'); manage.type='button'; manage.type='button';
  manage.type = 'button';
  manage.className = 'btn';
  manage.textContent = 'Manage files (0)';
  wrap.appendChild(manage);

  function normalize(v){
    if(!v) return [];
    return Array.isArray(v) ? v : [v];
  }
  function updateManage(){
    const arr = normalize(row[c.key]);
    manage.textContent = 'Manage files (' + arr.length + ')';
  }

  manage.onclick = ()=>{
    const current = normalize(row[c.key]);
    const opts = {
      accept: c.accept || '',
      maxSizeMB: c.maxSizeMB || 0,
      maxFiles: c.maxFiles || (c.multiple ? 0 : 1),
      multiple: !!c.multiple,
      htmlSandbox: true
    };
    // openFileManager(options, initialFiles, callback)
    if(typeof openFileManager === 'function'){
      openFileManager(opts, current, (next)=>{
        // Persist back in the same shape as the table expects
        const val = opts.multiple ? next : (next[0] || null);
        setValue(val);
        updateManage();
      });
    }else{
      alert('File manager is not available in this build.');
    }
  };

  // initial
  updateManage();
  return wrap;
}
</script>
<style>
.file-uploader{display:flex;flex-direction:column;gap:.5rem}
.upload-zone{border:1px dashed var(--line,#d0d7de); border-radius:10px; padding:.5rem; display:flex; align-items:center; gap:.5rem; cursor:pointer}
.upload-zone.hover{background:rgba(0,0,0,.03)}
.upload-label{font-size:.875rem; opacity:.75}
.file-chips{display:flex; flex-wrap:wrap; gap:6px}
.chip-wrap{display:inline-flex; align-items:center; gap:6px}
.file-chip{display:inline-block; padding:.2rem .5rem; border:1px solid var(--line,#d0d7de); border-radius:999px; text-decoration:none; white-space:nowrap}
.chip-x{border:0; background:transparent; cursor:pointer; font-size:14px; line-height:1; padding:0 .25rem}
.richtext-field{ display:flex; flex-direction:column; width:100%; }
.richtext-field .ql-toolbar{ flex:0 0 auto; }
.richtext-field .ql-container{ flex:1 1 auto; width:100%; box-sizing:border-box; min-height:160px; }
.richtext-field .ql-editor{ width:100%; box-sizing:border-box; min-height:120px; }
</style>
<script id="signature-field-js">
(function(){
  if (window.__signatureFieldInstalled) return; window.__signatureFieldInstalled = true;

  function dataURIToImage(uri){
    var img = new Image();
    img.src = uri;
    return img;
  }

  function setupCanvas(canvas, hidden, color, width){
    var ctx = canvas.getContext('2d');
    var drawing = false, lastX = 0, lastY = 0;

    function resize(){
      // Resize respecting device pixel ratio for sharpness
      var ratio = Math.max(window.devicePixelRatio || 1, 1);
      var rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(1, Math.floor(rect.width * ratio));
      canvas.height = Math.max(1, Math.floor(rect.height * ratio));
      ctx.scale(ratio, ratio);
      // Redraw existing image if any
      if (hidden.value){
        try{
          var img = dataURIToImage(hidden.value);
          img.onload = function(){ ctx.drawImage(img, 0, 0, rect.width, rect.height); };
        }catch(e){}
      } else {
        // background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,rect.width,rect.height);
      }
    }

    function pos(e){
      if (e.touches && e.touches.length) e = e.touches[0];
      var r = canvas.getBoundingClientRect();
      return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    function begin(e){
      if (window.demoMode) return;
      drawing = true;
      var p = pos(e);
      lastX = p.x; lastY = p.y;
    }

    function move(e){
      if (!drawing) return;
      e.preventDefault();
      var p = pos(e);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = color.value || '#111827';
      ctx.lineWidth = Math.max(1, Number(width.value||2));
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      lastX = p.x; lastY = p.y;
    }

    function end(){
      if (!drawing) return;
      drawing = false;
      // persist to hidden
      try{
        hidden.value = canvas.toDataURL('image/png');
        if (hidden.dispatchEvent){
          var evt = new Event('input', {bubbles:true});
          hidden.dispatchEvent(evt);
        }
      }catch(e){}
    }

    // events
    canvas.addEventListener('pointerdown', begin);
    canvas.addEventListener('pointermove', move);
    addEventListener('pointerup', end);
    canvas.addEventListener('touchstart', begin, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', end);

    // react to resize
    var ro;
    try{
      ro = new ResizeObserver(resize);
      ro.observe(canvas);
    }catch(e){
      window.addEventListener('resize', resize);
    }
    setTimeout(resize, 0);

    return {
      clear: function(){
        var rect = canvas.getBoundingClientRect();
        ctx.clearRect(0,0,rect.width,rect.height);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,rect.width,rect.height);
        hidden.value = '';
        if (hidden.dispatchEvent){
          var evt = new Event('input', {bubbles:true});
          hidden.dispatchEvent(evt);
        }
      },
      download: function(){
        try{
          var a = document.createElement('a');
          a.href = hidden.value || canvas.toDataURL('image/png');
          a.download = (hidden.getAttribute('data-name')||'signature') + '.png';
          a.click();
        }catch(e){ alert('Unable to download'); }
      }
    };
  }

  // Wrap/extend existing buildControl without altering original
  var __origBuildControl = window.buildControl;
  if (typeof __origBuildControl !== 'function') return;

  window.buildControl = function(fd){
    var t = (fd.ftype||'text').toLowerCase();
    if (t !== 'signature'){
      return __origBuildControl(fd);
    }

    var wrap = document.createElement('div');
    wrap.className = 'signature-field';

    // Hidden input stores dataURL value and satisfies required validation
    var hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.id = 'f_' + fd.id;
    hidden.value = fd.default || fd.value || '';
    hidden.setAttribute('data-name', (fd.name||'Signature'));
    wrap.appendChild(hidden);

    // Controls (color & width) – simple, optional
    var tools = document.createElement('div');
    tools.className = 'signature-tools';
    var color = document.createElement('input'); color.type = 'color'; color.value = fd.inkColor || '#111827';
    var width = document.createElement('input'); width.type = 'number'; width.min='1'; width.max='12'; width.value = (fd.inkWidth||2);
    var clearBtn = document.createElement('button'); clearBtn.type='button'; clearBtn.type='button'; clearBtn.type = 'button'; clearBtn.className = 'btn ghost'; clearBtn.textContent = 'Clear';
    var dlBtn = document.createElement('button'); dlBtn.type='button'; dlBtn.type='button'; dlBtn.type = 'button'; dlBtn.className = 'btn'; dlBtn.textContent = 'Download PNG';
    var hint = document.createElement('span'); hint.className = 'hint'; hint.textContent = 'Sign inside the box.';
    tools.append(color, width, clearBtn, dlBtn, hint);
    wrap.appendChild(tools);

    // Pad
    var pad = document.createElement('div'); pad.className = 'signature-pad';
    var canvas = document.createElement('canvas'); canvas.className = 'signature-canvas';
    pad.appendChild(canvas);
    wrap.appendChild(pad);

    // If we have existing value, show it
    if (hidden.value){
      try{
        var img = new Image();
        img.onload = function(){
          // draw as soon as canvas is ready (after first resize)
        };
        img.src = hidden.value;
      }catch(e){}
    }

    // Wire drawing unless demo mode
    var api = setupCanvas(canvas, hidden, color, width);
    clearBtn.addEventListener('click', function(){ if (window.demoMode){ return; } api.clear(); });
    dlBtn.addEventListener('click', function(){ api.download(); });

    return wrap;
  };

})();
</script>
<script id="row12-js">
// === 12-grid Row/Column renderer (integrated with existing nodes) ===
function renderRow12(row){
  const wrap=document.createElement('div'); wrap.className='row12'; wrap.dataset.nid=row.id;
  const head=document.createElement('div'); head.className='row12-head';
  const title=document.createElement('div'); title.className='row12-title'; title.textContent = row.name || 'Row';
  head.appendChild(title);
  const headTools=document.createElement('div'); headTools.className='row12-tools'; headTools.style.cssText='margin-left:auto;display:flex;gap:6px;flex-wrap:wrap';

  const addColBtn=document.createElement('button'); addColBtn.type='button'; addColBtn.type='button'; addColBtn.className='stool'; addColBtn.textContent='+ Column';
  addColBtn.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } addCol12(row, 3); };
  headTools.appendChild(addColBtn);

  const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.type='button'; delBtn.className='stool'; delBtn.textContent='🗑️ Delete Row';
  delBtn.onclick=()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } deleteNode(row.id); };
  headTools.appendChild(delBtn);

  head.appendChild(headTools); wrap.appendChild(head);

  const grid=document.createElement('div'); grid.className='row12-grid'; wrap.appendChild(grid);

  (row.columns||[]).sort((a,b)=>a.start-b.start).forEach((col,idx)=>{
    const c=document.createElement('div'); c.className='col12'; c.style.gridColumn = col.start+' / span '+col.span;
    c.dataset.nid = col.id;
    const ch=document.createElement('div'); ch.className='col12-head';
    ch.innerHTML = '<div>Col '+(idx+1)+' <span class="chip">start:'+col.start+'</span> <span class="chip">span:'+col.span+'</span></div>'
                 + '<div style="display:flex;gap:4px"><button type="button" class="icon-btn" data-act="left">◄</button><button type="button" class="icon-btn" data-act="shr">–</button><button type="button" class="icon-btn" data-act="exp">+</button><button type="button" class="icon-btn" data-act="right">►</button><button type="button" class="icon-btn warn" data-act="del">✕</button><button type="button" class="icon-btn" data-act="add">＋ Field</button></div>';
    c.appendChild(ch);

    const list=document.createElement('div'); list.className='fields';
    if(!col.children || col.children.length===0){ const e=document.createElement('div'); e.className='empty'; e.textContent='Drop or add a field here'; list.appendChild(e); }
    (col.children||[]).forEach(f=>{
      const fc = renderField(f);fc.setAttribute('draggable','false');
(function(){
  try{
    const dh=document.createElement('div'); dh.className='drag-handle-wrap';
const dragBtn=document.createElement('button'); dragBtn.type='button'; dragBtn.type='button'; dragBtn.type='button'; dragBtn.className='icon-btn drag-btn'; dragBtn.title='Drag field'; dragBtn.textContent='↕';
dragBtn.setAttribute('draggable','true');
dragBtn.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain','move:'+f.id+':'+col.id); ev.dataTransfer.effectAllowed='move'; });
const topBar = fc.querySelector('.icons');
if(topBar){ topBar.appendChild(dragBtn); }
else{ dh.appendChild(dragBtn); if(!fc.style.position) fc.style.position='relative'; fc.appendChild(dh); }

  }catch(e){ console.warn('drag handle inject failed', e); }
})();

      try{ if(!window.demoMode){ fc.setAttribute('draggable','true'); } else { fc.removeAttribute('draggable'); } }catch{}
      /* R12: patched click-to-open */
      fc.addEventListener('click', (ev)=>{ if(window.demoMode) return; try{ openInspector && openInspector(f.id); ev.stopPropagation(); }catch(e){} });
      // DnD hooks
      fc.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain','move:'+f.id+':'+col.id); ev.dataTransfer.effectAllowed='move'; });
      fc.addEventListener('dragend', ()=>{});
      list.appendChild(fc);
    });
    c.appendChild(list);

    // Column controls
    ch.querySelector('[data-act="add"]').onclick = async ()=>{ if(window.demoMode){ toast && toast('Demo mode: editing disabled'); return; }
      if(demoMode){ toast('Demo mode: editing disabled'); return; }
      try{
        const choice = (await window.pickFieldType()) || '';
        if(!choice) return;
        let n=null;
        if(choice==='space'){ n=space(1); }
        else if(choice==='divider'){ n=divider(); }
        else if(choice==='table'){ n=field('table','Table'); n.columns=[{key:'col1',label:'Column 1'},{key:'col2',label:'Column 2'}]; n.sampleRows=3; }
        else { const name = choice.charAt(0).toUpperCase()+choice.slice(1)+' Field'; n = field(choice, name); }
        if(Array.isArray(col.children) && col.children.length>0){ toast && toast('This column already has a field. Remove it first.'); return; }
col.children = col.children || []; col.children.push(n); render();
        if(n.type!=='space' && n.type!=='divider'){ /* inspector auto-open removed */}
      }catch(e){ console.error(e); }
    };
    ch.querySelector('[data-act="del"]').onclick = ()=>{ if(demoMode){ toast('Demo mode: editing disabled'); return; } removeCol12(row, col.id); };
    ch.querySelector('[data-act="left"]').onclick = ()=> shiftCol12(row, col.id, -1);
    ch.querySelector('[data-act="right"]').onclick = ()=> shiftCol12(row, col.id, +1);
    ch.querySelector('[data-act="shr"]').onclick = ()=> resizeCol12(row, col.id, -1);
    ch.querySelector('[data-act="exp"]').onclick = ()=> resizeCol12(row, col.id, +1);

    // DnD target for adding/moving fields
    c.addEventListener('dragover', (e)=>{ if(window.demoMode) return; const t=e.dataTransfer && e.dataTransfer.types && e.dataTransfer.types.includes('text/plain'); if(t){ e.preventDefault(); c.classList.add('droptarget'); } });
    c.addEventListener('dragleave', ()=> c.classList.remove('droptarget'));
    c.addEventListener('drop', (e)=>{ if(window.demoMode) return;
      e.preventDefault(); c.classList.remove('droptarget');
      const dt = e.dataTransfer.getData('text/plain')||'';
      if(dt.startsWith('move:')){
        const parts = dt.split(':');
        const fid = parts[1]; const fromColId = parts[2];
        moveFieldToCol(fid, fromColId, col.id);
      }
    });

    grid.appendChild(c);
  });

  return wrap;
}

function buildOcc(row){
  const occ = Array(row.capacity||12).fill(null);
  (row.columns||[]).forEach(col=>{
    for(let i=col.start-1;i<col.start-1+col.span;i++){ occ[i]=col.id; }
  });
  return occ;
}

function findFirstFreeRange(row, span){
  const o=buildOcc(row);
  for(let i=0;i<=o.length-span;i++){ let ok=true; for(let j=0;j<span;j++){ if(o[i+j]){ ok=false; break; } } if(ok) return i+1; }
  return null;
}

function addCol12(row, span){
  if(window.demoMode){ toast && toast('Demo mode: editing disabled'); return; }

  row.capacity = row.capacity || 12;
  const start = findFirstFreeRange(row, span||3);
  if(!start){ toast('Row is full for span '+(span||3)); return; }
  (row.columns=row.columns||[]).push({ id:uid(), type:'col12', start, span:span||3, children:[] });
  render();
}
function removeCol12(row, colId){
  if(window.demoMode){ toast && toast('Demo mode: editing disabled'); return; }

  row.columns = (row.columns||[]).filter(c=>c.id!==colId);
  render();
}
function resizeCol12(row, colId, delta){
  if(window.demoMode){ toast && toast('Demo mode: editing disabled'); return; }

  const col = (row.columns||[]).find(c=>c.id===colId); if(!col) return;
  if(delta>0){
    const right = col.start - 1 + col.span;
    if( right < (row.capacity||12) && !buildOcc(row)[right] ){ col.span += 1; render(); } else toast('No space to expand.');
  } else if(delta<0){
    if(col.span>1){ col.span -= 1; render(); } else toast('Minimum span is 1.');
  }
}
function shiftCol12(row, colId, dir){
  if(window.demoMode){ toast && toast('Demo mode: editing disabled'); return; }

  const col = (row.columns||[]).find(c=>c.id===colId); if(!col) return;
  if(dir<0){
    const left = col.start - 2;
    if(left>=0 && !buildOcc(row)[left]){ col.start -= 1; render(); } else toast('Blocked on left.');
  }else{
    const right = col.start - 1 + col.span;
    if(right < (row.capacity||12) && !buildOcc(row)[right]){ col.start += 1; render(); } else toast('Blocked on right.');
  }
}

function moveFieldToCol(fieldId, fromColId, toColId){
  if(window.demoMode){ toast && toast('Demo mode: editing disabled'); return; }

  const item=getItem(); if(!item) return;
  // find current parent col and target col
  function findWithParent(root,id,p=null){
    if(root.id===id) return {node:root,parent:p};
    if(root.children){ for(const c of root.children){ const r=findWithParent(c,id,root); if(r) return r; } }
    if(root.columns){ for(const c of root.columns){ const r=findWithParent(c,id,root); if(r) return r; } }
    return null;
  }
  const hitField = findWithParent(item.root, fieldId);
  const hitFromCol = findWithParent(item.root, fromColId);
  const hitToCol = findWithParent(item.root, toColId);
  if(hitField && hitFromCol && hitToCol && hitField.parent){
    // remove from old
    if(Array.isArray(hitField.parent.children)){
      hitField.parent.children = hitField.parent.children.filter(x=>x.id!==fieldId);
    }
    // add to new
    if(Array.isArray(hitToCol.node.children) && hitToCol.node.children.length>0){ toast && toast('Target column already has a field.'); return; }
hitToCol.node.children = hitToCol.node.children || [];
    hitToCol.node.children.push(hitField.node);
    render();
  }
}
</script>
<style id="no-col-borders-patch">

.row12 > .col12,
.row12 .col12 { border: none !important; }
</style>
<button aria-label="Add new" id="fabAdd">＋</button>
<div hidden="" id="fabSheet"></div>
<script>

/* === Unified Add Form (desktop & mobile) — validation + draft persistence === */
(function(){
  const fab = document.getElementById('fabAdd');
  const sheet = document.getElementById('fabSheet');
  const DRAFT_KEY = 'fabAddDraft';

  // Inject header Add button (desktop)
  (function(){
    var host = document.getElementById('pageHeader');
    if(!host) return;
    var btn = document.getElementById('headerAddBtn');
    if(!btn){
      btn = document.createElement('button');
      btn.id='headerAddBtn';
      btn.innerHTML = '<span class="plus">＋</span><span>Add</span>';
      btn.type='button';
      host.appendChild(btn);
      btn.addEventListener('click', function(){ try{ fab && fab.click(); }catch(e){} });
    }
  })();

  function getDraft(){
    try{ const obj = JSON.parse(localStorage.getItem(DRAFT_KEY)||'null'); return obj && typeof obj==='object' ? obj : null; }catch(e){ return null; }
  }
  function setDraft(d){ try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(d)); }catch(e){} }
  function clearDraft(){ try{ localStorage.removeItem(DRAFT_KEY); }catch(e){} }

  function closeSheet(){ sheet.hidden = true; }
  function openSheet(){ sheet.hidden = false; }

  function pickParents(place){
    try{
      if(typeof window.parentChoices==='function') return parentChoices(place);
    }catch(e){}
    return [{value:'', text:'(No parent — top level)'}];
  }

  function depthOf(place, parentId){
    try{
      if(!parentId) return -1; // adding as root -> new node depth 0
      if(typeof window.depthOfNode==='function') return depthOfNode(place, parentId);
    }catch(e){}
    return -1;
  }

  function getSiblings(place, parentId){
    const all = (window.Model && Array.isArray(Model.items)) ? Model.items : [];
    if(!parentId){
      if(typeof window.roots==='function') return roots(place) || [];
      return all.filter(n=>n.place===place && !findParentOf(n.id, place));
    }
    const p = (typeof window.findNavNode==='function') ? findNavNode(place, parentId) : all.find(n=>n.id===parentId && n.place===place);
    return p && Array.isArray(p.children) ? p.children : [];
  }

  function hasDuplicateName(place, parentId, name){
    const sibs = getSiblings(place, parentId);
    const val = (name||'').trim().toLowerCase();
    return sibs.some(n => (n.name||'').trim().toLowerCase() === val);
  }

  function hydrateForm(place, f, draft){
    const nameEl = f.querySelector('#fabName');
    const iconEl = f.querySelector('#fabIcon');
    const selEl  = f.querySelector('#fabParent');
    if(draft){
      const dPlace = draft.place==='v'?'v':'h';
      if(dPlace === place){
        if(draft.name) nameEl.value = draft.name;
        if(draft.icon) iconEl.value = draft.icon;
        if(typeof draft.parentId==='string'){
          const opt = Array.from(selEl.options).find(o=>o.value===draft.parentId);
          if(opt) selEl.value = draft.parentId;
        }
      }
    }
    function capture(){
      setDraft({ place, name: nameEl.value || '', icon: iconEl.value || '', parentId: selEl.value || '' });
      validate();
    }
    nameEl.addEventListener('input', capture);
    iconEl.addEventListener('input', capture);
    selEl.addEventListener('change', capture);

    const hint = f.querySelector('#fabHint');
    const btn = f.querySelector('#fabSubmit');

    function validate(){
      const nm = (nameEl.value||'').trim();
      const pid = selEl.value||'';
      const d = depthOf(place, pid);
      if(!nm){ hint.textContent='Name is required'; hint.classList.add('show'); btn.disabled=true; return false; }
      if(d >= 2){ hint.textContent='Cannot add beyond 3 levels (choose a higher parent)'; hint.classList.add('show'); btn.disabled=true; return false; }
      if(hasDuplicateName(place, pid, nm)){ hint.textContent='Duplicate name under the same parent'; hint.classList.add('show'); btn.disabled=true; return false; }
      hint.textContent=''; hint.classList.remove('show'); btn.disabled=false; return true;
    }
    f.__validate = validate;
    setTimeout(validate, 0);
  }

  function renderForm(place){
    sheet.innerHTML = '';

    const head = document.createElement('div');
    head.className='fab-row';
    head.innerHTML = `<span class="lbl">Add ${place==='h'?'Horizontal':'Vertical'} item</span>`;
    sheet.appendChild(head);

    const toggle = document.createElement('div');
    toggle.style.cssText='display:flex;gap:8px;justify-content:center;padding:6px 10px;';
    toggle.innerHTML = `
  <fieldset class="place-fieldset" style="display:inline-flex;gap:14px;align-items:center;border:1px solid var(--border,#ddd);border-radius:10px;padding:8px 10px;">
    <legend style="padding:0 6px;font-weight:600;">Placement</legend>
    <label><input type="radio" name="fabPlace" value="h" ${place==='h'?'checked':''}> Horizontal</label>
    <label><input type="radio" name="fabPlace" value="v" ${place==='v'?'checked':''}> Vertical</label>
  </fieldset>
`;
sheet.appendChild(toggle);const f = document.createElement('div'); f.style.padding='10px';
    f.innerHTML = `
      <div class="row" style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        <input id="fabName" class="input" placeholder="Item name…" style="flex:1" />
        <input id="fabIcon" class="input" placeholder="Icon (emoji or text)" style="width:160px" />
      </div>
      <div class="row" style="display:flex; gap:8px; align-items:center; margin-bottom:2px">
        <select id="fabParent" class="select" style="flex:1"></select>
      </div>
      <div class="row" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
        <label style="display:flex; align-items:center; gap:6px">
          <input id="fabPin" type="checkbox"/> <span>Pin to bottom bar</span>
        </label>
        <span id="fabHint" class="form-hint"></span>
      </div>
      <div class="row" style="display:flex; gap:8px; justify-content:flex-end">
        <button id="fabCancel" class="btn ghost" type="button">Cancel</button>
        <button id="fabSubmit" class="btn primary" type="button">Add</button>
      </div>
    `;
    sheet.appendChild(f);

    const sel = f.querySelector('#fabParent');
    const opts = pickParents(place);
    opts.forEach(o => { const op=document.createElement('option'); op.value=o.value||''; op.textContent=o.text||''; sel.appendChild(op); });

    const draft = getDraft();
    hydrateForm(place, f, draft);


    // Radio change: re-render with selected place
    ;(function(){
      var radios = sheet.querySelectorAll('input[name="fabPlace"]');
      radios.forEach(function(r){
        r.addEventListener('change', function(){
          var val = r.value === 'v' ? 'v' : 'h';
          setDraft({ ...(getDraft()||{}), place: val });
          renderForm(val);
        });
      });
    })();

    f.querySelector('#fabCancel').onclick = () => { clearDraft(); closeSheet(); };
    f.querySelector('#fabSubmit').onclick = () => {
      if(f.__validate && !f.__validate()) return;
      const name = f.querySelector('#fabName').value;
      const icon = f.querySelector('#fabIcon').value;
      const parentId = f.querySelector('#fabParent').value || '';
      const pin = !!f.querySelector('#fabPin').checked;
      if(typeof window.addNav==='function'){
        const node = addNav(name, place, parentId, icon);
        if(pin){
          try{
            const ids = (Model.pinnedIds && Array.isArray(Model.pinnedIds)) ? Model.pinnedIds.slice() : JSON.parse(localStorage.getItem('pinnedIds')||'[]');
            if(node && node.id && !ids.includes(node.id)){ ids.push(node.id); localStorage.setItem('pinnedIds', JSON.stringify(ids)); Model.pinnedIds = ids; }
            if(typeof window.renderTabs==='function') window.renderTabs();
          }catch(e){}
        }
        clearDraft();
        closeSheet();
      } else {
        alert('addNav() not available');
      }
    };
  }

  function openAdd(){
    const draft = getDraft();
    const place = (draft && (draft.place==='v' || draft.place==='h')) ? draft.place : 'h';
    renderForm(place);
    openSheet();
  }

  if(fab){
    fab.addEventListener('click', (e)=>{
      e.stopPropagation();
      if(sheet.hidden) openAdd(); else closeSheet();
    });
  }

  // Outside click: ignore clicks inside sidebar or legacy adders; otherwise close
  document.addEventListener('click', (e)=>{
    const insideSidebar = e.target.closest && e.target.closest('aside.sidebar, #vAdder, #hAdder');
    if(!sheet.hidden && !sheet.contains(e.target) && e.target!==fab && !insideSidebar) sheet.hidden=true;
  });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') sheet.hidden=true; });

  // Re-open draft after navigation
  function reopenDraftIfAny(){
    const d = getDraft();
    if(d){ renderForm(d.place==='v'?'v':'h'); openSheet(); }
  }
  if(typeof window.openDesigner==='function'){
    const __od = window.openDesigner;
    window.openDesigner = function(){
      const r = __od.apply(this, arguments);
      setTimeout(reopenDraftIfAny, 0);
      return r;
    };
  }
})();
</script>
<nav aria-label="Quick actions" class="mtabs" id="mTabs" role="navigation"></nav>
<div class="mtab-sheet" hidden="" id="mTabSheet"></div>
<script>

/* === Mobile bottom tabs logic === */
(function(){
  const tabs = document.getElementById('mTabs');
  const sheet = document.getElementById('mTabSheet');
  if(!tabs || !sheet) return;

  function isMobile(){ return window.matchMedia('(max-width:768px)').matches; }
  function allItems(){ return (window.Model && Array.isArray(Model.items)) ? Model.items.slice() : []; }
  function findById(id){ return allItems().find(n=>n.id===id); }
  function wantNames(){ return ['home','forms','reports','settings','dashboard']; }

  function roots(place){
    if(typeof window.roots==='function') return window.roots(place) || [];
    const items = allItems();
    const ids = new Set(items.filter(i=>i.place===place).map(i=>i.id));
    items.filter(i=>i.place===place).forEach(n=>{
      if(typeof window.findParentOf==='function'){ const p=findParentOf(n.id, place); if(p) ids.delete(n.id); }
    });
    return items.filter(i=>i.place===place && ids.has(i.id));
  }

  function getPinnedIds(){
    try{ const arr = JSON.parse(localStorage.getItem('pinnedIds')||'[]'); return Array.isArray(arr)?arr:[]; }catch(e){ return []; }
  }

  function pickAuto(){
    const items = allItems();
    const picks = [];
    wantNames().forEach(nm => {
      const cand = items.find(n => n.place==='h' && (n.name||'').toLowerCase().includes(nm));
      if(cand && !picks.includes(cand)) picks.push(cand);
    });
    roots('h').forEach(n => { if(picks.length<5 && !picks.includes(n)) picks.push(n); });
    // removed by patch: vertical roots excluded for mobile tabs
    // roots('v').forEach(n => { if(picks.length<5 && !picks.includes(n)) picks.push(n); });
    items.filter(n=> n.place==='h' && !(n.children?.length)).forEach(n => { if(picks.length<5 && !picks.includes(n)) picks.push(n); });
    return picks.slice(0,5);
  }

  function clearSheet(){ sheet.innerHTML=''; sheet.hidden=true; }
  function renderChildList(nodes, trail){
    sheet.innerHTML = '';
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #f1f5f9;position:sticky;top:0;background:#fff;';
    if (trail.length){
      const back = document.createElement('button'); back.type='button'; back.type='button';
      back.textContent = '‹ Back';
      back.className = 'btn ghost';
      back.onclick = () => {
        const up = trail.slice(0, -1);
        if(up.length){ const parent = up[up.length-1]; renderChildList(parent.children||[], up); } else { clearSheet(); }
      };
      header.appendChild(back);
      const title = document.createElement('div');
      title.textContent = trail[trail.length-1].name || 'Sub-pages';
      title.style.fontWeight = '600';
      header.appendChild(title);
    } else {
      const title = document.createElement('div');
      title.textContent = 'Pages';
      title.style.fontWeight = '600';
      header.appendChild(title);
    }
    sheet.appendChild(header);

    (nodes||[]).forEach(k => {
      const row = document.createElement('div'); row.className='mtab-item';
      const hasKids = (k.children?.length||0)>0;
      row.innerHTML = `${k.icon?`<span class="ico">${k.icon}</span>`:''}<span class="lbl">${k.name}</span>${hasKids?'<span style="margin-left:auto;opacity:.6">▸</span>':''}`;
      row.onclick = () => { if(hasKids){ renderChildList(k.children, [...trail, k]); } else { clearSheet(); openDesigner(k); } };
      sheet.appendChild(row);
    });

    sheet.hidden = false;
  }
  function openChildrenSheet(node){ renderChildList(node.children||[], [node]); }

  function renderTabs(){
    if(!isMobile()){ tabs.innerHTML=''; clearSheet(); document.body.classList.remove('mtabs-on'); tabs.style.display='none'; return; }
    tabs.innerHTML='';
    let picks = getPinnedIds().map(findById).filter(Boolean).filter(n => n.place==='h');
    if(!picks.length){ picks = pickAuto(); }
    if(!picks.length){ document.body.classList.remove('mtabs-on'); tabs.style.display='none'; return; }
    tabs.style.display='flex';
    document.body.classList.add('mtabs-on');
    picks.forEach(n => {
      const btn = document.createElement('button'); btn.type='button'; btn.type='button'; btn.className='mtab'; btn.dataset.id=n.id;
      btn.innerHTML = `${n.icon?`<span class="ico">${n.icon}</span>`:''}<span class="lbl">${n.name}</span>`;
      const hasKids = (n.children?.length||0)>0;
      btn.onclick = () => { if(hasKids) openChildrenSheet(n); else openDesigner(n); };
      tabs.appendChild(btn);
    });
    highlightActive();
  }
  function highlightActive(){
    const id = window.current?.id;
    document.querySelectorAll('#mTabs .mtab').forEach(b => b.classList.toggle('active', b.dataset.id===id));
  }

  // Keep in sync with page changes
  if(typeof window.render==='function'){
    const _r = window.render;
    window.render = function(){ _r.apply(this, arguments); renderTabs(); };
  }
  if(typeof window.setActive==='function'){
    const _s = window.setActive;
    window.setActive = function(){ _s.apply(this, arguments); highlightActive(); };
  }

  window.addEventListener('resize', renderTabs);
  window.addEventListener('orientationchange', renderTabs);
  setTimeout(renderTabs, 0);
})();
</script>
<script>

/* === Hide Add UI in demo mode === */
(function(){
  function apply(){
    const isDemo = (window.demoMode===true || String(window.demoMode).toLowerCase()==='true');
    const fab = document.getElementById('fabAdd');
    const head = document.getElementById('headerAddBtn');
    if(fab) fab.style.display = isDemo ? 'none' : '';
    if(head) head.style.display = isDemo ? 'none' : '';
  }
  apply();
  // Hook into a common toggle if present
  if(typeof window.toggleMode==='function'){
    const __t = window.toggleMode;
    window.toggleMode = function(){
      const r = __t.apply(this, arguments);
      apply();
      return r;
    };
  }
  // Fallback: observe a body data attribute if app uses it
  const mo = new MutationObserver(apply);
  mo.observe(document.documentElement, { attributes:true, attributeFilter:['data-mode'] });
  // Re-apply on visibility change (e.g., after demo switch renders)
  document.addEventListener('visibilitychange', apply);
})();
</script>
<script>

/* === Guard Add triggers when in demo === */
(function(){
  function isDemo(){ return (window.demoMode===true || String(window.demoMode).toLowerCase()==='true'); }
  const fab = document.getElementById('fabAdd');
  if(fab){
    const __click = fab.onclick;
    fab.addEventListener('click', function(e){
      if(isDemo()){ e.stopPropagation(); e.preventDefault(); try{ toast && toast('Editing is disabled in Demo mode.'); }catch(_){} }
    }, true);
  }
  const head = document.getElementById('headerAddBtn');
  if(head){
    head.addEventListener('click', function(e){
      if(isDemo()){ e.stopPropagation(); e.preventDefault(); try{ toast && toast('Editing is disabled in Demo mode.'); }catch(_){} }
    }, true);
  }
})();
</script>
<script>

/* === Insert Edit/Demo toggle and wire it as a true mode switch === */

</script>
<script id="add-nav-dialog-stability-fix">
(function(){
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  } else { init(); }

  function init(){
    const dialog = document.querySelector('.nav-add-dialog, [data-dialog="add-nav"], #addNavDialog');
    if (!dialog) return;

    // Keep dialog visible
    dialog.removeAttribute('hidden');
    dialog.setAttribute('aria-hidden','false');

    // 0) Disable form submits inside dialog (prevents accidental close on default submit handlers)
    dialog.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', function(e){ 
    // DEMO GUARD: process only when an explicit Submit control triggered this submit
    if (window.demoMode) {
      var __s = (typeof e!=='undefined' && e) ? (e.submitter || document.activeElement) : document.activeElement;
      var __isSubmit = (function(el){
        if(!el || !el.tagName) return false;
        var txt=(el.getAttribute('aria-label')||el.textContent||'').trim().toLowerCase();
        return el.type==='submit' || el.classList.contains('submit') || el.getAttribute('data-role')==='submit' || txt==='submit';
      })(__s);
      if(!__isSubmit){ e.preventDefault(); return; }
    }
e.preventDefault(); e.stopPropagation(); }, true);
    });

    // 1) Shield dialog from global outside-click/mousedown/touch closers
    ['click','mousedown','mouseup','touchstart','touchend'].forEach(evt => {
      dialog.addEventListener(evt, function(ev){
        // Anything inside the dialog should NOT bubble to document-level closers
        ev.stopPropagation();
      }, true); // capture
    });

    // 2) Extra shielding for the tab bar
    const tabsWrap = dialog.querySelector('.nav-add-tabs');
    if (tabsWrap){
      // Hide old Horizontal/Vertical buttons and inject a mode toggle
      try{
        tabsWrap.style.display = 'none';
      }catch(_){}
      buildModeToggle(dialog, tabsWrap);

      ['click','mousedown','mouseup','touchstart','touchend'].forEach(evt => {
        tabsWrap.addEventListener(evt, function(ev){
          ev.preventDefault();
          // strongest shield to neutralize zealous global handlers
          if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
          ev.stopPropagation();
        }, true);
      });
    }

    // 3) Tab activation wiring (anchors/buttons/role=tab/data-tab)
    const panes = Array.from(dialog.querySelectorAll('.add-nav-pane, .nav-add-pane, [role="tabpanel"]'));
    cacheOriginalDisplays(panes);

    const tabActivators = [];
    if (tabsWrap){
      tabActivators.push(
        ...tabsWrap.querySelectorAll('button, [role="tab"], a[href^="#"], [data-tab]')
      );
    }
    tabActivators.forEach(ctrl => {
      // Ensure buttons don't submit
      if (ctrl.tagName === 'BUTTON' && !ctrl.getAttribute('type')) ctrl.setAttribute('type','button');
      ctrl.addEventListener('click', function(e){
        e.preventDefault();
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        e.stopPropagation();
        const key = getTabKey(ctrl);
        if (key) setActiveTab(key, dialog, panes, tabsWrap);
      }, false);
    });

    // Safe-guard against [data-close] or .js-close elements inside tabs
    if (tabsWrap){
      tabsWrap.querySelectorAll('[data-close], .js-close').forEach(el => {
        el.addEventListener('click', function(e){
          e.preventDefault();
          if (e.stopImmediatePropagation) e.stopImmediatePropagation();
          e.stopPropagation();
        }, true);
      });
    }

    // Initialize default tab: prefer horizontal then vertical
    const first =
      (tabsWrap && (tabsWrap.querySelector('[data-tab="horizontal"]') || tabsWrap.querySelector('[href="#horizontal"]'))) ||
      (tabsWrap && (tabsWrap.querySelector('[data-tab="vertical"]') || tabsWrap.querySelector('[href="#vertical"]')));
    if (first){
      const key = getTabKey(first);
      if (key) setActiveTab(key, dialog, panes, tabsWrap);
    }
  }

  function cacheOriginalDisplays(panes){
    panes.forEach(p => {
      if (!p.dataset.origDisplay){
        try {
          const cs = window.getComputedStyle ? getComputedStyle(p) : null;
          const disp = cs && cs.display && cs.display !== 'none' ? cs.display : '';
          p.dataset.origDisplay = disp || (p.classList.contains('flex') ? 'flex' : 'block');
        } catch(_){
          p.dataset.origDisplay = 'block';
        }
      }
    });
  }

  function getTabKey(el){
    let key = el.getAttribute('data-tab') || el.getAttribute('aria-controls');
    if (!key){
      const href = el.getAttribute && el.getAttribute('href');
      if (href) key = href.replace(/^#/, '');
    }
    return key ? key.toLowerCase().trim() : null;
  }

  function paneKey(p){
    const id = (p.id || '').toLowerCase();
    const dp = (p.getAttribute('data-pane') || '').toLowerCase();
    const tr = (p.getAttribute('data-tabrole') || '').toLowerCase();
    return id || dp || tr || '';
  }

  function setActiveTab(key, root, panes, tabsWrap){
    const normKey = (key||'').toLowerCase().trim();

    // Update tab button states
    if (tabsWrap){
      tabsWrap.querySelectorAll('[aria-selected="true"]').forEach(n => n.setAttribute('aria-selected','false'));
      tabsWrap.querySelectorAll('.active, .is-active, .selected').forEach(n => n.classList.remove('active','is-active','selected'));
      const btn = tabsWrap.querySelector(
        `[data-tab="${normKey}"], [href="#${normKey}"], [aria-controls="${normKey}"], [data-tab="${key}"], [href="#${key}"], [aria-controls="${key}"]`
      );
      if (btn){
        btn.setAttribute('aria-selected','true');
        btn.classList.add('active','is-active','selected');
      }
    }

    // Show matching pane, hide others
    let shown = false;
    panes.forEach(p => {
      const k = paneKey(p);
      const match = k === normKey || k === key || (k && k.includes(normKey));
      if (match && !shown){
        p.style.display = p.dataset.origDisplay || 'block';
        p.removeAttribute('hidden');
        p.setAttribute('aria-hidden','false');
        p.classList.add('active','is-active','show');
        shown = true;
      } else {
        p.style.display = 'none';
        p.setAttribute('hidden','hidden');
        p.setAttribute('aria-hidden','true');
        p.classList.remove('active','is-active','show');
      }
    });

    // Notify
    root.dispatchEvent(new CustomEvent('addnav:tabchange', {detail:{ tab: normKey }, bubbles:true}));
  }
})();

  function currentActiveTabKey(tabsWrap){
    const a = tabsWrap && (tabsWrap.querySelector('[aria-selected="true"]') || tabsWrap.querySelector('.active,.is-active,.selected'));
    if (!a) return null;
    const k = a.getAttribute('data-tab') || a.getAttribute('aria-controls') || (a.getAttribute('href')||'').replace(/^#/, '');
    return k ? k.toLowerCase().trim() : null;
  }

  function buildModeToggle(dialog, tabsWrap){
    // Container near the top of the dialog
    const host = dialog.querySelector('.nav-add-header, .dialog-header, .modal-header, .nav-add-dialog') || dialog;
    const firstChild = host.firstElementChild;

    const wrap = document.createElement('div');
    wrap.className = 'addnav-mode-toggle';
    wrap.setAttribute('role', 'group');
    wrap.setAttribute('aria-label', 'Navigation mode');

    const left = document.createElement('span');
    left.className = 'opt';
    left.textContent = 'Horizontal';

    const right = document.createElement('span');
    right.className = 'opt';
    right.textContent = 'Vertical';

    const label = document.createElement('label');
    label.className = 'switch';
    label.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); }, true);

    const input = document.createElement('input');
    input.type = 'checkbox'; // checked = Vertical, unchecked = Horizontal
    input.setAttribute('aria-label', 'Toggle navigation mode');

    const slider = document.createElement('span');
    slider.className = 'slider';

    label.appendChild(input);
    label.appendChild(slider);

    wrap.appendChild(left);
    wrap.appendChild(label);
    wrap.appendChild(right);

    // Insert at the top (above form fields)
    if (host && firstChild){
      host.insertBefore(wrap, firstChild);
    }else{
      dialog.insertBefore(wrap, dialog.firstChild);
    }

    // Default position based on active tab
    let activeKey = currentActiveTabKey(tabsWrap) || 'horizontal';
    input.checked = activeKey === 'vertical';

    // Change handler: toggle between horizontal <-> vertical
    input.addEventListener('change', function(e){
      e.preventDefault();
      e.stopPropagation();
      const key = input.checked ? 'vertical' : 'horizontal';
      try {
        // Use existing setActiveTab from our script
        const evt = new Event('click', {bubbles:false, cancelable:true});
        // Directly call setActiveTab if available in closure; otherwise click hidden controls
        if (typeof setActiveTab === 'function'){
          // We have closure access in this script scope
          const dialog = document.querySelector('.nav-add-dialog, [data-dialog="add-nav"], #addNavDialog') || document;
          const panes = Array.from(dialog.querySelectorAll('.add-nav-pane, .nav-add-pane, [role="tabpanel"]'));
          // TabsWrap might be hidden; still pass it so states apply
          setActiveTab(key, dialog, panes, tabsWrap);
        } else {
          // Fallback: click the original hidden tab control
          const btn = tabsWrap && (tabsWrap.querySelector(`[data-tab="${key}"]`) || tabsWrap.querySelector(`[href="#${key}"]`));
          if (btn){ btn.dispatchEvent(evt); }
        }
      } catch(_){}
    });

    // Also listen for programmatic tab changes to keep switch in sync
    dialog.addEventListener('addnav:tabchange', function(ev){
      const k = (ev.detail && ev.detail.tab) || '';
      if (!k) return;
      input.checked = k.toLowerCase() === 'vertical';
    });
  }
</script>
<script>
(function(){
  // Global override point
  window.VALIDATION_MESSAGES = window.VALIDATION_MESSAGES || {
    required: (name)=> `${name} is required.`,
    typeMismatch: (name, type)=> `Please enter a valid ${type||'value'}.`,
    pattern: ()=> `Input does not match the required format.`,
    min: (name, min)=> `Value must be ≥ ${min}.`,
    max: (name, max)=> `Value must be ≤ ${max}.`,
    step: (name, step)=> `Please use a valid step (${step}).`,
    tooShort: (name, n)=> `Please enter at least ${n} characters.`,
    tooLong: (name, n)=> `Please enter no more than ${n} characters.`,
    badInput: ()=> `Please provide a valid value.`,
    generic: ()=> `Invalid value.`
  };

  window.attachValidationUX = function(form){


    function _cleanLabelText(t){
      if(!t) return '';
      return String(t).replace(/\s*\*+\s*$/,'').replace(/\s+/g,' ').trim();
    }
    function _cssEsc(s){
      try{ return CSS && CSS.escape ? CSS.escape(s) : String(s).replace(/([ #.;?+*~\\':"!^$[\]\(\)=>|\/@])/g,'\\$1'); }catch(_){ return String(s); }
    }
    function _findControlLabel(ctrl, form){
      let name = ctrl.getAttribute('aria-label');
      if(name) return _cleanLabelText(name);
      if(ctrl.id){
        const forLbl = form.querySelector('label[for="'+_cssEsc(ctrl.id)+'"]');
        if(forLbl){ name = forLbl.textContent; if(name){ return _cleanLabelText(name); } }
      }
      const wrap = ctrl.closest('.field, .form-group, .form-control, .control, .input, .col, .cell, .row');
      if(wrap){
        let wl = wrap.querySelector('label, .field-label, .form-label, .label, [data-label]');
        if(wl){
          if(wl.dataset && wl.dataset.label) return _cleanLabelText(wl.dataset.label);
          if(wl.textContent) return _cleanLabelText(wl.textContent);
          if(wl.getAttribute && wl.getAttribute('data-label')) return _cleanLabelText(wl.getAttribute('data-label'));
        }
      }
      const prev = ctrl.previousElementSibling;
      if(prev && (prev.tagName==='LABEL' || prev.classList.contains('label') || prev.classList.contains('form-label'))) {
        return _cleanLabelText(prev.textContent);
      }
      if(ctrl.dataset && ctrl.dataset.label) return _cleanLabelText(ctrl.dataset.label);
      if(ctrl.placeholder) return _cleanLabelText(ctrl.placeholder);
      if(ctrl.name) return _cleanLabelText(ctrl.name);
      if(ctrl.id) return _cleanLabelText(ctrl.id);
      return 'This field';
    }

if(!form) return;

    // Remove previous summary/errors
    function clearSummary(){
      const prev=form.querySelector('#validationSummary');
      if(prev) prev.remove();
    }

    function messageFor(ctrl){
      const v = ctrl.validity;
      const name = _findControlLabel(ctrl, form);
      try{ if(!ctrl.getAttribute('aria-label')) ctrl.setAttribute('aria-label', name); }catch(_){}
      if(v.valueMissing && ctrl.dataset.requiredMsg) return ctrl.dataset.requiredMsg;
      if(v.typeMismatch && ctrl.dataset.typeMsg) return ctrl.dataset.typeMsg;
      if(v.patternMismatch && ctrl.dataset.patternMsg) return ctrl.dataset.patternMsg;
      if(v.rangeUnderflow && ctrl.dataset.minMsg) return ctrl.dataset.minMsg;
      if(v.rangeOverflow && ctrl.dataset.maxMsg) return ctrl.dataset.maxMsg;
      if(v.stepMismatch && ctrl.dataset.stepMsg) return ctrl.dataset.stepMsg;
      if(v.tooShort && ctrl.dataset.tooShortMsg) return ctrl.dataset.tooShortMsg;
      if(v.tooLong && ctrl.dataset.tooLongMsg) return ctrl.dataset.tooLongMsg;
      if(v.customError) return ctrl.validationMessage;

      if(v.valueMissing) return VALIDATION_MESSAGES.required(name);
      if(v.typeMismatch) return VALIDATION_MESSAGES.typeMismatch(name, ctrl.type);
      if(v.patternMismatch) return VALIDATION_MESSAGES.pattern(name);
      if(v.rangeUnderflow) return VALIDATION_MESSAGES.min(name, ctrl.min);
      if(v.rangeOverflow) return VALIDATION_MESSAGES.max(name, ctrl.max);
      if(v.stepMismatch) return VALIDATION_MESSAGES.step(name, ctrl.step);
      if(v.tooShort) return VALIDATION_MESSAGES.tooShort(name, ctrl.minLength);
      if(v.tooLong) return VALIDATION_MESSAGES.tooLong(name, ctrl.maxLength);
      if(v.badInput) return VALIDATION_MESSAGES.badInput(name);
      return VALIDATION_MESSAGES.generic(name);
    }

function placeError(ctrl, msg){
      ctrl.classList.add('is-invalid');
      const wrap = ctrl.closest('.field, .form-control, .control, .input, .col, .cell') || ctrl.parentElement;
      if(!wrap) return;
      let err = wrap.querySelector('.error-msg');
      if(!err){
        err = document.createElement('div');
        err.className = 'error-msg';
        err.setAttribute('role','alert');
        wrap.appendChild(err);
      }
      err.textContent = msg;
    }
    function clearError(ctrl){
      ctrl.classList.remove('is-invalid');
      const wrap = ctrl.closest('.field, .form-control, .control, .input, .col, .cell') || ctrl.parentElement;
      if(!wrap) return;
      const err = wrap.querySelector('.error-msg');
      if(err) err.remove();
    }

    // Attach handlers to all native controls + hidden inputs (used by custom widgets)
    const controls = Array.from(form.querySelectorAll('input, select, textarea')).filter(el=>!el.disabled && el.willValidate!==false);
    controls.forEach(ctrl=>{
      ctrl.addEventListener('invalid', (e)=>{
        // Suppress native bubble
        e.preventDefault();
        placeError(ctrl, messageFor(ctrl));
      });
      ctrl.addEventListener('input', ()=>{
        if(ctrl.checkValidity()) clearError(ctrl);
        else placeError(ctrl, messageFor(ctrl));
      });
      ctrl.addEventListener('blur', ()=>{
        if(!ctrl.checkValidity()) placeError(ctrl, messageFor(ctrl));
      });
    });

    form.addEventListener('submit', (e)=>{
      
    // DEMO GUARD: process only when an explicit Submit control triggered this submit
    if (window.demoMode) {
      var __s = (typeof e!=='undefined' && e) ? (e.submitter || document.activeElement) : document.activeElement;
      var __isSubmit = (function(el){
        if(!el || !el.tagName) return false;
        var txt=(el.getAttribute('aria-label')||el.textContent||'').trim().toLowerCase();
        return el.type==='submit' || el.classList.contains('submit') || el.getAttribute('data-role')==='submit' || txt==='submit';
      })(__s);
      if(!__isSubmit){ e.preventDefault(); return; }
    }
clearSummary();
      if(!form.checkValidity()){
        e.preventDefault();
        const invalid = Array.from(form.querySelectorAll(':invalid'));
        invalid.forEach(ctrl=> placeError(ctrl, messageFor(ctrl)));
        // Build summary
        const summary=document.createElement('div');
        summary.id='validationSummary';
        summary.className='validation-summary';
        const title=document.createElement('div');
        title.className='summary-title';
        title.textContent=`Please fix ${invalid.length} field${invalid.length>1?'s':''}`;
        const ul=document.createElement('ul');
        invalid.forEach(ctrl=>{
          const li=document.createElement('li');
          const a=document.createElement('a');
          a.href = ctrl.id ? '#'+ctrl.id : '#';
          a.textContent = messageFor(ctrl);
          a.addEventListener('click', (ev)=>{
            ev.preventDefault();
            ctrl.focus({preventScroll:false});
            try{ ctrl.scrollIntoView({behavior:'smooth', block:'center'}); }catch(_){}
          });
          li.appendChild(a); ul.appendChild(li);
        });
        summary.appendChild(title); summary.appendChild(ul);
        form.prepend(summary);
        // Focus first invalid
        const first = invalid[0];
        if(first){
          first.focus();
          try{ first.scrollIntoView({behavior:'smooth', block:'center'}); }catch(_){}
        }
      }
    }, true);
  };
})();
</script>
<script>
// Lightweight signature modal for table cells
function openSignatureCellModal(initial, onSave){
  const root=document.createElement('div'); root.className='sig-modal'; root.addEventListener('click', (e)=>{ if(e.target===root) close(); });
  const card=document.createElement('div'); card.className='sig-card'; root.appendChild(card);
  const head=document.createElement('div'); head.className='sig-head';
  const ttl=document.createElement('div'); ttl.textContent='Draw signature';
  const x=document.createElement('button'); x.type='button'; x.type='button'; x.type='button'; x.className='btn ghost'; x.textContent='✕';
  x.onclick=()=>close();
  head.append(ttl,x);
  const body=document.createElement('div'); body.className='sig-body';
  const canvas=document.createElement('canvas'); canvas.className='sig-canvas';
  const tools=document.createElement('div'); tools.className='sig-tools';
  const color=document.createElement('input'); color.type='color'; color.value='#111827';
  const width=document.createElement('input'); width.type='number'; width.min='1'; width.max='12'; width.value='2';
  const clear=document.createElement('button'); clear.type='button'; clear.type='button'; clear.type='button'; clear.className='btn ghost'; clear.textContent='Clear';
  tools.append('Ink', color, 'Width', width, clear);
  const actions=document.createElement('div'); actions.className='sig-actions';
  const save=document.createElement('button'); save.type='button'; save.type='button'; save.type='button'; save.className='btn'; save.textContent='Save';
  const cancel=document.createElement('button'); cancel.type='button'; cancel.type='button'; cancel.type='button'; cancel.className='btn ghost'; cancel.textContent='Cancel';
  
  const download=document.createElement('button'); download.type='button'; download.type='button'; download.type='button'; download.className='btn ghost'; download.textContent='Download PNG';
  download.onclick=()=>{
    try{
      const a=document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'signature.png';
      a.click();
    }catch(e){ console.error('Download PNG failed', e); }
  };
actions.append(download, cancel, save);
  body.append(canvas, tools, actions);
  card.append(head, body);
  document.body.appendChild(root);

  // Setup canvas with DPR scaling
  const ctx = canvas.getContext('2d');
  function resize(){
    const rect=canvas.getBoundingClientRect(); const dpr=window.devicePixelRatio||1;
    canvas.width = Math.max(300, Math.floor(rect.width*dpr));
    canvas.height= Math.max(150, Math.floor(rect.height*dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    if(initial && /^data:image\//.test(String(initial))){
      const img=new Image(); img.onload=()=>{ ctx.drawImage(img, 0,0, rect.width, rect.height); }; img.src=initial;
    }
  }
  const ro = new ResizeObserver(resize); ro.observe(canvas);

  let drawing=false, lx=0, ly=0;
  function pos(e){ const r=canvas.getBoundingClientRect(); const t=(e.touches? e.touches[0] : e); return {x:t.clientX - r.left, y:t.clientY - r.top}; }
  function start(e){ e.preventDefault(); drawing=true; const p=pos(e); lx=p.x; ly=p.y; }
  function move(e){ if(!drawing) return; const p=pos(e); ctx.strokeStyle=color.value; ctx.lineWidth=Number(width.value)||2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(p.x,p.y); ctx.stroke(); lx=p.x; ly=p.y; }
  function end(){ drawing=false; }
  canvas.addEventListener('pointerdown', start); canvas.addEventListener('pointermove', move); window.addEventListener('pointerup', end);
  canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
  clear.onclick=()=>{ const r=canvas.getBoundingClientRect(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,r.width,r.height); };

  function close(){ try{ ro.disconnect(); }catch{}; root.remove(); }
  cancel.onclick=close;
  save.onclick=()=>{ try{ const data = canvas.toDataURL('image/png'); onSave && onSave(data); }catch{} close(); };
}

// Create a compact Quill editor for a table cell; stores HTML in get/set
function attachCellQuill(container, initialHTML, onChange){
  if(!window.Quill){
    const ta=document.createElement('textarea'); ta.className='input'; ta.rows=2; ta.value=initialHTML||'';
    ta.oninput=()=>onChange && onChange(ta.value);
    container.appendChild(ta);
    return { destroy:()=>{} };
  }
  const toolbar=document.createElement('div'); toolbar.className='ql-toolbar ql-snow'; toolbar.style.borderRadius='8px 8px 0 0';
  toolbar.innerHTML=[
    '<span class="ql-formats"><button class="ql-bold" type="button"></button><button class="ql-italic" type="button"></button><button class="ql-underline" type="button"></button></span>',
    '<span class="ql-formats"><button class="ql-list" value="ordered" type="button"></button><button class="ql-list" value="bullet" type="button"></button></span>'
  ].join('');
  const editorWrap=document.createElement('div'); editorWrap.className='ql-container ql-snow'; editorWrap.style.minHeight='80px'; editorWrap.style.borderRadius='0 0 8px 8px';
  const editor=document.createElement('div'); editor.className='ql-editor'; editor.style.minHeight='64px';
  editorWrap.appendChild(editor);
  container.appendChild(toolbar); container.appendChild(editorWrap);
  const q = new Quill(editor, { theme:'snow', modules:{ toolbar: toolbar } });
  try{ if(initialHTML){ q.clipboard.dangerouslyPasteHTML(initialHTML); } }catch{}
  q.on('text-change', ()=>{ try{ onChange && onChange(q.root.innerHTML); }catch{} });
  return { destroy:()=>{ try{ q.disable(); }catch{} } };
}
</script>
<!-- Modal editor for rich text (in-table) -->
<style>
#rtx-modal-root.rtx-hidden { display: none; }
#rtx-modal-root { position: fixed; inset: 0; z-index: 9999; }
#rtx-modal-root .rtx-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
#rtx-modal-root .rtx-dialog {
  position: absolute; inset: 4% 50% auto 50%;
  transform: translate(-50%, 0);
  width: min(900px, 92vw);
  background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,.22);
  display: flex; flex-direction: column; max-height: 92vh;
}
.rtx-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee; }
.rtx-close { border:0; background:transparent; font-size:22px; cursor:pointer; line-height:1; }
.rtx-actions { display:flex; gap:8px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #eee; }
.rtx-btn { border:1px solid #ddd; background:#f7f7f7; padding:8px 14px; border-radius:8px; cursor:pointer; }
.rtx-save { background:#0b5fff; color:#fff; border-color:#0b5fff; }
.rtx-body { padding:12px 16px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
.rtx-toolbar { }
.rtx-editor { min-height: 260px; }
.rtx-loading { display:none; font-size:14px; opacity:.7; }
.rtx-dialog .ql-container { height: 360px; }
@media (max-height: 700px) { .rtx-dialog .ql-container { height: 240px; } }
body.demo-mode #rtx-modal-root [contenteditable="true"] { pointer-events: auto !important; user-select: text !important; }

/* Preview in cell */
.rtx-cellwrap { display:flex; flex-direction:column; gap:8px; }
.rtx-preview { border:1px dashed #ddd; border-radius:8px; padding:8px; max-height:180px; overflow:auto; background:#fafafa; }
.rtx-edit-btn { align-self:flex-start; border:1px solid #ddd; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; }
</style>
<div class="rtx-hidden" id="rtx-modal-root">
<div class="rtx-backdrop"></div>
<div aria-labelledby="rtx-modal-title" aria-modal="true" class="rtx-dialog" role="dialog">
<div class="rtx-header">
<h3 id="rtx-modal-title">Edit rich text</h3>
<button aria-label="Close" class="rtx-close" type="button">×</button>
</div>
<div class="rtx-body">
<div class="rtx-toolbar"></div>
<div class="rtx-editor"></div>
<div class="rtx-loading">Loading editor…</div>
</div>
<div class="rtx-actions">
<button class="rtx-btn rtx-cancel" type="button">Cancel</button>
<button class="rtx-btn rtx-save" type="button">Save</button>
</div>
</div>
</div>
<script>
// Ensure a QuillReady promise exists
window.QuillReady = window.QuillReady || new Promise((resolve) => {
  if (window.Quill) return resolve();
  window.addEventListener('load', () => {
    const start = performance.now();
    (function waitQ(){
      if (window.Quill) return resolve();
      if (performance.now() - start > 4000) return resolve(); // Fail-open
      requestAnimationFrame(waitQ);
    })();
  });
});

function rtxSafeHTML(html) {
  const t = document.createElement('template');
  t.innerHTML = html || '';
  t.content.querySelectorAll('script').forEach(s => s.remove());
  return t.innerHTML;
}

function rtxOpenModal(initialHtml, { title = 'Edit rich text', toolbar = null } = {}) {
  const root = document.getElementById('rtx-modal-root');
  const qToolbar = root.querySelector('.rtx-toolbar');
  const qEditor  = root.querySelector('.rtx-editor');
  const btnX  = root.querySelector('.rtx-close');
  const btnCancel = root.querySelector('.rtx-cancel');
  const btnSave   = root.querySelector('.rtx-save');
  const loadingEl = root.querySelector('.rtx-loading');
  root.querySelector('#rtx-modal-title').textContent = title;

  qToolbar.innerHTML = '';
  qEditor.innerHTML  = '';
  loadingEl.style.display = 'block';

  root.classList.remove('rtx-hidden');

  let quill = null;
  let resolved = false;

  const teardown = () => {
    quill = null;
    root.classList.add('rtx-hidden');
    qToolbar.innerHTML = '';
    qEditor.innerHTML  = '';
    loadingEl.style.display = 'none';
    btnX.removeEventListener('click', onCancel);
    btnCancel.removeEventListener('click', onCancel);
    btnSave.removeEventListener('click', onSave);
    root.removeEventListener('click', onBackdrop);
    document.removeEventListener('keydown', onKey);
  };

  const onKey = (e) => { if (e.key === 'Escape') onCancel(); };
  const onBackdrop = (e) => { if (e.target === root || e.target.classList.contains('rtx-backdrop')) onCancel(); };

  let resolver;
  const onCancel = () => { if (resolved) return; resolved = true; teardown(); resolver(null); };
  const onSave   = () => { if (resolved) return; resolved = true; const html = quill ? quill.root.innerHTML : qEditor.innerHTML; teardown(); resolver(html); };

  btnX.addEventListener('click', onCancel);
  btnCancel.addEventListener('click', onCancel);
  btnSave.addEventListener('click', onSave);
  root.addEventListener('click', onBackdrop);
  document.addEventListener('keydown', onKey);

  const p = new Promise((r)=> resolver = r);

  (async () => {
    await window.QuillReady;
    if (!window.Quill) {
      loadingEl.textContent = 'Editor failed to load; using plain content box.';
      qEditor.contentEditable = 'true';
      qEditor.innerHTML = rtxSafeHTML(initialHtml || '');
      loadingEl.style.display = 'none';
      qEditor.focus();
      return;
    }
    const tb = toolbar || [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      [{ 'align': [] }],
      ['link', 'blockquote', 'code-block'],
      [{ 'color': [] }, { 'background': [] }],
      ['clean']
    ];
    const modules = { toolbar: Array.isArray(tb) ? tb : qToolbar };
    if (Array.isArray(tb)) qToolbar.classList.add('ql-toolbar');
    quill = new Quill(qEditor, { theme: 'snow', modules: modules });
    try{ quill.root.innerHTML = initialHtml || ''; }catch(e){}
    loadingEl.style.display = 'none';
    requestAnimationFrame(()=> quill && quill.focus());
  })();

  return p;
}

function renderRichtextCell(hostEl, rowObj, colDef, { onChange } = {}) {
  hostEl.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'rtx-cellwrap';
  const preview = document.createElement('div');
  preview.className = 'rtx-preview';
  preview.innerHTML = rtxSafeHTML(rowObj[colDef.key] || '<div style="opacity:.6">— empty —</div>');

  const btn = document.createElement('button'); btn.type='button'; btn.type='button';
  btn.type = 'button';
  btn.className = 'rtx-edit-btn';
  btn.textContent = 'Edit rich text…';

  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const html = await rtxOpenModal(rowObj[colDef.key] || '', { title: colDef.label || colDef.key });
    if (html !== null) {
      rowObj[colDef.key] = html;
      preview.innerHTML = rtxSafeHTML(html);
      onChange && onChange(html);
    }
  });

  wrap.appendChild(preview);
  wrap.appendChild(btn);
  hostEl.appendChild(wrap);
}
</script>
<!-- OVERRIDE: Modal Quill singleton + toolbar container (prevents duplicate toolbars) -->
<script>
(function(){
  // Guard: only apply once
  if (window.__rtxModalPatchedV2) return;
  window.__rtxModalPatchedV2 = true;

  // Build standard toolbar markup inside a given container
  function buildToolbar(container){
    container.classList.add('ql-toolbar','ql-snow');
    container.innerHTML = ''
      + '<span class="ql-formats">'
      + '  <select class="ql-header">'
      + '    <option selected>Normal</option>'
      + '    <option value="1">Heading 1</option>'
      + '    <option value="2">Heading 2</option>'
      + '    <option value="3">Heading 3</option>'
      + '  </select>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-bold"></button>'
      + '  <button class="ql-italic"></button>'
      + '  <button class="ql-underline"></button>'
      + '  <button class="ql-strike"></button>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-list" value="ordered"></button>'
      + '  <button class="ql-list" value="bullet"></button>'
      + '  <button class="ql-align" value=""></button>'
      + '  <button class="ql-align" value="center"></button>'
      + '  <button class="ql-align" value="right"></button>'
      + '  <button class="ql-align" value="justify"></button>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-link"></button>'
      + '  <button class="ql-blockquote"></button>'
      + '  <button class="ql-code-block"></button>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <select class="ql-color"></select>'
      + '  <select class="ql-background"></select>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-clean"></button>'
      + '</span>';
  }

  // Replace rtxOpenModal with singleton-based version
  window.rtxOpenModal = function rtxOpenModal(initialHtml, { title = 'Edit rich text' } = {}) {
    const root = document.getElementById('rtx-modal-root');
    const dlg  = root.querySelector('.rtx-dialog');
    const qToolbar = root.querySelector('.rtx-toolbar');
    const qEditor  = root.querySelector('.rtx-editor');
    const btnX  = root.querySelector('.rtx-close');
    const btnCancel = root.querySelector('.rtx-cancel');
    const btnSave   = root.querySelector('.rtx-save');
    const loadingEl = root.querySelector('.rtx-loading');
    root.querySelector('#rtx-modal-title').textContent = title;

    // Remove any stray toolbars created by older code
    root.querySelectorAll('.ql-toolbar').forEach(tb => {
      if (tb !== qToolbar) tb.remove();
    });

    // Prepare DOM
    qEditor.innerHTML = '';
    qToolbar.innerHTML = '';
    buildToolbar(qToolbar);
    loadingEl.style.display = 'block';
    root.classList.remove('rtx-hidden');

    let resolved = false;

    let resolver;
    const p = new Promise((r)=> resolver = r);

    const teardown = () => {
      root.classList.add('rtx-hidden');
      loadingEl.style.display = 'none';
      // Do NOT remove toolbar or editor; we reuse them with singleton Quill
      btnX.removeEventListener('click', onCancel);
      btnCancel.removeEventListener('click', onCancel);
      btnSave.removeEventListener('click', onSave);
      root.removeEventListener('click', onBackdrop);
      document.removeEventListener('keydown', onKey);
    };

    const onKey = (e) => { if (e.key === 'Escape') onCancel(); };
    const onBackdrop = (e) => { if (e.target === root || e.target.classList.contains('rtx-backdrop')) onCancel(); };
    const onCancel = () => {
      if (resolved) return;
      resolved = true; teardown(); resolver(null);
    };
    const onSave = () => {
      if (resolved) return;
      resolved = true;
      const q = window.__rtxModalQuill;
      const html = q ? q.root.innerHTML : qEditor.innerHTML;
      teardown(); resolver(html);
    };

    btnX.addEventListener('click', onCancel);
    btnCancel.addEventListener('click', onCancel);
    btnSave.addEventListener('click', onSave);
    root.addEventListener('click', onBackdrop);
    document.addEventListener('keydown', onKey);

    (async () => {
      await window.QuillReady;
      // Fallback if Quill failed to load
      if (!window.Quill) {
        loadingEl.textContent = 'Editor failed to load; using plain content box.';
        qEditor.contentEditable = 'true';
        qEditor.innerHTML = (window.rtxSafeHTML ? window.rtxSafeHTML(initialHtml || '') : (initialHtml || ''));
        loadingEl.style.display = 'none';
        qEditor.focus();
        return;
      }

      // Singleton instance
      if (!window.__rtxModalQuill) {
        window.__rtxModalQuill = new Quill(qEditor, {
          theme: 'snow',
          modules: { toolbar: qToolbar }
        });
      } else {
        // Rebind toolbar module to the current toolbar, if needed
        // Quill doesn't support reconfiguring modules; but since we keep the
        // same qToolbar node across opens, the instance remains valid.
        // Ensure focus is not on a detached node.
      }
      const q = window.__rtxModalQuill;
      // Set content
      q.setContents([]); // clear delta
      q.root.innerHTML = initialHtml || '';
      loadingEl.style.display = 'none';
      requestAnimationFrame(()=> q && q.focus());
    })();

    return p;
  };

  // No change needed to renderRichtextCell; just ensure it's defined.
  if (typeof window.renderRichtextCell !== 'function') {
    window.renderRichtextCell = function(hostEl, rowObj, colDef, { onChange } = {}){
      hostEl.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'rtx-cellwrap';
      const preview = document.createElement('div');
      preview.className = 'rtx-preview';
      const safe = (window.rtxSafeHTML || ((h)=>h));
      preview.innerHTML = safe(rowObj[colDef.key] || '<div style="opacity:.6">— empty —</div>');
      const btn = document.createElement('button'); btn.type='button'; btn.type='button';
      btn.type = 'button'; btn.className = 'rtx-edit-btn'; btn.textContent = 'Edit rich text…';
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const html = await window.rtxOpenModal(rowObj[colDef.key] || '', { title: colDef.label || colDef.key });
        if (html !== null) {
          rowObj[colDef.key] = html; preview.innerHTML = safe(html); onChange && onChange(html);
        }
      });
      wrap.appendChild(preview); wrap.appendChild(btn); hostEl.appendChild(wrap);
    }
  }
})();
</script>
<!-- OVERRIDE V3: fix 'False' typo, avoid rebuilding toolbar when singleton exists, use dangerouslyPasteHTML -->
<script>
(function(){
  if (window.__rtxModalPatchedV3) return;
  window.__rtxModalPatchedV3 = true;

  function buildToolbar(container){
    container.classList.add('ql-toolbar','ql-snow');
    container.innerHTML = ''
      + '<span class="ql-formats">'
      + '  <select class="ql-header">'
      + '    <option selected>Normal</option>'
      + '    <option value="1">Heading 1</option>'
      + '    <option value="2">Heading 2</option>'
      + '    <option value="3">Heading 3</option>'
      + '  </select>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-bold"></button>'
      + '  <button class="ql-italic"></button>'
      + '  <button class="ql-underline"></button>'
      + '  <button class="ql-strike"></button>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-list" value="ordered"></button>'
      + '  <button class="ql-list" value="bullet"></button>'
      + '  <button class="ql-align" value=""></button>'
      + '  <button class="ql-align" value="center"></button>'
      + '  <button class="ql-align" value="right"></button>'
      + '  <button class="ql-align" value="justify"></button>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-link"></button>'
      + '  <button class="ql-blockquote"></button>'
      + '  <button class="ql-code-block"></button>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <select class="ql-color"></select>'
      + '  <select class="ql-background"></select>'
      + '</span>'
      + '<span class="ql-formats">'
      + '  <button class="ql-clean"></button>'
      + '</span>';
  }

  window.rtxOpenModal = function rtxOpenModal(initialHtml, { title = 'Edit rich text' } = {}) {
    const root = document.getElementById('rtx-modal-root');
    const qToolbar = root.querySelector('.rtx-toolbar');
    const qEditor  = root.querySelector('.rtx-editor');
    const btnX  = root.querySelector('.rtx-close');
    const btnCancel = root.querySelector('.rtx-cancel');
    const btnSave   = root.querySelector('.rtx-save');
    const loadingEl = root.querySelector('.rtx-loading');
    root.querySelector('#rtx-modal-title').textContent = title;

    // Remove stray toolbars from older versions (defensive)
    root.querySelectorAll('.ql-toolbar').forEach(tb => {
      if (tb !== qToolbar) tb.remove();
    });

    // Prepare DOM
    loadingEl.style.display = 'block';
    root.classList.remove('rtx-hidden');

    let resolved = false;

    const teardown = () => {
      root.classList.add('rtx-hidden');
      loadingEl.style.display = 'none';
      btnX.removeEventListener('click', onCancel);
      btnCancel.removeEventListener('click', onCancel);
      btnSave.removeEventListener('click', onSave);
      root.removeEventListener('click', onBackdrop);
      document.removeEventListener('keydown', onKey);
    };

    const onKey = (e) => { if (e.key === 'Escape') onCancel(); };
    const onBackdrop = (e) => { if (e.target === root || e.target.classList.contains('rtx-backdrop')) onCancel(); };
    const onCancel = () => {
      if (resolved) return;
      resolved = true; teardown(); resolver(null);
    };
    const onSave = () => {
      if (resolved) return;
      resolved = true;
      const q = window.__rtxModalQuill;
      const html = q ? q.root.innerHTML : qEditor.innerHTML;
      teardown(); resolver(html);
    };

    btnX.addEventListener('click', onCancel);
    btnCancel.addEventListener('click', onCancel);
    btnSave.addEventListener('click', onSave);
    root.addEventListener('click', onBackdrop);
    document.addEventListener('keydown', onKey);

    let resolver;
    const p = new Promise((r)=> resolver = r);

    (async () => {
      await window.QuillReady;
      if (!window.Quill) {
        // Fallback: plain contenteditable (no Quill)
        qEditor.contentEditable = 'true';
        qEditor.innerHTML = (window.rtxSafeHTML ? window.rtxSafeHTML(initialHtml || '') : (initialHtml || ''));
        loadingEl.style.display = 'none';
        qEditor.focus();
        return;
      }

      // First-time init: build toolbar & instantiate Quill
      if (!window.__rtxModalQuill) {
        // Build toolbar markup ONCE (do not rebuild on subsequent opens)
        qToolbar.innerHTML = '';
        buildToolbar(qToolbar);
        window.__rtxModalQuill = new Quill(qEditor, {
          theme: 'snow',
          modules: { toolbar: qToolbar }
        });
      }

      // Set content on each open
      const q = window.__rtxModalQuill;
      if (typeof q.clipboard?.dangerouslyPasteHTML === 'function') {
        q.clipboard.dangerouslyPasteHTML(initialHtml || '');
      } else {
        q.root.innerHTML = initialHtml || '';
      }

      loadingEl.style.display = 'none';
      requestAnimationFrame(()=> q && q.focus());
    })();

    return p;
  };
})();
</script>
<script id="sig-modal-js">
(function(){
  function openSignatureCellModal(initial, onSave){
    const supportsDialog = typeof HTMLDialogElement !== 'undefined' && 'showModal' in HTMLDialogElement.prototype;
    let root, card, canvas, ctx, color, width, clear, save, cancel, x, ro, _prevOverflow;

    function createUI(){
      if (supportsDialog){
        root = document.createElement('dialog');
        root.className = 'sig-modal';
        root.setAttribute('role','dialog'); root.setAttribute('aria-modal','true');
      }else{
        root = document.createElement('div');
        root.className = 'sig-modal';
      }
      card = document.createElement('div'); card.className='sig-card';
      const head=document.createElement('div'); head.className='sig-head';
      const ttl=document.createElement('div'); ttl.textContent='Draw signature';
      x=document.createElement('button'); x.type='button'; x.className='btn ghost'; x.textContent='✕';
      head.append(ttl,x);

      const body=document.createElement('div'); body.className='sig-body';
      canvas=document.createElement('canvas'); canvas.className='sig-canvas';
      const tools=document.createElement('div'); tools.className='sig-tools';
      color=document.createElement('input'); color.type='color'; color.value='#111827';
      width=document.createElement('input'); width.type='number'; width.min='1'; width.max='12'; width.value='2';
      clear=document.createElement('button'); clear.type='button'; clear.className='btn ghost'; clear.textContent='Clear';
      const actions=document.createElement('div'); actions.className='sig-actions';
      save=document.createElement('button'); save.type='button'; save.className='btn'; save.textContent='Save';
      cancel=document.createElement('button'); cancel.type='button'; cancel.className='btn ghost'; cancel.textContent='Cancel';
      actions.append(cancel, save);
      tools.append('Ink', color, 'Width', width, clear);
      body.append(canvas, tools, actions);
      card.append(head, body); root.appendChild(card);
      document.body.appendChild(root);
    }

    function disableScroll(){ _prevOverflow = document.body.style.overflow; document.body.style.overflow = 'hidden'; }
    function enableScroll(){ document.body.style.overflow = _prevOverflow || ''; }

    function resize(){
      const r = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const w = Math.max(300, Math.floor(r.width * dpr));
      const h = Math.max(150, Math.floor(240 * dpr));
      if (canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      const cssScale = dpr;
      ctx.setTransform(cssScale, 0, 0, cssScale, 0, 0);
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      if(initial && /^data:image\//.test(String(initial))){
        try{
          const img=new Image();
          img.onload=()=>{
            // draw fit-to-canvas
            const cw = canvas.width/cssScale, ch = canvas.height/cssScale;
            const iw = img.width, ih = img.height;
            const scale = Math.min(cw/iw, ch/ih);
            const dw = iw*scale, dh = ih*scale;
            const dx = (cw-dw)/2, dy=(ch-dh)/2;
            ctx.drawImage(img, dx, dy, dw, dh);
          };
          img.src=initial;
        }catch(e){}
      }
    }

    function bindEvents(){
      const pos = (e)=>{
        const t=e.touches?e.touches[0]:e;
        const r=canvas.getBoundingClientRect();
        return {x: t.clientX - r.left, y: t.clientY - r.top};
      };
      let drawing=false, lx=0, ly=0;
      function start(e){ e.preventDefault(); drawing=true; const p=pos(e); lx=p.x; ly=p.y; }
      function move(e){ if(!drawing) return; const p=pos(e); ctx.strokeStyle=color.value; ctx.lineWidth=Number(width.value)||2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(p.x,p.y); ctx.stroke(); lx=p.x; ly=p.y; }
      function end(){ drawing=false; }
      canvas.addEventListener('pointerdown', start);
      canvas.addEventListener('pointermove', move);
      window.addEventListener('pointerup', end);
      canvas.addEventListener('touchstart', start, {passive:false});
      canvas.addEventListener('touchmove', move, {passive:false});
      window.addEventListener('touchend', end);

      clear.onclick=()=>{ const r=canvas.getBoundingClientRect(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,r.width,r.height); };
      cancel.onclick=close;
      x.onclick=close;
      save.onclick=()=>{ try{ const data = canvas.toDataURL('image/png'); onSave && onSave(data); }catch{} close(); };

      // close on ESC and backdrop
      root.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ e.preventDefault(); close(); } });
      if (! (root instanceof HTMLDialogElement)){
        // only for overlay fallback
        root.addEventListener('click',(e)=>{ if(e.target===root){ close(); } });
      }
    }

    function open(){
      if (root instanceof HTMLDialogElement){
        try{ root.showModal(); }catch{ /* already open */ }
      }else{
        root.style.display='flex';
      }
      try{ root.focus(); }catch{}
      disableScroll();
      setTimeout(resize, 0);
    }

    function close(){
      try{
        if (ro) ro.disconnect();
        if (root instanceof HTMLDialogElement){ root.close(); }
      }catch{}
      enableScroll();
      try{ root.remove(); }catch{}
      window.removeEventListener('pointerup', ()=>{});
      window.removeEventListener('touchend', ()=>{});
    }

    // init
    createUI();
    ctx = canvas.getContext('2d');
    ro = new ResizeObserver(resize); ro.observe(canvas);
    resize(); // immediate
    bindEvents();
    open();
  }

  // Expose globally
  try{ window.openSignatureCellModal = openSignatureCellModal; }catch{}
})();
</script>
<script>
function stripHtmlToText(html){
  try{
    if(html==null) return '';
    const div = document.createElement('div');
    div.innerHTML = String(html);
    const txt = (div.textContent || div.innerText || '').replace(/\s+/g,' ').trim();
    return txt;
  }catch{ return String(html||''); }
}
</script>
<script>
// Inspector: don't close when interacting with inputs/textareas/selects/contenteditable
(function(){
  const insp = document.getElementById('inspector') || document.querySelector('.inspector') || document.getElementById('inspectorPane') || document.querySelector('#inspectorPane');
  if(!insp) return;
  function isEditable(el){ return el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]')); }
  function onDown(e){
    if(!insp.classList || !insp.classList.contains('open')) return;
    if(isEditable(e.target)) return;
    // Let existing handlers decide; this script only guards editable interactions.
  }
  document.addEventListener('mousedown', onDown, true);
  document.addEventListener('touchstart', onDown, {capture:true, passive:true});
})();
</script>
<script>
// V4: Coalesced render (rAF) + minimal restore to eliminate flicker while typing
(function(){
  if (window.__focusSafeRenderV4) return;
  window.__focusSafeRenderV4 = true;

  // Shadow cache for values (by id & name)
  window.__valueCache = window.__valueCache || { byId: {}, byName: {} };

  // IME guard
  window.__imeComposing = !!window.__imeComposing;
  document.addEventListener('compositionstart', function(){ window.__imeComposing = true; }, true);
  document.addEventListener('compositionend', function(){ window.__imeComposing = false; if (window.__queuedRAFRender) window.__queuedRAFRender(); }, true);

  function isTexty(el){ return el && ((/^(INPUT|TEXTAREA)$/).test(el.tagName) || el.isContentEditable); }
  function ensureStableId(el){
    if (!el) return '';
    if (!el.id){ el.id = '__af_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); el.setAttribute('data-auto-id','1'); }
    return el.id;
  }
  function getVal(el){
    if (!el) return null;
    if (el.isContentEditable) return el.innerHTML;
    if (el.tagName==='INPUT' || el.tagName==='TEXTAREA') return el.value;
    return null;
  }
  function setVal(el, v){
    if (!el || v==null) return;
    if (el.isContentEditable){ if (el.innerHTML!==v) el.innerHTML = v; return; }
    if (el.tagName==='INPUT' || el.tagName==='TEXTAREA'){ if (el.value!==v) el.value = v; return; }
  }
  function cacheWrite(el, v){
    if (!el) return;
    const id = el.id || '';
    const nm = el.getAttribute && el.getAttribute('name') || '';
    if (id) window.__valueCache.byId[id] = v;
    if (nm) window.__valueCache.byName[nm] = v;
  }
  function cacheReadByIdOrName(id, nm){
    if (id && Object.prototype.hasOwnProperty.call(window.__valueCache.byId, id)) return window.__valueCache.byId[id];
    if (nm && Object.prototype.hasOwnProperty.call(window.__valueCache.byName, nm)) return window.__valueCache.byName[nm];
    return null;
  }

  // Keep cache in sync while user types & when blur occurs
  function onInputLike(e){
    const el = e.target;
    if (!isTexty(el)) return;
    cacheWrite(el, getVal(el));
  }
  document.addEventListener('input', onInputLike, true);
  document.addEventListener('change', onInputLike, true);
  document.addEventListener('blur', onInputLike, true);

  if (typeof window.render !== 'function') return;
  const _render = window.render;

  let scheduled = false;
  let lastArgs = null;

  function doRender(){
    scheduled = false;
    // Defer during composition
    if (window.__imeComposing){ window.__queuedRAFRender = scheduleRender; return; }

    // Capture focused field state
    const a = document.activeElement;
    const texty = isTexty(a);
    const keepId = texty ? ensureStableId(a) : '';
    const keepName = texty ? (a.getAttribute && a.getAttribute('name') || '') : '';
    const selStart = texty && typeof a.selectionStart==='number' ? a.selectionStart : null;
    const selEnd   = texty && typeof a.selectionEnd==='number' ? a.selectionEnd   : null;
    const typedVal = texty ? getVal(a) : null;
    if (texty) cacheWrite(a, typedVal);

    // Render once per frame
    try { _render.apply(this, lastArgs || []); } catch(e){}

    // Restore minimal state without forcing extra focus/selection if already correct
    let next = keepId ? document.getElementById(keepId) : null;
    if (!next && keepName) next = document.querySelector('[name="' + CSS.escape(keepName) + '"]');
    if (next){
      try{
        const afterVal = getVal(next);
        const cached = (typedVal != null) ? typedVal : cacheReadByIdOrName(keepId, keepName);
        if (cached != null && afterVal !== cached){
          setVal(next, cached);
        }
        if (next !== document.activeElement){
          try { next.focus(); } catch{}
        }
        if (selStart!=null && selEnd!=null && typeof next.setSelectionRange==='function'){
          const curS = typeof next.selectionStart==='number' ? next.selectionStart : null;
          const curE = typeof next.selectionEnd==='number' ? next.selectionEnd : null;
          if (curS!==selStart || curE!==selEnd){
            next.setSelectionRange(selStart, selEnd);
          }
        }
      }catch(e){}
    }
  }

  function scheduleRender(){
    if (scheduled) return;
    scheduled = true;
    window.requestAnimationFrame(doRender);
  }

  window.render = function(){
    lastArgs = arguments;
    scheduleRender();
  };
})();
</script>
<script>
(function(){
  let t;
  function onType(){ 
    document.documentElement.classList.add('typing'); 
    clearTimeout(t); 
    t = setTimeout(()=>document.documentElement.classList.remove('typing'), 160);
  }
  document.addEventListener('input', onType, true);
})();
</script>
<script>
// buildControl wrapper: ensure text inputs keep their value in the model (fd.default)
(function(){
  if (window.__bcSyncWrapped) return;
  window.__bcSyncWrapped = true;

  var __orig_buildControl = window.buildControl;
  if (typeof __orig_buildControl !== 'function') return;

  function isTextLikeType(t){
    t = String(t||'').toLowerCase();
    return ['text','email','url','tel','password','search','number'].includes(t);
  }

  function attachSync(el, fd){
    try{
      if(!el) return;
      var node = (el.matches && el.matches('input, textarea, [contenteditable="true"]')) ? el : el.querySelector && el.querySelector('input, textarea, [contenteditable="true"]');
      if(!node) return;

      var isCE = !!node.isContentEditable;
      var tag = node.tagName || '';
      var type = (tag === 'INPUT') ? (node.type||'text').toLowerCase() : (isCE ? 'contenteditable' : (tag === 'TEXTAREA' ? 'textarea' : ''));

      // Only sync plain text-like inputs and textareas (skip date/color/range)
      if (tag === 'INPUT' && !isTextLikeType(type)) return;

      // Seed from model/default when available
      if (fd && typeof fd === 'object'){
        var seed = (fd.default != null) ? fd.default : null;
        if (seed != null && seed !== ''){
          if (isCE) { if (node.innerHTML !== seed) node.innerHTML = seed; }
          else { if (node.value !== seed) node.value = seed; }
        }
      }

      function push(){
        try{
          if (!fd || typeof fd !== 'object') return;
          var v = isCE ? node.innerHTML : node.value;
          fd.default = v; // keep simple text values in default so rebuilds persist them
        }catch(e){}
      }
      node.addEventListener('input', push, true);
      node.addEventListener('blur', push, true);
    }catch(e){}
  }

  window.buildControl = function(fd){
    var el = __orig_buildControl.call(this, fd);
    try{ attachSync(el, fd); }catch(e){}
    return el;
  };
})();
</script>
<script>
(function(){
  // Late, defensive binding so we don't race DOM construction
  function init(){
    try{
      var box = document.getElementById('logoBox');
      var btn = document.getElementById('logoBtn');
      var onKey = function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openLogoPicker && openLogoPicker(); } };
      if(box){
        box.addEventListener('click', function(){ if(window.demoMode){ toast && toast('Demo mode: logo editing is disabled'); return; } openLogoPicker && openLogoPicker(); });
        box.addEventListener('keydown', onKey);
      }
      if(btn){
        btn.addEventListener('click', function(){ if(window.demoMode){ toast && toast('Demo mode: logo editing is disabled'); return; } openLogoPicker && openLogoPicker(); });
        btn.addEventListener('keydown', onKey);
      }
    }catch(e){ console.warn('logo binding (safe) failed', e); }
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
})();
</script>
<style>
  /* Logo Generator Modal */
  #logoGen.backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; z-index: 1000; }
  #logoGen.backdrop.open { display:block; }
  #logoGen .panel { position:absolute; top:50%; left:50%; transform: translate(-50%, -50%);
    width: min(880px, 96vw); max-height: 86vh; overflow:auto; background: var(--panel, #0b1220);
    color: var(--text, #e5e7eb); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.35); }
  #logoGen .head { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); }
  #logoGen .head h3 { margin:0; font-size:18px; }
  #logoGen .body { display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px; }
  #logoGen .controls { display:grid; gap:12px; }
  #logoGen label { font-size:12px; opacity:.9; display:block; margin-bottom:6px; }
  #logoGen input[type="text"], #logoGen select, #logoGen input[type="number"] { width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04); color:inherit; }
  #logoGen input[type="color"] { width:48px; height:32px; padding:0; border:0; background:transparent; }
  #logoGen .row { display:flex; gap:10px; align-items:center; }
  #logoGen .row > * { flex:1; }
  #logoGen .preview { display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,.03); border-radius:12px; min-height:300px; }
  #logoGen .actions { display:flex; flex-wrap:wrap; gap:10px; padding:12px 16px 16px; border-top:1px solid rgba(255,255,255,.06); }
  #logoGen .btn { padding:8px 12px; border-radius:10px; background: rgba(255,255,255,.08); color:inherit; border:1px solid rgba(255,255,255,.08); cursor:pointer; }
  #logoGen .btn.primary { background: var(--accent, #1d4ed8); border-color: var(--accent, #1d4ed8); color:white; }
  #logoGen .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
  @media (max-width: 720px){
    #logoGen .body { grid-template-columns: 1fr; }
  }
</style>
<div aria-hidden="true" aria-labelledby="lgTitle" aria-modal="true" class="backdrop" id="logoGen" role="dialog">
<div class="panel">
<div class="head">
<h3 id="lgTitle">Logo Generator</h3>
<button aria-label="Close" class="btn" id="lgClose">✖</button>
</div>
<div class="body">
<div class="controls">
<div class="row">
<div>
<label>Initials</label>
<input id="lgText" maxlength="3" placeholder="e.g., EQ" type="text"/>
</div>
<div>
<label>Template</label>
<select id="lgTemplate">
<option value="circle">Circle Badge</option>
<option value="rounded">Rounded Square</option>
<option value="hex">Hex</option>
<option value="shield">Shield</option>
<option value="bolt">Bolt</option>
<option value="wave">Wave</option>
<option value="atom">Atom</option>
</select>
</div>
</div>
<div class="row">
<div>
<label>Gradient Start</label>
<input id="lgC1" type="color" value="#3b82f6"/>
</div>
<div>
<label>Gradient End</label>
<input id="lgC2" type="color" value="#22d3ee"/>
</div>
</div>
<div class="row">
<div>
<label>Text Size</label>
<input id="lgSize" max="28" min="12" type="number" value="20"/>
</div>
<div>
<label>Stroke (some templates)</label>
<input id="lgStroke" max="6" min="0" type="number" value="2"/>
</div>
</div>
<div class="row">
<button class="btn" id="lgRandom">🎲 Randomize</button>
<button class="btn" id="lgShuffle">🔁 Shuffle Template</button>
<button class="btn" id="lgRegen">⚡ Regenerate</button>
</div>
</div>
<div aria-label="Logo preview" class="preview" id="lgPreview">
<!-- SVG renders here -->
</div>
</div>
<div class="actions">
<button class="btn" id="lgAddPicker">Add to Picker</button>
<button class="btn" id="lgSetCurrent">Set as Current</button>
<button class="btn" id="lgDownloadSvg">Download SVG</button>
<button class="btn" id="lgDownloadPng">Download PNG</button>
<span style="flex:1"></span>
<button class="btn primary" id="lgDone">Done</button>
</div>
</div>
</div>
<script>
(function(){
  // State
  let LG = { text:'EQ', tpl:'circle', c1:'#3b82f6', c2:'#22d3ee', size:20, stroke:2 };

  // Utilities
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function esc(s){ return String(s||'').replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s])); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function randHex(){ return '#'+Array.from(crypto.getRandomValues(new Uint8Array(3))).map(x=>x.toString(16).padStart(2,'0')).join(''); }

  function buildSVG(o){
    const id = 'gLG_'+Math.random().toString(36).slice(2);
    const text = esc((o.text||'').slice(0,3).toUpperCase());
    const s = clamp(+o.size||20, 12, 28);
    const sw = clamp(+o.stroke||0, 0, 6);
    const c1 = o.c1 || '#3b82f6';
    const c2 = o.c2 || '#22d3ee';

    let shape='';
    if(o.tpl==='circle'){
      shape = `<circle cx="32" cy="32" r="22" fill="url(#${id})"/>`;
    } else if(o.tpl==='rounded'){
      shape = `<rect x="10" y="10" width="44" height="44" rx="12" fill="url(#${id})"/>`;
    } else if(o.tpl==='hex'){
      shape = `<path d="M32 8 L52 20 V44 L32 56 L12 44 V20 Z" fill="url(#${id})"/>`;
    } else if(o.tpl==='shield'){
      shape = `<path d="M32 8 L52 14 V30 C52 42 43 52 32 56 C21 52 12 42 12 30 V14 Z" fill="url(#${id})"/>`;
    } else if(o.tpl==='bolt'){
      shape = `<path d="M36 6 L14 36 H30 L26 58 L50 28 H34 Z" fill="url(#${id})"/>`;
    } else if(o.tpl==='wave'){
      shape = `<path d="M8 40 Q16 32 24 36 T40 36 T56 32 L56 56 H8 Z" fill="url(#${id})"/>`;
    } else if(o.tpl==='atom'){
      shape = `<circle cx="32" cy="32" r="5" fill="white" opacity=".9"/>` +
              `<ellipse cx="32" cy="32" rx="22" ry="12" fill="none" stroke="url(#${id})" stroke-width="${sw||2}"/>` +
              `<ellipse cx="32" cy="32" rx="12" ry="22" fill="none" stroke="url(#${id})" stroke-width="${sw||2}" transform="rotate(45 32 32)"/>` +
              `<ellipse cx="32" cy="32" rx="12" ry="22" fill="none" stroke="url(#${id})" stroke-width="${sw||2}" transform="rotate(-45 32 32)"/>`;
    } else {
      shape = `<rect x="10" y="10" width="44" height="44" rx="12" fill="url(#${id})"/>`;
    }

    const textEl = text ? `<text x="32" y="38" text-anchor="middle" font-size="${s}" font-weight="700" fill="white" font-family="ui-sans-serif, system-ui, -apple-system">`+text+`</text>` : '';
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
<defs><linearGradient id="${id}" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="${c1}"/><stop offset="1" stop-color="${c2}"/></linearGradient></defs>
${shape}
${textEl}
</svg>`;
  }

  function render(){
    const p = document.getElementById('lgPreview');
    if(!p) return;
    p.innerHTML = buildSVG(LG);
  }

  // Export functions
  function download(filename, content, mime){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }
  function toPng(svgString, cb){
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement('canvas');
      canvas.width = 512; canvas.height = 512;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,512,512);
      ctx.drawImage(img, 0, 0, 512, 512);
      canvas.toBlob(b=>cb(b), 'image/png', 0.95);
    };
    img.onerror = ()=>{ cb(null); };
    const svg64 = btoa(unescape(encodeURIComponent(svgString)));
    img.src = 'data:image/svg+xml;base64,'+svg64;
  }

  function openLogoGen(){
    const back = document.getElementById('logoGen');
    if(!back) return;
    back.classList.add('open'); back.setAttribute('aria-hidden','false');
    render();
    try{ document.getElementById('lgText').focus(); }catch(_){}
  }
  function closeLogoGen(){
    const back = document.getElementById('logoGen');
    if(!back) return;
    back.classList.remove('open'); back.setAttribute('aria-hidden','true');
  }

  // Wire controls
  function wireLogoGenOnce(){
    if(window.__wiredLogoGen) return;
    window.__wiredLogoGen = true;
    const Q = id=>document.getElementById(id);

    ['lgText','lgTemplate','lgC1','lgC2','lgSize','lgStroke'].forEach(id=>{
      const el = Q(id); if(!el) return;
      el.addEventListener('input', ()=>{
        if(id==='lgText') LG.text = el.value;
        if(id==='lgTemplate') LG.tpl = el.value;
        if(id==='lgC1') LG.c1 = el.value;
        if(id==='lgC2') LG.c2 = el.value;
        if(id==='lgSize') LG.size = +el.value || 20;
        if(id==='lgStroke') LG.stroke = +el.value || 2;
        render();
      });
    });

    Q('lgRandom').addEventListener('click', ()=>{
      LG.c1 = randHex(); LG.c2 = randHex(); LG.size = 16 + Math.floor(Math.random()*10);
      Q('lgC1').value = LG.c1; Q('lgC2').value = LG.c2; Q('lgSize').value = LG.size;
      render();
    });
    Q('lgShuffle').addEventListener('click', ()=>{
      const tpls = ['circle','rounded','hex','shield','bolt','wave','atom'];
      LG.tpl = pick(tpls); Q('lgTemplate').value = LG.tpl; render();
    });
    Q('lgRegen').addEventListener('click', render);
    Q('lgClose').addEventListener('click', closeLogoGen);
    Q('lgDone').addEventListener('click', closeLogoGen);

    Q('lgAddPicker').addEventListener('click', ()=>{
      const svg = buildSVG(LG);
      try{
        if(window.GENERIC_LOGOS && Array.isArray(GENERIC_LOGOS)){
          GENERIC_LOGOS.unshift(svg);
        }
        if(window.filteredLogos && Array.isArray(filteredLogos)){
          filteredLogos.unshift(svg);
        }
        if(typeof paintLogoGrid==='function'){ paintLogoGrid(); }
        if(typeof lpBig!=='undefined'){ lpBig.innerHTML = svg; }
        if(window.toast) toast('Added to picker');
      }catch(e){ console.warn(e); }
    });

    Q('lgSetCurrent').addEventListener('click', ()=>{
      const svg = buildSVG(LG);
      const box = document.getElementById('logoBox');
      if(window.demoMode){ window.toast && toast('Demo mode: applying is disabled'); return; }
      if(box){ box.innerHTML = svg; box.dataset.version = String(Date.now()); window.toast && toast('Logo updated'); }
    });

    Q('lgDownloadSvg').addEventListener('click', ()=>{
      const svg = buildSVG(LG);
      download('logo.svg', svg, 'image/svg+xml');
    });

    Q('lgDownloadPng').addEventListener('click', ()=>{
      const svg = buildSVG(LG);
      toPng(svg, blob=>{
        if(!blob){ window.toast && toast('PNG export failed'); return; }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'logo.png';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      });
    });

    // Esc to close
    document.addEventListener('keydown', (e)=>{
      const back = document.getElementById('logoGen');
      if(!back || !back.classList.contains('open')) return;
      if(e.key==='Escape'){ e.preventDefault(); closeLogoGen(); }
    });
  }

  // Add "Generate" button into the logo picker header if present
  function injectGenButton(){
    try{
      const picker = document.getElementById('logoPicker');
      if(!picker) return;
      let header = picker.querySelector('.lp-head, .head, .toolbar'); // best-effort
      if(!header){
        // create a simple header row if none
        header = document.createElement('div');
        header.className = 'head';
        picker.insertBefore(header, picker.firstChild);
      }
      if(!picker.querySelector('#lpGenBtn')){
        const btn = document.createElement('button'); btn.type='button'; btn.type='button';
        btn.id = 'lpGenBtn'; btn.className = 'btn soft'; btn.type='button';
        btn.textContent = 'Generate';
        btn.style.marginLeft = '8px';
        btn.addEventListener('click', ()=>{ wireLogoGenOnce(); openLogoGen(); });
        header.appendChild(btn);
      }
    }catch(e){ console.warn('injectGenButton failed', e); }
  }

  // Initialize after DOM ready
  function initLG(){
    wireLogoGenOnce();
    injectGenButton();
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', initLG);
  } else {
    initLG();
  }

  // Expose tiny API (optional)
  window.openLogoGen = function(){ wireLogoGenOnce(); openLogoGen(); };
})();
</script>
<style>
/* --- Logo Generator: White Mode Overrides --- */
#logoGen .panel {
  background: #ffffff !important;
  color: #111827 !important; /* slate-900 */
  border: 1px solid #e5e7eb; /* gray-200 */
}
#logoGen .head { border-bottom: 1px solid #e5e7eb !important; }
#logoGen .body { background: #ffffff !important; }
#logoGen label { color: #374151 !important; } /* gray-700 */

#logoGen input[type="text"],
#logoGen select,
#logoGen input[type="number"] {
  background: #ffffff !important;
  color: #111827 !important;
  border: 1px solid #e5e7eb !important;
  box-shadow: 0 1px 2px rgba(0,0,0,.04);
}
#logoGen input[type="text"]:focus,
#logoGen select:focus,
#logoGen input[type="number"]:focus {
  outline: 2px solid #2563eb; /* blue-600 */
  outline-offset: 1px;
  border-color: #2563eb !important;
}

#logoGen .preview {
  background: #f8fafc !important; /* slate-50 */
  border: 1px dashed #e5e7eb;
}

#logoGen .actions { border-top: 1px solid #e5e7eb !important; }

#logoGen .btn {
  background: #f3f4f6 !important; /* gray-100 */
  color: #111827 !important;
  border: 1px solid #e5e7eb !important;
}
#logoGen .btn:hover { background: #e5e7eb !important; }
#logoGen .btn.primary {
  background: #1d4ed8 !important; /* blue-700 */
  border-color: #1d4ed8 !important;
  color: #ffffff !important;
}
#logoGen .btn.primary:hover { background: #1e40af !important; } /* blue-800 */

#logoGen .backdrop { /* keep backdrop the same for contrast */ }
</style>
<script>
(function(){
  // Idempotent define
  if (!window.updatePlaceholderLive) {
    window.updatePlaceholderLive = function(nodeId, value){
      try{
        var host = document.querySelector('.fcard[data-nid="'+nodeId+'"]') || document.querySelector('[data-nid="'+nodeId+'"]');
        if(!host) return;
        // Inputs / textareas
        var input = host.querySelector('input, textarea');
        if (input) {
          // text, number, date/time types
          input.setAttribute('placeholder', value || '');
        }
        // Select/Dropdown: ensure leading placeholder option
        var sel = host.querySelector('select');
        if (sel) {
          // find existing placeholder option by data-role
          var ph = sel.querySelector('option[data-role="placeholder"]');
          if (!value) {
            // remove placeholder option if any
            if (ph) ph.remove();
          } else {
            if (!ph) {
              ph = document.createElement('option');
              ph.setAttribute('data-role', 'placeholder');
              ph.value = "";
              ph.disabled = true;
              ph.selected = true;
              sel.insertBefore(ph, sel.firstChild);
            }
            ph.textContent = value;
          }
        }
        // Quill rich-text: set placeholder on .ql-editor if present
        var ql = host.querySelector('.ql-editor');
        if (ql) {
          if (value) ql.setAttribute('data-placeholder', value);
          else ql.removeAttribute('data-placeholder');
        }
      }catch(e){ /* no-op */ }
    };
  }
})();
</script>
<script>
(function(){
  if (!window.__placeholderLiveBound) {
    window.__placeholderLiveBound = true;
    document.addEventListener('input', function(evt){
      var t = evt.target;
      if (!t) return;
      var key = (t.name||t.getAttribute('data-key')||'').toLowerCase();
      if (key==='placeholder') {
        // Try to resolve node id from context
        var nEl = t.closest('[data-nid]');
        var nid = nEl ? nEl.getAttribute('data-nid') : null;
        // fallback: inspector stores current node id in a field?
        if (!nid && window.current && current.id) nid = current.id;
        if (nid) updatePlaceholderLive(nid, t.value);
      }
    }, true);
  }
})();
</script>
<script id="demo-richtext-reimpl">
(function(){
  // Keep original
  var __origBuildControl = window.buildControl;
  if (typeof __origBuildControl !== 'function') return;

  function demoRichText(fd){
    // Container
    var wrap = document.createElement('div');
    wrap.className = 'richtext-field';
    wrap.id = 'f_'+fd.id;
    wrap.style.width = '100%';

    var host = document.createElement('div');
    host.className = 'ql-host';
    host.style.width = '100%';

    // Toolbar (full, including color/background)
    var toolbar = document.createElement('div');
    toolbar.className = 'ql-toolbar ql-snow';
    toolbar.innerHTML = [
      '<span class="ql-formats">',
        '<select class="ql-header"><option value="1"></option><option value="2"></option><option selected></option></select>',
      '</span>',
      '<span class="ql-formats">',
        '<button type="button" class="ql-bold"></button>',
        '<button type="button" class="ql-italic"></button>',
        '<button type="button" class="ql-underline"></button>',
        '<button type="button" class="ql-strike"></button>',
      '</span>',
      '<span class="ql-formats">',
        '<select class="ql-color"></select>',
        '<select class="ql-background"></select>',
      '</span>',
      '<span class="ql-formats">',
        '<button type="button" class="ql-blockquote"></button>',
        '<button type="button" class="ql-code-block"></button>',
      '</span>',
      '<span class="ql-formats">',
        '<button type="button" class="ql-list" value="ordered"></button>',
        '<button type="button" class="ql-list" value="bullet"></button>',
        '<button type="button" class="ql-indent" value="-1"></button>',
        '<button type="button" class="ql-indent" value="+1"></button>',
      '</span>',
      '<span class="ql-formats">',
        '<select class="ql-align"></select>',
      '</span>',
      '<span class="ql-formats">',
        '<button type="button" class="ql-link"></button>',
      '</span>',
      '<span class="ql-formats">',
        '<button type="button" class="ql-clean"></button>',
      '</span>'
    ].join('');

    var container = document.createElement('div');
    container.style.minHeight = '160px';
    container.setAttribute('aria-label','Rich Text');

    host.appendChild(toolbar);
    try{ host.style.position='relative'; host.style.zIndex='20'; }catch(_){}
    host.appendChild(container);
    wrap.appendChild(host);

    if (window.Quill) {
      try {
        var quill = new Quill(container, {
          theme: 'snow',
          modules: { toolbar: toolbar },
          // Explicit formats to ensure color/bg work
          formats: ['header','bold','italic','underline','strike','blockquote','code-block',
                    'list','bullet','indent','link','color','background','align','clean']
        });
        try{ quill.root.style.minHeight = '120px'; }catch(_){}
        // Ensure interactive in Demo mode
        try{ quill.enable(true); quill.root && quill.root.setAttribute('contenteditable','true'); }catch(_){}

        // Focus editor when toolbar is used (so formats apply)
        try{
          ['pointerdown','mousedown','click','touchstart'].forEach(function(ev){
            toolbar.addEventListener(ev, function(){ try{ quill.focus(); }catch(_){} }, {capture:true});
          });
        }catch(_){}

        // Seed content from fd
        var seeded = false;
        try{
          if (fd && fd.valueDelta) { quill.setContents(fd.valueDelta); seeded = true; }
        }catch(_){}
        if (!seeded) {
          try{
            if (fd && fd.valueHtml) { quill.clipboard.dangerouslyPasteHTML(fd.valueHtml); seeded = true; }
          }catch(_){}
        }
        if (!seeded && typeof fd?.default === 'string') {
          try{ quill.setText(fd.default); }catch(_){}
        }

        // Persist back into fd so switching modes keeps edits
        try{
          quill.on('text-change', function(){
            try{
              fd.valueDelta = quill.getContents();
              fd.valueHtml  = quill.root.innerHTML;
            }catch(_){}
          });
        }catch(_){}

        // Guard: if something (other code) toggles contenteditable=false, re-enable
        try{
          var mo = new MutationObserver(function(){
            try{
              if (quill && quill.root && quill.root.getAttribute('contenteditable') !== 'true') {
                quill.enable(true);
                quill.root.setAttribute('contenteditable','true');
              }
            }catch(_){}
          });
          mo.observe(quill.root, { attributes:true, attributeFilter:['contenteditable'] });
        }catch(_){}
      } catch(e) {
        // Quill failed, fallback view (sanitized HTML)
        var view = document.createElement('div');
        view.className = 'ql-editor';
        var html = (fd && fd.valueHtml) || '';
        try{
          if (!html && fd && fd.valueDelta && Array.isArray(fd.valueDelta.ops)) {
            html = fd.valueDelta.ops.map(function(op){ return (typeof op.insert==='string' ? op.insert : ''); }).join('');
          }
        }catch(_){}
        try{ view.innerHTML = (window.DOMPurify ? DOMPurify.sanitize(html) : html); }catch(_){ view.innerHTML = html || ''; }
        wrap.appendChild(view);
      }
    } else {
      // No Quill loaded: plain, sanitized view
      var v = document.createElement('div');
      v.className = 'ql-editor';
      var h = (fd && fd.valueHtml) || '';
      try{ v.innerHTML = (window.DOMPurify ? DOMPurify.sanitize(h) : h); }catch(_){ v.innerHTML = h || ''; }
      wrap.appendChild(v);
    }

    return wrap;
  }

  window.buildControl = function(fd){
    try{
      var t = (fd && fd.ftype ? fd.ftype : 'text');
      t = (t || 'text').toLowerCase();
      var isDemo = document.body.classList.contains('demo-mode');
      if (t === 'richtext' && isDemo) {
        return demoRichText(fd);
      }
      // Otherwise, use original
      return __origBuildControl(fd);
    }catch(_){
      // On any error, fallback to original
      return __origBuildControl(fd);
    }
  };
})();
</script>
<script id="demo-submit-guard">
(function(){
  function isSubmitBtn(el){
    if(!el || !el.tagName) return false;
    var txt = (el.getAttribute('aria-label') || el.textContent || '').trim().toLowerCase();
    return el.type === 'submit' || el.classList.contains('submit') || el.getAttribute('data-role') === 'submit' || txt === 'submit';
  }
  function hardenButtons(root){
    var scope = root || document;
    var btns = scope.querySelectorAll('button');
    btns.forEach(function(b){
      if(!b.hasAttribute('type') || b.getAttribute('type') === ''){
        if(!isSubmitBtn(b)) b.type = 'button';
      }
    });
  }
  var allowSubmitUntil = 0;
  function markSubmitClick(){ allowSubmitUntil = Date.now() + 1000; }
  document.addEventListener('click', function(ev){
    try{
      var t = ev.target;
      if(t && t.tagName === 'BUTTON' && isSubmitBtn(t)) markSubmitClick();
    }catch(e){}
  }, true);
  document.addEventListener('submit', function(ev){
    try{
      if(window.demoMode){
        var s = ev.submitter;
        if(!(isSubmitBtn(s) && Date.now() <= allowSubmitUntil)){
          ev.preventDefault(); ev.stopImmediatePropagation(); return false;
        }
      }
    }catch(e){}
  }, true);
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ hardenButtons(document); }, {once:true});
  } else {
    hardenButtons(document);
  }
  try{
    var _render = window.render;
    if(typeof _render === 'function'){
      window.render = function(){
        var r = _render.apply(this, arguments);
        try{ hardenButtons(document); }catch(e){}
        return r;
      };
    }
  }catch(e){}
  try{
    var mo = new MutationObserver(function(muts){
      muts.forEach(function(m){
        m.addedNodes && m.addedNodes.forEach(function(node){
          if(node && node.querySelectorAll) hardenButtons(node);
        });
      });
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
<script id="enter-key-guard">
(function(){
  var form = document.getElementById('designerForm');
  if(!form) return;
  form.addEventListener('keydown', function(ev){
    if(!window.demoMode) return;
    if(ev.key !== 'Enter') return;
    // Allow Enter on textareas
    if(ev.target && ev.target.tagName === 'TEXTAREA') return;
    // Allow only if focused element is explicit submit
    function isSubmitEl(el){
      if(!el || !el.tagName) return false;
      var txt=(el.getAttribute('aria-label')||el.textContent||'').trim().toLowerCase();
      return el.type==='submit' || el.classList.contains('submit') || el.getAttribute('data-role')==='submit' || txt==='submit';
    }
    if(!isSubmitEl(ev.target)){
      ev.preventDefault();
      ev.stopPropagation();
      return false;
    }
  }, true);
})();
</script>
<script id="demo-global-enter-guard">
(function(){
  function isSubmitEl(el){
    if(!el || !el.tagName) return false;
    var txt=(el.getAttribute('aria-label')||el.textContent||'').trim().toLowerCase();
    return el.type==='submit' || el.classList.contains('submit') || el.getAttribute('data-role')==='submit' || txt==='submit';
  }
  document.addEventListener('keydown', function(ev){
    if(!window.demoMode) return;
    if(ev.key !== 'Enter') return;
    // Allow Enter in textareas/contenteditable fields
    var t = ev.target;
    var isEditable = (t && ((t.tagName==='TEXTAREA') || (t.isContentEditable===true)));
    if(isEditable) return;
    // If focused element isn't an explicit submit control, block default (prevents implicit form submit)
    if(!isSubmitEl(t)){
      ev.preventDefault();
      ev.stopPropagation();
      return false;
    }
  }, true);
})();
</script>
<style id="fieldpicker-enhanced-css">
:root { --fp-border:#e5e7eb; --fp-muted:#64748b; --fp-text:#0b1220; --fp-bg:#ffffff; --fp-surface:#ffffff; --fp-hover:#f8fafc; --fp-chip:#f1f5f9; --fp-chip-border:#e2e8f0; --fp-ring:#2563eb; }
.fp-root { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; padding: 24px; z-index: 2147483600; background: rgba(0,0,0,.18); }
.fp-root.open { display: flex; }
.fp-confirm { width: min(920px, 96vw); max-height: min(84vh, 900px); background: var(--fp-surface); color: var(--fp-text); border-radius: 14px; border: 1px solid var(--fp-border); box-shadow: 0 20px 55px rgba(15,23,42,.18); display: grid; grid-template-rows: auto auto 1fr auto; overflow: hidden; }
.fp-head { display: flex; align-items: center; gap: 10px; padding: 14px 16px; border-bottom: 1px solid var(--fp-border); }
.fp-head .icon { font-size: 20px; }
.fp-title { font-weight: 600; font-size: 16px; color: var(--fp-text); }
.fp-controls { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 10px 16px; background: #fff; border-bottom: 1px solid var(--fp-border); }
.fp-search { width: 100%; }
.fp-search .input { width: 100%; background: #fff; border: 1px solid var(--fp-border); color: var(--fp-text); border-radius: 10px; padding: 8px 10px; }
.fp-chips { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: flex-end; }
.fp-chip { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--fp-chip-border); background: var(--fp-chip); border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; user-select:none; color: var(--fp-text); }
.fp-chip[aria-pressed="true"] { background: var(--fp-hover); border-color: var(--fp-border); }
.fp-body { padding: 8px 16px 16px; overflow: auto; background: var(--fp-bg); }
.fp-section { margin-top: 12px; }
.fp-section h4 { margin: 10px 2px 8px; font-size: 12px; font-weight: 700; letter-spacing: .02em; color: var(--fp-muted); }
.fp-grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
@media (max-width: 780px){ .fp-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
.fp-card { position: relative; border: 1px solid var(--fp-border); border-radius: 12px; background: var(--fp-surface); text-align: left; padding: 10px; display: grid; grid-template-columns: auto 1fr; grid-template-rows: auto auto; gap: 6px 8px; cursor:pointer; transition: box-shadow .15s ease, border-color .15s ease, background .15s ease; }
.fp-card:hover { background: var(--fp-hover); border-color: #d1d5db; box-shadow: 0 6px 18px rgba(15,23,42,.08); }
.fp-card:focus { outline: 2px solid transparent; box-shadow: 0 0 0 3px rgba(37,99,235,.35); }
.fp-ico { grid-row: 1 / span 2; font-size: 20px; line-height: 1; }
.fp-name { font-weight: 700; font-size: 14px; color: var(--fp-text); }
.fp-desc { font-size: 12px; color: var(--fp-muted); }
.fp-star { position: absolute; top: 6px; right: 6px; border: 1px solid var(--fp-border); background: #fff; color: #f59e0b; border-radius: 999px; padding: 2px 6px; font-size: 13px; cursor: pointer; }
.fp-star[aria-pressed="true"] { background: #fff7ed; border-color: #f59e0b; }
.fp-foot { padding: 12px 16px; border-top: 1px solid var(--fp-border); display: flex; gap: 10px; justify-content: flex-end; background: #fff; }
.fp-btn { border: 1px solid var(--fp-border); background: #fff; color: var(--fp-text); border-radius: 10px; padding: 8px 12px; font-size: 13px; cursor: pointer; }
.fp-btn:hover { background: var(--fp-hover); }
</style>
<script id="fieldpicker-enhanced-js">
(function(){
  // Override/Enhance window.pickFieldType while preserving the same API (resolves to type string or null).
  // Features: search, chips (All/Most used/Favorites + categories), a11y dialog semantics, focus trap, favorites, usage tracking.
  const KEY_USAGE = 'fp_usage_v1';
  const KEY_FAVS  = 'fp_favs_v1';
  const KEY_LAST  = 'fp_last_v1';

  const TYPES = ['text','number','email','password','date','time','datetime','url','tel','textarea','dropdown','radio','multiselect','checkboxes','file','image','rating','divider','space','table','toggle','signature','richtext'];
  const ICONS = {'text':'🔤','number':'🔢','email':'✉️','password':'🔒','date':'📅','time':'⏰','datetime':'🗓️','url':'🔗','tel':'📞','textarea':'📝','dropdown':'▾','radio':'◉','multiselect':'⧉','checkboxes':'☑️','file':'📎','image':'🖼️','rating':'⭐','divider':'⎯','space':'⬚','table':'📊','toggle':'🎚️','signature':'✍️','richtext':'🅁'};
  const DESCS = {
    text:'Single-line text input',
    number:'Numeric input with min/max',
    email:'Email address field',
    password:'Obscured input',
    date:'Date picker',
    time:'Time picker',
    datetime:'Date & time picker',
    url:'Website link input',
    tel:'Phone number',
    textarea:'Multi-line text area',
    dropdown:'Single selection from list',
    radio:'Radio button group',
    multiselect:'Choose multiple from list',
    checkboxes:'Multiple checkboxes',
    file:'Upload a file',
    image:'Upload an image',
    rating:'Star rating',
    divider:'Horizontal separator',
    space:'Blank spacer',
    table:'Table field with columns',
    toggle:'On/Off switch',
    signature:'Signature capture',
    richtext:'Rich text editor'
  };

  const CATS = {
    'Inputs': ['text','textarea','number','email','tel','url','password'],
    'Selection': ['dropdown','radio','checkboxes','multiselect'],
    'Date/Time': ['date','time','datetime'],
    'Media': ['file','image','signature'],
    'Content': ['richtext'],
    'Layout': ['divider','space','table'],
    'Controls': ['toggle','rating']
  };

  function load(key, fallback){
    try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; }catch{ return fallback; }
  }
  function save(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
  }

  function incUsage(type){
    const usage = load(KEY_USAGE, {});
    usage[type] = (usage[type]||0) + 1;
    save(KEY_USAGE, usage);
  }
  function mostUsed(limit){
    const usage = load(KEY_USAGE, {});
    const arr = Object.keys(usage).map(k => ({type:k, n:usage[k]})).sort((a,b)=>b.n-a.n).map(x=>x.type);
    if(arr.length) return arr.slice(0, limit||6);
    // sensible defaults if no history
    return ['text','number','dropdown','date','checkboxes','radio'].slice(0, limit||6).filter(t => TYPES.includes(t));
  }
  function favs(){ return load(KEY_FAVS, []); }
  function toggleFav(type){
    const set = new Set(favs());
    if(set.has(type)) set.delete(type); else set.add(type);
    save(KEY_FAVS, Array.from(set));
    return Array.from(set);
  }

  // Build/ensure root
  function ensureRoot(){
    let root = document.getElementById('pickerRootEnhanced');
    if(!root){
      root = document.createElement('div');
      root.id = 'pickerRootEnhanced';
      root.className = 'fp-root';
      root.setAttribute('role','dialog');
      root.setAttribute('aria-modal','true');
      document.body.appendChild(root);
    }
    root.innerHTML = '';
    return root;
  }

  // Focus trap
  function trapFocusWithin(root){
    function onKey(ev){
      if(ev.key !== 'Tab') return;
      const focusables = Array.from(root.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')).filter(el => !el.disabled && el.offsetParent !== null);
      if(!focusables.length) return;
      const first = focusables[0], last = focusables[focusables.length-1];
      if(ev.shiftKey && document.activeElement===first){ ev.preventDefault(); last.focus(); }
      else if(!ev.shiftKey && document.activeElement===last){ ev.preventDefault(); first.focus(); }
    }
    root.addEventListener('keydown', onKey);
    return ()=> root.removeEventListener('keydown', onKey);
  }

  // New picker implementation
  window.pickFieldType = function(opts){
    if(window.__pickerOpen){ return Promise.resolve(null); }
    window.__pickerOpen = true;

    const last = load(KEY_LAST, {chip:'All', q:''});
    const trigger = document.activeElement;

    const root = ensureRoot();
    const box = document.createElement('div'); box.className = 'fp-confirm'; root.appendChild(box);

    // HEAD
    const head = document.createElement('div'); head.className = 'fp-head';
    const ic = document.createElement('div'); ic.className = 'icon'; ic.textContent = '➕';
    const title = document.createElement('div'); title.className = 'fp-title'; title.id='fieldpicker-title'; title.textContent = 'Add a new field';
    head.append(ic, title);

    // CONTROLS: search + chips
    const ctr = document.createElement('div'); ctr.className = 'fp-controls';
    const srchWrap = document.createElement('div'); srchWrap.className = 'fp-search';
    const input = document.createElement('input'); input.type='search'; input.className='input'; input.placeholder='Search fields…'; input.setAttribute('aria-label','Search fields'); input.value = last.q || '';
    srchWrap.appendChild(input);
    const chips = document.createElement('div'); chips.className = 'fp-chips';
    const chipDefs = ['All','Most used','Favorites','Inputs','Selection','Date/Time','Media','Content','Layout','Controls'];
    const chipEls = [];
    chipDefs.forEach(name=>{
      const ch = document.createElement('button'); ch.type='button'; ch.className='fp-chip'; ch.textContent = name; ch.setAttribute('aria-pressed', String((last.chip||'All')===name));
      ch.dataset.val = name;
      chips.appendChild(ch);
      chipEls.push(ch);
    });
    ctr.append(srchWrap, chips);

    // BODY
    const body = document.createElement('div'); body.className = 'fp-body';
    // sections: Favorites, Most used, Results
    const secFav = document.createElement('div'); secFav.className = 'fp-section';
    const hFav = document.createElement('h4'); hFav.textContent = 'Favorites'; secFav.appendChild(hFav);
    const gridFav = document.createElement('div'); gridFav.className = 'fp-grid'; secFav.appendChild(gridFav);

    const secMu = document.createElement('div'); secMu.className = 'fp-section';
    const hMu = document.createElement('h4'); hMu.textContent = 'Most used'; secMu.appendChild(hMu);
    const gridMu = document.createElement('div'); gridMu.className = 'fp-grid'; secMu.appendChild(gridMu);

    const secAll = document.createElement('div'); secAll.className = 'fp-section';
    const hAll = document.createElement('h4'); hAll.textContent = 'All'; secAll.appendChild(hAll);
    const gridAll = document.createElement('div'); gridAll.className = 'fp-grid'; secAll.appendChild(gridAll);

    body.append(secFav, secMu, secAll);

    // FOOT
    const foot = document.createElement('div'); foot.className = 'fp-foot';
    const cancel = document.createElement('button'); cancel.type='button'; cancel.className='fp-btn'; cancel.textContent='Cancel';
    foot.append(cancel);

    // Append all
    box.append(head, ctr, body, foot);
    root.setAttribute('aria-labelledby','fieldpicker-title');
    root.classList.add('open');

    // focus & trap
    try{ input.focus({preventScroll:true}); }catch{}
    const untrap = trapFocusWithin(root);

    function close(){
      root.classList.remove('open');
      root.innerHTML = '';
      window.__pickerOpen = false;
      try{ untrap(); }catch{}
      try{ trigger && trigger.focus({preventScroll:true}); }catch{}
    }

    function makeCard(t){
      if(!TYPES.includes(t)) return null;
      const card = document.createElement('button'); card.type='button'; card.className='fp-card'; card.setAttribute('aria-label', (ICONS[t]||'') + ' ' + t);
      const ico = document.createElement('div'); ico.className='fp-ico'; ico.textContent = ICONS[t] || '•';
      const name = document.createElement('div'); name.className='fp-name'; name.textContent = t.charAt(0).toUpperCase()+t.slice(1);
      const desc = document.createElement('div'); desc.className='fp-desc'; desc.textContent = DESCS[t] || '';
      const star = document.createElement('button'); star.type='button'; star.className='fp-star'; star.setAttribute('aria-label','Toggle favorite'); star.textContent='★';
      const favset = new Set(favs());
      star.setAttribute('aria-pressed', String(favset.has(t)));
      star.addEventListener('click', (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        const out = toggleFav(t);
        star.setAttribute('aria-pressed', String(out.includes(t)));
        render(); // refresh sections that depend on favs
      });
      card.append(ico, name, desc, star);
      card.addEventListener('click', ()=>{
        incUsage(t);
        save(KEY_LAST, {chip: currentChip(), q: input.value||''});
        resolve(t);
      });
      card.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ e.preventDefault(); card.click(); }
      });
      return card;
    }

    function currentChip(){
      const active = chipEls.find(c => c.getAttribute('aria-pressed')==='true');
      return active ? active.dataset.val : 'All';
    }

    function render(){
      // Clear
      [gridFav, gridMu, gridAll].forEach(g => g.innerHTML='');
      const q = (input.value||'').toLowerCase().trim();
      const favSet = new Set(favs());

      const filterByChip = (arr)=>{
        const chip = currentChip();
        if(chip==='All') return arr;
        if(chip==='Most used') return mostUsed(12);
        if(chip==='Favorites') return arr.filter(t => favSet.has(t));
        if(CATS[chip]) return arr.filter(t => CATS[chip].includes(t));
        return arr;
      };

      // Favorites section
      const favList = TYPES.filter(t => favSet.has(t));
      if(favList.length){ favList.forEach(t => { const c=makeCard(t); if(c) gridFav.appendChild(c); }); secFav.style.display=''; } else { secFav.style.display='none'; }

      // Most used section
      const muList = mostUsed(8);
      if(muList.length){ muList.forEach(t => { const c=makeCard(t); if(c) gridMu.appendChild(c); }); secMu.style.display=''; } else { secMu.style.display='none'; }

      // All/results section
      let list = TYPES.slice();
      list = filterByChip(list);
      if(q){ list = list.filter(t => (t.toLowerCase().includes(q) || (DESCS[t]||'').toLowerCase().includes(q))); }
      list.forEach(t => { const c=makeCard(t); if(c) gridAll.appendChild(c); });

      hAll.textContent = q ? 'Results' : 'All';
    }

    // Wire chips
    chipEls.forEach(ch => {
      ch.addEventListener('click', ()=>{
        chipEls.forEach(c => c.setAttribute('aria-pressed','false'));
        ch.setAttribute('aria-pressed','true');
        render();
      });
    });

    // Search
    input.addEventListener('input', render);
    // Slash focuses search
    const onKey = (e)=>{
      if(e.key==='/'){ e.preventDefault(); input.focus(); }
      if(e.key==='Escape'){ e.preventDefault(); resolve(null); }
      // Grid arrow nav is handled by browser focus order; cards are buttons in DOM order.
    };
    document.addEventListener('keydown', onKey, true);

    cancel.addEventListener('click', ()=> resolve(null));
    root.addEventListener('click', (e)=>{ if(e.target===root){ resolve(null); } });

    let settled = false;
    function resolve(val){
      if(settled) return; settled = true;
      document.removeEventListener('keydown', onKey, true);
      close();
      _resolver && _resolver(val);
    }

    // Promise wrapper
    let _resolver = null;
    const p = new Promise((r)=> _resolver = r);

    // Start
    render();

    return p;
  };
})();
</script>
<!-- === Schema IO Minimal FAB Styles (bottom-left, two options) === -->
<style id="schema-io-fab-style">
  #schemaIOFab{position:fixed; z-index:100000; pointer-events:auto; font-family:inherit}
  #schemaIOFab.pos-bl{bottom:16px; left:16px; top:auto; right:auto}
  #schemaIOFabBtn{all:unset; display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border-radius:999px; background:#111; color:#fff; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.25)}
  #schemaIOFabBtn:focus{outline:2px solid rgba(0,0,0,.35); outline-offset:2px}
  #schemaIOFabMenu{position:absolute; left:0; bottom:52px; background:#fff; border:1px solid rgba(0,0,0,.15); border-radius:.6rem; box-shadow:0 12px 24px rgba(0,0,0,.2); min-width:200px; padding:.35rem; display:none}
  #schemaIOFabMenu.open{display:block}
  #schemaIOFabMenu button{all:unset; display:block; width:100%; text-align:left; padding:.55rem .7rem; border-radius:.45rem; cursor:pointer; color:#111}
  #schemaIOFabMenu button:hover{background:rgba(0,0,0,.06)}
  #schemaIOFabMenu .disabled{opacity:.5; cursor:not-allowed}
  @media (max-width: 480px){
    #schemaIOFab.pos-bl{bottom:10px; left:10px}
    #schemaIOFabMenu{bottom:46px}
  }
</style>
<script id="schema-io-core">
(function(){
  if(window.__schemaIOCoreApplied) return; window.__schemaIOCoreApplied = true;

  function _safeGetCurrentItem(){
    try{
      if(typeof window.getItem==='function'){ return window.getItem(); }
      if(window.Model && Array.isArray(Model.items)){
        if(Model.current) return Model.current;
        const active = Model.items.find(it=>it && (it.isActive||it.active));
        return active || Model.items[0] || null;
      }
    }catch(_){}
    return null;
  }

  function _downloadFile(filename, text, mime){
    try{
      const blob = new Blob([text], {type: mime || 'application/json'});
      const url = URL.createObjectURL(blob);
      // try anchor click
      const a = document.createElement('a');
      a.href = url; a.download = filename || 'form.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }catch(e){
      alert('Download failed: ' + (e && e.message ? e.message : e));
    }
  }

  function _ensureIdsAndNormalize(node){
    try{
      if(!node || typeof node!=='object') return node;
      if(!node.id && typeof window.uid === 'function') node.id = window.uid();

      if(node.type === 'field'){
        node.span = Math.max(1, Math.min(4, Number(node.span)||2));
        node.logic = node.logic && typeof node.logic==='object' ? node.logic : {mode:'all', conditions:[]};
        node.options = Array.isArray(node.options) ? node.options : [];
        delete node.valueDelta; delete node.valueHtml;
      }
      if(node.type === 'section'){
        node.name = node.name || 'Section';
        node.children = Array.isArray(node.children) ? node.children : [];
        node.children.forEach(_ensureIdsAndNormalize);
      }
      if(node.type === 'row12'){
        node.name = node.name || 'Row';
        node.capacity = Number(node.capacity)||12;
        node.columns = Array.isArray(node.columns) ? node.columns : [];
        node.columns.forEach(col=>{
          if(!col.id && typeof window.uid === 'function') col.id = window.uid();
          col.type = 'col12';
          col.start = Math.max(1, Number(col.start)||1);
          col.span  = Math.max(1, Math.min(12, Number(col.span)||3));
          col.children = Array.isArray(col.children) ? col.children : [];
          col.children.forEach(_ensureIdsAndNormalize);
        });
      }
      if(node.type === 'divider'){
        node.showLine = node.showLine !== false;
      }
      if(node.type === 'space'){
        node.span = Math.max(1, Math.min(4, Number(node.span)||1));
      }
    }catch(e){ console.warn('[schemaIO] normalize error', e); }
    return node;
  }

  function _makeSchemaPayload(item){
    const rootCopy = JSON.parse(JSON.stringify(item.root || {}));
    _ensureIdsAndNormalize(rootCopy);
    return {
      $schema: "https://example.com/form.schema.json",
      app: "FormDesigner",
      version: 1,
      title: item.name || "Untitled",
      exportedAt: new Date().toISOString(),
      root: rootCopy
    };
  }

  function _mergeRoots(targetRoot, incomingRoot){
    try{
      if(!targetRoot) return incomingRoot;
      if(!incomingRoot) return targetRoot;
      if(targetRoot.type !== 'section' || incomingRoot.type !== 'section'){
        targetRoot.children = targetRoot.children || [];
        targetRoot.children.push(incomingRoot);
        return targetRoot;
      }
      (incomingRoot.children||[]).forEach(ch=>{
        targetRoot.children = targetRoot.children || [];
        targetRoot.children.push(ch);
      });
      return targetRoot;
    }catch(e){ console.warn('[schemaIO] merge error', e); return incomingRoot; }
  }

  function _applySchemaToCurrent(schema, mode){
    const item = _safeGetCurrentItem();
    if(!item){ alert('Open a page first.'); return; }
    const root = schema && (schema.root || schema);
    if(!root || typeof root!=='object'){ throw new Error('No root found in JSON'); }
    _ensureIdsAndNormalize(root);
    if(mode === 'merge'){
      if(!item.root) item.root = root;
      else item.root = _mergeRoots(item.root, root);
    }else{
      item.root = root;
    }
    if(!item.root || item.root.type!=='section'){
      if(typeof window.defaultRootSection === 'function'){
        const wrapper = window.defaultRootSection(item.name || 'Form');
        wrapper.children = [item.root];
        item.root = wrapper;
      }else{
        item.root = {id:(window.uid?window.uid():'sec_root'), type:'section', name:'Form', children:[item.root]};
      }
    }
    if(typeof window.render === 'function') window.render();
    try{ if(window.toast) toast('Schema imported'); }catch(_){}
  }

  window.__schemaIOCore = {
    exportCurrent: function(){
      const item = _safeGetCurrentItem();
      if(!item || !item.root){ alert('Open a page first.'); return; }
      const payload = _makeSchemaPayload(item);
      const safe = (item.name||'form').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || 'form';
      _downloadFile(safe + '.json', JSON.stringify(payload, null, 2), 'application/json');
      try{ if(window.toast) toast('Schema exported'); }catch(_){}
    },
    importCurrent: function(){
      if((window.demoMode===true) || (document.body.classList && document.body.classList.contains('demo-mode'))){
        try{ if(window.toast) toast('Demo mode: import disabled'); }catch(_){}
        return;
      }
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'application/json';
      input.onchange = function(){
        const f = input.files && input.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = function(){
          try{
            const parsed = JSON.parse(String(reader.result||'{}'));
            const mode = (confirm('OK = Replace current form, Cancel = Merge into current form') ? 'replace' : 'merge');
            _applySchemaToCurrent(parsed, mode);
          }catch(e){
            alert('Invalid JSON: ' + (e && e.message ? e.message : e));
          }
        };
        reader.readAsText(f);
      };
      document.body.appendChild(input);
      try{ input.click(); } finally { setTimeout(()=>input.remove(), 0); }
    }
  };
})();
</script>
<script id="data-io-core">
(function(){
  if(window.__dataIOCoreApplied) return; window.__dataIOCoreApplied = true;

  function _downloadFile(filename, text, mime){
    try{
      const blob = new Blob([text], {type: mime || 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename || 'form-values.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }catch(e){ alert('Download failed'); }
  }

  function _safeForm(){
    return document.getElementById('designerForm') || document.querySelector('form.designer-form');
  }

  function _collectValues(){
    const form = _safeForm();
    if(!form) return { byId:{}, byName:{} };
    const byId = Object.create(null);
    const byName = Object.create(null);

    form.querySelectorAll('input, select, textarea').forEach(el=>{
      if(!el || el.disabled) return;
      const id = el.id || '';
      const nm = el.name || '';
      const type = (el.type||'').toLowerCase();

      function setName(v){
        if(!nm) return;
        if(type==='checkbox'){
          const arr = Array.isArray(byName[nm]) ? byName[nm] : [];
          if(el.checked){ arr.push(v); }
          byName[nm] = arr;
        } else if(type==='radio'){
          if(el.checked){ byName[nm] = v; }
        } else {
          byName[nm] = v;
        }
      }
      function setId(v){
        if(!id) return;
        if(type==='checkbox' || type==='radio'){
          byId[id] = !!el.checked;
        } else {
          byId[id] = v;
        }
      }

      if(type==='file'){ return; }
      if(type==='checkbox'){
        setId(el.checked);
        setName(el.value || true);
      }else if(type==='radio'){
        setId(el.checked);
        if(el.checked) setName(el.value || true);
      }else{
        setId(el.value);
        setName(el.value);
      }
    });

    form.querySelectorAll('[contenteditable="true"]').forEach(el=>{
      const id = el.id || '';
      const nm = el.getAttribute('name') || '';
      const v = el.innerHTML;
      if(id) byId[id] = v;
      if(nm) byName[nm] = v;
    });

    return { byId, byName };
  }

  function _applyValues(payload){
    const form = _safeForm();
    if(!form) { alert('Open a page first.'); return; }
    const byId = (payload && payload.values && payload.values.byId) || payload.byId || {};
    const byName = (payload && payload.values && payload.values.byName) || payload.byName || {};

    Object.keys(byName || {}).forEach(nm=>{
      const v = byName[nm];
      const nodes = form.querySelectorAll(`[name="${CSS.escape(nm)}"]`);
      nodes.forEach(el=>{
        const type = (el.type||'').toLowerCase();
        if(type==='radio'){
          el.checked = (el.value==v);
        }else if(type==='checkbox'){
          const arr = Array.isArray(v) ? v.map(String) : [];
          el.checked = arr.includes(String(el.value));
        }else{
          el.value = (v==null?'':v);
        }
        try{ el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
      });
    });

    Object.keys(byId || {}).forEach(id=>{
      const el = form.querySelector('#'+CSS.escape(id));
      if(!el) return;
      const type = (el.type||'').toLowerCase();
      const v = byId[id];
      if(type==='radio' || type==='checkbox'){
        el.checked = !!v;
      }else if(el.isContentEditable){
        el.innerHTML = (v==null?'':v);
      }else{
        el.value = (v==null?'':v);
      }
      try{ el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
    });
  }

  window.__dataIOCore = {
    exportValues: function(){
      const form = _safeForm();
      if(!form){ alert('Open a page first.'); return; }
      const values = _collectValues();
      const meta = {
        ts: new Date().toISOString(),
        pageId: (window.Model && window.Model.current && window.Model.current.id) || null,
        route: (typeof window.getCurrentRoute==='function' && window.getCurrentRoute()) || (location.hash||'')
      };
      const payload = { type:'form-values', meta, values };
      const safe = ((window.Model && window.Model.current && window.Model.current.name)||'form')
        .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || 'form';
      _downloadFile(safe + '-values.json', JSON.stringify(payload, null, 2), 'application/json');
      try{ if(window.toast) toast('Values exported'); }catch(_){}
    },
    importValues: function(){
      if((window.demoMode===true) || (document.body.classList && document.body.classList.contains('demo-mode'))){
        try{ if(window.toast) toast('Demo mode: import disabled'); }catch(_){}
        return;
      }
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'application/json';
      input.onchange = function(){
        const f = input.files && input.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = function(){
          try{
            const parsed = JSON.parse(String(reader.result||'{}'));
            _applyValues(parsed);
            try{ if(window.toast) toast('Values imported'); }catch(_){}
          }catch(e){
            alert('Invalid JSON: ' + (e && e.message ? e.message : e));
          }
        };
        reader.readAsText(f);
      };
      document.body.appendChild(input);
      try{ input.click(); } finally { setTimeout(()=>input.remove(), 0); }
    }
  };

  (function setupFab(){
    try{
      if(document.getElementById('dataIOFab')) return;
      const fab = document.createElement('div'); fab.id='dataIOFab'; fab.className='pos-bl';
      const btn = document.createElement('button'); btn.type='button'; btn.className='btn';
      btn.setAttribute('aria-haspopup','true'); btn.setAttribute('aria-expanded','false');
      btn.innerHTML = '<span>Data</span><svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>';
      const menu = document.createElement('div'); menu.id='dataIOFabMenu'; menu.setAttribute('role','menu');
      const b1 = document.createElement('button'); b1.id='dataIOFabExport'; b1.textContent='Export Values'; b1.setAttribute('role','menuitem');
      const b2 = document.createElement('button'); b2.id='dataIOFabImport'; b2.textContent='Import Values'; b2.setAttribute('role','menuitem');
      menu.appendChild(b1); menu.appendChild(b2);
      fab.appendChild(btn); fab.appendChild(menu);
      document.body.appendChild(fab);

      function toggle(open){
        menu.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
      }
      btn.addEventListener('click', function(e){
        try{ e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){}
        const open = !menu.classList.contains('open');
        toggle(open);
        return false;
      }, true);
      window.addEventListener('click', function(){ toggle(false); }, true);
      menu.addEventListener('click', function(e){ e.stopPropagation(); }, true);

      b1.addEventListener('click', function(e){
        try{ e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){}
        try{ window.__dataIOCore && window.__dataIOCore.exportValues(); }catch(err){ alert('Export failed: ' + (err && err.message || err)); }
        toggle(false);
        return false;
      }, true);
      b2.addEventListener('click', function(e){
        try{ e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){}
        try{ window.__dataIOCore && window.__dataIOCore.importValues(); }catch(err){ alert('Import failed: ' + (err && err.message || err)); }
        toggle(false);
        return false;
      }, true);
    }catch(_){}
  })();

})();
</script>
<script id="schema-io-fab-script">
(function(){
  if(window.__schemaIOFabAppliedOnlyTwo) return; window.__schemaIOFabAppliedOnlyTwo = true;

  function isDemo(){
    try{ return (window.demoMode===true) || (document.body.classList && document.body.classList.contains('demo-mode')); }
    catch(_){ return false; }
  }

  function buildFab(){
    let fab = document.getElementById('schemaIOFab');
    if(!fab){
      fab = document.createElement('div');
      fab.id = 'schemaIOFab';
      fab.className = 'pos-bl'; // lock to bottom-left
      document.body.appendChild(fab);
      const btn = document.createElement('button');
      btn.id = 'schemaIOFabBtn'; btn.setAttribute('type','button');
      btn.setAttribute('aria-haspopup','menu'); btn.setAttribute('aria-expanded','false');
      btn.innerHTML = '<span>Schema</span><svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>';
      const menu = document.createElement('div');
      menu.id = 'schemaIOFabMenu'; menu.setAttribute('role','menu');
      const b1 = document.createElement('button');
      b1.id = 'schemaIOFabExport'; b1.textContent = 'Export JSON'; b1.setAttribute('role','menuitem');
      const b2 = document.createElement('button');
      b2.id = 'schemaIOFabImport'; b2.textContent = 'Import JSON'; b2.setAttribute('role','menuitem');
      menu.appendChild(b1); menu.appendChild(b2);
      fab.appendChild(btn); fab.appendChild(menu);

      // open/close
      btn.addEventListener('click', function(e){
        try{ e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){}
        const open = !menu.classList.contains('open');
        menu.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
        return false;
      }, true);

      // outside click to close
      document.addEventListener('click', function(){
        if(menu.classList.contains('open')){ menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      }, true);

      // stop closing when clicking inside
      menu.addEventListener('click', function(e){ e.stopPropagation(); }, true);

      // actions (we also have global early-capture as a fallback)
      b1.addEventListener('click', function(e){ 
        try{ e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){}
        try{ if(window.__schemaIOCore) window.__schemaIOCore.exportCurrent(); }catch(err){ alert('Export failed: '+(err && err.message || err)); }
        menu.classList.remove('open'); btn.setAttribute('aria-expanded','false');
        return false;
      }, true);

      b2.addEventListener('click', function(e){ 
        try{ e.stopImmediatePropagation(); e.stopPropagation(); }catch(_){}
        if(isDemo()){ try{ if(window.toast) toast('Demo mode: import disabled'); }catch(_){}
          menu.classList.remove('open'); btn.setAttribute('aria-expanded','false');
          return false;
        }
        try{ if(window.__schemaIOCore) window.__schemaIOCore.importCurrent(); }catch(err){ alert('Import failed: '+(err && err.message || err)); }
        menu.classList.remove('open'); btn.setAttribute('aria-expanded','false');
        return false;
      }, true);
    }

    // reflect demo mode
    const imp = document.getElementById('schemaIOFabImport');
    if(imp){
      if(isDemo()){ imp.classList.add('disabled'); } else { imp.classList.remove('disabled'); }
    }
  }

  function ensureFab(){ try{ buildFab(); }catch(_){ } }

  // Hook app nav to ensure FAB persists
  if(typeof window.openDesigner === 'function' && !window.__schemaIOFabWrapOpen2){
    window.__schemaIOFabWrapOpen2 = true;
    const o = window.openDesigner;
    window.openDesigner = function(){ const r = o.apply(this, arguments); ensureFab(); return r; };
  }
  if(typeof window.renderMenus === 'function' && !window.__schemaIOFabWrapMenu2){
    window.__schemaIOFabWrapMenu2 = true;
    const o = window.renderMenus;
    window.renderMenus = function(){ const r = o.apply(this, arguments); ensureFab(); return r; };
  }

  // Observe DOM changes just in case
  const mo = new MutationObserver(function(){ ensureFab(); });
  mo.observe(document.body, {childList:true, subtree:true});

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureFab);
  }else{
    ensureFab();
  }
})();
</script>
<script>
/* export/import-all patch v1 — includes navigation (items), pinnedIds, and brand (site name + logo) */
(function(){
  if (window.__schemaIOExtNavBrand) return; window.__schemaIOExtNavBrand = true;

  function safeCall(fn, args){ try{ return fn && fn.apply(null, args||[]); }catch(_){ return undefined; } }

  function hook(){
    const core = window.__schemaIOCore;
    if (!core) return false;

    function makeFullPayload(item){
      const siteNameEl = document.getElementById('siteName');
      const logoBox    = document.getElementById('logoBox');
      let pinned = [];
      try { pinned = JSON.parse(localStorage.getItem('pinnedIds')||'[]'); } catch(e){}
      return {
        version: '1.0',
        app: { title: siteNameEl?.textContent?.trim() || '', at: new Date().toISOString() },
        root: item.root || null,
        navigation: { items: (window.Model && Array.isArray(window.Model.items)) ? window.Model.items : [], pinnedIds: pinned },
        brand: { siteName: siteNameEl?.textContent?.trim() || '', logoHtml: logoBox?.innerHTML || '' }
      };
    }

    // ---- Extend export to include nav + brand
    const oldExport = core.exportCurrent;
    core.exportCurrent = function(){
      let item = null;
      try{
        if (window.current && typeof window.findNavNode === 'function'){
          item = window.findNavNode(window.current.place, window.current.id);
        }
      }catch(_){}
      if (!item && typeof window.getItem === 'function'){
        try{ item = window.getItem(); }catch(_){}
      }
      if (!item || !item.root){ alert('Open a page first.'); return; }
      const json = JSON.stringify(makeFullPayload(item), null, 2);
      const safeName = (item.name||'form').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || 'form';
      const a=document.createElement('a');
      a.href='data:application/json;charset=utf-8,'+encodeURIComponent(json);
      a.download=safeName+'.json';
      a.click();
      try{ window.toast && window.toast('Schema exported'); }catch(_){}
      if (typeof oldExport === 'function'){ try{ oldExport.call(core); }catch(_){ } } // keep compatibility
    };

    // ---- Extend import to apply nav + brand
    const oldApply = window._applySchemaToCurrent;
    window._applySchemaToCurrent = function(schema, mode){
      const r = (typeof oldApply === 'function') ? oldApply(schema, mode) : undefined;
      try{
        // Brand
        if (schema?.brand){
          const siteNameEl = document.getElementById('siteName');
          const logoBox    = document.getElementById('logoBox');
          if (siteNameEl && schema.brand.siteName) siteNameEl.textContent = schema.brand.siteName;
          if (logoBox && schema.brand.logoHtml)    logoBox.innerHTML      = schema.brand.logoHtml;
          try{ window.saveBrand && window.saveBrand(); }catch(_){}
          try{ window.updateFaviconFromLogo && window.updateFaviconFromLogo(); }catch(_){}
        }
        // Navigation + pinned
        if (schema?.navigation && Array.isArray(schema.navigation.items)){
          window.Model = window.Model || { items: [] };
          window.Model.items = schema.navigation.items;
          if (schema.navigation.pinnedIds){
            try{ localStorage.setItem('pinnedIds', JSON.stringify(schema.navigation.pinnedIds)); }catch(_){}
          }
          try{ typeof window.renderMenus === 'function' && window.renderMenus(); }catch(_){}
          try{ typeof window.renderTabs  === 'function' && window.renderTabs(); }catch(_){}
        }
      }catch(e){ console.warn('Import brand/nav failed', e); }
      try{ typeof window.render === 'function' && window.render(); }catch(_){}
      try{ window.toast && window.toast('Schema imported'); }catch(_){}
      return r;
    };

    return true;
  }

  if (!hook()){
    let tries = 0;
    const iv = setInterval(function(){
      tries++;
      if (hook() || tries > 60){ clearInterval(iv); }
    }, 100);
    window.addEventListener('beforeunload', function(){ try{ clearInterval(iv); }catch(_){} });
  }
})();
</script>
<script>
/* export/import-all patch v2 — ensures active page resolution after import */
(function(){
  if (window.__schemaIOExtNavBrandV2) return; window.__schemaIOExtNavBrandV2 = true;

  function findNavNode(place, id){
    try{
      const items = (window.Model && Array.isArray(window.Model.items)) ? window.Model.items : [];
      let hit = null;
      (function walk(list){
        for(const n of list){
          if((place ? n.place===place : true) && (id ? n.id===id : true)){ hit = n; return; }
          if(n.children && n.children.length){ walk(n.children); if(hit) return; }
        }
      })(items);
      return hit;
    }catch(_){ return null; }
  }

  const oldApply = window._applySchemaToCurrent;
  window._applySchemaToCurrent = function(schema, mode){
    const r = (typeof oldApply === 'function') ? oldApply(schema, mode) : undefined;

    try{
      // After brand & navigation from v1 have been applied, ensure a valid current
      const cur = (window.current && findNavNode(window.current.place, window.current.id)) ? window.current : null;
      if(!cur){
        // prefer a vertical page, else any page
        let first = null;
        try{
          const items = (window.Model && Array.isArray(window.Model.items)) ? window.Model.items : [];
          const flat = [];
          (function flatten(list){ for(const n of list){ flat.push(n); if(n.children?.length) flatten(n.children); } })(items);
          first = flat.find(n => n.place === 'v') || flat[0] || null;
        }catch(_){}
        if(first){
          window.current = { place: first.place, id: first.id };
          if(typeof window.openDesigner === 'function'){ try{ window.openDesigner(first); }catch(_){ } }
          else if(typeof window.render === 'function'){ try{ window.render(); }catch(_){ } }
        }
      }else{
        // if current exists after import, open it to refresh UI with new schema
        const node = findNavNode(window.current.place, window.current.id);
        if(node && typeof window.openDesigner === 'function'){ try{ window.openDesigner(node); }catch(_){ } }
      }
      try{ if(typeof window.renderMenus === 'function') window.renderMenus(); }catch(_){}
      try{ if(typeof window.renderTabs  === 'function') window.renderTabs(); }catch(_){}
    }catch(e){ console.warn('V2 post-import activation failed', e); }

    return r;
  };
})();
</script>
<script>
/* export/import-all patch v3 — single-file "all app settings" export with settings block + nicer filename */
(function(){
  if (window.__schemaIOExtNavBrandV3) return; window.__schemaIOExtNavBrandV3 = true;

  function nowStamp(){
    const d = new Date();
    const pad = n => (n<10?'0':'')+n;
    return d.getFullYear().toString()+pad(d.getMonth()+1)+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds());
  }

  function slug(s){ return (s||'app').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || 'app'; }

  function collectBrand(){
    const siteNameEl = document.getElementById('siteName');
    const logoBox    = document.getElementById('logoBox');
    return {
      siteName: siteNameEl?.textContent?.trim() || '',
      logoHtml: logoBox?.innerHTML || ''
    };
  }

  function collectNav(){
    let pinned = [];
    try { pinned = JSON.parse(localStorage.getItem('pinnedIds')||'[]'); } catch(_){}
    const items = (window.Model && Array.isArray(window.Model.items)) ? window.Model.items : [];
    return { items, pinnedIds: pinned };
  }

  function collectSettings(){
    // Extend here if more app-wide settings are added in the future.
    return {
      demoMode: !!window.demoMode
    };
  }

  // Extend export to guarantee single-file all-in-one JSON
  (function enhanceExport(){
    const core = window.__schemaIOCore;
    if (!core) return;

    const oldExport = core.exportCurrent;
    core.exportCurrent = function(){
      let currentItem = null;
      try{
        if (window.current && typeof window.findNavNode === 'function'){
          currentItem = window.findNavNode(window.current.place, window.current.id);
        }
      }catch(_){}
      if (!currentItem && typeof window.getItem === 'function'){
        try{ currentItem = window.getItem(); }catch(_){}
      }
      if (!currentItem || !currentItem.root){
        alert('Open a page first.');
        return;
      }

      const brand = collectBrand();
      const nav   = collectNav();
      const settings = collectSettings();

      const payload = {
        version: '1.1',
        app: { title: brand.siteName || 'App', at: new Date().toISOString(), generator: 'export-all-v3' },
        brand,
        navigation: nav,
        settings,
        // keep compatibility with legacy single-page imports
        root: currentItem.root || null
      };

      const json = JSON.stringify(payload, null, 2);
      const fileName = `app-export-${slug(brand.siteName || currentItem.name)}-${nowStamp()}.json`;
      const a=document.createElement('a');
      a.href='data:application/json;charset=utf-8,'+encodeURIComponent(json);
      a.download=fileName;
      a.click();
      try{ window.toast && window.toast('Full app exported'); }catch(_){}

      // do NOT call oldExport to avoid duplicate downloads; legacy kept only for fallback
    };
  })();

  // Extend import to apply settings as well (still respects Demo restrictions inside core importer)
  (function enhanceImport(){
    const oldApply = window._applySchemaToCurrent;
    window._applySchemaToCurrent = function(schema, mode){
      const r = (typeof oldApply === 'function') ? oldApply(schema, mode) : undefined;
      try{
        if (schema?.settings && typeof schema.settings.demoMode === 'boolean'){
          window.demoMode = !!schema.settings.demoMode;
          try{
            if (typeof window.updateDemoModeUI === 'function') window.updateDemoModeUI();
          }catch(_){}
        }
      }catch(e){ console.warn('V3 import settings failed', e); }
      return r;
    };
  })();
})();
</script>
<script>
/* export/import-all patch v4 — robust importer (bypasses demo block, applies full app) */
(function(){
  if (window.__schemaIOFullImporterV4) return; window.__schemaIOFullImporterV4 = true;

  function flattenNav(items){
    const out = [];
    (function walk(list){
      for(const n of (list||[])){
        out.push(n);
        if(n.children && n.children.length) walk(n.children);
      }
    })(items||[]);
    return out;
  }

  function pickFirstPage(items){
    const flat = flattenNav(items);
    return flat.find(n => n.place === 'v') || flat[0] || null;
  }

  function applyBrand(brand){
    if(!brand) return;
    try{
      const siteNameEl = document.getElementById('siteName');
      const logoBox    = document.getElementById('logoBox');
      if (siteNameEl && typeof brand.siteName === 'string') siteNameEl.textContent = brand.siteName;
      if (logoBox   && typeof brand.logoHtml === 'string')  logoBox.innerHTML      = brand.logoHtml;
      if (typeof window.saveBrand === 'function') window.saveBrand();
      if (typeof window.updateFaviconFromLogo === 'function') window.updateFaviconFromLogo();
    }catch(_){}
  }

  function applyNavigation(nav){
    if(!nav || !Array.isArray(nav.items)) return null;
    window.Model = window.Model || { items: [] };
    window.Model.items = nav.items;
    if (nav.pinnedIds){
      try{ localStorage.setItem('pinnedIds', JSON.stringify(nav.pinnedIds)); }catch(_){}
    }
    try{ typeof window.renderMenus === 'function' && window.renderMenus(); }catch(_){}
    try{ typeof window.renderTabs  === 'function' && window.renderTabs(); }catch(_){}
    return pickFirstPage(nav.items);
  }

  function findNodeByRootId(rootId){
    try{
      const flat = flattenNav((window.Model && window.Model.items) || []);
      return flat.find(n => n && n.root && n.root.id === rootId) || null;
    }catch(_){ return null; }
  }

  function openNode(node){
    if (!node) return;
    try{
      if(typeof window.openDesigner === 'function'){ window.openDesigner(node); }
      else if(typeof window.render === 'function'){ window.render(); }
    }catch(_){}
  }

  function attachRootToBestNode(schemaRoot, preferredNode){
    if(!schemaRoot) return;
    let target = null;
    // 1) exact root.id match
    target = (schemaRoot.id && findNodeByRootId(schemaRoot.id)) || null;
    // 2) preferred node fallback
    if(!target && preferredNode) target = preferredNode;
    // 3) last resort: first page
    if(!target) target = pickFirstPage((window.Model && window.Model.items) || []);
    if(target){
      try{ target.root = schemaRoot; }catch(_){}
    }
  }

  // Override __schemaIOCore.importCurrent to be robust and independent from demoMode
  (function overrideImporter(){
    const core = window.__schemaIOCore = (window.__schemaIOCore || {});
    const oldImport = core.importCurrent;

    core.importCurrent = function(){
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'application/json';
      input.onchange = function(){
        const f = input.files && input.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = function(){
          let parsed = null;
          try{
            parsed = JSON.parse(String(reader.result||'{}'));
          }catch(e){
            alert('Invalid JSON: ' + (e && e.message ? e.message : e));
            return;
          }

          // Apply brand + nav first
          applyBrand(parsed.brand);
          const preferred = applyNavigation(parsed.navigation);

          // settings (e.g., demoMode)
          try{
            if (parsed.settings && typeof parsed.settings.demoMode === 'boolean'){
              window.demoMode = !!parsed.settings.demoMode;
              if (typeof window.updateDemoModeUI === 'function') window.updateDemoModeUI();
            }
          }catch(_){}

          // Attach root to matching/current/first node
          attachRootToBestNode(parsed.root, preferred);

          // Open the active/current page
          openNode(preferred || (window.current && preferred));

          // final render
          try{ typeof window.render === 'function' && window.render(); }catch(_){}

          try{ window.toast && window.toast('Full app imported'); }catch(_){}
        };
        reader.readAsText(f);
      };
      document.body.appendChild(input);
      try{ input.click(); } finally { setTimeout(()=>input.remove(), 0); }
    };
  })();
})();
</script>
<script>
/* routes patch v1 — unique per-page routes with hash navigation */
(function(){
  if (window.__routeSupportV1) return; window.__routeSupportV1 = true;

  function slugify(s){
    try{
      return (s||'page')
        .toString()
        .normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'') || 'page';
    }catch(_){
      return 'page';
    }
  }

  function flatten(items){
    const out=[];
    (function walk(list){
      for(const n of (list||[])){
        out.push(n);
        if(n.children && n.children.length) walk(n.children);
      }
    })(items||[]);
    return out;
  }

  function ensureUniqueRoutes(){
    const items = (window.Model && Array.isArray(window.Model.items)) ? window.Model.items : [];
    const flat = flatten(items);
    const used = new Set();
    for(const n of flat){
      let r = (typeof n.route === 'string' && n.route.trim()) ? n.route.trim() : slugify(n.name || n.id || '');
      r = r.replace(/^\/+|\/+$/g,''); // trim slashes
      if(!r) r = 'page';
      let cand = r, i = 2;
      while(used.has(cand)){
        cand = r + '-' + i++;
      }
      n.route = cand;
      used.add(cand);
    }
  }

  function findByRoute(route){
    route = (route||'').replace(/^\/+|\/+$/g,'');
    const flat = flatten((window.Model && window.Model.items) || []);
    return flat.find(n => (n && typeof n.route === 'string' && n.route.replace(/^\/+|\/+$/g,'') === route)) || null;
  }

  function setHashForNode(node){
    if(!node || !node.route) return;
    const target = '#/' + node.route.replace(/^\/+|\/+$/g,'');
    if (location.hash !== target){
      location.hash = target;
    }
  }

  function handleRouteChange(){
    ensureUniqueRoutes();
    const route = (location.hash||'').replace(/^#\/?/, '');
    if(!route){
      // if no route in hash, sync hash to current or first
      let node = (window.current && typeof window.findNavNode === 'function') ? window.findNavNode(window.current.place, window.current.id) : null;
      if(!node){
        const items = (window.Model && Array.isArray(window.Model.items)) ? window.Model.items : [];
        const flat = flatten(items);
        node = flat.find(n=>n.place==='v') || flat[0] || null;
      }
      if(node) setHashForNode(node);
      return;
    }
    const node = findByRoute(route);
    if(node){
      try{
        if(typeof window.openDesigner === 'function'){ window.openDesigner(node); }
        else if(typeof window.render === 'function'){ window.render(); }
      }catch(_){}
    }
  }

  // Wrap openDesigner to keep hash in sync and ensure route exists
  (function wrapOpenDesigner(){
    const old = window.openDesigner;
    window.openDesigner = function(item){
      // ensure route exists
      if (item && (!item.route || !item.route.trim())){
        ensureUniqueRoutes();
      }
      const r = (typeof old === 'function') ? old.apply(this, arguments) : undefined;
      try{ setHashForNode(item); }catch(_){}
      return r;
    };
  })();

  // Recompute routes after menus render (e.g., after adding/deleting pages)
  (function wrapRenderMenus(){
    const old = window.renderMenus;
    window.renderMenus = function(){
      const r = (typeof old === 'function') ? old.apply(this, arguments) : undefined;
      try{ ensureUniqueRoutes(); }catch(_){}
      return r;
    };
  })();

  // Ensure routes exist on load/import and react to hash changes
  document.addEventListener('DOMContentLoaded', function(){
    ensureUniqueRoutes();
    handleRouteChange();
  });
  window.addEventListener('hashchange', handleRouteChange);

  // Also ensure routes after full-app import (v4 importer toasts "Full app imported")
  (function wrapApply(){
    const oldApply = window._applySchemaToCurrent;
    window._applySchemaToCurrent = function(schema, mode){
      const r = (typeof oldApply === 'function') ? oldApply(schema, mode) : undefined;
      try{ ensureUniqueRoutes(); handleRouteChange(); }catch(_){}
      return r;
    };
  })();
})();
</script>
<!-- CB ROLES INJECTION START -->
<style>
  .cb-hidden{display:none!important}
  .cb-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .cb-modal-content{background:#fff;color:#111;width:min(1000px,96vw);max-height:88vh;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden;display:flex;flex-direction:column}
  .cb-modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eee;background:#f8fafc}
  .cb-modal-body{padding:16px;overflow:auto}
  .cb-modal-actions{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end;background:#fafafa}
  .cb-btn{border:1px solid #ddd;padding:8px 12px;border-radius:10px;cursor:pointer;background:#fff}
  .cb-btn.primary{background:#111;color:#fff;border-color:#111}
  .cb-grid{width:100%;border-collapse:collapse}
  .cb-grid th,.cb-grid td{border-bottom:1px solid #eee;padding:10px;text-align:left}
  .cb-grid th{background:#f9fafb;font-weight:600}
  .cb-form{display:grid;grid-template-columns:1fr 1fr;gap:12px 16px;margin-bottom:16px}
  .cb-form .full{grid-column:1 / -1}
  .cb-input,.cb-textarea{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;outline:none}
  .cb-input:focus,.cb-textarea:focus{border-color:#111}
  .cb-tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
  @media (max-width:640px){.cb-form{grid-template-columns:1fr}}
</style>
<div aria-labelledby="cb-roles-title" aria-modal="true" class="cb-modal cb-hidden" id="cb-roles-modal" role="dialog">
<div class="cb-modal-content">
<div class="cb-modal-header">
<h3 id="cb-roles-title" style="margin:0;">Roles &amp; Permissions</h3>
<button aria-label="Close roles dialog" class="cb-btn" id="cb-roles-close">✕</button>
</div>
<div class="cb-modal-body">
<form class="cb-form" id="cb-roles-form">
<div>
<label for="cb-role-name" style="display:block;margin-bottom:6px;">Role name <span class="cb-tag">required</span></label>
<input class="cb-input" id="cb-role-name" placeholder="e.g., Admin, Reviewer, Approver" required="" type="text"/>
</div>
<div>
<label for="cb-role-code" style="display:block;margin-bottom:6px;">Role code (optional)</label>
<input class="cb-input" id="cb-role-code" placeholder="e.g., admin, reviewer" type="text"/>
</div>
<div class="full">
<label for="cb-role-desc" style="display:block;margin-bottom:6px;">Description (optional)</label>
<textarea class="cb-textarea" id="cb-role-desc" placeholder="Short description of this role..." rows="2"></textarea>
</div>
<div class="full" style="display:flex;gap:8px;align-items:center;">
<button class="cb-btn primary" type="submit">Add Role</button>
<button class="cb-btn" id="cb-roles-clear" type="button">Clear All (Local)</button>
<span id="cb-roles-msg" style="margin-left:8px;font-size:12px;color:#16a34a;"></span>
</div>
</form>
<table aria-label="Roles table" class="cb-grid" id="cb-roles-table">
<thead>
<tr><th style="width:22%;">Name</th><th style="width:18%;">Code</th><th>Description</th><th style="width:18%;">Created</th><th style="width:14%;">Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="cb-modal-actions">
<button class="cb-btn" id="cb-roles-export">Export</button>
<input accept="application/json" class="cb-hidden" id="cb-roles-import-input" type="file"/>
<button class="cb-btn" id="cb-roles-import">Import</button>
<button class="cb-btn" id="cb-roles-close-bottom">Close</button>
</div>
</div>
</div>
<script>
(function(){
  const STORAGE_KEY = "cb_roles";
  function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]") } catch { return [] } }
  function save(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)) }
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])) }
  function formatDate(iso){ try{ return new Date(iso).toLocaleString() } catch { return iso || "" } }

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function render(){
    const tbody = $("#cb-roles-table tbody");
    if (!tbody) return;
    const list = load();
    tbody.innerHTML = "";
    if (list.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "No roles yet. Add one using the form above.";
      td.style.color = "#6b7280";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    for (const r of list) {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td>'+escapeHtml(r.name||"")+'</td>' +
                     '<td>'+escapeHtml(r.code||"")+'</td>' +
                     '<td>'+escapeHtml(r.desc||"")+'</td>' +
                     '<td>'+formatDate(r.createdAt)+'</td>' +
                     '<td><button class="cb-btn" data-cb-action="edit" data-id="'+r.id+'">Edit</button> ' +
                     '<button class="cb-btn" data-cb-action="delete" data-id="'+r.id+'">Delete</button></td>';
      tbody.appendChild(tr);
    }
  }

  function showModal(){ $("#cb-roles-modal")?.classList.remove("cb-hidden"); setTimeout(()=>$("#cb-role-name")?.focus(),50); }
  function closeModal(){ $("#cb-roles-modal")?.classList.add("cb-hidden"); }

  function openHandler(e){
    if (e) e.preventDefault();
    render();
    showModal();
  }

  function wire(){
    if (window.__cbRolesWired) return;
    window.__cbRolesWired = true;

    // Capturing-phase global listener for robustness
    document.addEventListener("click", function(ev){
      const el = ev.target.closest("[data-cb-nav='roles-permissions'], #navRolesPermissions");
      if (el) openHandler(ev);
    }, true); // <-- capturing

    // Direct element listener if present
    const btn = document.getElementById("navRolesPermissions");
    if (btn) {
      btn.setAttribute("data-cb-nav","roles-permissions");
      btn.addEventListener("click", openHandler, true); // capturing on element
    }

    // Floating fallback button
    // Modal basics
    $("#cb-roles-close")?.addEventListener("click", closeModal);
    $("#cb-roles-close-bottom")?.addEventListener("click", closeModal);
    $("#cb-roles-modal")?.addEventListener("click", (e)=>{ if(e.target === $("#cb-roles-modal")) closeModal(); });

    // Form submit
    $("#cb-roles-form")?.addEventListener("submit", function(e){
      e.preventDefault();
      const name = ($("#cb-role-name")?.value || "").trim();
      const code = ($("#cb-role-code")?.value || "").trim();
      const desc = ($("#cb-role-desc")?.value || "").trim();
      const msgEl = $("#cb-roles-msg");
      if(!name){ if(msgEl){ msgEl.style.color="#dc2626"; msgEl.textContent="Role name is required."; } $("#cb-role-name")?.focus(); return; }
      const list = load();
      if (list.some(x => (x.name||"").toLowerCase() === name.toLowerCase())) {
        if(msgEl){ msgEl.style.color="#dc2626"; msgEl.textContent="A role with this name already exists."; }
        return;
      }
      const id = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now() + Math.random());
      list.push({ id, name, code, desc, createdAt: new Date().toISOString() });
      save(list);
      render();
      this.reset();
      if(msgEl){ msgEl.style.color="#16a34a"; msgEl.textContent="Role added."; }
    });

    // Row actions
    $("#cb-roles-table")?.addEventListener("click", function(e){
      const btn = e.target.closest("button[data-cb-action]");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-cb-action");
      const list = load();
      const idx = list.findIndex(x => x.id === id);
      if (idx === -1) return;
      if (action === "delete") {
        if (confirm("Delete this role?")) {
          list.splice(idx, 1); save(list); render();
        }
      } else if (action === "edit") {
        const r = list[idx];
        const newName = prompt("Role name:", r.name || ""); if (newName === null) return;
        const trimmedName = newName.trim(); if (!trimmedName) { alert("Name is required."); return; }
        if (list.some((x,i)=> i!==idx && (x.name||"").toLowerCase() === trimmedName.toLowerCase())) { alert("Another role already has this name."); return; }
        const newCode = prompt("Role code (optional):", r.code || "") ?? "";
        const newDesc = prompt("Description (optional):", r.desc || "") ?? "";
        list[idx] = { ...r, name: trimmedName, code: newCode.trim(), desc: newDesc.trim() }; save(list); render();
      }
    });

    // Export / Import
    $("#cb-roles-export")?.addEventListener("click", function(){
      const data = load();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "roles.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $("#cb-roles-import")?.addEventListener("click", ()=> $("#cb-roles-import-input")?.click());
    $("#cb-roles-import-input")?.addEventListener("change", function(){
      const file = this.files && this.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = function(){
        try {
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data)) throw new Error("Invalid file format. Expected an array.");
          save(data); render();
          const msgEl = $("#cb-roles-msg"); if (msgEl){ msgEl.style.color="#16a34a"; msgEl.textContent="Imported."; }
        } catch(err){ alert("Import failed: " + (err && err.message ? err.message : err)); }
      };
      reader.readAsText(file); 
      setTimeout(()=>{ try{ document.getElementById("cb-roles-import-input").value = "" } catch{} }, 50);
    });
  }

  // Ensure label normalization & attribute marking even after SPA renders
  function normalizeAndMark(){
    const nodes = $$("a,button,li,div,span");
    for (const el of nodes){
      const txt = (el.textContent || "").replace(/\s+/g," ").trim().toLowerCase();
      if (/^roles\s*(&|and)\s*(access|permissions)$/.test(txt)) {
        if (!el.id) el.id = "navRolesPermissions";
        el.setAttribute("data-cb-nav","roles-permissions");
        if (el.firstChild && el.firstChild.nodeType === Node.TEXT_NODE){
          el.firstChild.nodeValue = "Roles & Permissions";
        } else {
          // safer update: replace the text portion without touching icon spans
          const parts = Array.from(el.childNodes);
          const textNode = parts.find(n=> n.nodeType === Node.TEXT_NODE && /\S/.test(n.nodeValue || ""));
          if (textNode) textNode.nodeValue = " Roles & Permissions";
        }
        break;
      }
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    normalizeAndMark();
    wire();
    // Observe DOM changes
    const mo = new MutationObserver(()=>{ normalizeAndMark(); });
    mo.observe(document.body, { childList:true, subtree:true });
  });
})();
</script>
<!-- CB ROLES INJECTION END -->
<!-- CB USERS INJECTION START -->
<style>
  .cu-hidden{display:none!important}
  .cu-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .cu-modal-content{background:#fff;color:#111;width:min(1100px,96vw);max-height:88vh;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden;display:flex;flex-direction:column}
  .cu-modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eee;background:#f8fafc}
  .cu-modal-body{padding:16px;overflow:auto}
  .cu-modal-actions{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end;background:#fafafa}
  .cu-btn{border:1px solid #ddd;padding:8px 12px;border-radius:10px;cursor:pointer;background:#fff}
  .cu-btn.primary{background:#111;color:#fff;border-color:#111}
  .cu-grid{width:100%;border-collapse:collapse}
  .cu-grid th,.cu-grid td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
  .cu-grid th{background:#f9fafb;font-weight:600}
  .cu-form{display:grid;grid-template-columns:1fr 1fr;gap:12px 16px;margin-bottom:16px}
  .cu-form .full{grid-column:1 / -1}
  .cu-input,.cu-select,.cu-textarea{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;outline:none}
  .cu-input:focus,.cu-select:focus,.cu-textarea:focus{border-color:#111}
  .cu-tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
  .cu-roles{min-height:80px}
  .cu-hint{font-size:12px;color:#6b7280}
  .cu-badger{display:inline-flex;gap:6px;flex-wrap:wrap}
  .cu-badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;border:1px solid #e5e7eb}
  @media (max-width:640px){.cu-form{grid-template-columns:1fr}}
</style>
<div aria-labelledby="cu-users-title" aria-modal="true" class="cu-modal cu-hidden" id="cu-users-modal" role="dialog">
<div class="cu-modal-content">
<div class="cu-modal-header">
<h3 id="cu-users-title" style="margin:0;">Users</h3>
<button aria-label="Close users dialog" class="cu-btn" id="cu-users-close">✕</button>
</div>
<div class="cu-modal-body">
<form class="cu-form" id="cu-users-form">
<div>
<label for="cu-user-name" style="display:block;margin-bottom:6px;">Full name <span class="cu-tag">required</span></label>
<input class="cu-input" id="cu-user-name" placeholder="e.g., John Doe" required="" type="text"/>
</div>
<div>
<label for="cu-user-username" style="display:block;margin-bottom:6px;">Username / Email <span class="cu-tag">required</span></label>
<input class="cu-input" id="cu-user-username" placeholder="e.g., jdoe or jdoe@example.com" required="" type="text"/>
</div>
<div class="full">
<label for="cu-user-roles" style="display:block;margin-bottom:6px;">Roles</label>
<select class="cu-select cu-roles" id="cu-user-roles" multiple=""></select>
<div class="cu-hint">Hold Ctrl/Cmd to select multiple roles.</div>
</div>
<div class="full">
<label for="cu-user-notes" style="display:block;margin-bottom:6px;">Notes (optional)</label>
<textarea class="cu-textarea" id="cu-user-notes" placeholder="Any notes about this user..." rows="2"></textarea>
</div>
<div class="full" style="display:flex;gap:8px;align-items:center;">
<button class="cu-btn primary" type="submit">Add User</button>
<button class="cu-btn" id="cu-users-clear" type="button">Clear All (Local)</button>
<span id="cu-users-msg" style="margin-left:8px;font-size:12px;color:#16a34a;"></span>
</div>
</form>
<table aria-label="Users table" class="cu-grid" id="cu-users-table">
<thead>
<tr>
<th style="width:22%;">Name</th>
<th style="width:22%;">Username</th>
<th>Roles</th>
<th style="width:18%;">Created</th>
<th style="width:14%;">Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="cu-modal-actions">
<button class="cu-btn" id="cu-users-export">Export</button>
<input accept="application/json" class="cu-hidden" id="cu-users-import-input" type="file"/>
<button class="cu-btn" id="cu-users-import">Import</button>
<button class="cu-btn" id="cu-users-close-bottom">Close</button>
</div>
</div>
</div>
<script>
(function(){
  const USERS_KEY = "cb_users";
  const ROLES_KEY = "cb_roles";

  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  function slugify(s){ return String(s||"").toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function roleKey(r){ return (r.code && r.code.trim()) ? r.code.trim().toLowerCase() : slugify(r.name); }

  function loadUsers(){ try{ const arr = JSON.parse(localStorage.getItem(USERS_KEY)||"[]"); return Array.isArray(arr)?arr:[] }catch{return []} }
  function saveUsers(arr){ localStorage.setItem(USERS_KEY, JSON.stringify(arr||[])); }

  function loadRoles(){ try{ const arr = JSON.parse(localStorage.getItem(ROLES_KEY)||"[]"); return Array.isArray(arr)?arr:[] }catch{return []} }

  function rolesMap(){
    const map = new Map();
    for (const r of loadRoles()){
      map.set(roleKey(r), r.name || roleKey(r));
    }
    return map;
  }

  function formatDate(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso||""; } }
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;","&gt;":">&gt;","\"":"&quot;","'":"&#39;"}[s])); }

  function openModal(){
    $("#cu-users-modal")?.classList.remove("cu-hidden");
    setTimeout(()=> $("#cu-user-name")?.focus(), 50);
  }
  function closeModal(){
    $("#cu-users-modal")?.classList.add("cu-hidden");
  }

  function populateRoleSelect(){
    const sel = $("#cu-user-roles");
    if (!sel) return;
    const roles = loadRoles();
    sel.innerHTML = "";
    if (!roles.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.disabled = true;
      opt.textContent = "No roles yet — add roles first";
      sel.appendChild(opt);
      sel.multiple = false;
      sel.disabled = true;
      return;
    }
    sel.disabled = false;
    sel.multiple = true;
    for (const r of roles){
      const opt = document.createElement("option");
      opt.value = roleKey(r);
      opt.textContent = r.name || roleKey(r);
      sel.appendChild(opt);
    }
  }

  function renderTable(){
    const tbody = $("#cu-users-table tbody");
    if (!tbody) return;
    const list = loadUsers();
    const rmap = rolesMap();
    tbody.innerHTML = "";
    if (!list.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "No users yet. Add one using the form above.";
      td.style.color = "#6b7280";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    for (const u of list){
      const tr = document.createElement("tr");
      const rolesHtml = (Array.isArray(u.roles)?u.roles:[]).map(k => {
        const label = rmap.get(k) || (k ? k + " (unknown)" : "");
        return '<span class="cu-badge">'+escapeHtml(label)+'</span>';
      }).join(" ");
      tr.innerHTML = `
        <td>${escapeHtml(u.name||"")}</td>
        <td>${escapeHtml(u.username||"")}</td>
        <td class="cu-badger">${rolesHtml || '<span class="cu-hint">No roles</span>'}</td>
        <td>${formatDate(u.createdAt)}</td>
        <td>
          <button class="cu-btn" data-cu-action="edit" data-id="${u.id}">Edit</button>
          <button class="cu-btn" data-cu-action="delete" data-id="${u.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function ensureUsersNav(){
    if (document.getElementById("navUsersManage")) return true;

    // Strategy 1: Find the "Admin" side-title, then its following ul.vnav
    let adminList = null;
    const titles = $$(".side-title");
    for (const t of titles){
      const txt = (t.textContent||"").trim().toLowerCase();
      if (txt === "admin"){
        let next = t.nextElementSibling;
        while (next){
          if (next.matches && next.matches("ul.vnav")) { adminList = next; break; }
          next = next.nextElementSibling;
        }
        if (adminList) break;
      }
    }

    // Strategy 2: If not found, pick a ul.vnav that contains Roles & Permissions
    if (!adminList){
      const lists = $$("ul.vnav");
      for (const ul of lists){
        const hasRoles = !!Array.from(ul.querySelectorAll("button, a")).find(el => /roles\s*(&|and)\s*(permissions|access)/i.test((el.textContent||"").trim()));
        if (hasRoles){ adminList = ul; break; }
      }
    }

    if (!adminList) return false;

    // Build Users item
    const li = document.createElement("li");
    li.className = "vitem";
    const btn = document.createElement("button");
    btn.className = "vbtn";
    btn.id = "navUsersManage";
    btn.setAttribute("data-cb-nav","users-manage");
    const icon = document.createElement("span"); icon.className = "ico"; icon.textContent = "👥";
    btn.appendChild(icon);
    btn.append(" Users");
    li.appendChild(btn);

    // Insert after Roles item if we can locate it
    const rolesBtn = adminList.querySelector("#navRolesPermissions, [data-cb-nav='roles-permissions']");
    if (rolesBtn && rolesBtn.closest("li.vitem") && rolesBtn.closest("li.vitem").parentElement === adminList){
      rolesBtn.closest("li.vitem").insertAdjacentElement("afterend", li);
    } else {
      adminList.appendChild(li);
    }
    return true;
  }

  function wire(){
    if (window.__cuUsersWired) return;
    window.__cuUsersWired = true;

    // Try multiple times in case the nav renders late
    let attempts = 0;
    const tryInsert = () => {
      attempts++;
      const ok = ensureUsersNav();
      if (!ok && attempts < 20){
        setTimeout(tryInsert, 150);
      }
    };
    tryInsert();

    // Observe mutations on the sidebar to re-insert if it re-renders
    const sidebar = document.querySelector("aside") || document.body;
    const mo = new MutationObserver(() => { ensureUsersNav(); });
    mo.observe(sidebar, { childList: true, subtree: true });

    // Open modal (capturing to beat blockers)
    document.addEventListener("click", function(e){
      const el = e.target.closest("[data-cb-nav='users-manage'], #navUsersManage");
      if (el){ e.preventDefault(); populateRoleSelect(); renderTable(); openModal(); }
    }, true);

    // Modal wiring
    $("#cu-users-close")?.addEventListener("click", ()=> { closeModal(); });
    $("#cu-users-close-bottom")?.addEventListener("click", ()=> { closeModal(); });
    $("#cu-users-modal")?.addEventListener("click", (e)=>{ if(e.target === $("#cu-users-modal")) closeModal(); });

    // Form submit
    $("#cu-users-form")?.addEventListener("submit", function(e){
      e.preventDefault();
      const name = ($("#cu-user-name")?.value || "").trim();
      const username = ($("#cu-user-username")?.value || "").trim();
      const notes = ($("#cu-user-notes")?.value || "").trim();
      const roles = Array.from($("#cu-user-roles")?.selectedOptions || []).map(o=>o.value).filter(Boolean);
      const msg = $("#cu-users-msg");
      if(!name){ msg && (msg.style.color="#dc2626", msg.textContent="Full name is required."); $("#cu-user-name")?.focus(); return; }
      if(!username){ msg && (msg.style.color="#dc2626", msg.textContent="Username/Email is required."); $("#cu-user-username")?.focus(); return; }
      const list = loadUsers();
      if (list.some(x => (x.username||"").toLowerCase() === username.toLowerCase())){
        msg && (msg.style.color="#dc2626", msg.textContent="A user with this username already exists.");
        return;
      }
      const id = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now() + Math.random());
      list.push({ id, name, username, roles, notes, createdAt: new Date().toISOString() });
      saveUsers(list);
      renderTable();
      this.reset();
      populateRoleSelect();
      msg && (msg.style.color="#16a34a", msg.textContent="User added.");
    });

    // Row actions
    $("#cu-users-table")?.addEventListener("click", function(e){
      const btn = e.target.closest("button[data-cu-action]");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-cu-action");
      const list = loadUsers();
      const idx = list.findIndex(x => x.id === id);
      if (idx === -1) return;
      if (action === "delete"){
        if (confirm("Delete this user?")){
          list.splice(idx, 1);
          saveUsers(list);
          renderTable();
        }
      } else if (action === "edit"){
        const u = list[idx];
        const newName = prompt("Full name:", u.name || "");
        if (newName === null) return;
        const tName = newName.trim(); if (!tName){ alert("Full name is required."); return; }

        const newUsername = prompt("Username/Email:", u.username || "");
        if (newUsername === null) return;
        const tUser = newUsername.trim(); if (!tUser){ alert("Username/Email is required."); return; }
        if (list.some((x,i)=> i!==idx && (x.username||"").toLowerCase() === tUser.toLowerCase())){ alert("Another user already has this username."); return; }

        const rmap = rolesMap();
        const currentRoles = Array.isArray(u.roles)?u.roles:[];
        const hint = "Enter role keys (comma separated). Known keys: " + Array.from(rmap.keys()).join(", ");
        let newRoles = prompt(hint, currentRoles.join(",") );
        if (newRoles === null) return;
        const roles = newRoles.split(",").map(s=>s.trim().toLowerCase()).filter(Boolean);

        list[idx] = { ...u, name: tName, username: tUser, roles };
        saveUsers(list);
        renderTable();
      }
    });

    // Export/Import
    $("#cu-users-export")?.addEventListener("click", function(){
      const data = loadUsers();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "users.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $("#cu-users-import")?.addEventListener("click", ()=> $("#cu-users-import-input")?.click());
    $("#cu-users-import-input")?.addEventListener("change", function(){
      const file = this.files && this.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = function(){
        try{
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data)) throw new Error("Invalid file format. Expected an array.");
          saveUsers(data);
          renderTable();
          const msg = $("#cu-users-msg"); if (msg){ msg.style.color="#16a34a"; msg.textContent="Imported."; }
        }catch(err){ alert("Import failed: " + (err && err.message ? err.message : err)); }
      };
      reader.readAsText(file);
      document.getElementById("cu-users-import-input").value = "";
    });

    // Keep roles-driven UI in sync
    window.addEventListener("storage", function(e){
      if (e.key === ROLES_KEY){
        populateRoleSelect();
        renderTable();
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    wire();
  });
})();
</script>
<!-- CB USERS INJECTION END -->
<!-- CB ROLE + USER SWITCH START -->
<style>
  .cb-switch{display:flex;align-items:center;gap:14px;margin-left:auto}
  .cb-switch .lbl{font-size:12px;color:#6b7280}
  .cb-select-wrap{position:relative;display:inline-block}
  .cb-select{
    appearance:none;-webkit-appearance:none;-moz-appearance:none;
    border:1px solid var(--line,#d1d5db);
    background:#fff;border-radius:12px;
    padding:8px 36px 8px 12px;height:36px;min-width:200px;cursor:pointer;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    transition:border-color .18s ease, box-shadow .18s ease;font-size:14px;
  }
  .cb-select:hover{border-color:#9ca3af}
  .cb-select:focus{outline:none;border-color:#111;box-shadow:0 0 0 3px rgba(17,17,17,.12)}
  .cb-caret{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;pointer-events:none;opacity:.56}
  .topbar .inner{display:flex;align-items:center;gap:12px}
</style>
<script>
(function(){
  const ROLES_KEY = "cb_roles";
  const USERS_KEY = "cb_users";
  const CUR_ROLE_KEY = "cb_current_role_key";
  const CUR_USER_KEY = "cb_current_user_key";

  const $ = (s, r=document) => r.querySelector(s);

  function slugify(s){ return String(s||"").toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function roleKey(r){ return (r.code && r.code.trim()) ? r.code.trim().toLowerCase() : slugify(r.name); }
  function userKey(u){ return (u.username || "").trim().toLowerCase(); }

  function loadRoles(){ try{ const a = JSON.parse(localStorage.getItem(ROLES_KEY)||"[]"); return Array.isArray(a)?a:[] }catch{return []} }
  function loadUsers(){ try{ const a = JSON.parse(localStorage.getItem(USERS_KEY)||"[]"); return Array.isArray(a)?a:[] }catch{return []} }

  function getCurrentUserFromQuery(){
    const u = new URL(location.href);
    return (u.searchParams.get('user')||"").trim().toLowerCase() || null;
  }
  function getCurrentUser(){ return getCurrentUserFromQuery() || localStorage.getItem(CUR_USER_KEY) || null; }
  function setCurrentUser(key){
    if (!key) return;
    localStorage.setItem(CUR_USER_KEY, key);
    const u = new URL(location.href);
    u.searchParams.set('user', key);
    history.replaceState(null, "", u.toString()); // no reload
  }

  function getCurrentRoleFromQuery(){
    const u = new URL(location.href);
    return (u.searchParams.get('role')||"").trim().toLowerCase() || null;
  }
  function setCurrentRole(key){
    if(!key) return;
    localStorage.setItem(CUR_ROLE_KEY, key);
    const u = new URL(location.href);
    u.searchParams.set('role', key);
    location.href = u.toString(); // reload so the app picks it up
  }

  function renderSwitchers(){
    const topInner = document.querySelector(".topbar .inner");
    if (!topInner) return;
    if (document.getElementById("cbSwitchWrap")) return;

    const wrap = document.createElement("div");
    wrap.id = "cbSwitchWrap";
    wrap.className = "cb-switch";

    // --- User select ---
    const userLbl = document.createElement("div");
    userLbl.className = "lbl";
    userLbl.textContent = "User";

    const userWrap = document.createElement("div");
    userWrap.className = "cb-select-wrap";
    const userSel = document.createElement("select");
    userSel.id = "cbUserSelect";
    userSel.className = "cb-select";
    const userCaret = document.createElementNS("http://www.w3.org/2000/svg","svg");
    userCaret.setAttribute("viewBox","0 0 24 24");
    userCaret.classList.add("cb-caret");
    userCaret.innerHTML = '<path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
    userWrap.appendChild(userSel); userWrap.appendChild(userCaret);

    // --- Role select ---
    const roleLbl = document.createElement("div");
    roleLbl.className = "lbl";
    roleLbl.textContent = "Role";

    const roleWrap = document.createElement("div");
    roleWrap.className = "cb-select-wrap";
    const roleSel = document.createElement("select");
    roleSel.id = "cbRoleSelect";
    roleSel.className = "cb-select";
    const roleCaret = document.createElementNS("http://www.w3.org/2000/svg","svg");
    roleCaret.setAttribute("viewBox","0 0 24 24");
    roleCaret.classList.add("cb-caret");
    roleCaret.innerHTML = '<path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
    roleWrap.appendChild(roleSel); roleWrap.appendChild(roleCaret);

    // Place before the mode switch for right alignment
    const modeSwitch = document.getElementById("modeSwitch");
    if (modeSwitch && modeSwitch.parentElement === topInner){
      topInner.insertBefore(wrap, modeSwitch);
    } else {
      topInner.appendChild(wrap);
    }

    wrap.appendChild(userLbl);
    wrap.appendChild(userWrap);
    wrap.appendChild(roleLbl);
    wrap.appendChild(roleWrap);

    // Populate then wire
    populateUserOptions();
    populateRoleOptionsForSelectedUser();

    userSel.addEventListener("change", function(){
      const key = this.value;
      if (!key) return;
      setCurrentUser(key);
      populateRoleOptionsForSelectedUser();
    });

    roleSel.addEventListener("change", function(){
      const rkey = this.value;
      if (!rkey) return;
      setCurrentRole(rkey); // triggers reload
    });
  }

  function populateUserOptions(){
    const userSel = document.getElementById("cbUserSelect");
    if (!userSel) return;
    const users = loadUsers();
    const curr = getCurrentUser();
    userSel.innerHTML = "";
    if (!users.length){
      const opt = document.createElement("option");
      opt.value = ""; opt.textContent = "No users — add in Admin"; opt.disabled = true; opt.selected = true;
      userSel.appendChild(opt);
      return;
    }
    // Placeholder
    const ph = document.createElement("option");
    ph.value = ""; ph.textContent = "Select user"; ph.disabled = false;
    userSel.appendChild(ph);

    for (const u of users){
      const key = userKey(u); if (!key) continue;
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = u.name ? (u.name + " (" + u.username + ")") : u.username;
      if (curr && curr === key){ opt.selected = true; }
      userSel.appendChild(opt);
    }
  }

  function populateRoleOptionsForSelectedUser(){
    const roleSel = document.getElementById("cbRoleSelect");
    const userSel = document.getElementById("cbUserSelect");
    if (!roleSel || !userSel) return;
    roleSel.innerHTML = "";
    const users = loadUsers();
    const allRoles = loadRoles();

    const addDisabled = (txt) => {
      const opt = document.createElement("option"); opt.value = ""; opt.textContent = txt; opt.disabled = true; opt.selected = true; roleSel.appendChild(opt);
    };

    const selectedUserKey = userSel.value || getCurrentUser();
    if (!selectedUserKey){
      addDisabled("Select a user first");
      return;
    }
    const user = users.find(x => userKey(x) === selectedUserKey);
    if (!user){
      addDisabled("User not found");
      return;
    }
    const userRoles = Array.isArray(user.roles) ? user.roles.map(r => (r||"").toLowerCase()).filter(Boolean) : [];
    if (!userRoles.length){
      addDisabled("No roles assigned to this user");
      return;
    }

    const currRole = getCurrentRoleFromQuery() || localStorage.getItem(CUR_ROLE_KEY) || null;
    let hasCurr = false;

    // Placeholder
    const ph = document.createElement("option");
    ph.value = ""; ph.textContent = "Select role"; ph.disabled = false;
    roleSel.appendChild(ph);

    for (const rkey of userRoles){
      const role = allRoles.find(rr => roleKey(rr) === rkey);
      const label = role ? (role.name || rkey) : rkey;
      const opt = document.createElement("option");
      opt.value = rkey; opt.textContent = label;
      if (currRole && currRole === rkey){ opt.selected = true; hasCurr = true; }
      roleSel.appendChild(opt);
    }

    if (!hasCurr){
      roleSel.value = ""; // force user to pick a role explicitly
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    renderSwitchers();

    // Re-render when users/roles change elsewhere
    let lastUsers = JSON.stringify(loadUsers()||[]);
    let lastRoles = JSON.stringify(loadRoles()||[]);
    setInterval(function(){
      const uNow = JSON.stringify(loadUsers()||[]);
      const rNow = JSON.stringify(loadRoles()||[]);
      if (uNow !== lastUsers || rNow !== lastRoles){
        lastUsers = uNow; lastRoles = rNow;
        document.getElementById("cbSwitchWrap")?.remove();
        renderSwitchers();
      }
    }, 1200);

    window.addEventListener("storage", function(e){
      if (e.key === USERS_KEY || e.key === ROLES_KEY){
        document.getElementById("cbSwitchWrap")?.remove();
        renderSwitchers();
      }
    });
  });
})();
</script>
<!-- CB ROLE + USER SWITCH END -->
<!-- CB PROFILE START -->
<style>
  /* Profile avatar button (top-right) */
  .cp-prof-wrap{display:flex;align-items:center;gap:10px;margin-left:8px}
  .cp-avatar-btn{border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:999px}
  .cp-avatar-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(17,17,17,.12)}
  .cp-avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;flex:0 0 32px;border:1px solid rgba(0,0,0,.08);background:#f3f4f6;display:grid;place-items:center;font-weight:600;font-size:12px;color:#111}
  .cp-avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .cp-name{font-size:13px;color:#111;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  @media (max-width:720px){ .cp-name{display:none} }

  /* Profile modal */
  .cp-hidden{display:none!important}
  .cp-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .cp-modal-content{background:#fff;color:#111;width:min(760px,96vw);max-height:88vh;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden;display:flex;flex-direction:column}
  .cp-modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eee;background:#f8fafc}
  .cp-modal-body{padding:16px;overflow:auto}
  .cp-modal-actions{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end;background:#fafafa}
  .cp-btn{border:1px solid #ddd;padding:8px 12px;border-radius:10px;cursor:pointer;background:#fff}
  .cp-btn.primary{background:#111;color:#fff;border-color:#111}
  .cp-form{display:grid;grid-template-columns:1fr 1fr;gap:12px 16px;margin-bottom:8px}
  .cp-form .full{grid-column:1 / -1}
  .cp-input,.cp-textarea{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;outline:none}
  .cp-input:focus,.cp-textarea:focus{border-color:#111}
  .cp-photo-row{display:flex;align-items:center;gap:16px}
  .cp-photo{width:96px;height:96px;border-radius:50%;overflow:hidden;border:1px solid #e5e7eb;background:#f3f4f6;display:grid;place-items:center}
  .cp-photo img{width:100%;height:100%;object-fit:cover}
  .cp-hint{font-size:12px;color:#6b7280}
</style>
<div aria-labelledby="cp-profile-title" aria-modal="true" class="cp-modal cp-hidden" id="cp-profile-modal" role="dialog">
<div class="cp-modal-content">
<div class="cp-modal-header">
<h3 id="cp-profile-title" style="margin:0;">Profile</h3>
<button aria-label="Close profile dialog" class="cp-btn" id="cp-profile-close">✕</button>
</div>
<div class="cp-modal-body">
<div class="cp-photo-row full" style="margin-bottom:12px;">
<div class="cp-photo"><img alt="Avatar preview" id="cp-avatar-preview"/></div>
<div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
<input accept="image/*" class="cp-input" id="cp-file" style="padding:6px" type="file"/>
<button class="cp-btn" id="cp-remove-photo" type="button">Remove photo</button>
</div>
<div class="cp-hint">Upload a square image for best results. We store it locally in your browser.</div>
</div>
</div>
<form class="cp-form" id="cp-profile-form">
<div>
<label style="display:block;margin-bottom:6px;">Full name</label>
<input class="cp-input" id="cp-name" placeholder="e.g., John Doe" type="text"/>
</div>
<div>
<label style="display:block;margin-bottom:6px;">Username / Email</label>
<input class="cp-input" id="cp-username" placeholder="e.g., jdoe or jdoe@example.com" type="text"/>
</div>
<div>
<label style="display:block;margin-bottom:6px;">Title (optional)</label>
<input class="cp-input" id="cp-title" placeholder="e.g., Product Manager" type="text"/>
</div>
<div>
<label style="display:block;margin-bottom:6px;">Phone (optional)</label>
<input class="cp-input" id="cp-phone" placeholder="e.g., +1 202 555 0123" type="text"/>
</div>
<div class="full">
<label style="display:block;margin-bottom:6px;">Notes</label>
<textarea class="cp-textarea" id="cp-notes" placeholder="Any notes…" rows="2"></textarea>
</div>
<div class="full" style="display:flex;gap:8px;align-items:center;margin-top:4px;">
<button class="cp-btn primary" type="submit">Save</button>
<span class="cp-hint" id="cp-msg" style="color:#16a34a;"></span>
</div>
</form>
</div>
<div class="cp-modal-actions">
<button class="cp-btn" id="cp-profile-close-bottom">Close</button>
</div>
</div>
</div>
<script>
(function(){
  const USERS_KEY = "cb_users";
  const CUR_USER_KEY = "cb_current_user_key";

  const $ = (s, r=document) => r.querySelector(s);

  function loadUsers(){ try{ const arr = JSON.parse(localStorage.getItem(USERS_KEY)||"[]"); return Array.isArray(arr)?arr:[] }catch{return []} }
  function saveUsers(arr){ localStorage.setItem(USERS_KEY, JSON.stringify(arr||[])); }
  function userKey(u){ return (u.username || "").trim().toLowerCase(); }

  function getCurrentUserKey(){
    const u = new URL(location.href);
    return (u.searchParams.get('user')||"").trim().toLowerCase() || localStorage.getItem(CUR_USER_KEY) || null;
  }

  function getInitials(name, fallback){
    const s = String(name||"").trim();
    if (!s) return (fallback||"?").slice(0,2).toUpperCase();
    const parts = s.split(/\s+/).filter(Boolean);
    if (parts.length === 1) return parts[0].slice(0,2).toUpperCase();
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }

  function renderProfileButton(){
    const topInner = document.querySelector(".topbar .inner");
    if (!topInner) return;
    if (!document.getElementById("cbSwitchWrap")) return; // wait until switches are in place
    if (document.getElementById("cpProfWrap")) return;

    const wrap = document.createElement("div");
    wrap.id = "cpProfWrap";
    wrap.className = "cp-prof-wrap";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.id = "cpProfileBtn";
    btn.className = "cp-avatar-btn";

    const av = document.createElement("div");
    av.className = "cp-avatar";
    const img = document.createElement("img");
    img.id = "cpAvatarTop";
    av.appendChild(img);

    const name = document.createElement("div");
    name.id = "cpTopName";
    name.className = "cp-name";

    btn.appendChild(av);
    btn.appendChild(name);
    wrap.appendChild(btn);

    const modeSwitch = document.getElementById("modeSwitch");
    if (modeSwitch && modeSwitch.parentElement === topInner){
      modeSwitch.parentElement.insertBefore(wrap, modeSwitch.nextSibling);
    } else {
      topInner.appendChild(wrap);
    }

    // Click to open profile
    btn.addEventListener("click", function(e){
      e.preventDefault();
      openProfile();
    });

    refreshTopbarAvatar();
  }

  function refreshTopbarAvatar(){
    const users = loadUsers();
    const uk = getCurrentUserKey();
    const u = users.find(x => userKey(x) === uk);
    const img = document.getElementById("cpAvatarTop");
    const nm = document.getElementById("cpTopName");

    if (!img || !nm) return;

    if (u && u.avatar){
      img.src = u.avatar;
      img.style.display = "block";
      nm.textContent = u.name || u.username || "";
    
    const btn = document.getElementById("cpProfileBtn");
    if (btn) {
      const display = u ? (u.name || u.username || "Profile") : "Profile";
      btn.title = display;
    }
} else if (u){
      img.removeAttribute("src");
      img.style.display = "none";
      // show initials in the avatar div
      const av = img.parentElement;
      av.textContent = getInitials(u.name || u.username, "U");
      nm.textContent = u.name || u.username || "";
    } else {
      img.removeAttribute("src");
      img.style.display = "none";
      const av = img.parentElement;
      av.textContent = "U";
      nm.textContent = "Profile";
    }
  }

  function openProfile(){
    const modal = $("#cp-profile-modal");
    const msg = $("#cp-msg");
    msg && (msg.textContent = "");

    const users = loadUsers();
    const uk = getCurrentUserKey();
    const u = users.find(x => userKey(x) === uk);

    if (!u){
      alert("Select a user first (top-right) to edit profile.");
      return;
    }

    $("#cp-name").value = u.name || "";
    $("#cp-username").value = u.username || "";
    $("#cp-title").value = (u.title || "");
    $("#cp-phone").value = (u.phone || "");
    $("#cp-notes").value = (u.notes || "");
    const prev = $("#cp-avatar-preview");
    if (u.avatar){ prev.src = u.avatar; prev.style.display = "block"; } else { prev.removeAttribute("src"); prev.style.display = "none"; }

    modal.classList.remove("cp-hidden");
  }

  function closeProfile(){
    $("#cp-profile-modal")?.classList.add("cp-hidden");
  }

  async function readAndResize(file, size=256, mime="image/jpeg", quality=0.9){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = function(){
        const img = new Image();
        img.onload = function(){
          // draw cover into square canvas
          const canvas = document.createElement("canvas");
          canvas.width = size; canvas.height = size;
          const ctx = canvas.getContext("2d");
          const iw = img.width, ih = img.height;
          const s = Math.max(size/iw, size/ih);
          const sw = size / s, sh = size / s;
          const sx = (iw - sw) / 2;
          const sy = (ih - sh) / 2;
          ctx.drawImage(img, sx, sy, sw, sh, 0, 0, size, size);
          try {
            const dataUrl = canvas.toDataURL(mime, quality);
            resolve(dataUrl);
          } catch(e){ resolve(canvas.toDataURL()); }
        };
        img.onerror = reject;
        img.src = fr.result;
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  function wire(){
    if (window.__cpProfileWired) return;
    window.__cpProfileWired = true;

    document.addEventListener("DOMContentLoaded", function(){
      renderProfileButton();
    });

    // Re-render avatar when the user selection changes
    document.addEventListener("change", function(e){
      if (e.target && e.target.id === "cbUserSelect"){
        setTimeout(refreshTopbarAvatar, 0);
      }
    }, true);

    // Also poll in case other code updates storage
    setInterval(refreshTopbarAvatar, 1500);

    // Modal controls
    $("#cp-profile-close")?.addEventListener("click", closeProfile);
    $("#cp-profile-close-bottom")?.addEventListener("click", closeProfile);
    $("#cp-profile-modal")?.addEventListener("click", (e)=>{ if(e.target === $("#cp-profile-modal")) closeProfile(); });

    // Photo upload
    $("#cp-file")?.addEventListener("change", async function(){
      const file = this.files && this.files[0];
      if (!file) return;
      try{
        const dataUrl = await readAndResize(file, 256, "image/jpeg", 0.9);
        const prev = $("#cp-avatar-preview");
        prev.src = dataUrl; prev.style.display = "block";
        // Temporarily stash on the element for save
        prev.dataset.pending = dataUrl;
        // Reset input so same file can be chosen again
        this.value = "";
      }catch(err){
        alert("Could not read image.");
      }
    });

    // Remove photo
    $("#cp-remove-photo")?.addEventListener("click", function(){
      const prev = $("#cp-avatar-preview");
      prev.removeAttribute("src"); prev.style.display = "none";
      delete prev.dataset.pending;
    });

    // Save profile
    $("#cp-profile-form")?.addEventListener("submit", function(e){
      e.preventDefault();
      const users = loadUsers();
      const uk = getCurrentUserKey();
      const idx = users.findIndex(x => userKey(x) === uk);
      const msg = $("#cp-msg");
      if (idx === -1){ alert("Select a user first."); return; }

      const newName = ($("#cp-name").value || "").trim();
      const newUsername = ($("#cp-username").value || "").trim();
      const newTitle = ($("#cp-title").value || "").trim();
      const newPhone = ($("#cp-phone").value || "").trim();
      const newNotes = ($("#cp-notes").value || "").trim();

      if (!newUsername){ msg && (msg.style.color="#dc2626", msg.textContent="Username/Email is required."); return; }
      // Unique username check
      if (users.some((x,i)=> i!==idx && (x.username||"").toLowerCase() === newUsername.toLowerCase())){
        msg && (msg.style.color="#dc2626", msg.textContent="Another user already has this username."); return;
      }

      const prev = $("#cp-avatar-preview");
      const pending = prev.dataset.pending;
      const current = users[idx];
      const updated = {
        ...current,
        name: newName || current.name || "",
        username: newUsername || current.username || "",
        title: newTitle,
        phone: newPhone,
        notes: newNotes
      };
      if (pending !== undefined){
        // If pending exists and preview has src, set; if removed, clear
        updated.avatar = prev.getAttribute("src") ? prev.getAttribute("src") : "";
      }

      users[idx] = updated;
      saveUsers(users);

      // Update current user key if username changed
      if (userKey(updated) !== uk){
        localStorage.setItem(CUR_USER_KEY, userKey(updated));
        const url = new URL(location.href);
        url.searchParams.set('user', userKey(updated));
        history.replaceState(null, "", url.toString());
      }

      // Refresh topbar
      refreshTopbarAvatar();
      if (msg){ msg.style.color="#16a34a"; msg.textContent="Saved."; }
    });
  }

  wire();
})();
</script>
<!-- CB PROFILE END -->
<script id="app-mode-script">
// --- App Mode bootstrap & Open App button ---
(function () {
  try {
    const qp = new URLSearchParams(location.search);
    const mode = qp.get('mode');
    const isAppMode = mode === 'app';

    const disableBuilderHotkeys = () => {
      try {
        if (window.__builderHotkeys && typeof window.removeEventListener === 'function') {
          window.removeEventListener('keydown', window.__builderHotkeys);
        }
      } catch (_) {}
      window.__builderHotkeys = null;
    };

    const nukeBuilderChrome = () => {
      const selectors = [
        '.mode-switch', '.builder-toolbar', '.inspector', '.schema-panel',
        '.drag-handle', '.dev-badges'
      ];
      selectors.forEach(sel => document.querySelectorAll(sel).forEach(n => n.remove()));
    };

    if (isAppMode) {
      document.body.classList.add('app-mode');
      document.body.classList.remove('demo-mode');
      document.body.classList.remove('edit-mode');
      disableBuilderHotkeys();
      nukeBuilderChrome();

      // Guard: block schema mutations in app mode
      const block = (fnName) => {
        const orig = window[fnName];
        if (typeof orig === 'function') {
          window[fnName] = function () {
            console.warn(fnName + ' is disabled in app mode.');
            return;
          };
        }
      };
      ['applySchemaChanges','addField','removeField','moveField','saveSchema','updateWorkflow','openWorkflow'].forEach(block);

      // Initialize runtime if available
      if (typeof window.initRuntime === 'function') {
        try { window.initRuntime({ strict: true }); } catch (e) { console.warn('initRuntime failed', e); }
      }
    }

    // Wire the "Open App" button
    const openBtn = document.getElementById('openAppBtn');
    if (openBtn) {
      openBtn.addEventListener('click', () => {
        const url = new URL(location.href);
        url.searchParams.set('mode', 'app');

        // Carry testing params if present
        const wf = (document.getElementById('wfSelect') || {}).value;
        const role = (document.getElementById('roleSelect') || {}).value;
        const step = (document.getElementById('stepSelect') || {}).value;
        if (wf)   url.searchParams.set('wf', wf);
        if (role) url.searchParams.set('role', role);
        if (step) url.searchParams.set('step', step);

        // Option A: rely on saved schema/localStorage
        window.open(url.toString(), '_blank', 'noopener');

        // Option B: embed snapshot in hash (kept commented)
        // const schema = window.getCurrentSchema?.() ?? {};
        // try {
        //   const snap = btoa(unescape(encodeURIComponent(JSON.stringify(schema))));
        //   url.hash = 'app=' + snap;
        // } catch (e) { console.warn('snapshot failed', e); }
        // window.open(url.toString(), '_blank', 'noopener');
      }, { once: false });
    }
  } catch (e) {
    console.warn('App mode bootstrap error:', e);
  }
})();


// Remove specific builder buttons by label within toolbar-like roots
(function(){
  if (!document.body.classList.contains('app-mode')) return;
  const labelMatches = (el, needles) => {
    const txt = (el.textContent || '').trim().toLowerCase();
    return needles.some(n => txt === n || txt.includes(n));
  };
  const removeTargets = (rootSel, needles) => {
    document.querySelectorAll(rootSel).forEach(root => {
      if (!root) return;
      root.querySelectorAll('button,[role="button"],a').forEach(el => {
        // common builder-only classes win immediately
        const cls = (el.className || '') + ' ' + (el.id || '');
        if (/(schema|dataio|data-io|addnav|add-row)/i.test(cls) || labelMatches(el, needles)) {
          el.remove();
        }
      });
    });
  };
  // Toolbar-like containers where those buttons usually live
  const roots = '.builder-toolbar, .mode-switch, header, .topbar, .schema-btns, .nav-toolbar, .cb-row-tools';
  // Needles to match
  const needles = ['+ row', 'add row', 'add new nav', 'add nav', 'schema', 'data'];
  removeTargets(roots, needles);

  // MutationObserver to catch late-added toolbar buttons
  const obs = new MutationObserver(() => removeTargets(roots, needles));
  obs.observe(document.documentElement, {childList: true, subtree: true});
})();


// In app mode: aggressively hide floating action buttons by position + label
(function(){
  if (!document.body.classList.contains('app-mode')) return;

  function isBottomRight(rect){
    const dx = window.innerWidth - rect.right;
    const dy = window.innerHeight - rect.bottom;
    return dx <= 220 && dy <= 220;
  }
  function isBottomLeft(rect){
    const dxLeft = rect.left;
    const dy = window.innerHeight - rect.bottom;
    return dxLeft <= 220 && dy <= 220;
  }
  function textLike(el, words){
    const t = (el.textContent || '').toLowerCase();
    return words.some(w => t.includes(w));
  }
  function classLike(el, words){
    const s = ((el.id||'') + ' ' + (el.className||'')).toLowerCase();
    return words.some(w => s.includes(w));
  }
  function hideFabCandidates(){
    const candidates = Array.from(document.querySelectorAll('button,a,[role=\"button\"],.fab,.floating, .btn, .chip, .action'));
    candidates.forEach(el => {
      const cs = getComputedStyle(el);
      if (cs.display === 'none' || cs.visibility === 'hidden') return;
      if (!['fixed','absolute','sticky'].includes(cs.position)) return;
      const rect = el.getBoundingClientRect();
      if (rect.width === 0 || rect.height === 0) return;

      // Bottom-right: hide "Add Nav" buttons
      if (isBottomRight(rect) && (textLike(el, ['add nav','new nav','add navbar']) || classLike(el, ['addnav','nav-fab','nav-add','navbar']))){
        el.remove();
        return;
      }
      // Bottom-left: hide "Schema" and "Data" export/import buttons
      if (isBottomLeft(rect) && (textLike(el, ['schema','data','export','import']) || classLike(el, ['schema','dataio','data-io','export','import']))){
        el.remove();
        return;
      }
    });
  }

  // Run now and also after future mutations
  hideFabCandidates();
  const obs = new MutationObserver(hideFabCandidates);
  obs.observe(document.documentElement, {childList:true, subtree:true});
})();


// Stronger bottom-left schema/data remover (position + heuristics)
(function(){
  if (!document.body.classList.contains('app-mode')) return;

  function isBottomLeft(rect){
    const left = rect.left;
    const bottomGap = window.innerHeight - rect.bottom;
    return left <= 260 && bottomGap <= 260;
  }
  function clickableCount(root){
    return root.querySelectorAll('button,[role="button"],a,input,label').length;
  }
  function markAndHide(el){
    el.style.setProperty('display','none','important');
    el.setAttribute('data-appmode-hidden','schema-bottom-left');
  }
  function strongHideBottomLeft(){
    const all = Array.from(document.querySelectorAll('*, *::before, *::after'));
    // Filter only elements with layout boxes
    const els = Array.from(document.querySelectorAll('*')).filter(e => {
      const cs = getComputedStyle(e);
      if (cs.display === 'none' || cs.visibility === 'hidden') return false;
      if (!['fixed','absolute','sticky'].includes(cs.position)) return false;
      const r = e.getBoundingClientRect();
      return r.width > 0 && r.height > 0 && isBottomLeft(r);
    });
    els.forEach(el => {
      if (el.getAttribute('data-appmode-hidden')) return;
      const label = ((el.getAttribute('title')||'') + ' ' + (el.getAttribute('aria-label')||'') + ' ' + (el.textContent||'')).toLowerCase();
      const sig = ((el.id||'') + ' ' + (el.className||'') + ' ' + label).toLowerCase();

      const looksSchema = sig.includes('schema') || sig.includes('json');
      const looksData = sig.includes('data') || sig.includes('export') || sig.includes('import');
      // Heuristic: small FAB clusters (<=3 clickables) often used for schema/data toolbelt
      const smallCluster = clickableCount(el) <= 3;

      if (looksSchema || looksData || smallCluster){
        markAndHide(el);
      }
    });
  }

  strongHideBottomLeft();
  const obs = new MutationObserver(strongHideBottomLeft);
  obs.observe(document.documentElement, {childList:true, subtree:true});
})();


// Hide generic '+' FAB at bottom-right in App mode
(function(){
  if (!document.body.classList.contains('app-mode')) return;

  function isBottomRight(rect){
    const dx = window.innerWidth - rect.right;
    const dy = window.innerHeight - rect.bottom;
    return dx <= 260 && dy <= 260;
  }
  function looksPlusLike(el){
    const t = (el.textContent || '').trim();
    const attr = ((el.getAttribute('title')||'') + ' ' + (el.getAttribute('aria-label')||'') + ' ' + (el.id||'') + ' ' + (el.className||'')).toLowerCase();
    if (t === '+' || t === '＋' || t.startsWith('+') || t.endsWith('+')) return true;
    if (attr.includes('plus')) return true;
    // Common synonyms used for '+' FABs
    if (/(add|create|new)\b/.test(attr)) return true;
    // If it contains an SVG with a plus-like path (heuristic: a plus sign often has two lines crossing)
    try {
      const svgs = el.querySelectorAll('svg');
      if (svgs.length){
        const s = (svgs[0].outerHTML || '').toLowerCase();
        if (s.includes('plus') || s.includes('fa-plus') || s.includes('icon-plus')) return true;
      }
    } catch(_) {}
    return false;
  }
  function hideBottomRightPlus(){
    const all = Array.from(document.querySelectorAll('button,[role=\"button\"],a,.fab,.floating,.action,.btn'));
    all.forEach(el => {
      if (!el || el.getAttribute('data-appmode-hidden') === 'plus-br') return;
      const cs = getComputedStyle(el);
      if (cs.display === 'none' || cs.visibility === 'hidden') return;
      if (!['fixed','absolute','sticky'].includes(cs.position)) return;
      const r = el.getBoundingClientRect();
      if (r.width <= 0 || r.height <= 0) return;
      if (!isBottomRight(r)) return;
      if (!looksPlusLike(el)) return;
      el.style.setProperty('display','none','important');
      el.setAttribute('data-appmode-hidden','plus-br');
    });
  }
  hideBottomRightPlus();
  const obs = new MutationObserver(hideBottomRightPlus);
  obs.observe(document.documentElement, {childList:true, subtree:true});
})();


// App mode: hide '+ Row' / 'Add Row' buttons heuristically
(function(){
  if (!document.body.classList.contains('app-mode')) return;

  function looksLikeAddRow(el){
    const txt = (el.textContent || '').trim().toLowerCase().replace(/\s+/g,' ');
    const title = ((el.getAttribute('title')||'') + ' ' + (el.getAttribute('aria-label')||'') + ' ' + (el.getAttribute('data-tooltip')||'')).toLowerCase();
    const idcls = ((el.id||'') + ' ' + (el.className||'')).toLowerCase();
    // direct text matches
    if (txt === '+ row' || txt.startsWith('+ row') || txt.includes('add row')) return true;
    // attribute matches
    if (title.includes('add row') || title.includes('+ row')) return true;
    // id/class heuristics
    if (/(add[-_ ]?row|row[-_ ]?add|fd[-_ ]?add[-_ ]?row|cb[-_ ]?add[-_ ]?row)/.test(idcls)) return true;
    // SVG/aria icon-only buttons with row hints
    try {
      const svg = el.querySelector('svg');
      if (svg){
        const s = (svg.outerHTML || '').toLowerCase();
        if (s.includes('plus') && (idcls.includes('row') || title.includes('row'))) return true;
      }
    } catch(_) {}
    return false;
  }

  function hideAddRow(){
    const candidates = document.querySelectorAll('button,[role=\"button\"],a,.chip,.fab,.action');
    candidates.forEach(el => {
      if (!el || el.getAttribute('data-appmode-hidden') === 'add-row') return;
      const cs = getComputedStyle(el);
      if (cs.display === 'none' || cs.visibility === 'hidden') return;
      if (looksLikeAddRow(el)){
        el.style.setProperty('display','none','important');
        el.setAttribute('data-appmode-hidden','add-row');
      }
    });
  }

  hideAddRow();
  const obs = new MutationObserver(hideAddRow);
  obs.observe(document.documentElement, {childList:true, subtree:true});
})();
</script></body>
</html>
<style>
.input.invalid{ outline:2px solid rgba(220,0,0,.35); border-color:#d33; }
td .cell-error{ color:var(--danger,#c00); font-size:11px; margin-top:4px; }
</style>
<style>
  table.tbl tfoot td { font-weight: 600; background: var(--surface-2, #f8f9fb); }
  table.tbl tfoot tr { border-top: 1px solid var(--border, #e3e6ea); }
  table.tbl td.agg-cell { font-size: 12px; color: var(--muted, #555); }
</style>
